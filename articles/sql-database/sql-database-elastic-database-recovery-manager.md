---
title: "aaaUsing toofix Menedżera odzyskiwania niezależnego fragmentu mapowania problemów | Dokumentacja firmy Microsoft"
description: "Użyj hello RecoveryManager klasy toosolve problemów przy użyciu map niezależnego fragmentu"
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 45520ca3-6903-4b39-88ba-1d41b22da9fe
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/25/2016
ms.author: ddove
ms.openlocfilehash: 2218fb15122f1df466e65483480461e366317f2f
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 10/06/2017
---
# <a name="using-hello-recoverymanager-class-toofix-shard-map-problems"></a><span data-ttu-id="cf41c-103">Przy użyciu hello RecoveryManager klasy toofix niezależnego fragmentu mapy problemów</span><span class="sxs-lookup"><span data-stu-id="cf41c-103">Using hello RecoveryManager class toofix shard map problems</span></span>
<span data-ttu-id="cf41c-104">Witaj [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) klasa udostępnia ADO.Net aplikacji hello możliwości tooeasily wykrywać i poprawiać niespójności między hello mapy globalne niezależnego fragmentu (GSM), a następnie mapować lokalnego niezależnych hello (LSM) tak, w środowisku bazy danych podzielonej.</span><span class="sxs-lookup"><span data-stu-id="cf41c-104">hello [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) class provides ADO.Net applications hello ability tooeasily detect and correct any inconsistencies between hello global shard map (GSM) and hello local shard map (LSM) in a sharded database environment.</span></span> 

<span data-ttu-id="cf41c-105">Witaj GSM i LSM Śledź hello mapowania poszczególnych baz danych w środowisku podzielonej.</span><span class="sxs-lookup"><span data-stu-id="cf41c-105">hello GSM and LSM track hello mapping of each database in a sharded environment.</span></span> <span data-ttu-id="cf41c-106">Czasami występuje podział między hello GSM i hello LSM.</span><span class="sxs-lookup"><span data-stu-id="cf41c-106">Occasionally, a break occurs between hello GSM and hello LSM.</span></span> <span data-ttu-id="cf41c-107">W takim przypadku użyj hello RecoveryManager klasy toodetect i napraw hello podziału.</span><span class="sxs-lookup"><span data-stu-id="cf41c-107">In that case, use hello RecoveryManager class toodetect and repair hello break.</span></span>

<span data-ttu-id="cf41c-108">Klasa RecoveryManager Hello jest częścią hello [biblioteki klienta elastycznej bazy danych](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="cf41c-108">hello RecoveryManager class is part of hello [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> 

![Identyfikator niezależnego fragmentu mapy][1]

<span data-ttu-id="cf41c-110">Aby uzyskać definicje terminów, zobacz [słownik narzędzi elastycznej bazy danych](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="cf41c-110">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span> <span data-ttu-id="cf41c-111">jak hello toounderstand **ShardMapManager** toomanage używane dane w podzielonym rozwiązania, zobacz [zarządzania mapy niezależnego fragmentu](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="cf41c-111">toounderstand how hello **ShardMapManager** is used toomanage data in a sharded solution, see [Shard map management](sql-database-elastic-scale-shard-map-management.md).</span></span>

## <a name="why-use-hello-recovery-manager"></a><span data-ttu-id="cf41c-112">Dlaczego warto używać Menedżera odzyskiwania hello?</span><span class="sxs-lookup"><span data-stu-id="cf41c-112">Why use hello recovery manager?</span></span>
<span data-ttu-id="cf41c-113">W środowisku podzielonej bazy danych ma jednej dzierżawy na bazę danych i wielu baz danych na serwerze.</span><span class="sxs-lookup"><span data-stu-id="cf41c-113">In a sharded database environment, there is one tenant per database, and many databases per server.</span></span> <span data-ttu-id="cf41c-114">Może istnieć wiele serwerów w środowisku hello.</span><span class="sxs-lookup"><span data-stu-id="cf41c-114">There can also be many servers in hello environment.</span></span> <span data-ttu-id="cf41c-115">Każda baza danych jest mapowany w mapie niezależnego fragmentu hello, dlatego wywołania mogą być kierowany toohello właściwym serwerem i bazy danych.</span><span class="sxs-lookup"><span data-stu-id="cf41c-115">Each database is mapped in hello shard map, so calls can be routed toohello correct server and database.</span></span> <span data-ttu-id="cf41c-116">Bazy danych są śledzone według tooa **klucza dzielenia na fragmenty**, i ma przypisany każdego niezależnych **zakres wartości klucza**.</span><span class="sxs-lookup"><span data-stu-id="cf41c-116">Databases are tracked according tooa **sharding key**, and each shard is assigned a **range of key values**.</span></span> <span data-ttu-id="cf41c-117">Na przykład klucz dzielenia na fragmenty może reprezentować powitania klienta nazwy z "D" za "F."</span><span class="sxs-lookup"><span data-stu-id="cf41c-117">For example, a sharding key may represent hello customer names from "D" too"F."</span></span> <span data-ttu-id="cf41c-118">Witaj, mapowanie wszystkich odłamków (alias bazy danych), ich zakresy mapowania są zawarte w hello **mapy globalne niezależnego fragmentu (GSM)**.</span><span class="sxs-lookup"><span data-stu-id="cf41c-118">hello mapping of all shards (aka databases) and their mapping ranges are contained in hello **global shard map (GSM)**.</span></span> <span data-ttu-id="cf41c-119">Każda baza danych zawiera także mapy zakresów hello zawartych w niezależnych hello, znany jako hello **mapy lokalnego niezależnego fragmentu (LSM) tak,**.</span><span class="sxs-lookup"><span data-stu-id="cf41c-119">Each database also contains a map of hello ranges contained on hello shard that is known as hello **local shard map (LSM)**.</span></span> <span data-ttu-id="cf41c-120">Gdy aplikacja łączy niezależnych tooa, mapowanie hello jest buforowany aplikacji hello szybkiego pobierania.</span><span class="sxs-lookup"><span data-stu-id="cf41c-120">When an app connects tooa shard, hello mapping is cached with hello app for quick retrieval.</span></span> <span data-ttu-id="cf41c-121">Witaj LSM jest toovalidate używanych w pamięci podręcznej danych.</span><span class="sxs-lookup"><span data-stu-id="cf41c-121">hello LSM is used toovalidate cached data.</span></span> 

<span data-ttu-id="cf41c-122">Witaj GSM i LSM może stać się zsynchronizowany na powitania z następujących powodów:</span><span class="sxs-lookup"><span data-stu-id="cf41c-122">hello GSM and LSM may become out of sync for hello following reasons:</span></span>

1. <span data-ttu-id="cf41c-123">Usuwanie Hello niezależnych, której zakres za toono dłużej być w użyciu lub zmiana nazwy niezależnego fragmentu.</span><span class="sxs-lookup"><span data-stu-id="cf41c-123">hello deletion of a shard whose range is believed toono longer be in use, or renaming of a shard.</span></span> <span data-ttu-id="cf41c-124">Powoduje usunięcie niezależnych **oddzielona mapowanie niezależnych**.</span><span class="sxs-lookup"><span data-stu-id="cf41c-124">Deleting a shard results in an **orphaned shard mapping**.</span></span> <span data-ttu-id="cf41c-125">Podobnie zmieniono nazwę bazy danych może spowodować oddzielone niezależnego fragmentu mapowania.</span><span class="sxs-lookup"><span data-stu-id="cf41c-125">Similarly, a renamed database can cause an orphaned shard mapping.</span></span> <span data-ttu-id="cf41c-126">W zależności od celem hello hello zmiany niezależnych hello może być konieczne toobe usunięte lub hello niezależnego fragmentu lokalizacji wymaga toobe aktualizacji.</span><span class="sxs-lookup"><span data-stu-id="cf41c-126">Depending on hello intent of hello change, hello shard may need toobe removed or hello shard location needs toobe updated.</span></span> <span data-ttu-id="cf41c-127">toorecover usuniętej bazy danych, zobacz [przywrócić usuniętą bazę](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="cf41c-127">toorecover a deleted database, see [Restore a deleted database](sql-database-recovery-using-backups.md).</span></span>
2. <span data-ttu-id="cf41c-128">Występuje zdarzenie geograficznie pracy w trybie failover.</span><span class="sxs-lookup"><span data-stu-id="cf41c-128">A geo-failover event occurs.</span></span> <span data-ttu-id="cf41c-129">toocontinue, co należy zaktualizować hello nazwę serwera i nazwę bazy danych Menedżera mapy niezależnego fragmentu w aplikacji hello, a następnie szczegóły mapowania niezależnego fragmentu hello aktualizacji wszystkich odłamków na mapie niezależnego fragmentu.</span><span class="sxs-lookup"><span data-stu-id="cf41c-129">toocontinue, one must update hello server name, and database name of shard map manager in hello application and then update hello shard mapping details for all shards in a shard map.</span></span> <span data-ttu-id="cf41c-130">W przypadku geograficznie trybu failover, takie logiki odzyskiwania powinno zostać zautomatyzowane w przepływie pracy trybu failover hello.</span><span class="sxs-lookup"><span data-stu-id="cf41c-130">If there is a geo-failover, such recovery logic should be automated within hello failover workflow.</span></span> <span data-ttu-id="cf41c-131">Automatyzowanie akcje odzyskiwania umożliwia frictionless możliwości zarządzania włączone geograficznie baz danych i pozwala uniknąć człowieka działań ręcznych.</span><span class="sxs-lookup"><span data-stu-id="cf41c-131">Automating recovery actions enables a frictionless manageability for geo-enabled databases and avoids manual human actions.</span></span> <span data-ttu-id="cf41c-132">toolearn o toorecover opcje bazy danych w przypadku awarii centrum danych, zobacz [ciągłość prowadzenia działalności biznesowej](sql-database-business-continuity.md) i [odzyskiwania po awarii](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="cf41c-132">toolearn about options toorecover a database if there is a data center outage, see [Business Continuity](sql-database-business-continuity.md) and [Disaster Recovery](sql-database-disaster-recovery.md).</span></span>
3. <span data-ttu-id="cf41c-133">Niezależnego fragmentu albo hello ShardMapManager bazy danych jest tooan przywróconej wcześniej punktu w czasie.</span><span class="sxs-lookup"><span data-stu-id="cf41c-133">Either a shard or hello ShardMapManager database is restored tooan earlier point-in time.</span></span> <span data-ttu-id="cf41c-134">toolearn dotyczące punktu w czasie odzyskiwania przy użyciu kopii zapasowych, zobacz [odzyskiwania za pomocą kopii zapasowej](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="cf41c-134">toolearn about point in time recovery using backups, see [Recovery using backups](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="cf41c-135">Aby uzyskać więcej informacji na temat narzędzi elastycznej bazy danych Azure SQL bazy danych — replikacja geograficzna i przywracania zobacz następujące hello:</span><span class="sxs-lookup"><span data-stu-id="cf41c-135">For more information about Azure SQL Database Elastic Database tools, geo-replication and Restore, see hello following:</span></span> 

* [<span data-ttu-id="cf41c-136">Omówienie: Chmury firm odzyskiwania po awarii ciągłości i bazy danych z bazy danych SQL</span><span class="sxs-lookup"><span data-stu-id="cf41c-136">Overview: Cloud business continuity and database disaster recovery with SQL Database</span></span>](sql-database-business-continuity.md) 
* [<span data-ttu-id="cf41c-137">Wprowadzenie do narzędzi elastycznej bazy danych</span><span class="sxs-lookup"><span data-stu-id="cf41c-137">Get started with elastic database tools</span></span>](sql-database-elastic-scale-get-started.md)  
* [<span data-ttu-id="cf41c-138">Zarządzanie ShardMap</span><span class="sxs-lookup"><span data-stu-id="cf41c-138">ShardMap Management</span></span>](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a><span data-ttu-id="cf41c-139">Pobieranie RecoveryManager z ShardMapManager</span><span class="sxs-lookup"><span data-stu-id="cf41c-139">Retrieving RecoveryManager from a ShardMapManager</span></span>
<span data-ttu-id="cf41c-140">pierwszym krokiem Hello jest toocreate wystąpienia RecoveryManager.</span><span class="sxs-lookup"><span data-stu-id="cf41c-140">hello first step is toocreate a RecoveryManager instance.</span></span> <span data-ttu-id="cf41c-141">Witaj [metody GetRecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) zwraca hello Menedżera odzyskiwania dla bieżącego hello [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) wystąpienia.</span><span class="sxs-lookup"><span data-stu-id="cf41c-141">hello [GetRecoveryManager method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returns hello recovery manager for hello current [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span></span> <span data-ttu-id="cf41c-142">Mapowanie niespójności w niezależnych hello tooaddress, należy najpierw pobrać hello RecoveryManager hello określonego niezależnych mapy.</span><span class="sxs-lookup"><span data-stu-id="cf41c-142">tooaddress any inconsistencies in hello shard map, you must first retrieve hello RecoveryManager for hello particular shard map.</span></span> 

   ```
    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 
   ```

<span data-ttu-id="cf41c-143">W tym przykładzie hello RecoveryManager jest inicjowana z hello ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="cf41c-143">In this example, hello RecoveryManager is initialized from hello ShardMapManager.</span></span> <span data-ttu-id="cf41c-144">Witaj ShardMapManager zawierający ShardMap jest również już zainicjowany.</span><span class="sxs-lookup"><span data-stu-id="cf41c-144">hello ShardMapManager containing a ShardMap is also already initialized.</span></span> 

<span data-ttu-id="cf41c-145">Ponieważ ten kod aplikacji manipuluje hello niezależnego fragmentu mapy, poświadczenia używane w metodzie fabryki hello hello (w hello poprzedzających przykład smmConnectionString) powinna być poświadczenia, które mają uprawnienia odczytu i zapisu w bazie danych GSM hello odwołuje się hello Parametry połączenia.</span><span class="sxs-lookup"><span data-stu-id="cf41c-145">Since this application code manipulates hello shard map itself, hello credentials used in hello factory method (in hello preceding example, smmConnectionString) should be credentials that have read-write permissions on hello GSM database referenced by hello connection string.</span></span> <span data-ttu-id="cf41c-146">Te poświadczenia zwykle różnią się od połączenia tooopen poświadczenia używane do routingu zależne od danych.</span><span class="sxs-lookup"><span data-stu-id="cf41c-146">These credentials are typically different from credentials used tooopen connections for data-dependent routing.</span></span> <span data-ttu-id="cf41c-147">Aby uzyskać więcej informacji, zobacz [powitania klienta elastycznej bazy danych przy użyciu poświadczeń](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="cf41c-147">For more information, see [Using credentials in hello elastic database client](sql-database-elastic-scale-manage-credentials.md).</span></span>

## <a name="removing-a-shard-from-hello-shardmap-after-a-shard-is-deleted"></a><span data-ttu-id="cf41c-148">Usuwanie niezależnych od hello ShardMap po usunięciu niezależnego fragmentu</span><span class="sxs-lookup"><span data-stu-id="cf41c-148">Removing a shard from hello ShardMap after a shard is deleted</span></span>
<span data-ttu-id="cf41c-149">Witaj [DetachShard metoda](https://msdn.microsoft.com/library/azure/dn842083.aspx) odłącza hello podany identyfikator niezależnego fragmentu z mapy niezależnego fragmentu hello i usuwa skojarzone z hello niezależnego fragmentu mapowania.</span><span class="sxs-lookup"><span data-stu-id="cf41c-149">hello [DetachShard method](https://msdn.microsoft.com/library/azure/dn842083.aspx) detaches hello given shard from hello shard map and deletes mappings associated with hello shard.</span></span>  

* <span data-ttu-id="cf41c-150">Parametr lokalizacja Hello jest hello niezależnego fragmentu lokalizacji, w szczególności nazwę serwera i nazwę bazy danych, niezależnych hello odłączany.</span><span class="sxs-lookup"><span data-stu-id="cf41c-150">hello location parameter is hello shard location, specifically server name and database name, of hello shard being detached.</span></span> 
* <span data-ttu-id="cf41c-151">Parametr shardMapName Hello jest nazwa mapy hello niezależnego fragmentu.</span><span class="sxs-lookup"><span data-stu-id="cf41c-151">hello shardMapName parameter is hello shard map name.</span></span> <span data-ttu-id="cf41c-152">Jest to tylko wymagana, gdy wielu map niezależnego fragmentu są zarządzane przez hello samego menedżera mapy niezależnego fragmentu.</span><span class="sxs-lookup"><span data-stu-id="cf41c-152">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="cf41c-153">Opcjonalny.</span><span class="sxs-lookup"><span data-stu-id="cf41c-153">Optional.</span></span> 


> [!IMPORTANT]
> <span data-ttu-id="cf41c-154">Użyj tej techniki tylko wtedy, gdy masz pewność, że zakres hello mapowania hello aktualizacji jest pusty.</span><span class="sxs-lookup"><span data-stu-id="cf41c-154">Use this technique only if you are certain that hello range for hello updated mapping is empty.</span></span> <span data-ttu-id="cf41c-155">metody Hello powyżej sprawdza dane dla zakresu hello przenoszony, dlatego najlepiej jest tooinclude sprawdza w kodzie.</span><span class="sxs-lookup"><span data-stu-id="cf41c-155">hello methods above do not check data for hello range being moved, so it is best tooinclude checks in your code.</span></span>
>

<span data-ttu-id="cf41c-156">W tym przykładzie usuwa hello mapy niezależnych fragmentów.</span><span class="sxs-lookup"><span data-stu-id="cf41c-156">This example removes shards from hello shard map.</span></span> 

   ```
   rm.DetachShard(s.Location, customerMap);
   ``` 

<span data-ttu-id="cf41c-157">mapy niezależnego fragmentu Hello odzwierciedla hello niezależnego fragmentu lokalizacji w hello GSM przed hello usunięcie hello niezależnego fragmentu.</span><span class="sxs-lookup"><span data-stu-id="cf41c-157">hello shard map reflects hello shard location in hello GSM before hello deletion of hello shard.</span></span> <span data-ttu-id="cf41c-158">Ponieważ niezależnych hello został usunięty, zakłada się to było zamierzone i zakresem kluczy hello dzielenia na fragmenty nie jest już używana.</span><span class="sxs-lookup"><span data-stu-id="cf41c-158">Because hello shard was deleted, it is assumed this was intentional, and hello sharding key range is no longer in use.</span></span> <span data-ttu-id="cf41c-159">Jeśli nie możesz wykonać przywracanie do punktu w czasie.</span><span class="sxs-lookup"><span data-stu-id="cf41c-159">If not, you can execute point-in time restore.</span></span> <span data-ttu-id="cf41c-160">toorecover hello niezależnych od wcześniejszej punktu w czasie.</span><span class="sxs-lookup"><span data-stu-id="cf41c-160">toorecover hello shard from an earlier point-in-time.</span></span> <span data-ttu-id="cf41c-161">(W takim przypadku Przejrzyj powitania po niespójności niezależnego fragmentu toodetect sekcji). toorecover, zobacz [punktu w czasie odzyskiwania](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="cf41c-161">(In that case, review hello following section toodetect shard inconsistencies.) toorecover, see [Point in time recovery](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="cf41c-162">Ponieważ zakłada się, że usunięcie bazy danych hello było zamierzone, hello Akcja końcowego oczyszczania administracyjnych jest toodelete hello wpis toohello niezależnych w Menedżerze mapy niezależnego fragmentu hello.</span><span class="sxs-lookup"><span data-stu-id="cf41c-162">Since it is assumed hello database deletion was intentional, hello final administrative cleanup action is toodelete hello entry toohello shard in hello shard map manager.</span></span> <span data-ttu-id="cf41c-163">Zapobiega to aplikacja hello przypadkowo zapisywania informacji tooa zakresu, który nie jest oczekiwany.</span><span class="sxs-lookup"><span data-stu-id="cf41c-163">This prevents hello application from inadvertently writing information tooa range that is not expected.</span></span>

## <a name="toodetect-mapping-differences"></a><span data-ttu-id="cf41c-164">różnice mapowania toodetect</span><span class="sxs-lookup"><span data-stu-id="cf41c-164">toodetect mapping differences</span></span>
<span data-ttu-id="cf41c-165">Witaj [metody DetectMappingDifferences](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) wybiera i zwraca jedną hello niezależnego fragmentu map (lokalnego lub globalnego) jako źródło hello prawdy i uzgadnia mapowanie na obu mapach niezależnego fragmentu (GSM i LSM).</span><span class="sxs-lookup"><span data-stu-id="cf41c-165">hello [DetectMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selects and returns one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   rm.DetectMappingDifferences(location, shardMapName);
   ```

* <span data-ttu-id="cf41c-166">Witaj *lokalizacji* określa hello nazwy serwera i bazy danych.</span><span class="sxs-lookup"><span data-stu-id="cf41c-166">hello *location* specifies hello server name and database name.</span></span> 
* <span data-ttu-id="cf41c-167">Witaj *shardMapName* parametru jest nazwa mapy hello niezależnego fragmentu.</span><span class="sxs-lookup"><span data-stu-id="cf41c-167">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="cf41c-168">Jest to tylko wymagane, jeśli wiele map niezależnego fragmentu są zarządzane przez hello samego menedżera mapy niezależnego fragmentu.</span><span class="sxs-lookup"><span data-stu-id="cf41c-168">This is only required if multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="cf41c-169">Opcjonalny.</span><span class="sxs-lookup"><span data-stu-id="cf41c-169">Optional.</span></span> 

## <a name="tooresolve-mapping-differences"></a><span data-ttu-id="cf41c-170">różnice mapowania tooresolve</span><span class="sxs-lookup"><span data-stu-id="cf41c-170">tooresolve mapping differences</span></span>
<span data-ttu-id="cf41c-171">Witaj [metody ResolveMappingDifferences](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) wybiera jeden hello niezależnego fragmentu map (lokalnego lub globalnego) jako źródło hello prawdy i uzgadnia mapowanie na obu mapach niezależnego fragmentu (GSM i LSM).</span><span class="sxs-lookup"><span data-stu-id="cf41c-171">hello [ResolveMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selects one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   ```

* <span data-ttu-id="cf41c-172">Witaj *RecoveryToken* parametru wylicza hello różnice w mapowaniach hello hello GSM i hello LSM dla określonych niezależnego fragmentu hello.</span><span class="sxs-lookup"><span data-stu-id="cf41c-172">hello *RecoveryToken* parameter enumerates hello differences in hello mappings between hello GSM and hello LSM for hello specific shard.</span></span> 
* <span data-ttu-id="cf41c-173">Witaj [wyliczenie MappingDifferenceResolution](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) jest używane tooindicate hello metody rozpoznawania hello różnica między hello niezależnego fragmentu mapowania.</span><span class="sxs-lookup"><span data-stu-id="cf41c-173">hello [MappingDifferenceResolution enumeration](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) is used tooindicate hello method for resolving hello difference between hello shard mappings.</span></span> 
* <span data-ttu-id="cf41c-174">**MappingDifferenceResolution.KeepShardMapping** zalecane jest podczas hello LSM zawiera hello mapowanie dokładne i w związku z tym mapowanie hello w niezależnych hello powinna być używana.</span><span class="sxs-lookup"><span data-stu-id="cf41c-174">**MappingDifferenceResolution.KeepShardMapping** is recommended that when hello LSM contains hello accurate mapping and therefore hello mapping in hello shard should be used.</span></span> <span data-ttu-id="cf41c-175">Dotyczy to zwykle hello jest trybu failover: hello niezależnych znajduje się teraz na nowym serwerze.</span><span class="sxs-lookup"><span data-stu-id="cf41c-175">This is typically hello case if there is a failover: hello shard now resides on a new server.</span></span> <span data-ttu-id="cf41c-176">Ponieważ najpierw należy usunąć niezależnych hello hello GSM (przy użyciu metody RecoveryManager.DetachShard hello), mapowanie już nie istnieje na powitania GSM.</span><span class="sxs-lookup"><span data-stu-id="cf41c-176">Since hello shard must first be removed from hello GSM (using hello RecoveryManager.DetachShard method), a mapping no longer exists on hello GSM.</span></span> <span data-ttu-id="cf41c-177">W związku z tym hello LSM musi być używane toore-ustanowić hello niezależnego fragmentu mapowania.</span><span class="sxs-lookup"><span data-stu-id="cf41c-177">Therefore, hello LSM must be used toore-establish hello shard mapping.</span></span>

## <a name="attach-a-shard-toohello-shardmap-after-a-shard-is-restored"></a><span data-ttu-id="cf41c-178">Dołącz toohello niezależnego fragmentu ShardMap po przywróceniu niezależnego fragmentu</span><span class="sxs-lookup"><span data-stu-id="cf41c-178">Attach a shard toohello ShardMap after a shard is restored</span></span>
<span data-ttu-id="cf41c-179">Witaj [metody AttachShard](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) dołącza hello danego niezależnych toohello niezależnego fragmentu mapy.</span><span class="sxs-lookup"><span data-stu-id="cf41c-179">hello [AttachShard method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attaches hello given shard toohello shard map.</span></span> <span data-ttu-id="cf41c-180">Następnie wykrycia niespójności mapy niezależnego fragmentu i aktualizuje niezależnego fragmentu hello toomatch mapowania hello w punkcie hello hello niezależnego fragmentu przywracania.</span><span class="sxs-lookup"><span data-stu-id="cf41c-180">It then detects any shard map inconsistencies and updates hello mappings toomatch hello shard at hello point of hello shard restoration.</span></span> <span data-ttu-id="cf41c-181">Przyjęto, tej bazy danych hello jest również tooreflect zmieniono nazwę hello oryginalna nazwa bazy danych (przed niezależnych hello została przywrócona), ponieważ hello punktu w czasie przywracania domyślne nową bazę danych tooa dołączony hello sygnatury czasowej.</span><span class="sxs-lookup"><span data-stu-id="cf41c-181">It is assumed that hello database is also renamed tooreflect hello original database name (before hello shard was restored), since hello point-in time restoration defaults tooa new database appended with hello timestamp.</span></span> 

   ```
   rm.AttachShard(location, shardMapName)
   ``` 

* <span data-ttu-id="cf41c-182">Witaj *lokalizacji* parametr jest hello nazwę serwera i nazwę bazy danych, niezależnych hello dołączony.</span><span class="sxs-lookup"><span data-stu-id="cf41c-182">hello *location* parameter is hello server name and database name, of hello shard being attached.</span></span> 
* <span data-ttu-id="cf41c-183">Witaj *shardMapName* parametru jest nazwa mapy hello niezależnego fragmentu.</span><span class="sxs-lookup"><span data-stu-id="cf41c-183">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="cf41c-184">Jest to tylko wymagana, gdy wielu map niezależnego fragmentu są zarządzane przez hello samego menedżera mapy niezależnego fragmentu.</span><span class="sxs-lookup"><span data-stu-id="cf41c-184">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="cf41c-185">Opcjonalny.</span><span class="sxs-lookup"><span data-stu-id="cf41c-185">Optional.</span></span> 

<span data-ttu-id="cf41c-186">W tym przykładzie dodaje niezależnego fragmentu mapy niezależnego fragmentu toohello przywrócono ostatnio z wcześniejszego punktu w stanu.</span><span class="sxs-lookup"><span data-stu-id="cf41c-186">This example adds a shard toohello shard map that has been recently restored from an earlier point-in time.</span></span> <span data-ttu-id="cf41c-187">Ponieważ hello niezależnego fragmentu (to znaczy hello mapowanie niezależnych hello w hello LSM) została przywrócona, jest potencjalnie niezgodnych z wpisu niezależnego fragmentu hello hello GSM.</span><span class="sxs-lookup"><span data-stu-id="cf41c-187">Since hello shard (namely hello mapping for hello shard in hello LSM) has been restored, it is potentially inconsistent with hello shard entry in hello GSM.</span></span> <span data-ttu-id="cf41c-188">Poza tym przykładowy kod niezależnych hello została przywrócona i zmieniono jego nazwę oryginalną nazwę toohello hello bazy danych.</span><span class="sxs-lookup"><span data-stu-id="cf41c-188">Outside of this example code, hello shard was restored and renamed toohello original name of hello database.</span></span> <span data-ttu-id="cf41c-189">Ponieważ został przywrócony, zakłada się mapowanie hello w hello LSM jest hello zaufanych mapowania.</span><span class="sxs-lookup"><span data-stu-id="cf41c-189">Since it was restored, it is assumed hello mapping in hello LSM is hello trusted mapping.</span></span> 

   ```
   rm.AttachShard(s.Location, customerMap); 
   var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 
   ```

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-hello-shards"></a><span data-ttu-id="cf41c-190">Trwa aktualizowanie lokalizacji niezależnego fragmentu po przełączeniu geograficznie (przywracanie) odłamków hello</span><span class="sxs-lookup"><span data-stu-id="cf41c-190">Updating shard locations after a geo-failover (restore) of hello shards</span></span>
<span data-ttu-id="cf41c-191">W przypadku awarię geograficznie hello dodatkowej bazy danych jest udostępniane zapisu i staje się hello nowe podstawowej bazy danych.</span><span class="sxs-lookup"><span data-stu-id="cf41c-191">If there is a geo-failover, hello secondary database is made write accessible and becomes hello new primary database.</span></span> <span data-ttu-id="cf41c-192">Witaj nazwy serwera hello i potencjalnie bazy danych hello (w zależności od konfiguracji), może być inny niż oryginalny podstawowy hello.</span><span class="sxs-lookup"><span data-stu-id="cf41c-192">hello name of hello server, and potentially hello database (depending on your configuration), may be different from hello original primary.</span></span> <span data-ttu-id="cf41c-193">W związku z tym hello wpisów mapowania dla niezależnych hello w hello GSM i LSM musi być stałą.</span><span class="sxs-lookup"><span data-stu-id="cf41c-193">Therefore hello mapping entries for hello shard in hello GSM and LSM must be fixed.</span></span> <span data-ttu-id="cf41c-194">Podobnie jeśli hello bazy danych jest przywracane tooa inną nazwę lub lokalizację lub tooan wcześniejszego punktu w czasie, może to spowodować niespójności w hello niezależnego fragmentu mapowania.</span><span class="sxs-lookup"><span data-stu-id="cf41c-194">Similarly, if hello database is restored tooa different name or location, or tooan earlier point in time, this might cause inconsistencies in hello shard maps.</span></span> <span data-ttu-id="cf41c-195">Hello niezależnego fragmentu mapy Manager obsługuje dystrybucji hello otwarte połączenia toohello poprawną bazą danych.</span><span class="sxs-lookup"><span data-stu-id="cf41c-195">hello Shard Map Manager handles hello distribution of open connections toohello correct database.</span></span> <span data-ttu-id="cf41c-196">Dystrybucji są oparte na danych hello mapy niezależnego fragmentu hello i wartość hello hello dzielenia na fragmenty klucza, który jest elementem docelowym hello żądania aplikacji hello.</span><span class="sxs-lookup"><span data-stu-id="cf41c-196">Distribution is based on hello data in hello shard map and hello value of hello sharding key that is hello target of hello applications request.</span></span> <span data-ttu-id="cf41c-197">Po przełączeniu geograficznie te informacje muszą zostać zaktualizowane nazwy serwera dokładne hello, nazwy bazy danych oraz mapowanie niezależnych hello odzyskanej bazy danych.</span><span class="sxs-lookup"><span data-stu-id="cf41c-197">After a geo-failover, this information must be updated with hello accurate server name, database name and shard mapping of hello recovered database.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="cf41c-198">Najlepsze praktyki</span><span class="sxs-lookup"><span data-stu-id="cf41c-198">Best practices</span></span>
<span data-ttu-id="cf41c-199">Geograficznie pracy w trybie failover i odzyskiwania są operacje zazwyczaj zarządza administrator chmury aplikacji hello celowo przy użyciu jednej z funkcjach ciągłości biznesowej baz danych SQL Azure.</span><span class="sxs-lookup"><span data-stu-id="cf41c-199">Geo-failover and recovery are operations typically managed by a cloud administrator of hello application intentionally utilizing one of Azure SQL Databases business continuity features.</span></span> <span data-ttu-id="cf41c-200">Planowanie ciągłości biznesowej wymaga procesów, procedury i środki tooensure, że operacje biznesowe można nadal bez przeszkód.</span><span class="sxs-lookup"><span data-stu-id="cf41c-200">Business continuity planning requires processes, procedures, and measures tooensure that business operations can continue without interruption.</span></span> <span data-ttu-id="cf41c-201">Witaj metody dostępne jako część hello klasy RecoveryManager powinien być używany w tym hello tooensure przepływu pracy GSM i LSM są aktualizowane oparte na powitania odzyskiwania działania podjęte.</span><span class="sxs-lookup"><span data-stu-id="cf41c-201">hello methods available as part of hello RecoveryManager class should be used within this work flow tooensure hello GSM and LSM are kept up-to-date based on hello recovery action taken.</span></span> <span data-ttu-id="cf41c-202">Istnieje pięć podstawowych kroków tooproperly zapewnienie hello GSM i LSM odzwierciedlają hello dokładnych informacji po wystąpieniu zdarzenia pracy awaryjnej.</span><span class="sxs-lookup"><span data-stu-id="cf41c-202">There are five basic steps tooproperly ensuring hello GSM and LSM reflect hello accurate information after a failover event.</span></span> <span data-ttu-id="cf41c-203">Witaj tooexecute kodu aplikacji, które tych kroków można zintegrować istniejących narzędzi i przepływ pracy.</span><span class="sxs-lookup"><span data-stu-id="cf41c-203">hello application code tooexecute these steps can be integrated into existing tools and workflow.</span></span> 

1. <span data-ttu-id="cf41c-204">Pobrać hello RecoveryManager z hello ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="cf41c-204">Retrieve hello RecoveryManager from hello ShardMapManager.</span></span> 
2. <span data-ttu-id="cf41c-205">Odłączyć hello starego niezależnego fragmentu z hello niezależnego fragmentu mapy.</span><span class="sxs-lookup"><span data-stu-id="cf41c-205">Detach hello old shard from hello shard map.</span></span>
3. <span data-ttu-id="cf41c-206">Dołącz hello nowy identyfikator niezależnego fragmentu toohello niezależnego fragmentu mapy, w tym hello nowej lokalizacji niezależnego fragmentu.</span><span class="sxs-lookup"><span data-stu-id="cf41c-206">Attach hello new shard toohello shard map, including hello new shard location.</span></span>
4. <span data-ttu-id="cf41c-207">Wykrył niespójności w hello mapowanie między hello GSM i LSM.</span><span class="sxs-lookup"><span data-stu-id="cf41c-207">Detect inconsistencies in hello mapping between hello GSM and LSM.</span></span> 
5. <span data-ttu-id="cf41c-208">Rozwiąż problemy dotyczące różnic między hello GSM i hello LSM, ufających hello LSM.</span><span class="sxs-lookup"><span data-stu-id="cf41c-208">Resolve differences between hello GSM and hello LSM, trusting hello LSM.</span></span> 

<span data-ttu-id="cf41c-209">W tym przykładzie przeprowadza hello następujące kroki:</span><span class="sxs-lookup"><span data-stu-id="cf41c-209">This example performs hello following steps:</span></span>

1. <span data-ttu-id="cf41c-210">Usuwa odłamków z hello mapy niezależnego fragmentu odzwierciedlenia lokalizacji niezależnego fragmentu przed hello zdarzenia pracy awaryjnej.</span><span class="sxs-lookup"><span data-stu-id="cf41c-210">Removes shards from hello Shard Map that reflect shard locations before hello failover event.</span></span>
2. <span data-ttu-id="cf41c-211">Dołącza odłamków toohello mapy niezależnego fragmentu odbicia hello nowych niezależnego fragmentu lokalizacji (parametr hello "Configuration.SecondaryServer" jest hello nowej nazwy serwera, ale hello same Nazwa bazy danych).</span><span class="sxs-lookup"><span data-stu-id="cf41c-211">Attaches shards toohello Shard Map reflecting hello new shard locations (hello parameter "Configuration.SecondaryServer" is hello new server name but hello same database name).</span></span>
3. <span data-ttu-id="cf41c-212">Pobiera tokeny odzyskiwania hello przez wykrywania różnic mapowania między hello GSM i hello LSM dla każdego niezależnego fragmentu.</span><span class="sxs-lookup"><span data-stu-id="cf41c-212">Retrieves hello recovery tokens by detecting mapping differences between hello GSM and hello LSM for each shard.</span></span> 
4. <span data-ttu-id="cf41c-213">Rozpoznaje niespójności hello ufających mapowanie hello z hello LSM każdego niezależnego fragmentu.</span><span class="sxs-lookup"><span data-stu-id="cf41c-213">Resolves hello inconsistencies by trusting hello mapping from hello LSM of each shard.</span></span> 
   
   ```
   var shards = smm.GetShards(); 
   foreach (shard s in shards) 
   { 
     if (s.Location.Server == Configuration.PrimaryServer) 
   
         { 
          ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database); 
   
          rm.DetachShard(s.Location); 
   
          rm.AttachShard(slNew); 
   
          var gs = rm.DetectMappingDifferences(slNew); 
   
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 
   ```

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png

