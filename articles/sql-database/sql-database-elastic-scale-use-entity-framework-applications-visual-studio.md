---
title: aaaUsing biblioteki klienta elastycznej bazy danych z programu Entity Framework | Dokumentacja firmy Microsoft
description: "Użyj kodowania bazy danych biblioteki klienta elastycznej bazy danych i strukturą Entity Framework"
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
editor: 
ms.assetid: b9c3065b-cb92-41be-aa7f-deba23e7e159
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/06/2017
ms.author: torsteng
ms.openlocfilehash: 917f6d28d9855c0b42afe2c008613a9bbb3ec6b6
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 10/06/2017
---
# <a name="elastic-database-client-library-with-entity-framework"></a><span data-ttu-id="9c9b7-103">Biblioteka klienta usługi elastycznej bazy danych z programu Entity Framework</span><span class="sxs-lookup"><span data-stu-id="9c9b7-103">Elastic Database client library with Entity Framework</span></span>
<span data-ttu-id="9c9b7-104">Ten dokument zawiera hello zmian w aplikacji programu Entity Framework, które są potrzebne toointegrate z hello [narzędzi elastycznej bazy danych](sql-database-elastic-scale-introduction.md).</span><span class="sxs-lookup"><span data-stu-id="9c9b7-104">This document shows hello changes in an Entity Framework application that are needed toointegrate with hello [Elastic Database tools](sql-database-elastic-scale-introduction.md).</span></span> <span data-ttu-id="9c9b7-105">Witaj koncentruje się na tworzenie [zarządzania mapy niezależnego fragmentu](sql-database-elastic-scale-shard-map-management.md) i [routingu zależne od danych](sql-database-elastic-scale-data-dependent-routing.md) z hello Entity Framework **Code First** podejście.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-105">hello focus is on composing [shard map management](sql-database-elastic-scale-shard-map-management.md) and [data-dependent routing](sql-database-elastic-scale-data-dependent-routing.md) with hello Entity Framework **Code First** approach.</span></span> <span data-ttu-id="9c9b7-106">Witaj [najpierw - Code nową bazę danych](http://msdn.microsoft.com/data/jj193542.aspx) samouczek dotyczący EF służy jako naszym przykładzie uruchomionych w tym dokumencie.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-106">hello [Code First - New Database](http://msdn.microsoft.com/data/jj193542.aspx) tutorial for EF serves as our running example throughout this document.</span></span> <span data-ttu-id="9c9b7-107">Hello przykładowy kod towarzyszące ten dokument jest częścią narzędzi elastycznej bazy danych, ustaw próbek w hello przykłady kodu w usłudze Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-107">hello sample code accompanying this document is part of elastic database tools' set of samples in hello Visual Studio Code Samples.</span></span>

## <a name="downloading-and-running-hello-sample-code"></a><span data-ttu-id="9c9b7-108">Pobieranie i uruchamianie hello przykładowy kod</span><span class="sxs-lookup"><span data-stu-id="9c9b7-108">Downloading and Running hello Sample Code</span></span>
<span data-ttu-id="9c9b7-109">Kod hello toodownload tego artykułu:</span><span class="sxs-lookup"><span data-stu-id="9c9b7-109">toodownload hello code for this article:</span></span>

* <span data-ttu-id="9c9b7-110">Visual Studio 2012 lub nowszy jest wymagany.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-110">Visual Studio 2012 or later is required.</span></span> 
* <span data-ttu-id="9c9b7-111">Pobierz hello [elastyczne narzędzia bazy danych dla bazy danych SQL Azure — przykładowy Entity Framework integracji](https://code.msdn.microsoft.com/windowsapps/Elastic-Scale-with-Azure-bae904ba) w witrynie MSDN.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-111">Download hello [Elastic DB Tools for Azure SQL - Entity Framework Integration sample](https://code.msdn.microsoft.com/windowsapps/Elastic-Scale-with-Azure-bae904ba) from MSDN.</span></span> <span data-ttu-id="9c9b7-112">Rozpakuj hello próbki tooa lokalizacji wybrane.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-112">Unzip hello sample tooa location of your choosing.</span></span>
* <span data-ttu-id="9c9b7-113">Uruchom program Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-113">Start Visual Studio.</span></span> 
* <span data-ttu-id="9c9b7-114">W programie Visual Studio wybierz Plik -> Otwórz projekt/rozwiązanie.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-114">In Visual Studio, select File -> Open Project/Solution.</span></span> 
* <span data-ttu-id="9c9b7-115">W hello **Otwórz projekt** okna dialogowego, przejdź do przykładowej toohello został pobrany i wybierz **EntityFrameworkCodeFirst.sln** tooopen hello próbki.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-115">In hello **Open Project** dialog, navigate toohello sample you downloaded and select **EntityFrameworkCodeFirst.sln** tooopen hello sample.</span></span> 

<span data-ttu-id="9c9b7-116">toorun hello próbki, należy toocreate trzy pusty bazy danych w bazie danych SQL Azure:</span><span class="sxs-lookup"><span data-stu-id="9c9b7-116">toorun hello sample, you need toocreate three empty databases in Azure SQL Database:</span></span>

* <span data-ttu-id="9c9b7-117">Bazy danych Menedżera Map niezależnego fragmentu</span><span class="sxs-lookup"><span data-stu-id="9c9b7-117">Shard Map Manager database</span></span>
* <span data-ttu-id="9c9b7-118">1 niezależnego fragmentu bazy danych</span><span class="sxs-lookup"><span data-stu-id="9c9b7-118">Shard 1 database</span></span>
* <span data-ttu-id="9c9b7-119">2 niezależnego fragmentu bazy danych</span><span class="sxs-lookup"><span data-stu-id="9c9b7-119">Shard 2 database</span></span>

<span data-ttu-id="9c9b7-120">Po utworzeniu tych baz danych, wypełnij hello symbole zastępcze w **Program.cs** o nazwę serwera bazy danych SQL Azure, hello nazwy bazy danych i baz danych toohello tooconnect poświadczeń.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-120">Once you have created these databases, fill in hello place holders in **Program.cs** with your Azure SQL DB server name, hello database names and your credentials tooconnect toohello databases.</span></span> <span data-ttu-id="9c9b7-121">Utworzenie rozwiązania hello w programie Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-121">Build hello solution in Visual Studio.</span></span> <span data-ttu-id="9c9b7-122">Program Visual Studio pobierze hello wymaganych pakietów NuGet dla biblioteki klienta elastycznej bazy danych hello, Entity Framework i obsługa jako część procesu kompilacji hello wystąpienia błędu przejściowego.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-122">Visual Studio will download hello required NuGet packages for hello elastic database client library, Entity Framework, and Transient Fault handling as part of hello build process.</span></span> <span data-ttu-id="9c9b7-123">Upewnij się, że trwa przywracanie pakietów NuGet jest włączona dla rozwiązania.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-123">Make sure that restoring NuGet packages is enabled for your solution.</span></span> <span data-ttu-id="9c9b7-124">To ustawienie zostanie włączone, klikając prawym przyciskiem myszy plik rozwiązania hello w hello Visual Studio Solution Explorer.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-124">You can enable this setting by right-clicking on hello solution file in hello Visual Studio Solution Explorer.</span></span> 

## <a name="entity-framework-workflows"></a><span data-ttu-id="9c9b7-125">Przepływy pracy programu Entity Framework</span><span class="sxs-lookup"><span data-stu-id="9c9b7-125">Entity Framework workflows</span></span>
<span data-ttu-id="9c9b7-126">Entity Framework deweloperzy polegać na jednym z czterech aplikacji toobuild przepływów pracy i tooensure trwałości dla obiektów aplikacji hello:</span><span class="sxs-lookup"><span data-stu-id="9c9b7-126">Entity Framework developers rely on one of hello following four workflows toobuild applications and tooensure persistence for application objects:</span></span> 

* <span data-ttu-id="9c9b7-127">**Code First (Nowa baza danych)**: hello EF developer tworzy hello model w kodzie aplikacji hello, a następnie EF generuje hello bazy danych z niego.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-127">**Code First (New Database)**: hello EF developer creates hello model in hello application code and then EF generates hello database from it.</span></span> 
* <span data-ttu-id="9c9b7-128">**Code First (istniejącej bazy danych)**: hello developer umożliwia EF generowanie kodu aplikacji hello modelu hello na podstawie istniejącej bazy danych.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-128">**Code First (Existing Database)**: hello developer lets EF generate hello application code for hello model from an existing database.</span></span>
* <span data-ttu-id="9c9b7-129">**Model pierwszy**: hello developer tworzy hello model hello EF Designer, a następnie EF tworzy hello bazy danych z modelu hello.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-129">**Model First**: hello developer creates hello model in hello EF designer and then EF creates hello database from hello model.</span></span>
* <span data-ttu-id="9c9b7-130">**Baza danych pierwszej**: hello deweloperów używa EF narzędzi tooinfer hello modelu z istniejącej bazy danych.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-130">**Database First**: hello developer uses EF tooling tooinfer hello model from an existing database.</span></span> 

<span data-ttu-id="9c9b7-131">Zarządzanie wszystkich tych sposobów polegać na tootransparently klasy DbContext hello połączenia bazy danych i schemat bazy danych dla aplikacji.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-131">All these approaches rely on hello DbContext class tootransparently manage database connections and database schema for an application.</span></span> <span data-ttu-id="9c9b7-132">Jak będzie omówiono bardziej szczegółowo w dalszej części dokumentu hello różnych konstruktorów w klasie podstawowej DbContext hello pozwolić na różne poziomy kontroli nad utworzenia połączenia bazy danych tworzenia uruchamianie i schematu.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-132">As we will discuss in more detail later in hello document, different constructors on hello DbContext base class allow for different levels of control over connection creation, database bootstrapping and schema creation.</span></span> <span data-ttu-id="9c9b7-133">Wyzwania wynikają głównie z hello fakt, że zarządzanie połączenia bazy danych hello zapewniane przez EF przecina z możliwościami zarządzania połączenia hello hello danych zależnych interfejsów routingu podane przez biblioteki klienta elastycznej bazy danych hello.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-133">Challenges arise primarily from hello fact that hello database connection management provided by EF intersects with hello connection management capabilities of hello data dependent routing interfaces provided by hello elastic database client library.</span></span> 

## <a name="elastic-database-tools-assumptions"></a><span data-ttu-id="9c9b7-134">Założenia narzędzi elastycznej bazy danych</span><span class="sxs-lookup"><span data-stu-id="9c9b7-134">Elastic database tools assumptions</span></span>
<span data-ttu-id="9c9b7-135">Aby uzyskać definicje terminów, zobacz [słownik narzędzi elastycznej bazy danych](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="9c9b7-135">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span>

<span data-ttu-id="9c9b7-136">Z biblioteki klienta elastycznej bazy danych należy zdefiniować partycji o nazwie shardlets danych aplikacji.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-136">With elastic database client library, you define partitions of your application data called shardlets.</span></span> <span data-ttu-id="9c9b7-137">Shardlets są identyfikowane za pomocą klucza dzielenia na fragmenty i są mapowane toospecific baz danych.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-137">Shardlets are identified by a sharding key and are mapped toospecific databases.</span></span> <span data-ttu-id="9c9b7-138">Aplikacja może mieć dowolną liczbę baz danych, zgodnie z potrzebami i dystrybuować hello shardlets tooprovide pojemności lub wydajności danego bieżące wymagania biznesowe.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-138">An application may have as many databases as needed and distribute hello shardlets tooprovide enough capacity or performance given current business requirements.</span></span> <span data-ttu-id="9c9b7-139">Mapowanie Hello baz danych toohello wartości klucza dzielenia na fragmenty są przechowywane przez mapy niezależnego fragmentu podana przez klienta elastycznej bazy danych hello interfejsów API.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-139">hello mapping of sharding key values toohello databases is stored by a shard map provided by hello elastic database client APIs.</span></span> <span data-ttu-id="9c9b7-140">Nazywamy tej możliwości **zarządzania mapy niezależnego fragmentu**, lub SMM skrócie.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-140">We call this capability **Shard Map Management**, or SMM for short.</span></span> <span data-ttu-id="9c9b7-141">Mapa niezależnego fragmentu Hello służy również jako hello brokera połączeń z bazą danych dla żądań zawierających klucz dzielenia na fragmenty.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-141">hello shard map also serves as hello broker of database connections for requests that carry a sharding key.</span></span> <span data-ttu-id="9c9b7-142">Firma Microsoft można znaleźć możliwości toothis jako **routingu zależne od danych**.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-142">We refer toothis capability as **data-dependent routing**.</span></span> 

<span data-ttu-id="9c9b7-143">Menedżera map niezależnego fragmentu Hello chroni użytkowników z widoków niespójne w shardlet dane, które mogą wystąpić, gdy są wykonywane operacje zarządzania równoczesnych shardlet (takich jak przemieszczenie dane z jednego niezależnego fragmentu tooanother).</span><span class="sxs-lookup"><span data-stu-id="9c9b7-143">hello shard map manager protects users from inconsistent views into shardlet data that can occur when concurrent shardlet management operations (such as relocating data from one shard tooanother) are happening.</span></span> <span data-ttu-id="9c9b7-144">toodo Witaj, mapy niezależnego fragmentu zarządza powitania klienta biblioteki brokera hello połączenia bazy danych dla aplikacji.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-144">toodo so, hello shard maps managed by hello client library broker hello database connections for an application.</span></span> <span data-ttu-id="9c9b7-145">Dzięki temu hello niezależnego fragmentu mapy funkcji tooautomatically kill połączenia z bazą danych podczas operacji zarządzania niezależnego fragmentu może mieć wpływ na shardlet hello, utworzony hello połączenia dla.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-145">This allows hello shard map functionality tooautomatically kill a database connection when shard management operations could impact hello shardlet that hello connection has been created for.</span></span> <span data-ttu-id="9c9b7-146">Ta metoda musi toointegrate z niektórych funkcji EF firmy, takich jak tworzenie nowych połączeń z istniejących toocheck jeden istnienie bazy danych.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-146">This approach needs toointegrate with some of EF’s functionality, such as creating new connections from an existing one toocheck for database existence.</span></span> <span data-ttu-id="9c9b7-147">Ogólnie rzecz biorąc, naszych obserwacji została czy hello standardowe konstruktory DbContext tylko działają niezawodnie połączeniach zamkniętego bazy danych, które można bezpiecznie sklonować EF pracy.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-147">In general, our observation has been that hello standard DbContext constructors only work reliably for closed database connections that can safely be cloned for EF work.</span></span> <span data-ttu-id="9c9b7-148">Zasada projektowania Hello elastycznej bazy danych zamiast tego jest tooonly brokera otwarte połączenia.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-148">hello design principle of elastic database instead is tooonly broker opened connections.</span></span> <span data-ttu-id="9c9b7-149">Jeden wydaje się, że zamknięcie połączenia przeprowadzana przez bibliotekę klienta hello przed przekazaniem ich toohello EF DbContext może rozwiązać ten problem.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-149">One might think that closing a connection brokered by hello client library before handing it over toohello EF DbContext may solve this issue.</span></span> <span data-ttu-id="9c9b7-150">Jednak zamykanie połączenia hello i polegania na otwieranie toore EF, jeden foregoes hello sprawdzania poprawności i sprawdzanie spójności z zastosowaniem biblioteki hello.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-150">However, by closing hello connection and relying on EF toore-open it, one foregoes hello validation and consistency checks performed by hello library.</span></span> <span data-ttu-id="9c9b7-151">Funkcja migracji Hello w EF, jednak wykorzystuje te hello toomanage połączeń podstawowy schemat bazy danych w sposób przezroczysty toohello aplikacji.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-151">hello migrations functionality in EF, however, uses these connections toomanage hello underlying database schema in a way that is transparent toohello application.</span></span> <span data-ttu-id="9c9b7-152">Firma Microsoft najlepiej, jeśli chcesz tooretain i połączyć wszystkie te funkcje z biblioteki klienta elastycznej bazy danych hello i EF w hello tej samej aplikacji.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-152">Ideally, we would like tooretain and combine all these capabilities from both hello elastic database client library and EF in hello same application.</span></span> <span data-ttu-id="9c9b7-153">Witaj następujących sekcji omówiono te właściwości i wymagania bardziej szczegółowo.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-153">hello following section discusses these properties and requirements in more detail.</span></span> 

## <a name="requirements"></a><span data-ttu-id="9c9b7-154">Wymagania</span><span class="sxs-lookup"><span data-stu-id="9c9b7-154">Requirements</span></span>
<span data-ttu-id="9c9b7-155">Podczas pracy z biblioteki klienta elastycznej bazy danych hello i interfejsy API programu Entity Framework, chcemy hello tooretain następujące właściwości:</span><span class="sxs-lookup"><span data-stu-id="9c9b7-155">When working with both hello elastic database client library and Entity Framework APIs, we want tooretain hello following properties:</span></span> 

* <span data-ttu-id="9c9b7-156">**Skalowalny w poziomie**: tooadd lub usuń baz danych z warstwy danych hello podzielonej aplikacji hello odpowiednio do potrzeb pojemności hello aplikacji hello.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-156">**Scale-out**: tooadd or remove databases from hello data tier of hello sharded application as necessary for hello capacity demands of hello application.</span></span> <span data-ttu-id="9c9b7-157">Oznacza to, kontrolę nad hello hello tworzenie i usuwanie baz danych i przy użyciu hello elastycznej bazy danych niezależnych Mapa Menedżera interfejsów API toomanage baz danych i mapowania shardlets.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-157">This means control over hello hello creation and deletion of databases and using hello elastic database shard map manager APIs toomanage databases, and mappings of shardlets.</span></span> 
* <span data-ttu-id="9c9b7-158">**Spójność**: dzielenia na fragmenty zatrudnia aplikacji hello i używa hello zależne funkcje routingu danych powitania klienta biblioteki.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-158">**Consistency**: hello application employs sharding, and uses hello data dependent routing capabilities of hello client library.</span></span> <span data-ttu-id="9c9b7-159">uszkodzenie tooavoid lub wyników zapytania niewłaściwy połączenia jest przeprowadzana za pośrednictwem Menedżera map hello niezależnego fragmentu.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-159">tooavoid corruption or wrong query results, connections are brokered through hello shard map manager.</span></span> <span data-ttu-id="9c9b7-160">Zachowuje również sprawdzania poprawności i spójność.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-160">This also retains validation and consistency.</span></span>
* <span data-ttu-id="9c9b7-161">**"Code First"**: tooretain wygodę hello EF przez kod pierwszego modelu.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-161">**Code First**: tooretain hello convenience of EF’s code first paradigm.</span></span> <span data-ttu-id="9c9b7-162">W pierwszym kodu klas w aplikacji hello są mapowane w sposób niewidoczny dla użytkownika toohello podstawowej struktury bazy danych.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-162">In Code First, classes in hello application are mapped transparently toohello underlying database structures.</span></span> <span data-ttu-id="9c9b7-163">Kod aplikacji Hello współdziała z DbSets, który zamaskować większości aspektów związanych hello bazowy przetwarzanie bazy danych.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-163">hello application code interacts with DbSets that mask most aspects involved in hello underlying database processing.</span></span>
* <span data-ttu-id="9c9b7-164">**Schemat**: Entity Framework obsługuje tworzenie schematu bazy danych początkowej i kolejnych schematu zmiany za pomocą migracji.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-164">**Schema**: Entity Framework handles initial database schema creation and subsequent schema evolution through migrations.</span></span> <span data-ttu-id="9c9b7-165">Zachowując te możliwości dostosowywania aplikacji jest łatwe jak powitalne rozwoju danych.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-165">By retaining these capabilities, adapting your app is easy as hello data evolves.</span></span> 

<span data-ttu-id="9c9b7-166">Witaj poniższe wskazówki nakazuje jak toosatisfy tych wymagań Code First aplikacji za pomocą narzędzi elastycznej bazy danych.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-166">hello following guidance instructs how toosatisfy these requirements for Code First applications using elastic database tools.</span></span> 

## <a name="data-dependent-routing-using-ef-dbcontext"></a><span data-ttu-id="9c9b7-167">Dane zależne routingu przy użyciu EF DbContext</span><span class="sxs-lookup"><span data-stu-id="9c9b7-167">Data dependent routing using EF DbContext</span></span>
<span data-ttu-id="9c9b7-168">Połączenia bazy danych z programu Entity Framework zwykle są zarządzane przez podklasy **DbContext**.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-168">Database connections with Entity Framework are typically managed through subclasses of **DbContext**.</span></span> <span data-ttu-id="9c9b7-169">Utworzyć te podklasy pochodny **DbContext**.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-169">Create these subclasses by deriving from **DbContext**.</span></span> <span data-ttu-id="9c9b7-170">Jest to, gdzie został zdefiniowany z **DbSets** implementują hello kopii bazy danych kolekcji obiektów CLR dla aplikacji.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-170">This is where you define your **DbSets** that implement hello database-backed collections of CLR objects for your application.</span></span> <span data-ttu-id="9c9b7-171">W kontekście hello danych zależnych routingu umożliwi nam poznanie kilka właściwości pomocne, które nie posiadają niekoniecznie dla innych pierwszy scenariuszy aplikacji EF kodu:</span><span class="sxs-lookup"><span data-stu-id="9c9b7-171">In hello context of data dependent routing, we can identify several helpful properties that do not necessarily hold for other EF code first application scenarios:</span></span> 

* <span data-ttu-id="9c9b7-172">Witaj bazy danych już istnieje i został zarejestrowany w mapie niezależnego fragmentu elastycznej bazy danych hello.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-172">hello database already exists and has been registered in hello elastic database shard map.</span></span> 
* <span data-ttu-id="9c9b7-173">Hello schematu aplikacji hello został już wdrożony toohello bazy danych (co omówiono poniżej).</span><span class="sxs-lookup"><span data-stu-id="9c9b7-173">hello schema of hello application has already been deployed toohello database (explained below).</span></span> 
* <span data-ttu-id="9c9b7-174">Zależne od danych routingu połączeń toohello w bazie danych są obsługiwane przez brokera przez hello niezależnego fragmentu mapy.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-174">Data-dependent routing connections toohello database are brokered by hello shard map.</span></span> 

<span data-ttu-id="9c9b7-175">toointegrate **DbContexts** zależne od danych routingu dla skalowalnego w poziomie:</span><span class="sxs-lookup"><span data-stu-id="9c9b7-175">toointegrate **DbContexts** with data-dependent routing for scale-out:</span></span>

1. <span data-ttu-id="9c9b7-176">Utwórz połączenia fizycznej bazy danych za pośrednictwem interfejsów klienta elastycznej bazy danych hello Menedżera mapy niezależnego fragmentu hello,</span><span class="sxs-lookup"><span data-stu-id="9c9b7-176">Create physical database connections through hello elastic database client interfaces of hello shard map manager,</span></span> 
2. <span data-ttu-id="9c9b7-177">Zawijaj hello połączenia z hello **DbContext** podklasy</span><span class="sxs-lookup"><span data-stu-id="9c9b7-177">Wrap hello connection with hello **DbContext** subclass</span></span>
3. <span data-ttu-id="9c9b7-178">Przekaż hello połączenia w dół do hello **DbContext** hello przetwarzania po stronie EF hello się stanie, a także tooensure klasy podstawowej.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-178">Pass hello connection down into hello **DbContext** base classes tooensure all hello processing on hello EF side happens as well.</span></span> 

<span data-ttu-id="9c9b7-179">Poniższy przykład kodu Hello przedstawiono tej metody.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-179">hello following code example illustrates this approach.</span></span> <span data-ttu-id="9c9b7-180">(Ten kod jest również hello towarzyszące projektu Visual Studio)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-180">(This code is also in hello accompanying Visual Studio project)</span></span>

    public class ElasticScaleContext<T> : DbContext
    {
    public DbSet<Blog> Blogs { get; set; }
    …

        // C'tor for data dependent routing. This call will open a validated connection 
        // routed toohello proper shard by hello shard map manager. 
        // Note that hello base class c'tor call will fail for an open connection
        // if migrations need toobe done and SQL credentials are used. This is hello reason for hello 
        // separation of c'tors into hello data-dependent routing case (this c'tor) and hello internal c'tor for new shards.
        public ElasticScaleContext(ShardMap shardMap, T shardingKey, string connectionStr)
            : base(CreateDDRConnection(shardMap, shardingKey, connectionStr), 
            true /* contextOwnsConnection */)
        {
        }

        // Only static methods are allowed in calls into base class c'tors.
        private static DbConnection CreateDDRConnection(
        ShardMap shardMap, 
        T shardingKey, 
        string connectionStr)
        {
            // No initialization
            Database.SetInitializer<ElasticScaleContext<T>>(null);

            // Ask shard map toobroker a validated connection for hello given key
            SqlConnection conn = shardMap.OpenConnectionForKey<T>
                                (shardingKey, connectionStr, ConnectionOptions.Validate);
            return conn;
        }    

## <a name="main-points"></a><span data-ttu-id="9c9b7-181">Główne punkty</span><span class="sxs-lookup"><span data-stu-id="9c9b7-181">Main points</span></span>
* <span data-ttu-id="9c9b7-182">Nowy Konstruktor zastępuje hello domyślnego konstruktora w hello podklasy DbContext</span><span class="sxs-lookup"><span data-stu-id="9c9b7-182">A new constructor replaces hello default constructor in hello DbContext subclass</span></span> 
* <span data-ttu-id="9c9b7-183">Nowy Konstruktor Hello przyjmuje hello argumenty, które są wymagane dla danych zależnych routingu za pomocą biblioteki klienta elastycznej bazy danych:</span><span class="sxs-lookup"><span data-stu-id="9c9b7-183">hello new constructor takes hello arguments that are required for data dependent routing through elastic database client library:</span></span>
  
  * <span data-ttu-id="9c9b7-184">Witaj niezależnego fragmentu mapy tooaccess hello interfejsów routingu zależne od danych,</span><span class="sxs-lookup"><span data-stu-id="9c9b7-184">hello shard map tooaccess hello data-dependent routing interfaces,</span></span>
  * <span data-ttu-id="9c9b7-185">Witaj dzielenia na fragmenty klucza tooidentify hello shardlet</span><span class="sxs-lookup"><span data-stu-id="9c9b7-185">hello sharding key tooidentify hello shardlet,</span></span>
  * <span data-ttu-id="9c9b7-186">Parametry połączenia przy użyciu poświadczeń hello na powitania zależne od danych routingu niezależnych toohello połączenia.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-186">a connection string with hello credentials for hello data-dependent routing connection toohello shard.</span></span> 
* <span data-ttu-id="9c9b7-187">Konstruktor klasy podstawowej toohello wywołania Hello uwzględnia przekierowania statyczną metodę, która wykonuje wszystkie kroki hello niezbędne dla routingu zależne od danych.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-187">hello call toohello base class constructor takes a detour into a static method that performs all hello steps necessary for data-dependent routing.</span></span> 
  
  * <span data-ttu-id="9c9b7-188">Używa hello OpenConnectionForKey wywołania interfejsów hello elastycznej bazy danych klienta na powitania niezależnego fragmentu mapy tooestablish otwartego połączenia.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-188">It uses hello OpenConnectionForKey call of hello elastic database client interfaces on hello shard map tooestablish an open connection.</span></span>
  * <span data-ttu-id="9c9b7-189">Mapa niezależnego fragmentu Hello tworzy hello otwartego połączenia toohello niezależnych przechowujący hello shardlet dla danego klucza dzielenia na fragmenty hello.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-189">hello shard map creates hello open connection toohello shard that holds hello shardlet for hello given sharding key.</span></span>
  * <span data-ttu-id="9c9b7-190">To połączenie otwarte jest przekazywany konstruktora klasy podstawowej wstecz toohello tooindicate DbContext, czy to połączenie jest toobe używane przez EF, zamiast czekać na EF automatycznie Utwórz nowe połączenie.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-190">This open connection is passed back toohello base class constructor of DbContext tooindicate that this connection is toobe used by EF instead of letting EF create a new connection automatically.</span></span> <span data-ttu-id="9c9b7-191">To połączenie hello sposób oznakowanym przez interfejs API do powitania klienta elastycznej bazy danych, dzięki czemu może zagwarantować spójności w operacjach zarządzania mapy niezależnego fragmentu.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-191">This way hello connection has been tagged by hello elastic database client API so that it can guarantee consistency under shard map management operations.</span></span>

<span data-ttu-id="9c9b7-192">Użyj hello nowy konstruktor podklasa użytkownika DbContext zamiast hello domyślnego konstruktora w kodzie.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-192">Use hello new constructor for your DbContext subclass instead of hello default constructor in your code.</span></span> <span data-ttu-id="9c9b7-193">Oto przykład:</span><span class="sxs-lookup"><span data-stu-id="9c9b7-193">Here is an example:</span></span> 

    // Create and save a new blog.

    Console.Write("Enter a name for a new blog: "); 
    var name = Console.ReadLine(); 

    using (var db = new ElasticScaleContext<int>( 
                            sharding.ShardMap,  
                            tenantId1,  
                            connStrBldr.ConnectionString)) 
    { 
        var blog = new Blog { Name = name }; 
        db.Blogs.Add(blog); 
        db.SaveChanges(); 

        // Display all Blogs for tenant 1 
        var query = from b in db.Blogs 
                    orderby b.Name 
                    select b; 
     … 
    }

<span data-ttu-id="9c9b7-194">Nowy Konstruktor Hello otwiera hello połączenia toohello niezależnych przechowujący dane powitania dla shardlet hello identyfikowane przez wartość hello **tenantid1**.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-194">hello new constructor opens hello connection toohello shard that holds hello data for hello shardlet identified by hello value of **tenantid1**.</span></span> <span data-ttu-id="9c9b7-195">Witaj kodu w hello **przy użyciu** bloku pozostaje niezmieniony tooaccess hello **DbSet** dla blogów za pomocą EF na powitania niezależnych dla **tenantid1**.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-195">hello code in hello **using** block stays unchanged tooaccess hello **DbSet** for blogs using EF on hello shard for **tenantid1**.</span></span> <span data-ttu-id="9c9b7-196">Spowoduje to zmianę semantyki dla kodu hello w hello przy użyciu bloku w taki sposób, że wszystkie operacje bazy danych są teraz zakres toohello jednego niezależnego fragmentu gdzie **tenantid1** jest przechowywany.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-196">This changes semantics for hello code in hello using block such that all database operations are now scoped toohello one shard where **tenantid1** is kept.</span></span> <span data-ttu-id="9c9b7-197">Na przykład zapytania LINQ za pośrednictwem blogi hello **DbSet** zwracać tylko blogi przechowywane na powitania bieżący identyfikator niezależnego fragmentu, ale nie hello te są przechowywane w innych fragmentów.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-197">For instance, a LINQ query over hello blogs **DbSet** would only return blogs stored on hello current shard, but not hello ones stored on other shards.</span></span>  

#### <a name="transient-faults-handling"></a><span data-ttu-id="9c9b7-198">Obsługa błędów przejściowych</span><span class="sxs-lookup"><span data-stu-id="9c9b7-198">Transient faults handling</span></span>
<span data-ttu-id="9c9b7-199">Witaj Microsoft Patterns & rozwiązania zespołu opublikowanych hello [hello bloku aplikacji obsługi błędów przejściowych](https://msdn.microsoft.com/library/dn440719.aspx).</span><span class="sxs-lookup"><span data-stu-id="9c9b7-199">hello Microsoft Patterns & Practices team published hello [hello Transient Fault Handling Application Block](https://msdn.microsoft.com/library/dn440719.aspx).</span></span> <span data-ttu-id="9c9b7-200">Biblioteka Hello jest używany z biblioteki klienta elastycznej skali w połączeniu z EF.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-200">hello library is used with elastic scale client library in combination with EF.</span></span> <span data-ttu-id="9c9b7-201">Jednak upewnić się, że przejściowy wyjątku zwraca tooa miejscu, gdzie możemy upewnij się, że tego konstruktora new hello jest używany po błędu przejściowego tak, aby wszystkie nowe połączenia podejmowana jest używanie konstruktorów hello, które firma Microsoft ma tweaked.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-201">However, ensure that any transient exception returns tooa place where we can ensure that hello new constructor is being used after a transient fault so that any new connection attempt is made using hello constructors we have tweaked.</span></span> <span data-ttu-id="9c9b7-202">W przeciwnym razie wartość toohello połączenia poprawny identyfikator niezależnego fragmentu nie jest gwarantowana i nie ma żadnych gwarancji połączenia hello jest obsługiwana jako zmiany wystąpić toohello niezależnego fragmentu mapy.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-202">Otherwise, a connection toohello correct shard is not guaranteed, and there are no assurances hello connection is maintained as changes toohello shard map occur.</span></span> 

<span data-ttu-id="9c9b7-203">Hello Poniższy przykładowy kod przedstawia sposób zasady ponawiania SQL może służyć wokół hello nowe **DbContext** podklas:</span><span class="sxs-lookup"><span data-stu-id="9c9b7-203">hello following code sample illustrates how a SQL retry policy can be used around hello new **DbContext** subclass constructors:</span></span> 

    SqlDatabaseUtils.SqlRetryPolicy.ExecuteAction(() => 
    { 
        using (var db = new ElasticScaleContext<int>( 
                                sharding.ShardMap,  
                                tenantId1,  
                                connStrBldr.ConnectionString)) 
            { 
                    var blog = new Blog { Name = name }; 
                    db.Blogs.Add(blog); 
                    db.SaveChanges(); 
            … 
            } 
        }); 

<span data-ttu-id="9c9b7-204">**SqlDatabaseUtils.SqlRetryPolicy** w hello powyższy kod jest zdefiniowany jako **SqlDatabaseTransientErrorDetectionStrategy** z liczbą ponowień równą 10 i 5 sekund oczekiwania czasu między kolejnymi próbami.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-204">**SqlDatabaseUtils.SqlRetryPolicy** in hello code above is defined as a **SqlDatabaseTransientErrorDetectionStrategy** with a retry count of 10, and 5 seconds wait time between retries.</span></span> <span data-ttu-id="9c9b7-205">Ta metoda jest podobne wskazówki toohello EF i transakcji inicjowanych przez użytkownika (zobacz [ograniczenia strategiami ponowną próbą wykonania (EF6 i jego nowszych wersjach)](http://msdn.microsoft.com/data/dn307226).</span><span class="sxs-lookup"><span data-stu-id="9c9b7-205">This approach is similar toohello guidance for EF and user-initiated transactions (see [Limitations with Retrying Execution Strategies (EF6 onwards)](http://msdn.microsoft.com/data/dn307226).</span></span> <span data-ttu-id="9c9b7-206">Zarówno sytuacje wymagają programu aplikacji hello steruje hello zakresu toowhich hello przejściowej wyjątek zwraca: tooeither ponownie transakcji hello, lub (jak pokazano) ponownie kontekstu hello z prawidłowego konstruktora hello, że używa hello elastycznej bazy danych Biblioteka klienta.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-206">Both situations require that hello application program controls hello scope toowhich hello transient exception returns: tooeither reopen hello transaction, or (as shown) recreate hello context from hello proper constructor that uses hello elastic database client library.</span></span>

<span data-ttu-id="9c9b7-207">Hello toocontrol potrzeby w przypadku gdy wyjątki przejściowej podjąć nam w zakresie także wyklucza Użyj hello wbudowanych hello **klasy SqlAzureExecutionStrategy** dołączony EF.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-207">hello need toocontrol where transient exceptions take us back in scope also precludes hello use of hello built-in **SqlAzureExecutionStrategy** that comes with EF.</span></span> <span data-ttu-id="9c9b7-208">**Klasy SqlAzureExecutionStrategy** będzie ponownie otworzyć połączenie, ale nie używać **OpenConnectionForKey** ominięcie wszystkich weryfikacji hello wykonywanej jako część hello **OpenConnectionForKey** wywołania.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-208">**SqlAzureExecutionStrategy** would reopen a connection but not use **OpenConnectionForKey** and therefore bypass all hello validation that is performed as part of hello **OpenConnectionForKey** call.</span></span> <span data-ttu-id="9c9b7-209">Zamiast tego hello przykładowy kod używa wbudowanego hello **DefaultExecutionStrategy** również dołączony EF.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-209">Instead, hello code sample uses hello built-in **DefaultExecutionStrategy** that also comes with EF.</span></span> <span data-ttu-id="9c9b7-210">W przeciwieństwie do zbyt**klasy SqlAzureExecutionStrategy**, działa on prawidłowo w połączeniu z hello zasady ponawiania z obsługi błędów przejściowych.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-210">As opposed too**SqlAzureExecutionStrategy**, it works correctly in combination with hello retry policy from Transient Fault Handling.</span></span> <span data-ttu-id="9c9b7-211">zasady wykonywania Hello jest ustawiana w hello **ElasticScaleDbConfiguration** klasy.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-211">hello execution policy is set in hello **ElasticScaleDbConfiguration** class.</span></span> <span data-ttu-id="9c9b7-212">Należy pamiętać, że zdecydowaliśmy nie toouse **DefaultSqlExecutionStrategy** ponieważ sugeruje toouse **klasy SqlAzureExecutionStrategy** Jeśli wystąpią wyjątki przejściowy — które doprowadziłaby zachowanie toowrong zgodnie z opisem.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-212">Note that we decided not toouse **DefaultSqlExecutionStrategy** since it suggests toouse **SqlAzureExecutionStrategy** if transient exceptions occur - which would lead toowrong behavior as discussed.</span></span> <span data-ttu-id="9c9b7-213">Aby uzyskać więcej informacji na powitania zasady różnych ponownych prób i EF, zobacz [połączenia odporność EF](http://msdn.microsoft.com/data/dn456835.aspx).</span><span class="sxs-lookup"><span data-stu-id="9c9b7-213">For more information on hello different retry policies and EF, see [Connection Resiliency in EF](http://msdn.microsoft.com/data/dn456835.aspx).</span></span>     

#### <a name="constructor-rewrites"></a><span data-ttu-id="9c9b7-214">Konstruktor modyfikacji oprogramowania</span><span class="sxs-lookup"><span data-stu-id="9c9b7-214">Constructor rewrites</span></span>
<span data-ttu-id="9c9b7-215">Hello kodu powyższych przykładach hello domyślnego konstruktora ponownie zapisuje wymagane przez aplikację w kolejności toouse danych zależnych routingu z hello Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-215">hello code examples above illustrate hello default constructor re-writes required for your application in order toouse  data dependent routing with hello Entity Framework.</span></span> <span data-ttu-id="9c9b7-216">w poniższej tabeli Hello stanowi uogólnienie tego podejścia tooother konstruktorów.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-216">hello following table generalizes this approach tooother constructors.</span></span> 

| <span data-ttu-id="9c9b7-217">Bieżący Konstruktor</span><span class="sxs-lookup"><span data-stu-id="9c9b7-217">Current Constructor</span></span> | <span data-ttu-id="9c9b7-218">Konstruktor nowych danych</span><span class="sxs-lookup"><span data-stu-id="9c9b7-218">Rewritten Constructor for data</span></span> | <span data-ttu-id="9c9b7-219">Konstruktora podstawowego</span><span class="sxs-lookup"><span data-stu-id="9c9b7-219">Base Constructor</span></span> | <span data-ttu-id="9c9b7-220">Uwagi</span><span class="sxs-lookup"><span data-stu-id="9c9b7-220">Notes</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="9c9b7-221">MyContext()</span><span class="sxs-lookup"><span data-stu-id="9c9b7-221">MyContext()</span></span> |<span data-ttu-id="9c9b7-222">ElasticScaleContext (ShardMap, TKey)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-222">ElasticScaleContext(ShardMap, TKey)</span></span> |<span data-ttu-id="9c9b7-223">DbContext (DbConnection, wartość logiczna)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-223">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="9c9b7-224">połączenie Hello wymaga toobe funkcję mapy niezależnego fragmentu hello i klucz routingu hello zależne od danych.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-224">hello connection needs toobe a function of hello shard map and hello data-dependent routing key.</span></span> <span data-ttu-id="9c9b7-225">Należy tooby przebiegu połączenie automatyczne tworzenie przez EF i zamiast tego użyć hello niezależnego fragmentu mapy toobroker hello połączenia.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-225">You need tooby-pass automatic connection creation by EF and instead use hello shard map toobroker hello connection.</span></span> |
| <span data-ttu-id="9c9b7-226">MyContext(string)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-226">MyContext(string)</span></span> |<span data-ttu-id="9c9b7-227">ElasticScaleContext (ShardMap, TKey)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-227">ElasticScaleContext(ShardMap, TKey)</span></span> |<span data-ttu-id="9c9b7-228">DbContext (DbConnection, wartość logiczna)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-228">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="9c9b7-229">połączenie Hello jest funkcją mapy niezależnego fragmentu hello i klucz routingu hello zależne od danych.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-229">hello connection is a function of hello shard map and hello data-dependent routing key.</span></span> <span data-ttu-id="9c9b7-230">Stałej bazy danych nazwa lub parametry połączenia nie będą działać jako ich obejścia weryfikacji przez hello niezależnego fragmentu mapy.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-230">A fixed database name or connection string will not work as they by-pass validation by hello shard map.</span></span> |
| <span data-ttu-id="9c9b7-231">MyContext(DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-231">MyContext(DbCompiledModel)</span></span> |<span data-ttu-id="9c9b7-232">ElasticScaleContext (ShardMap, TKey, model DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-232">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span></span> |<span data-ttu-id="9c9b7-233">DbContext (DbConnection, model DbCompiledModel, wartość logiczna)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-233">DbContext(DbConnection, DbCompiledModel, bool)</span></span> |<span data-ttu-id="9c9b7-234">Witaj połączenia zostaną utworzone dla hello podany klucz mapy i dzielenia na fragmenty niezależnego fragmentu z modelem hello podane.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-234">hello connection will get created for hello given shard map and sharding key with hello model provided.</span></span> <span data-ttu-id="9c9b7-235">Hello skompilowanego modelu zostaną przekazane na toohello c'tor podstawowej.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-235">hello compiled model will be passed on toohello base c’tor.</span></span> |
| <span data-ttu-id="9c9b7-236">MyContext (DbConnection, wartość logiczna)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-236">MyContext(DbConnection, bool)</span></span> |<span data-ttu-id="9c9b7-237">ElasticScaleContext (ShardMap, TKey, wartość logiczna)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-237">ElasticScaleContext(ShardMap, TKey, bool)</span></span> |<span data-ttu-id="9c9b7-238">DbContext (DbConnection, wartość logiczna)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-238">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="9c9b7-239">połączenie Hello wymaga toobe wywnioskować na podstawie mapy niezależnego fragmentu hello i hello klucza.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-239">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="9c9b7-240">Nie można podać jako dane wejściowe, (chyba że te dane wejściowe korzystał już z mapy niezależnego fragmentu hello i klucz hello).</span><span class="sxs-lookup"><span data-stu-id="9c9b7-240">It cannot be provided as an input (unless that input was already using hello shard map and hello key).</span></span> <span data-ttu-id="9c9b7-241">wartość logiczna Hello zostaną przekazane.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-241">hello Boolean will be passed on.</span></span> |
| <span data-ttu-id="9c9b7-242">MyContext (ciąg, model DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-242">MyContext(string, DbCompiledModel)</span></span> |<span data-ttu-id="9c9b7-243">ElasticScaleContext (ShardMap, TKey, model DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-243">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span></span> |<span data-ttu-id="9c9b7-244">DbContext (DbConnection, model DbCompiledModel, wartość logiczna)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-244">DbContext(DbConnection, DbCompiledModel, bool)</span></span> |<span data-ttu-id="9c9b7-245">połączenie Hello wymaga toobe wywnioskować na podstawie mapy niezależnego fragmentu hello i hello klucza.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-245">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="9c9b7-246">Nie można podać jako dane wejściowe, (chyba że te dane wejściowe używał mapy niezależnego fragmentu hello i klucz hello).</span><span class="sxs-lookup"><span data-stu-id="9c9b7-246">It cannot be provided as an input (unless that input was using hello shard map and hello key).</span></span> <span data-ttu-id="9c9b7-247">model skompilowanych Hello zostaną przekazane.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-247">hello compiled model will be passed on.</span></span> |
| <span data-ttu-id="9c9b7-248">MyContext (ObjectContext, wartość logiczna)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-248">MyContext(ObjectContext, bool)</span></span> |<span data-ttu-id="9c9b7-249">ElasticScaleContext (ShardMap TKey, ObjectContext, wartość logiczna)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-249">ElasticScaleContext(ShardMap, TKey, ObjectContext, bool)</span></span> |<span data-ttu-id="9c9b7-250">DbContext (ObjectContext, wartość logiczna)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-250">DbContext(ObjectContext, bool)</span></span> |<span data-ttu-id="9c9b7-251">Nowy Konstruktor Hello musi tooensure, który dowolnego połączenia, powitalne ObjectContext przekazany jako dane wejściowe jest połączenie przekierowane tooa zarządza elastycznego skalowania.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-251">hello new constructor needs tooensure that any connection in hello ObjectContext passed as an input is re-routed tooa connection managed by Elastic Scale.</span></span> <span data-ttu-id="9c9b7-252">Szczegółowe omówienie ObjectContexts wykracza poza zakres tego dokumentu hello.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-252">A detailed discussion of ObjectContexts is beyond hello scope of this document.</span></span> |
| <span data-ttu-id="9c9b7-253">MyContext (DbConnection, model DbCompiledModel, wartość logiczna)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-253">MyContext(DbConnection, DbCompiledModel,bool)</span></span> |<span data-ttu-id="9c9b7-254">ElasticScaleContext (ShardMap TKey, model DbCompiledModel, wartość logiczna)</span><span class="sxs-lookup"><span data-stu-id="9c9b7-254">ElasticScaleContext(ShardMap, TKey, DbCompiledModel, bool)</span></span> |<span data-ttu-id="9c9b7-255">DbContext (DbConnection, model DbCompiledModel, wartość logiczna);</span><span class="sxs-lookup"><span data-stu-id="9c9b7-255">DbContext(DbConnection, DbCompiledModel, bool);</span></span> |<span data-ttu-id="9c9b7-256">połączenie Hello wymaga toobe wywnioskować na podstawie mapy niezależnego fragmentu hello i hello klucza.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-256">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="9c9b7-257">Witaj połączenia nie można podać jako danych wejściowych (chyba że te dane wejściowe korzystał już z mapy niezależnego fragmentu hello i klucz hello).</span><span class="sxs-lookup"><span data-stu-id="9c9b7-257">hello connection cannot be provided as an input (unless that input was already using hello shard map and hello key).</span></span> <span data-ttu-id="9c9b7-258">Model i wartość logiczną są przekazywane toohello konstruktora klasy podstawowej.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-258">Model and Boolean are passed on toohello base class constructor.</span></span> |

## <a name="shard-schema-deployment-through-ef-migrations"></a><span data-ttu-id="9c9b7-259">Identyfikator niezależnego fragmentu wdrożenia schematu za pomocą migracji EF</span><span class="sxs-lookup"><span data-stu-id="9c9b7-259">Shard schema deployment through EF migrations</span></span>
<span data-ttu-id="9c9b7-260">Zarządzanie automatyczne schematu jest udogodnienie podał hello Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-260">Automatic schema management is a convenience provided by hello Entity Framework.</span></span> <span data-ttu-id="9c9b7-261">W kontekście hello aplikacji przy użyciu narzędzi elastycznej bazy danych chcemy tooretain tego odłamków możliwości tooautomatically udostępniania hello schematu toonewly utworzone po dodaniu aplikacji podzielonej toohello baz danych.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-261">In hello context of applications using elastic database tools, we want tooretain this capability tooautomatically provision hello schema toonewly created shards when databases are added toohello sharded application.</span></span> <span data-ttu-id="9c9b7-262">pierwotnym zastosowaniem Hello jest pojemność tooincrease podzielonej aplikacji przy użyciu EF na powitania warstwy danych.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-262">hello primary use case is tooincrease capacity at hello data tier for sharded applications using EF.</span></span> <span data-ttu-id="9c9b7-263">Zależne EF jego możliwości zarządzania schematu powoduje zmniejszenie nakładu pracy administracyjnej bazy danych hello z aplikacją podzielonej EF w oparciu.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-263">Relying on EF’s capabilities for schema management reduces hello database administration effort with a sharded application built on EF.</span></span> 

<span data-ttu-id="9c9b7-264">Wdrożenia schematu za pomocą migracji EF najlepiej **bez otwierania połączenia**.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-264">Schema deployment through EF migrations works best on **unopened connections**.</span></span> <span data-ttu-id="9c9b7-265">Jest to z kolei toohello scenariusz routingu zależnych danych zależy od połączenia hello otworzyć udostępniane przez interfejs API klienta elastycznej bazy danych hello.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-265">This is in contrast toohello scenario for data dependent routing that relies on hello opened connection provided by hello elastic database client API.</span></span> <span data-ttu-id="9c9b7-266">Inna różnica polega na wymaganie spójności hello: podczas pożądane tooensure spójności dla wszystkich danych zależne od routingu tooprotect połączenia przed manipulowania mapy równoczesnych niezależnego fragmentu, nie jest problemem z początkowej schematu wdrożenia tooa nowej bazy danych mający jeszcze nie został zarejestrowany w mapie niezależnego fragmentu hello i nie zostały jeszcze przydzielona toohold shardlets.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-266">Another difference is hello consistency requirement: While desirable tooensure consistency for all data-dependent routing connections tooprotect against concurrent shard map manipulation, it is not a concern with initial schema deployment tooa new database that has not yet been registered in hello shard map, and not yet been allocated toohold shardlets.</span></span> <span data-ttu-id="9c9b7-267">Firma Microsoft może w związku z tym polegać na połączenia zwykłej bazy danych dla tego scenariusze jako min. zależne od toodata routingu.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-267">We can therefore rely on regular database connections for this scenarios, as opposed toodata-dependent routing.</span></span>  

<span data-ttu-id="9c9b7-268">Prowadzi to podejście tooan gdzie wdrożenia schematu za pomocą migracji EF jest ściśle powiązane ze rejestracji hello hello nowej bazy danych jako niezależnego fragmentu w aplikacji hello niezależnego fragmentu mapy.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-268">This leads tooan approach where schema deployment through EF migrations is tightly coupled with hello registration of hello new database as a shard in hello application’s shard map.</span></span> <span data-ttu-id="9c9b7-269">To opiera się na powitania następujące wymagania wstępne:</span><span class="sxs-lookup"><span data-stu-id="9c9b7-269">This relies on hello following prerequisites:</span></span> 

* <span data-ttu-id="9c9b7-270">Witaj bazy danych już istnieje.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-270">hello database has already been created.</span></span> 
* <span data-ttu-id="9c9b7-271">Witaj baza danych jest pusta — posiada nie użytkowników schematu i danych użytkownika.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-271">hello database is empty - it holds no user schema and no user data.</span></span>
* <span data-ttu-id="9c9b7-272">bazy danych Hello jeszcze nie są dostępne za pośrednictwem interfejsów API klienta elastycznej bazy danych hello zależne od danych routingu.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-272">hello database cannot yet be accessed through hello elastic database client APIs for data-dependent routing.</span></span> 

<span data-ttu-id="9c9b7-273">Z tych wymagań wstępnych w miejscu, możemy utworzyć zwykły bez otwartego **SqlConnection** tookick poza EF migracji wdrożenia schematu.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-273">With these prerequisites in place, we can create a regular un-opened **SqlConnection** tookick off EF migrations for schema deployment.</span></span> <span data-ttu-id="9c9b7-274">powitania po przykładowy kod przedstawia tej metody.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-274">hello following code sample illustrates this approach.</span></span> 

        // Enter a new shard - i.e. an empty database - toohello shard map, allocate a first tenant tooit  
        // and kick off EF intialization of hello database toodeploy schema 

        public void RegisterNewShard(string server, string database, string connStr, int key) 
        { 

            Shard shard = this.ShardMap.CreateShard(new ShardLocation(server, database)); 

            SqlConnectionStringBuilder connStrBldr = new SqlConnectionStringBuilder(connStr); 
            connStrBldr.DataSource = server; 
            connStrBldr.InitialCatalog = database; 

            // Go into a DbContext tootrigger migrations and schema deployment for hello new shard. 
            // This requires an un-opened connection. 
            using (var db = new ElasticScaleContext<int>(connStrBldr.ConnectionString)) 
            { 
                // Run a query tooengage EF migrations 
                (from b in db.Blogs 
                    select b).Count(); 
            } 

            // Register hello mapping of hello tenant toohello shard in hello shard map. 
            // After this step, data-dependent routing on hello shard map can be used 

            this.ShardMap.CreatePointMapping(key, shard); 
        } 


<span data-ttu-id="9c9b7-275">W tym przykładzie pokazano metodę hello **RegisterNewShard** czy rejestrów hello niezależnego fragmentu w mapie niezależnego fragmentu hello, wdraża hello schematu za pomocą migracji EF i przechowuje mapowanie niezależnych klucza toohello dzielenia na fragmenty.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-275">This sample shows hello method **RegisterNewShard** that registers hello shard in hello shard map, deploys hello schema through EF migrations, and stores a mapping of a sharding key toohello shard.</span></span> <span data-ttu-id="9c9b7-276">Zależy od konstruktora hello **DbContext** podklasy (**ElasticScaleContext** w przykładowym hello) pobierającej parametrów połączenia SQL jako dane wejściowe.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-276">It relies on a constructor of hello **DbContext** subclass (**ElasticScaleContext** in hello sample) that takes a SQL connection string as input.</span></span> <span data-ttu-id="9c9b7-277">Kod Hello tego konstruktora jest proste, jako powitania po przykładzie:</span><span class="sxs-lookup"><span data-stu-id="9c9b7-277">hello code of this constructor is straight-forward, as hello following example shows:</span></span> 

        // C'tor toodeploy schema and migrations tooa new shard 
        protected internal ElasticScaleContext(string connectionString) 
            : base(SetInitializerForConnection(connectionString)) 
        { 
        } 

        // Only static methods are allowed in calls into base class c'tors 
        private static string SetInitializerForConnection(string connnectionString) 
        { 
            // We want existence checks so that hello schema can get deployed 
            Database.SetInitializer<ElasticScaleContext<T>>( 
        new CreateDatabaseIfNotExists<ElasticScaleContext<T>>()); 

            return connnectionString; 
        } 

<span data-ttu-id="9c9b7-278">Co najmniej jedna może być używana wersja hello konstruktora hello odziedziczona z klasy podstawowej hello.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-278">One might have used hello version of hello constructor inherited from hello base class.</span></span> <span data-ttu-id="9c9b7-279">Ale hello tooensure potrzeb kodu, który hello domyślne inicjator dla EF jest używany podczas nawiązywania połączenia.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-279">But hello code needs tooensure that hello default initializer for EF is used when connecting.</span></span> <span data-ttu-id="9c9b7-280">Dlatego hello krótkich przekierowania do metody statycznej hello przed wywołaniem do konstruktora klasy podstawowej hello z hello parametry połączenia.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-280">Hence hello short detour into hello static method before calling into hello base class constructor with hello connection string.</span></span> <span data-ttu-id="9c9b7-281">Zauważ, że hello rejestracji odłamków należy uruchomić w aplikacji innej domeny lub proces tooensure, które nie powodują konfliktu ustawień inicjatora hello EF.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-281">Note that hello registration of shards should run in a different app domain or process tooensure that hello initializer settings for EF do not conflict.</span></span> 

## <a name="limitations"></a><span data-ttu-id="9c9b7-282">Ograniczenia</span><span class="sxs-lookup"><span data-stu-id="9c9b7-282">Limitations</span></span>
<span data-ttu-id="9c9b7-283">Witaj metod opisanych w tym dokumencie pociąga za sobą kilka ograniczeń:</span><span class="sxs-lookup"><span data-stu-id="9c9b7-283">hello approaches outlined in this document entail a couple of limitations:</span></span> 

* <span data-ttu-id="9c9b7-284">EF aplikacji, które używają **LocalDb** najpierw toomigrate tooa zwykłej bazy danych programu SQL Server przed rozpoczęciem korzystania z biblioteki klienta elastycznej bazy danych.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-284">EF applications that use **LocalDb** first need toomigrate tooa regular SQL Server database before using elastic database client library.</span></span> <span data-ttu-id="9c9b7-285">Skalowania aplikacji za pośrednictwem dzielenia na fragmenty o elastycznego skalowania nie jest możliwe za pomocą **LocalDb**.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-285">Scaling out an application through sharding with Elastic Scale is not possible with **LocalDb**.</span></span> <span data-ttu-id="9c9b7-286">Należy pamiętać, że programowanie można nadal używać **LocalDb**.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-286">Note that development can still use **LocalDb**.</span></span> 
* <span data-ttu-id="9c9b7-287">Każda aplikacja toohello zmiany, która oznacza zmiany schematu bazy danych należy toogo za pomocą migracji EF na wszystkich fragmentów.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-287">Any changes toohello application that imply database schema changes need toogo through EF migrations on all shards.</span></span> <span data-ttu-id="9c9b7-288">Witaj przykładowy kod dla tego dokumentu nie pokazują, jak toodo to.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-288">hello sample code for this document does not demonstrate how toodo this.</span></span> <span data-ttu-id="9c9b7-289">Należy rozważyć użycie Update-Database z tooiterate parametru ConnectionString za pośrednictwem wszystkich odłamków; Wyodrębnij hello T-SQL skryptu lub dla hello oczekujących migracji Update-Database z użyciem hello - opcja skryptu i zastosować odłamków tooyour skryptu hello T-SQL.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-289">Consider using Update-Database with a ConnectionString parameter tooiterate over all shards; or extract hello T-SQL script for hello pending migration using Update-Database with hello -Script option and apply hello T-SQL script tooyour shards.</span></span>  
* <span data-ttu-id="9c9b7-290">Biorąc pod uwagę na żądanie, zakłada się, że wszystkie jego przetwarzanie bazy danych znajduje się w obrębie jednego niezależnego fragmentu określonej za pomocą hello dzielenia na fragmenty klucza udostępnionego przez hello żądania.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-290">Given a request, it is assumed that all of its database processing is contained within a single shard as identified by hello sharding key provided by hello request.</span></span> <span data-ttu-id="9c9b7-291">Jednak to założenie nie zawsze ma wartość true.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-291">However, this assumption does not always hold true.</span></span> <span data-ttu-id="9c9b7-292">Na przykład, jeśli nie jest możliwe toomake dostępne klucz dzielenia na fragmenty.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-292">For example, when it is not possible toomake a sharding key available.</span></span> <span data-ttu-id="9c9b7-293">tooaddress tego hello biblioteki klienta zawiera hello **MultiShardQuery** klasa implementująca abstrakcji połączenia, na potrzeby zapytań przez kilka fragmentów.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-293">tooaddress this, hello client library provides hello **MultiShardQuery** class that implements a connection abstraction for querying over several shards.</span></span> <span data-ttu-id="9c9b7-294">Learning toouse hello **MultiShardQuery** w połączeniu z EF wykracza poza zakres tego dokumentu hello</span><span class="sxs-lookup"><span data-stu-id="9c9b7-294">Learning toouse hello **MultiShardQuery** in combination with EF is beyond hello scope of this document</span></span>

## <a name="conclusion"></a><span data-ttu-id="9c9b7-295">Podsumowanie</span><span class="sxs-lookup"><span data-stu-id="9c9b7-295">Conclusion</span></span>
<span data-ttu-id="9c9b7-296">Hello kroków opisanych w tym dokumencie, EF aplikacje mogą używać biblioteki hello elastycznej bazy danych klienta możliwości danych zależnych routingu w ramach refaktoryzacji elementu konstruktorów hello **DbContext** podklasy używane w hello EF aplikacja.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-296">Through hello steps outlined in this document, EF applications can use hello elastic database client library's capability for data dependent routing by refactoring constructors of hello **DbContext** subclasses used in hello EF application.</span></span> <span data-ttu-id="9c9b7-297">Wymagane zmiany hello tego ograniczenia toothose miejsc, gdzie **DbContext** klasy już istnieje.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-297">This limits hello  changes required toothose places where **DbContext** classes already exist.</span></span> <span data-ttu-id="9c9b7-298">Ponadto aplikacje EF można nadal toobenefit z wdrażania automatycznego schematu łącząc hello kroki, które wywołują hello niezbędne EF migracji z rejestracją hello nowych fragmentów i mapowania hello niezależnego fragmentu mapy.</span><span class="sxs-lookup"><span data-stu-id="9c9b7-298">In addition, EF applications can continue toobenefit from automatic schema deployment by combining hello steps that invoke hello necessary EF migrations with hello registration of new shards and mappings in hello shard map.</span></span> 

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-use-entity-framework-applications-visual-studio/sample.png
