---
title: "Uwierzytelnianie główną usługi dla aplikacji interfejsu API w usłudze Azure App Service | Dokumentacja firmy Microsoft"
description: "Dowiedz się, jak chronić aplikację interfejsu API w usłudze Azure App Service dla scenariuszy service-to-service."
services: app-service\api
documentationcenter: .net
author: alexkarcher-msft
manager: erikre
editor: 
ms.assetid: 7ca0bab2-1d29-4d51-b779-dce0edd34f8b
ms.service: app-service-api
ms.workload: na
ms.tgt_pltfrm: dotnet
ms.devlang: na
ms.topic: article
ms.date: 06/30/2016
ms.author: alkarche
ms.openlocfilehash: 95653287546bbe358111ed16af0c30a53caff2b5
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 07/11/2017
---
# <a name="service-principal-authentication-for-api-apps-in-azure-app-service"></a><span data-ttu-id="5c82a-103">Uwierzytelnianie główną usługi dla aplikacji interfejsu API w usłudze Azure App Service</span><span class="sxs-lookup"><span data-stu-id="5c82a-103">Service principal authentication for API Apps in Azure App Service</span></span>
## <a name="overview"></a><span data-ttu-id="5c82a-104">Omówienie</span><span class="sxs-lookup"><span data-stu-id="5c82a-104">Overview</span></span>
<span data-ttu-id="5c82a-105">W tym artykule opisano sposób korzystania z usługi aplikacji uwierzytelniania dla *wewnętrzny* dostęp do aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-105">This article explains how to use App Service authentication for *internal* access to API apps.</span></span> <span data-ttu-id="5c82a-106">Scenariusz wewnętrzny jest, gdzie masz aplikację interfejsu API, które mają być dostępne tylko przez kod aplikacji.</span><span class="sxs-lookup"><span data-stu-id="5c82a-106">An internal scenario is where you have an API app that you want to be consumable only by your own application code.</span></span> <span data-ttu-id="5c82a-107">Zalecanym sposobem wdrożenia tego scenariusza, w usłudze App Service jest o nazwie aplikacji interfejsu API ochrony przy użyciu usługi Azure AD.</span><span class="sxs-lookup"><span data-stu-id="5c82a-107">The recommended way to implement this scenario in App Service is to use Azure AD to protect the called API app.</span></span> <span data-ttu-id="5c82a-108">Należy wywołać chronionej aplikacji interfejsu API z tokenu elementu nośnego, który można pobrać z usługi Azure AD przez udostępnienie tożsamość aplikacji poświadczeń (nazwy głównej usługi).</span><span class="sxs-lookup"><span data-stu-id="5c82a-108">You call the protected API app with a bearer token that you get from Azure AD by providing application identity (service principal) credentials.</span></span> <span data-ttu-id="5c82a-109">Wariantów przy użyciu usługi Azure AD, zobacz **do usługi uwierzytelniania** sekcji [omówienie uwierzytelniania w usłudze Azure App Service](../app-service/app-service-authentication-overview.md#service-to-service-authentication).</span><span class="sxs-lookup"><span data-stu-id="5c82a-109">For alternatives to using Azure AD, see the **Service-to-service authentication** section of the [Azure App Service authentication overview](../app-service/app-service-authentication-overview.md#service-to-service-authentication).</span></span>

<span data-ttu-id="5c82a-110">W tym artykule dowiesz się:</span><span class="sxs-lookup"><span data-stu-id="5c82a-110">In this article, you'll learn:</span></span>

* <span data-ttu-id="5c82a-111">Jak używać usługi Azure Active Directory (Azure AD) do ochrony aplikacji interfejsu API przed nieuwierzytelnionym dostępem.</span><span class="sxs-lookup"><span data-stu-id="5c82a-111">How to use Azure Active Directory (Azure AD) to protect an API app from unauthenticated access.</span></span>
* <span data-ttu-id="5c82a-112">Jak korzystać z chronionej aplikacji interfejsu API z aplikacji interfejsu API, aplikacji sieci web lub aplikacji mobilnej przy użyciu poświadczeń podmiotu zabezpieczeń (tożsamość aplikacji) usługi Azure AD.</span><span class="sxs-lookup"><span data-stu-id="5c82a-112">How to consume a protected API app from an API app, web app, or mobile app by using Azure AD service principal (app identity) credentials.</span></span> <span data-ttu-id="5c82a-113">Aby uzyskać informacje o sposobie korzystania z aplikacji logiki, zobacz [przy użyciu niestandardowego interfejsu API hostowanych w usłudze aplikacji z usługą Logic apps](../logic-apps/logic-apps-custom-hosted-api.md).</span><span class="sxs-lookup"><span data-stu-id="5c82a-113">For information about how to consume from a logic app, see [Using your custom API hosted on App Service with Logic apps](../logic-apps/logic-apps-custom-hosted-api.md).</span></span>
* <span data-ttu-id="5c82a-114">Jak upewnij się, że chronionej aplikacji interfejsu API nie można wywołać z poziomu przeglądarki przy zalogowanych użytkowników.</span><span class="sxs-lookup"><span data-stu-id="5c82a-114">How to make sure that the protected API app can't be called from a browser by logged on users.</span></span>
* <span data-ttu-id="5c82a-115">W jaki sposób upewnij się, że chronionej aplikacji interfejsu API można wywołać tylko przez określonych Azure AD service principal.</span><span class="sxs-lookup"><span data-stu-id="5c82a-115">How to make sure that the protected API app can only be called by a specific Azure AD service principal.</span></span>

<span data-ttu-id="5c82a-116">Ten artykuł zawiera dwie sekcje:</span><span class="sxs-lookup"><span data-stu-id="5c82a-116">The article contains two sections:</span></span>

* <span data-ttu-id="5c82a-117">[Jak skonfigurować usługę podmiotu zabezpieczeń uwierzytelniania w usłudze Azure App Service](#authconfig) sekcji wyjaśniono, ogólnie rzecz biorąc, jak skonfigurować uwierzytelnianie dla dowolnej aplikacji interfejsu API oraz sposób korzystać z chronionej aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-117">The [How to configure service principal authentication in Azure App Service](#authconfig) section explains in general how to configure authentication for any API app, and how to consume the protected API app.</span></span> <span data-ttu-id="5c82a-118">Ta sekcja dotyczy jednakowo do wszystkich platform obsługiwanych przez usługę App Service, w tym .NET, Node.js i Java.</span><span class="sxs-lookup"><span data-stu-id="5c82a-118">This section applies equally to all frameworks supported by App Service, including .NET, Node.js, and Java.</span></span>
* <span data-ttu-id="5c82a-119">Począwszy od [kontynuowanie samouczki dotyczące rozpoczynania pracy .NET](#tutorialstart) sekcji samouczka instrukcje konfigurowania scenariusza "dostęp do" przykładową aplikację .NET w aplikacji usługi.</span><span class="sxs-lookup"><span data-stu-id="5c82a-119">Starting with the [Continuing the .NET getting-started tutorials](#tutorialstart) section, the tutorial guides you through configuring an "internal access" scenario for a .NET sample application running in App Service.</span></span> 

## <span data-ttu-id="5c82a-120"><a id="authconfig"></a>Jak skonfigurować usługę podmiotu zabezpieczeń uwierzytelniania w usłudze Azure App Service</span><span class="sxs-lookup"><span data-stu-id="5c82a-120"><a id="authconfig"></a> How to configure service principal authentication in Azure App Service</span></span>
<span data-ttu-id="5c82a-121">Ta sekcja zawiera ogólne instrukcje, które są stosowane do wszystkich aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-121">This section provides general instructions that apply to any API app.</span></span> <span data-ttu-id="5c82a-122">Dla określonego kroki, aby do .NET listy czy przykładowej aplikacji, przejdź do [kontynuowanie serii samouczek aplikacji interfejsu API programu .NET](#tutorialstart).</span><span class="sxs-lookup"><span data-stu-id="5c82a-122">For steps specific to the To Do List .NET sample application, go to [Continuing the .NET API Apps tutorial series](#tutorialstart).</span></span>

1. <span data-ttu-id="5c82a-123">W [portalu Azure](https://portal.azure.com/), przejdź do **ustawienia** bloku aplikacji interfejsu API, który chcesz chronić, a następnie znajdź **funkcje** sekcji, a następnie kliknij przycisk  **Uwierzytelnianie / autoryzacja**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-123">In the [Azure portal](https://portal.azure.com/), navigate to the **Settings** blade of the API app that you want to protect, and then find the **Features** section and click **Authentication/ Authorization**.</span></span>
   
    ![Uwierzytelnianie/autoryzację, w portalu Azure](./media/app-service-api-dotnet-user-principal-auth/features.png)
2. <span data-ttu-id="5c82a-125">W **uwierzytelniania / autoryzacji** bloku, kliknij przycisk **na**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-125">In the **Authentication / Authorization** blade, click **On**.</span></span>
3. <span data-ttu-id="5c82a-126">W **działania należy podjąć w przypadku nieuwierzytelnionego żądania** listy rozwijanej wybierz **Zaloguj się za pomocą usługi Azure Active Directory** .</span><span class="sxs-lookup"><span data-stu-id="5c82a-126">In the **Action to take when request is not authenticated** drop-down list, select **Log in with Azure Active Directory** .</span></span>
4. <span data-ttu-id="5c82a-127">W obszarze **dostawców uwierzytelniania**, wybierz pozycję **usługi Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-127">Under **Authentication Providers**, select **Azure Active Directory**.</span></span>
   
    ![Blok uwierzytelniania/autoryzacji w portalu Azure](./media/app-service-api-dotnet-user-principal-auth/authblade.png)
5. <span data-ttu-id="5c82a-129">Skonfiguruj **ustawień usługi Azure Active Directory** bloku, aby utworzyć nową aplikację usługi Azure AD, lub użyj istniejącej aplikacji usługi Azure AD, jeśli masz już konto, którego chcesz używać.</span><span class="sxs-lookup"><span data-stu-id="5c82a-129">Configure the **Azure Active Directory Settings** blade to create a new Azure AD application, or use an existing Azure AD application if you already have one that you want to use.</span></span>
   
    <span data-ttu-id="5c82a-130">Scenariusze wewnętrzny zwykle obejmują wywołanie aplikacji interfejsu API aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-130">Internal scenarios typically involve an API app calling an API app.</span></span> <span data-ttu-id="5c82a-131">Oddzielne Azure można użyć tylko jednej aplikacji usługi Azure AD lub aplikacji usługi AD dla każdej aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-131">You can use separate Azure AD applications for each API app or just one Azure AD application.</span></span>
   
    <span data-ttu-id="5c82a-132">Aby uzyskać szczegółowe informacje dotyczące tego bloku, zobacz [sposobu konfigurowania aplikacji usługi aplikacji do użycia usługi Azure Active Directory logowania](../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication.md).</span><span class="sxs-lookup"><span data-stu-id="5c82a-132">For detailed instructions on this blade, see [How to configure your App Service application to use Azure Active Directory login](../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication.md).</span></span>
6. <span data-ttu-id="5c82a-133">Po zakończeniu korzystania z bloku konfiguracji dostawcy uwierzytelniania, kliknij przycisk **OK**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-133">When you're done with the authentication provider configuration blade, click **OK**.</span></span>
7. <span data-ttu-id="5c82a-134">W **uwierzytelniania / autoryzacji** bloku, kliknij przycisk **zapisać**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-134">In the **Authentication / Authorization** blade, click **Save**.</span></span>
   
    ![Klikanie pozycji Zapisz.](./media/app-service-api-dotnet-service-principal-auth/authsave.png)

<span data-ttu-id="5c82a-136">Po zakończeniu App Service tylko zezwala na żądania pochodzące z wywołań w skonfigurowanego dzierżawy usługi Azure AD.</span><span class="sxs-lookup"><span data-stu-id="5c82a-136">When this is done, App Service only allows requests from callers in the configured Azure AD tenant.</span></span> <span data-ttu-id="5c82a-137">Brak kodu uwierzytelniania i autoryzacji jest wymagany w chronionej aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-137">No authentication or authorization code is required in the protected API app.</span></span> <span data-ttu-id="5c82a-138">Token elementu nośnego, są przekazywane do aplikacji interfejsu API wraz z powszechnie oświadczeń używanych w nagłówkach HTTP, a może odczytywać dane kod, aby sprawdzić, czy żądania są z określonego obiektu wywołującego, takich jak nazwy głównej usługi.</span><span class="sxs-lookup"><span data-stu-id="5c82a-138">The bearer token is passed to the API app along with commonly used claims in HTTP headers, and you can read that information in code to validate that requests are from a particular caller, such as a service principal.</span></span>

<span data-ttu-id="5c82a-139">Ta funkcja uwierzytelniania działa tak samo dla wszystkich języków, które obsługuje usługi aplikacji, w tym .NET, Node.js i Java.</span><span class="sxs-lookup"><span data-stu-id="5c82a-139">This authentication functionality works the same way for all languages that App service supports, including .NET, Node.js, and Java.</span></span> 

#### <a name="how-to-consume-the-protected-api-app"></a><span data-ttu-id="5c82a-140">Jak korzystać z chronionej aplikacji interfejsu API</span><span class="sxs-lookup"><span data-stu-id="5c82a-140">How to consume the protected API app</span></span>
<span data-ttu-id="5c82a-141">Obiekt wywołujący musi dostarczyć token elementu nośnego usługi Azure AD wywołań interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-141">The caller must provide an Azure AD bearer token with API calls.</span></span> <span data-ttu-id="5c82a-142">Do pobrania tokenu elementu nośnego przy użyciu poświadczenia główne, wywołujący korzysta z biblioteki uwierzytelniania usługi Active Directory (ADAL dla [.NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory), [Node.js](https://github.com/AzureAD/azure-activedirectory-library-for-nodejs), lub [Java](https://github.com/AzureAD/azure-activedirectory-library-for-java)).</span><span class="sxs-lookup"><span data-stu-id="5c82a-142">To get a bearer token using service principal credentials, the caller uses Active Directory Authentication Library (ADAL for [.NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory), [Node.js](https://github.com/AzureAD/azure-activedirectory-library-for-nodejs), or [Java](https://github.com/AzureAD/azure-activedirectory-library-for-java)).</span></span> <span data-ttu-id="5c82a-143">Aby uzyskać token, kod, który wywołuje ADAL zawiera do biblioteki ADAL następujące informacje:</span><span class="sxs-lookup"><span data-stu-id="5c82a-143">To get a token, the code that calls ADAL provides to ADAL the following information:</span></span>

* <span data-ttu-id="5c82a-144">Nazwa dzierżawy usługi Azure AD.</span><span class="sxs-lookup"><span data-stu-id="5c82a-144">The name of your Azure AD tenant.</span></span>
* <span data-ttu-id="5c82a-145">Identyfikator klienta i klucz tajny klienta (klucz aplikacji) skojarzone z funkcją wywołującą aplikacji usługi Azure AD.</span><span class="sxs-lookup"><span data-stu-id="5c82a-145">The client ID and client secret (app key) of the Azure AD app associated with the caller.</span></span>
* <span data-ttu-id="5c82a-146">Identyfikator klienta aplikacji usługi Azure AD skojarzonej z chronionej aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-146">The client ID of the Azure AD application associated with the protected API app.</span></span> <span data-ttu-id="5c82a-147">(Jeśli jest używany tylko jednej aplikacji usługi Azure AD, to ten sam identyfikator klienta, jak dla obiekt wywołujący.)</span><span class="sxs-lookup"><span data-stu-id="5c82a-147">(If just one Azure AD application is used, this is the same client ID as the one for the caller.)</span></span>

<span data-ttu-id="5c82a-148">Te wartości są dostępne na stronach usługi Azure AD [klasycznego portalu Azure](https://manage.windowsazure.com/).</span><span class="sxs-lookup"><span data-stu-id="5c82a-148">These values are available in the Azure AD pages of the [Azure classic portal](https://manage.windowsazure.com/).</span></span>

<span data-ttu-id="5c82a-149">Po uzyskano token, wywołujący obejmuje żądań HTTP w nagłówku autoryzacji.</span><span class="sxs-lookup"><span data-stu-id="5c82a-149">Once the token has been acquired, the caller includes it with HTTP requests in the Authorization header.</span></span>  <span data-ttu-id="5c82a-150">Usługi aplikacji sprawdza poprawność tokenu i umożliwia żądań do chronionej aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-150">App Service validates the token and allows the requests to reach the protected API app.</span></span>

#### <a name="how-to-protect-the-api-app-from-access-by-users-in-the-same-tenant"></a><span data-ttu-id="5c82a-151">Ochrona aplikacji interfejsu API przed dostępem użytkowników w tej samej dzierżawy</span><span class="sxs-lookup"><span data-stu-id="5c82a-151">How to protect the API app from access by users in the same tenant</span></span>
<span data-ttu-id="5c82a-152">Tokenów elementu nośnego dla użytkowników w tej samej dzierżawy są uznawane za prawidłowe dla chronionej aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-152">Bearer tokens for users in the same tenant are considered valid for the protected API app.</span></span>  <span data-ttu-id="5c82a-153">Jeśli chcesz upewnić się, że tylko nazwy głównej usługi można wywołać chronionej aplikacji interfejsu API, należy dodać kodu w chronionej aplikacji interfejsu API do sprawdzania poprawności następujących oświadczeń z tokenu:</span><span class="sxs-lookup"><span data-stu-id="5c82a-153">If you want to ensure that only a service principal can call the protected API app, add code in the protected API app to validate the following claims from the token:</span></span>

* <span data-ttu-id="5c82a-154">`appid`powinien być identyfikator klienta aplikacji usługi Azure AD, która jest skojarzona z funkcją wywołującą.</span><span class="sxs-lookup"><span data-stu-id="5c82a-154">`appid` should be the client ID of the Azure AD application that is associated with the caller.</span></span> 
* <span data-ttu-id="5c82a-155">`oid`(`objectidentifier`) powinna być identyfikator podmiotu zabezpieczeń usługi obiektu wywołującego.</span><span class="sxs-lookup"><span data-stu-id="5c82a-155">`oid` (`objectidentifier`) should be the service principal ID of the caller.</span></span> 

<span data-ttu-id="5c82a-156">Usługi aplikacji są także `objectidentifier` oświadczeń nagłówka X-MS-CLIENT-podmiot zabezpieczeń-ID.</span><span class="sxs-lookup"><span data-stu-id="5c82a-156">App Service also provides the `objectidentifier` claim in the X-MS-CLIENT-PRINCIPAL-ID header.</span></span>

### <a name="how-to-protect-the-api-app-from-browser-access"></a><span data-ttu-id="5c82a-157">Ochrona aplikacji interfejsu API z dostęp za pomocą przeglądarki</span><span class="sxs-lookup"><span data-stu-id="5c82a-157">How to protect the API app from browser access</span></span>
<span data-ttu-id="5c82a-158">Jeśli nie można zweryfikować oświadczenia w kodzie w chronionej aplikacji interfejsu API i używać oddzielnego aplikacji usługi Azure AD dla chronionej aplikacji interfejsu API, upewnij się, że adres URL odpowiedzi aplikacji usługi Azure AD nie jest taki sam jak podstawowy adres URL aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-158">If you don't validate claims in code in the protected API app, and if you use a separate Azure AD application for the protected API app, make sure that the Azure AD application's Reply URL is not the same as the API app's base URL.</span></span> <span data-ttu-id="5c82a-159">Jeśli adres URL odpowiedzi wskazuje bezpośrednio do chronionej aplikacji interfejsu API, użytkowników w tej samej dzierżawy usługi Azure AD można przejść do aplikacji interfejsu API, zaloguj się na i pomyślnie wywołać interfejs API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-159">If the Reply URL points directly to the protected API app, a user in the same Azure AD tenant could browse to the API app, log on, and successfully call the API.</span></span>

## <span data-ttu-id="5c82a-160"><a id="tutorialstart"></a>Kontynuowanie serii samouczek aplikacji interfejsu API programu .NET</span><span class="sxs-lookup"><span data-stu-id="5c82a-160"><a id="tutorialstart"></a> Continuing the .NET API Apps tutorial series</span></span>
<span data-ttu-id="5c82a-161">Jeśli korzystasz z serii samouczek środowiska Node.js lub Java dla aplikacji interfejsu API, przejdź do [następne kroki](#next-steps) sekcji.</span><span class="sxs-lookup"><span data-stu-id="5c82a-161">If you are following the Node.js or Java tutorial series for API apps, skip to the [Next steps](#next-steps) section.</span></span> 

<span data-ttu-id="5c82a-162">W dalszej części tego artykułu nadal serii samouczek aplikacji interfejsu API programu .NET i przyjęto założenie, że zostały wykonane [samouczek uwierzytelniania użytkownika](app-service-api-dotnet-user-principal-auth.md) i przykładowej aplikacji działających na platformie Azure z włączone uwierzytelnianie użytkownika.</span><span class="sxs-lookup"><span data-stu-id="5c82a-162">The remainder of this article continues the .NET API Apps tutorial series and assumes that you have completed the [user authentication tutorial](app-service-api-dotnet-user-principal-auth.md) and have the sample application running in Azure with user authentication enabled.</span></span>

## <a name="set-up-authentication-in-azure"></a><span data-ttu-id="5c82a-163">Konfigurowanie uwierzytelniania w systemie Azure</span><span class="sxs-lookup"><span data-stu-id="5c82a-163">Set up authentication in Azure</span></span>
<span data-ttu-id="5c82a-164">W tej sekcji można skonfigurować usługi aplikacji tak, aby tylko żądania HTTP, umożliwia uzyskanie aplikacji interfejsu API warstwy danych są tymi, które mają prawidłowy Azure AD tokenów elementu nośnego.</span><span class="sxs-lookup"><span data-stu-id="5c82a-164">In this section you configure App Service so that the only HTTP requests it allows to reach the data tier API app are the ones that have valid Azure AD bearer tokens.</span></span> 

<span data-ttu-id="5c82a-165">W poniższej sekcji skonfigurujesz aplikacji interfejsu API warstwy środkowej do wysyłania poświadczeń aplikacji do usługi Azure AD, wrócić tokenu elementu nośnego i Wyślij token elementu nośnego w aplikacji interfejsu API warstwy danych.</span><span class="sxs-lookup"><span data-stu-id="5c82a-165">In the following section, you configure the middle tier API app to send application credentials to Azure AD, get back a bearer token, and send the bearer token to the data tier API app.</span></span> <span data-ttu-id="5c82a-166">Ten proces przedstawiono na schemacie.</span><span class="sxs-lookup"><span data-stu-id="5c82a-166">This process is illustrated in the diagram.</span></span>

![Diagram uwierzytelniania usługi](./media/app-service-api-dotnet-service-principal-auth/appdiagram.png)

<span data-ttu-id="5c82a-168">Jeśli wystąpiły problemy podczas zgodnie z instrukcjami samouczka zobacz [Rozwiązywanie problemów](#troubleshooting) sekcji na końcu samouczka.</span><span class="sxs-lookup"><span data-stu-id="5c82a-168">If you run into problems while following the tutorial directions, see the [Troubleshooting](#troubleshooting) section at the end of the tutorial.</span></span> 

1. <span data-ttu-id="5c82a-169">W [portalu Azure](https://portal.azure.com/), przejdź do **ustawienia** bloku aplikacji interfejsu API, które utworzono dla aplikacji interfejsu API ToDoListDataAPI (warstwy danych), a następnie kliknij przycisk **ustawienia**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-169">In the [Azure portal](https://portal.azure.com/), navigate to the **Settings** blade of the API app that you created for the ToDoListDataAPI (data tier) API app, and then click **Settings**.</span></span>
2. <span data-ttu-id="5c82a-170">W **ustawienia** bloku znaleźć **funkcje** sekcji, a następnie kliknij przycisk **uwierzytelniania / autoryzacji**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-170">In the **Settings** blade, find the **Features** section, and then click **Authentication / Authorization**.</span></span>
   
    ![Uwierzytelnianie/autoryzację, w portalu Azure](./media/app-service-api-dotnet-user-principal-auth/features.png)
3. <span data-ttu-id="5c82a-172">W **uwierzytelniania / autoryzacji** bloku, kliknij przycisk **na**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-172">In the **Authentication / Authorization** blade, click **On**.</span></span>
4. <span data-ttu-id="5c82a-173">W **działania należy podjąć w przypadku nieuwierzytelnionego żądania** listy rozwijanej wybierz **Zaloguj się za pomocą usługi Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-173">In the **Action to take when request is not authenticated** drop-down list, select **Log in with Azure Active Directory**.</span></span>
   
    <span data-ttu-id="5c82a-174">To ustawienie powoduje, że usługi aplikacji w celu zapewnienia tylko uwierzytelnienia żądania reach aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-174">This is the setting that causes App Service to ensure that only authenticated requests reach the API app.</span></span> <span data-ttu-id="5c82a-175">Dla żądania, które mają tokenów elementu nośnego prawidłowe usługi aplikacji przekazuje tokeny wzdłuż w aplikacji interfejsu API i wypełnia nagłówków HTTP z często używanych oświadczeń do łatwo udostępnić te informacje w kodzie.</span><span class="sxs-lookup"><span data-stu-id="5c82a-175">For requests that have valid bearer tokens, App Service passes the tokens along to the API app and populates HTTP headers with commonly used claims to make that information more easily available to your code.</span></span>
5. <span data-ttu-id="5c82a-176">W obszarze **dostawców uwierzytelniania**, kliknij przycisk **usługi Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-176">Under **Authentication Providers**, click **Azure Active Directory**.</span></span>
   
    ![Blok uwierzytelniania/autoryzacji w portalu Azure](./media/app-service-api-dotnet-user-principal-auth/authblade.png)
6. <span data-ttu-id="5c82a-178">W **ustawień usługi Azure Active Directory** bloku, kliknij przycisk **Express**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-178">In the **Azure Active Directory Settings** blade, click **Express**.</span></span>
   
    <span data-ttu-id="5c82a-179">Z **Express** opcji Azure można automatycznie utworzyć aplikację AAD w usługi Azure AD [dzierżawy](https://msdn.microsoft.com/en-us/library/azure/jj573650.aspx#BKMK_WhatIsAnAzureADTenant).</span><span class="sxs-lookup"><span data-stu-id="5c82a-179">With the **Express** option Azure can automatically create an AAD application in your Azure AD [tenant](https://msdn.microsoft.com/en-us/library/azure/jj573650.aspx#BKMK_WhatIsAnAzureADTenant).</span></span> 
   
    <span data-ttu-id="5c82a-180">Nie masz utworzyć dzierżawcę, ponieważ każde konto Azure automatycznie ma jeden.</span><span class="sxs-lookup"><span data-stu-id="5c82a-180">You don't have to create a tenant, because every Azure account automatically has one.</span></span>
7. <span data-ttu-id="5c82a-181">W obszarze **tryb zarządzania**, kliknij przycisk **Utwórz nową aplikację usługi AD** Jeśli nie została jeszcze wybrana.</span><span class="sxs-lookup"><span data-stu-id="5c82a-181">Under **Management mode**, click **Create New AD App** if it isn't already selected.</span></span>
   
    <span data-ttu-id="5c82a-182">Podłącza portalu **tworzenie aplikacji** pole wprowadzania wartości domyślnej.</span><span class="sxs-lookup"><span data-stu-id="5c82a-182">The portal plugs the **Create App** input box with a default value.</span></span> <span data-ttu-id="5c82a-183">Domyślnie aplikacja Azure AD nosi nazwę taki sam jak w aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-183">By default, the Azure AD application is named the same as the API app.</span></span> <span data-ttu-id="5c82a-184">Jeśli wolisz, możesz wprowadzić inną nazwę.</span><span class="sxs-lookup"><span data-stu-id="5c82a-184">If you prefer, you can enter a different name.</span></span>
   
    ![Ustawienia usługi Azure AD](./media/app-service-api-dotnet-service-principal-auth/aadsettings.png)
   
    <span data-ttu-id="5c82a-186">**Uwaga**: Alternatywnie można użyć jednej usługi Azure AD aplikacji dla wywołania aplikacji interfejsu API i chronionej aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-186">**Note**: As an alternative, you could use a single Azure AD application for both the calling API app and the protected API app.</span></span> <span data-ttu-id="5c82a-187">W przypadku wybrania to alternatywne rozwiązanie nie jest wymagane **Utwórz nową aplikację usługi AD** opcji w tym miejscu, ponieważ utworzonej wcześniej w samouczku uwierzytelniania użytkownika aplikacji usługi Azure AD.</span><span class="sxs-lookup"><span data-stu-id="5c82a-187">If you chose that alternative, you would not need the **Create New AD App** option here because you already created an Azure AD application earlier in the user authentication tutorial.</span></span> <span data-ttu-id="5c82a-188">W tym samouczku użyjesz rozdzielenie aplikacji usługi Azure AD dla wywołania aplikacji interfejsu API i chronionej aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-188">For this tutorial, you'll use separate Azure AD applications for the calling API app and the protected API app.</span></span>
8. <span data-ttu-id="5c82a-189">Zanotuj wartość, która znajduje się w **tworzenie aplikacji** pole wprowadzania; będzie wyszukiwanie tej usługi AAD aplikacji w klasycznym portalu Azure później.</span><span class="sxs-lookup"><span data-stu-id="5c82a-189">Make a note of the value that is in the **Create App** input box; you'll look up this AAD application in the Azure classic portal later.</span></span>
9. <span data-ttu-id="5c82a-190">Kliknij przycisk **OK**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-190">Click **OK**.</span></span>
10. <span data-ttu-id="5c82a-191">W **uwierzytelniania / autoryzacji** bloku, kliknij przycisk **zapisać**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-191">In the **Authentication / Authorization** blade, click **Save**.</span></span>
    
    ![Klikanie pozycji Zapisz.](./media/app-service-api-dotnet-service-principal-auth/saveauth.png)
    
    <span data-ttu-id="5c82a-193">Usługi aplikacji — tworzy aplikację usługi Azure Active Directory z **adres URL logowania** i **adres URL odpowiedzi** automatycznie Ustaw adres URL aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-193">App Service creates an Azure Active Directory application with **Sign-on URL** and **Reply URL** automatically set to the URL of your API app.</span></span> <span data-ttu-id="5c82a-194">Ostatnie wartość włącza użytkowników w dzierżawie usługi AAD do logowania i dostępu do aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-194">The latter value enables users in your AAD tenant to log in and access the API app.</span></span>

### <a name="verify-that-the-api-app-is-protected"></a><span data-ttu-id="5c82a-195">Sprawdź, czy w aplikacji interfejsu API jest chroniony</span><span class="sxs-lookup"><span data-stu-id="5c82a-195">Verify that the API app is protected</span></span>
1. <span data-ttu-id="5c82a-196">W przeglądarce przejdź do adresu URL aplikacji interfejsu API: w **aplikacji interfejsu API** bloku w portalu Azure, kliknij łącze w obszarze **adres URL**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-196">In a browser go to the URL of the API app: in the **API app** blade in the Azure portal, click the link under **URL**.</span></span> 
   
    <span data-ttu-id="5c82a-197">Użytkownik zostanie przekierowany do ekran logowania, ponieważ nieuwierzytelnione żądania nie mogą nawiązać połączenia w aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-197">You are redirected to a login screen because unauthenticated requests are not allowed to reach the API app.</span></span> 
   
    <span data-ttu-id="5c82a-198">Jeśli w przeglądarce przejdź do interfejsu użytkownika programu Swagger, mogą już zarejestrowane przeglądarce — w takim przypadku otwórz sesję InPrivate lub Incognito okno i przejdź do adresu URL programu Swagger interfejsu użytkownika.</span><span class="sxs-lookup"><span data-stu-id="5c82a-198">If your browser does go to the Swagger UI, your browser might already be logged on -- in that case, open an InPrivate or Incognito window and go to the Swagger UI URL.</span></span>
2. <span data-ttu-id="5c82a-199">Zaloguj się przy użyciu poświadczeń użytkownika w dzierżawie usługi AAD.</span><span class="sxs-lookup"><span data-stu-id="5c82a-199">Log in with credentials of a user in your AAD tenant.</span></span>
   
   <span data-ttu-id="5c82a-200">Gdy użytkownik jest zalogowany, "został pomyślnie utworzony" strona jest wyświetlana w przeglądarce.</span><span class="sxs-lookup"><span data-stu-id="5c82a-200">When you're logged on, the "successfully created" page appears in the browser.</span></span>

## <a name="configure-the-todolistapi-project-to-acquire-and-send-the-azure-ad-token"></a><span data-ttu-id="5c82a-201">Konfigurowanie projektu ToDoListAPI nabywanie i Wyślij token usługi Azure AD</span><span class="sxs-lookup"><span data-stu-id="5c82a-201">Configure the ToDoListAPI project to acquire and send the Azure AD token</span></span>
<span data-ttu-id="5c82a-202">W tej sekcji możesz wykonać następujące zadania:</span><span class="sxs-lookup"><span data-stu-id="5c82a-202">In this section you do the following tasks:</span></span>

* <span data-ttu-id="5c82a-203">Dodaj kod w aplikacji interfejsu API warstwy środkowej, który używa poświadczeń aplikacji usługi Azure AD do uzyskania tokenu i wysyłania żądań HTTP do aplikacji interfejsu API warstwy danych.</span><span class="sxs-lookup"><span data-stu-id="5c82a-203">Add code in the middle tier API app that uses Azure AD application credentials to acquire a token and send it with HTTP requests to the data tier API app.</span></span>
* <span data-ttu-id="5c82a-204">Pobierz poświadczenia, które są potrzebne z usługi Azure AD.</span><span class="sxs-lookup"><span data-stu-id="5c82a-204">Get the credentials you need from Azure AD.</span></span>
* <span data-ttu-id="5c82a-205">Wprowadź poświadczenia w usłudze Azure App Service ustawienia środowiska środowiska uruchomieniowego w aplikacji interfejsu API warstwy środkowej.</span><span class="sxs-lookup"><span data-stu-id="5c82a-205">Enter the credentials into Azure App Service runtime environment settings in the middle tier API app.</span></span> 

### <a name="configure-the-todolistapi-project-to-acquire-and-send-the-azure-ad-token"></a><span data-ttu-id="5c82a-206">Konfigurowanie projektu ToDoListAPI nabywanie i Wyślij token usługi Azure AD</span><span class="sxs-lookup"><span data-stu-id="5c82a-206">Configure the ToDoListAPI project to acquire and send the Azure AD token</span></span>
<span data-ttu-id="5c82a-207">Wprowadź następujące zmiany w projekcie ToDoListAPI w programie Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="5c82a-207">Make the following changes in the ToDoListAPI project in Visual Studio.</span></span>

1. <span data-ttu-id="5c82a-208">Usuń znaczniki komentarza cały kod w *ServicePrincipal.cs* pliku.</span><span class="sxs-lookup"><span data-stu-id="5c82a-208">Uncomment all of the code in the *ServicePrincipal.cs* file.</span></span>
   
    <span data-ttu-id="5c82a-209">To jest kod, który używa biblioteki ADAL dla platformy .NET można uzyskać tokenu elementu nośnego usługi Azure AD.</span><span class="sxs-lookup"><span data-stu-id="5c82a-209">This is the code that uses ADAL for .NET to acquire the Azure AD bearer token.</span></span>  <span data-ttu-id="5c82a-210">Używa kilka wartości konfiguracji, które zostaną ustawione w środowisko uruchomieniowe platformy Azure później.</span><span class="sxs-lookup"><span data-stu-id="5c82a-210">It uses several configuration values that you'll set in the Azure runtime environment later.</span></span> <span data-ttu-id="5c82a-211">Oto kod:</span><span class="sxs-lookup"><span data-stu-id="5c82a-211">Here's the code:</span></span> 
   
        public static class ServicePrincipal
        {
            static string authority = ConfigurationManager.AppSettings["ida:Authority"];
            static string clientId = ConfigurationManager.AppSettings["ida:ClientId"];
            static string clientSecret = ConfigurationManager.AppSettings["ida:ClientSecret"];
            static string resource = ConfigurationManager.AppSettings["ida:Resource"];
   
            public static AuthenticationResult GetS2SAccessTokenForProdMSA()
            {
                return GetS2SAccessToken(authority, resource, clientId, clientSecret);
            }
   
            static AuthenticationResult GetS2SAccessToken(string authority, string resource, string clientId, string clientSecret)
            {
                var clientCredential = new ClientCredential(clientId, clientSecret);
                AuthenticationContext context = new AuthenticationContext(authority, false);
                AuthenticationResult authenticationResult = context.AcquireToken(
                    resource,
                    clientCredential);
                return authenticationResult;
            }
        }
   
    <span data-ttu-id="5c82a-212">**Uwaga:** ten kod wymaga biblioteki ADAL dla pakietu NuGet programu .NET (Microsoft.IdentityModel.Clients.ActiveDirectory), który jest już zainstalowany w projekcie.</span><span class="sxs-lookup"><span data-stu-id="5c82a-212">**Note:** This code requires the ADAL for .NET NuGet package (Microsoft.IdentityModel.Clients.ActiveDirectory), which is already installed in the project.</span></span> <span data-ttu-id="5c82a-213">W przypadku tego projektu zostały tworzenia od początku, trzeba zainstalować ten pakiet.</span><span class="sxs-lookup"><span data-stu-id="5c82a-213">If you were creating this project from scratch, you would have to install this package.</span></span> <span data-ttu-id="5c82a-214">Ten pakiet nie jest automatycznie instalowany przez szablon nowego projektu aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-214">This package is not automatically installed by the API app new-project template.</span></span>
2. <span data-ttu-id="5c82a-215">W *kontrolerów/ToDoListController*, Usuń komentarz kodu w `NewDataAPIClient` metodę, która dodaje token do HTTP żądań w nagłówku autoryzacji.</span><span class="sxs-lookup"><span data-stu-id="5c82a-215">In *Controllers/ToDoListController*, uncomment the code in the `NewDataAPIClient` method that adds the token to HTTP requests in the authorization header.</span></span>
   
        client.HttpClient.DefaultRequestHeaders.Authorization =
            new AuthenticationHeaderValue("Bearer", ServicePrincipal.GetS2SAccessTokenForProdMSA().AccessToken);
3. <span data-ttu-id="5c82a-216">Wdrażanie projektu ToDoListAPI.</span><span class="sxs-lookup"><span data-stu-id="5c82a-216">Deploy the ToDoListAPI project.</span></span> <span data-ttu-id="5c82a-217">(Kliknij projekt prawym przyciskiem myszy, a następnie kliknij przycisk **Publikuj > Publikuj**.)</span><span class="sxs-lookup"><span data-stu-id="5c82a-217">(Right-click the project, then click **Publish > Publish**.)</span></span>
   
    <span data-ttu-id="5c82a-218">Visual Studio wdroży projekt i otworzy w przeglądarce podstawowy adres URL aplikacji sieci web.</span><span class="sxs-lookup"><span data-stu-id="5c82a-218">Visual Studio deploys the project and opens a browser to the web app's base URL.</span></span> <span data-ttu-id="5c82a-219">Wyświetli stronę błędu 403, co jest zrozumiałe próbę przejść do podstawowego adresu URL interfejsu API sieci Web w przeglądarce.</span><span class="sxs-lookup"><span data-stu-id="5c82a-219">This will show a 403 error page, which is normal for an attempt to go to a Web API base URL from a browser.</span></span>
4. <span data-ttu-id="5c82a-220">Zamknij przeglądarkę.</span><span class="sxs-lookup"><span data-stu-id="5c82a-220">Close the browser.</span></span>

### <a name="get-azure-ad-configuration-values"></a><span data-ttu-id="5c82a-221">Pobiera wartości konfiguracji usługi Azure AD</span><span class="sxs-lookup"><span data-stu-id="5c82a-221">Get Azure AD configuration values</span></span>
1. <span data-ttu-id="5c82a-222">W [klasycznego portalu Azure](https://manage.windowsazure.com/), przejdź do **usługi Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-222">In the [Azure classic portal](https://manage.windowsazure.com/), go to **Azure Active Directory**.</span></span>
2. <span data-ttu-id="5c82a-223">Na **katalogu** kliknij dzierżawę usługi AAD.</span><span class="sxs-lookup"><span data-stu-id="5c82a-223">On the **Directory** tab, click your AAD tenant.</span></span>
3. <span data-ttu-id="5c82a-224">Kliknij przycisk **aplikacji > aplikacje Moja firma jest właścicielem**, a następnie kliknij znacznik wyboru.</span><span class="sxs-lookup"><span data-stu-id="5c82a-224">Click **Applications > Applications my company owns**, and then click the check mark.</span></span>
4. <span data-ttu-id="5c82a-225">Na liście aplikacji kliknij nazwę tego typu Azure utworzony po włączeniu uwierzytelniania dla aplikacji interfejsu API ToDoListDataAPI (warstwy danych).</span><span class="sxs-lookup"><span data-stu-id="5c82a-225">In the list of applications, click the name of the one that Azure created for you when you enabled authentication for the ToDoListDataAPI (data tier) API app.</span></span>
5. <span data-ttu-id="5c82a-226">Kliknij kartę **Konfiguracja**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-226">Click the **Configure** tab.</span></span>
6. <span data-ttu-id="5c82a-227">Kopiuj **identyfikator klienta** wartość i zapisz go w innym możesz pobrać go z później.</span><span class="sxs-lookup"><span data-stu-id="5c82a-227">Copy the **Client ID** value and save it someplace you can get it from later.</span></span> 
7. <span data-ttu-id="5c82a-228">Azure klasycznego portalu przejdź do listy **aplikacji Moja firma jest właścicielem**i kliknij utworzony dla aplikacji interfejsu API ToDoListAPI warstwy środkowej (utworzonym w poprzednim samouczek, nie można utworzyć aplikację AAD w tym samouczku).</span><span class="sxs-lookup"><span data-stu-id="5c82a-228">In the Azure classic portal go back to the list of **Applications my company owns**, and click the AAD application that you created for the middle tier ToDoListAPI API app (the one you created in the previous tutorial, not the one you created in this tutorial).</span></span>
8. <span data-ttu-id="5c82a-229">Kliknij kartę **Konfiguracja**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-229">Click the **Configure** tab.</span></span>
9. <span data-ttu-id="5c82a-230">Kopiuj **identyfikator klienta** wartość i zapisz go w innym możesz pobrać go z później.</span><span class="sxs-lookup"><span data-stu-id="5c82a-230">Copy the **Client ID** value and save it someplace you can get it from later.</span></span>
10. <span data-ttu-id="5c82a-231">W obszarze **klucze**, wybierz pozycję **1 rok** z **wybierz czas trwania** listy rozwijanej.</span><span class="sxs-lookup"><span data-stu-id="5c82a-231">Under **keys**, select **1 year** from the **Select duration** drop-down list.</span></span>
11. <span data-ttu-id="5c82a-232">Kliknij pozycję **Zapisz**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-232">Click **Save**.</span></span>
    
     ![Generowanie klucza aplikacji](./media/app-service-api-dotnet-service-principal-auth/genkey.png)
12. <span data-ttu-id="5c82a-234">Skopiuj wartość tego klucza i zapisz go w innym, które możesz pobrać go z później.</span><span class="sxs-lookup"><span data-stu-id="5c82a-234">Copy the key value and save it someplace you can get it from later.</span></span>
    
     ![Skopiuj nowy klucz aplikacji](./media/app-service-api-dotnet-service-principal-auth/genkeycopy.png)

### <a name="configure-azure-ad-settings-in-the-middle-tier-api-apps-runtime-environment"></a><span data-ttu-id="5c82a-236">Konfigurowanie ustawień usługi Azure AD w aplikacji interfejsu API warstwy środkowej środowiska uruchomieniowego</span><span class="sxs-lookup"><span data-stu-id="5c82a-236">Configure Azure AD settings in the middle tier API app's runtime environment</span></span>
1. <span data-ttu-id="5c82a-237">Przejdź do [portalu Azure](https://portal.azure.com/), a następnie przejdź do **aplikacji interfejsu API** bloku aplikacji interfejsu API, który jest hostem projektu TodoListAPI (warstwy środkowej).</span><span class="sxs-lookup"><span data-stu-id="5c82a-237">Go to the [Azure portal](https://portal.azure.com/), and then navigate to the **API App** blade for the API app that hosts the TodoListAPI (middle tier) project.</span></span>
2. <span data-ttu-id="5c82a-238">Kliknij kolejno pozycje **Ustawienia > Ustawienia aplikacji**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-238">Click **Settings > Application Settings**.</span></span>
3. <span data-ttu-id="5c82a-239">W **ustawień aplikacji** Dodaj następujące klucze i wartości:</span><span class="sxs-lookup"><span data-stu-id="5c82a-239">In the **App settings** section, add the following keys and values:</span></span>
   
   | <span data-ttu-id="5c82a-240">**Klucz**</span><span class="sxs-lookup"><span data-stu-id="5c82a-240">**Key**</span></span> | <span data-ttu-id="5c82a-241">IDA: urzędu</span><span class="sxs-lookup"><span data-stu-id="5c82a-241">ida:Authority</span></span> |
   | --- | --- |
   | <span data-ttu-id="5c82a-242">**Wartość**</span><span class="sxs-lookup"><span data-stu-id="5c82a-242">**Value**</span></span> |<span data-ttu-id="5c82a-243">https://login.microsoftonline.com/ {nazwa dzierżawy usługi Azure AD}</span><span class="sxs-lookup"><span data-stu-id="5c82a-243">https://login.microsoftonline.com/{your Azure AD tenant name}</span></span> |
   | <span data-ttu-id="5c82a-244">**Przykład**</span><span class="sxs-lookup"><span data-stu-id="5c82a-244">**Example**</span></span> |<span data-ttu-id="5c82a-245">https://login.microsoftonline.com/contoso.onmicrosoft.com</span><span class="sxs-lookup"><span data-stu-id="5c82a-245">https://login.microsoftonline.com/contoso.onmicrosoft.com</span></span> |
   
   | <span data-ttu-id="5c82a-246">**Klucz**</span><span class="sxs-lookup"><span data-stu-id="5c82a-246">**Key**</span></span> | <span data-ttu-id="5c82a-247">IDA: ClientId</span><span class="sxs-lookup"><span data-stu-id="5c82a-247">ida:ClientId</span></span> |
   | --- | --- |
   | <span data-ttu-id="5c82a-248">**Wartość**</span><span class="sxs-lookup"><span data-stu-id="5c82a-248">**Value**</span></span> |<span data-ttu-id="5c82a-249">Identyfikator klienta aplikacji wywołującej (warstwy środkowej - ToDoListAPI)</span><span class="sxs-lookup"><span data-stu-id="5c82a-249">Client ID of the calling application (middle tier - ToDoListAPI)</span></span> |
   | <span data-ttu-id="5c82a-250">**Przykład**</span><span class="sxs-lookup"><span data-stu-id="5c82a-250">**Example**</span></span> |<span data-ttu-id="5c82a-251">960adec2-b74a-484a-960adec2-b74a-484a</span><span class="sxs-lookup"><span data-stu-id="5c82a-251">960adec2-b74a-484a-960adec2-b74a-484a</span></span> |
   
   | <span data-ttu-id="5c82a-252">**Klucz**</span><span class="sxs-lookup"><span data-stu-id="5c82a-252">**Key**</span></span> | <span data-ttu-id="5c82a-253">IDA: ClientSecret</span><span class="sxs-lookup"><span data-stu-id="5c82a-253">ida:ClientSecret</span></span> |
   | --- | --- |
   | <span data-ttu-id="5c82a-254">**Wartość**</span><span class="sxs-lookup"><span data-stu-id="5c82a-254">**Value**</span></span> |<span data-ttu-id="5c82a-255">Klucz aplikacji z aplikacji wywołującej (warstwy środkowej - ToDoListAPI)</span><span class="sxs-lookup"><span data-stu-id="5c82a-255">App key of the calling application (middle tier - ToDoListAPI)</span></span> |
   | <span data-ttu-id="5c82a-256">**Przykład**</span><span class="sxs-lookup"><span data-stu-id="5c82a-256">**Example**</span></span> |<span data-ttu-id="5c82a-257">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span><span class="sxs-lookup"><span data-stu-id="5c82a-257">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span></span> |
   
   | <span data-ttu-id="5c82a-258">**Klucz**</span><span class="sxs-lookup"><span data-stu-id="5c82a-258">**Key**</span></span> | <span data-ttu-id="5c82a-259">IDA: zasobów</span><span class="sxs-lookup"><span data-stu-id="5c82a-259">ida:Resource</span></span> |
   | --- | --- |
   | <span data-ttu-id="5c82a-260">**Wartość**</span><span class="sxs-lookup"><span data-stu-id="5c82a-260">**Value**</span></span> |<span data-ttu-id="5c82a-261">Identyfikator klienta aplikacji o nazwie (- projekt ToDoListDataAPI warstwy danych)</span><span class="sxs-lookup"><span data-stu-id="5c82a-261">Client ID of the called application (data tier - ToDoListDataAPI)</span></span> |
   | <span data-ttu-id="5c82a-262">**Przykład**</span><span class="sxs-lookup"><span data-stu-id="5c82a-262">**Example**</span></span> |<span data-ttu-id="5c82a-263">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span><span class="sxs-lookup"><span data-stu-id="5c82a-263">e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8</span></span> |
   
    <span data-ttu-id="5c82a-264">**Uwaga**: dla `ida:Resource`, upewnij się, że używasz aplikacji o nazwie **identyfikator klienta** i nie jego **identyfikator URI aplikacji**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-264">**Note**: For `ida:Resource`, make sure you use the called application's **client ID** and not its **App ID URI**.</span></span>
   
    <span data-ttu-id="5c82a-265">`ida:ClientId`i `ida:Resource` są różne wartości w tym samouczku, ponieważ używasz oddzielnych applicaations usługi Azure AD dla warstwy środkowej i warstwy danych.</span><span class="sxs-lookup"><span data-stu-id="5c82a-265">`ida:ClientId` and `ida:Resource` are different values for this tutorial because you're using separate Azure AD applicaations for the middle tier and data tier.</span></span> <span data-ttu-id="5c82a-266">Przy użyciu pojedynczej aplikacji usługi Azure AD dla wywołania aplikacji interfejsu API i chronionej aplikacji interfejsu API będzie używać tej samej wartości w obu `ida:ClientId` i `ida:Resource`.</span><span class="sxs-lookup"><span data-stu-id="5c82a-266">If you were using a single Azure AD application for the calling API app and the protected API app, you would use the same value in both `ida:ClientId` and `ida:Resource`.</span></span>
   
    <span data-ttu-id="5c82a-267">Kod używa program Configuration Manager, aby uzyskać te wartości, więc może być przechowywany w pliku Web.config projektu lub środowisko uruchomieniowe platformy Azure.</span><span class="sxs-lookup"><span data-stu-id="5c82a-267">The code uses ConfigurationManager to get these values, so they could be stored in the project's Web.config file or in the Azure runtime environment.</span></span> <span data-ttu-id="5c82a-268">Po uruchomieniu aplikacji ASP.NET w usłudze Azure App Service ustawienia środowiska automatycznie zastąpić ustawienia z pliku Web.config.</span><span class="sxs-lookup"><span data-stu-id="5c82a-268">While an ASP.NET application is running in Azure App Service, environment settings automatically override settings from Web.config.</span></span> <span data-ttu-id="5c82a-269">Ustawienia środowiska są zwykle [bardziej bezpieczny sposób przechowywania informacji poufnych porównane do pliku Web.config](http://www.asp.net/identity/overview/features-api/best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure).</span><span class="sxs-lookup"><span data-stu-id="5c82a-269">Environment settings are generally a [more secure way to store sensitive information compared to a Web.config file](http://www.asp.net/identity/overview/features-api/best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure).</span></span>
4. <span data-ttu-id="5c82a-270">Kliknij pozycję **Zapisz**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-270">Click **Save**.</span></span>
   
    ![Klikanie pozycji Zapisz.](./media/app-service-api-dotnet-service-principal-auth/appsettings.png)

### <a name="test-the-application"></a><span data-ttu-id="5c82a-272">Testowanie aplikacji</span><span class="sxs-lookup"><span data-stu-id="5c82a-272">Test the application</span></span>
1. <span data-ttu-id="5c82a-273">W przeglądarce przejdź do adresu URL HTTPS aplikacji sieci web frontonu AngularJS.</span><span class="sxs-lookup"><span data-stu-id="5c82a-273">In a browser go to the HTTPS URL of the AngularJS front end web app.</span></span>
2. <span data-ttu-id="5c82a-274">Kliknij przycisk **listy zadań do wykonania** kartę i zaloguj się przy użyciu poświadczeń użytkownika w dzierżawie usługi Azure AD.</span><span class="sxs-lookup"><span data-stu-id="5c82a-274">Click the **To Do List** tab and log in with credentials for a user in your Azure AD tenant.</span></span> 
3. <span data-ttu-id="5c82a-275">Dodawanie elementów do wykonania, aby sprawdzić, czy aplikacja działa.</span><span class="sxs-lookup"><span data-stu-id="5c82a-275">Add to-do items to verify that the application is working.</span></span>
   
    ![Lista zadań do wykonania strony](./media/app-service-api-dotnet-service-principal-auth/mvchome.png)
   
    <span data-ttu-id="5c82a-277">Jeśli aplikacja nie działa zgodnie z oczekiwaniami, należy dokładnie sprawdzić wszystkie ustawienia, która została wprowadzona w portalu Azure.</span><span class="sxs-lookup"><span data-stu-id="5c82a-277">If the application doesn't work as expected, double-check all of the settings you entered in the Azure portal.</span></span> <span data-ttu-id="5c82a-278">Jeśli wszystkie ustawienia wydają się być poprawne, zobacz [Rozwiązywanie problemów](#troubleshooting) dalszej części tego samouczka.</span><span class="sxs-lookup"><span data-stu-id="5c82a-278">If all of the settings appear to be correct, see the [Troubleshooting](#troubleshooting) section later in this tutorial.</span></span>

## <a name="protect-the-api-app-from-browser-access"></a><span data-ttu-id="5c82a-279">Ochrona aplikacji interfejsu API przed dostępem przeglądarki</span><span class="sxs-lookup"><span data-stu-id="5c82a-279">Protect the API app from browser access</span></span>
<span data-ttu-id="5c82a-280">W tym samouczku utworzona oddzielna aplikacji usługi Azure AD dla aplikacji interfejsu API ToDoListDataAPI (warstwy danych).</span><span class="sxs-lookup"><span data-stu-id="5c82a-280">For this tutorial you created a separate Azure AD application for the ToDoListDataAPI (data tier) API app.</span></span> <span data-ttu-id="5c82a-281">Jak przedstawiono, gdy usługi aplikacji — tworzy aplikację usługi AAD, konfiguruje usługi AAD aplikacji w taki sposób, który umożliwia użytkownikowi przejdź do adresu URL aplikacji interfejsu API w przeglądarce i zaloguj się.</span><span class="sxs-lookup"><span data-stu-id="5c82a-281">As you've seen, when App Service creates an AAD application, it configures the AAD application in a way that enables a user to go to the API app's URL in a browser and log on.</span></span> <span data-ttu-id="5c82a-282">Oznacza to, że istnieje możliwość, że użytkownik końcowy w dzierżawie usługi Azure AD, nie tylko nazwę główną usługi, aby dostęp do interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-282">That means it's possible for an end user in your Azure AD tenant, not just a service principal, to access the API.</span></span> 

<span data-ttu-id="5c82a-283">Jeśli chcesz uniemożliwić dostęp za pomocą przeglądarki bez pisania żadnego kodu w chronionej aplikacji interfejsu API, można zmienić **adres URL odpowiedzi** w aplikacji AAD bazowy adres URL, aby różni się od aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-283">If you want to prevent browser access without writing any code in the protected API app, you can change the **Reply URL** in the AAD application so that it's different from the API app's base URL.</span></span> 

### <a name="disable-browser-access"></a><span data-ttu-id="5c82a-284">Wyłącz dostęp za pomocą przeglądarki</span><span class="sxs-lookup"><span data-stu-id="5c82a-284">Disable browser access</span></span>
1. <span data-ttu-id="5c82a-285">W portalu klasycznym **Konfiguruj** karcie dla aplikacji usługi AAD, który został utworzony dla TodoListService, zmień wartość w **adres URL odpowiedzi** pola tak, aby prawidłowy adres URL, ale nie adres URL aplikacji interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-285">In the classic portal's **Configure** tab for the AAD application that was created for the TodoListService, change the value in the **Reply URL** field so that it is a valid URL but not the API app's URL.</span></span>
2. <span data-ttu-id="5c82a-286">Kliknij pozycję **Zapisz**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-286">Click **Save**.</span></span>

### <a name="verify-browser-access-no-longer-works"></a><span data-ttu-id="5c82a-287">Sprawdź, czy dostęp za pomocą przeglądarki przestanie działać.</span><span class="sxs-lookup"><span data-stu-id="5c82a-287">Verify browser access no longer works</span></span>
<span data-ttu-id="5c82a-288">Wcześniej upewnieniu się, że można przejść do adresu URL aplikacji interfejsu API z poziomu przeglądarki logując się przy użyciu poświadczeń użytkownika.</span><span class="sxs-lookup"><span data-stu-id="5c82a-288">Earlier you verified that you can go to the API app URL from a browser by logging on with an individual user's credentials.</span></span> <span data-ttu-id="5c82a-289">W tej sekcji możesz sprawdzić, czy nie jest to możliwe.</span><span class="sxs-lookup"><span data-stu-id="5c82a-289">In this section, you verify that this is no longer possible.</span></span> 

1. <span data-ttu-id="5c82a-290">W nowym oknie przeglądarki przejdź do adresu URL aplikacji interfejsu API ponownie.</span><span class="sxs-lookup"><span data-stu-id="5c82a-290">In a new browser window, go to the URL of the API app again.</span></span>
2. <span data-ttu-id="5c82a-291">Zaloguj się po wyświetleniu monitu, aby to zrobić.</span><span class="sxs-lookup"><span data-stu-id="5c82a-291">Log in when prompted to do so.</span></span>
3. <span data-ttu-id="5c82a-292">Logowania zakończy się pomyślnie, ale prowadzi do strony błędu.</span><span class="sxs-lookup"><span data-stu-id="5c82a-292">Login succeeds but leads to an error page.</span></span>
   
    <span data-ttu-id="5c82a-293">Skonfigurowano usługi AAD aplikacji, aby użytkownicy w dzierżawie usługi AAD nie może zalogować się i dostęp do interfejsu API w przeglądarce.</span><span class="sxs-lookup"><span data-stu-id="5c82a-293">You've configured the AAD app so that users in the AAD tenant cannot log in and access the API from a browser.</span></span> <span data-ttu-id="5c82a-294">Można nadal dostęp do aplikacji interfejsu API przy użyciu tokenu głównej usługi, które można sprawdzić, przechodząc do adresu URL aplikacji sieci web i dodanie więcej elementów do wykonania.</span><span class="sxs-lookup"><span data-stu-id="5c82a-294">You can still access the API app by using a service principal token, which you can verify by going to the web app's URL and adding more to-do items.</span></span>

## <a name="restrict-access-to-a-particular-service-principal"></a><span data-ttu-id="5c82a-295">Ograniczanie dostępu do określonej usługi podmiot zabezpieczeń</span><span class="sxs-lookup"><span data-stu-id="5c82a-295">Restrict access to a particular service principal</span></span>
<span data-ttu-id="5c82a-296">Teraz każdego obiektu wywołującego, który można uzyskać token dla użytkownika lub nazwy głównej usługi w dzierżawie usługi Azure AD można wywołać w aplikacji interfejsu API TodoListDataAPI (warstwy danych).</span><span class="sxs-lookup"><span data-stu-id="5c82a-296">Right now, any caller that can get a token for a user or service principal in your Azure AD tenant can call the TodoListDataAPI (data tier) API app.</span></span> <span data-ttu-id="5c82a-297">Możesz upewnić się, że aplikacji interfejsu API warstwy danych akceptuje tylko wywołania z aplikacji interfejsu API (warstwy środkowej) TodoListAPI, a tylko z określoną usługą podmiot zabezpieczeń.</span><span class="sxs-lookup"><span data-stu-id="5c82a-297">You might want to make sure that the data tier API app only accepts calls from the TodoListAPI (middle tier) API app, and only from a particular service principal.</span></span> 

<span data-ttu-id="5c82a-298">Ograniczenia te można dodać, dodając kod do sprawdzania poprawności `appid` i `objectidentifier` oświadczenia na przychodzące wywołania.</span><span class="sxs-lookup"><span data-stu-id="5c82a-298">You can add these restrictions by adding code to validate the `appid` and `objectidentifier` claims on incoming calls.</span></span>

<span data-ttu-id="5c82a-299">W ramach tego samouczka należy umieścić kod, który sprawdza identyfikator aplikacji i usług identyfikator podmiotu zabezpieczeń bezpośrednio w akcji kontrolera.</span><span class="sxs-lookup"><span data-stu-id="5c82a-299">For this tutorial you put the code that validates app ID and service principal ID directly in your controller actions.</span></span>  <span data-ttu-id="5c82a-300">Alternatywy mają używać niestandardowego `Authorize` atrybutu lub w tej weryfikacji w uruchamiania sekwencje (np. oprogramowanie pośredniczące OWIN).</span><span class="sxs-lookup"><span data-stu-id="5c82a-300">Alternatives are to use a custom `Authorize` attribute or to do this validation in your startup sequences (e.g. OWIN middleware).</span></span> <span data-ttu-id="5c82a-301">Na przykład tych, zobacz [tej aplikacji przykładowej](https://github.com/mohitsriv/EasyAuthMultiTierSample/blob/master/MyDashDataAPI/Startup.cs).</span><span class="sxs-lookup"><span data-stu-id="5c82a-301">For an example of the latter, see [this sample application](https://github.com/mohitsriv/EasyAuthMultiTierSample/blob/master/MyDashDataAPI/Startup.cs).</span></span> 

<span data-ttu-id="5c82a-302">Wprowadź następujące zmiany w projekcie TodoListDataAPI.</span><span class="sxs-lookup"><span data-stu-id="5c82a-302">Make the following changes to the TodoListDataAPI project.</span></span>

1. <span data-ttu-id="5c82a-303">Otwórz *Controllers/TodoListController.cs* pliku.</span><span class="sxs-lookup"><span data-stu-id="5c82a-303">Open the *Controllers/TodoListController.cs* file.</span></span>
2. <span data-ttu-id="5c82a-304">Usuń znaczniki komentarza wierszy, które ustawić `trustedCallerClientId` i `trustedCallerServicePrincipalId`.</span><span class="sxs-lookup"><span data-stu-id="5c82a-304">Uncomment the lines that set `trustedCallerClientId` and `trustedCallerServicePrincipalId`.</span></span>
   
        private static string trustedCallerClientId = ConfigurationManager.AppSettings["todo:TrustedCallerClientId"];
        private static string trustedCallerServicePrincipalId = ConfigurationManager.AppSettings["todo:TrustedCallerServicePrincipalId"];
3. <span data-ttu-id="5c82a-305">Usuń znaczniki komentarza kod w metodzie CheckCallerId.</span><span class="sxs-lookup"><span data-stu-id="5c82a-305">Uncomment the code in the CheckCallerId method.</span></span> <span data-ttu-id="5c82a-306">Ta metoda jest wywoływana na początku każdej metody akcji w kontrolerze.</span><span class="sxs-lookup"><span data-stu-id="5c82a-306">This method is called at the start of every action method in the controller.</span></span> 
   
        private static void CheckCallerId()
        {
            string currentCallerClientId = ClaimsPrincipal.Current.FindFirst("appid").Value;
            string currentCallerServicePrincipalId = ClaimsPrincipal.Current.FindFirst("http://schemas.microsoft.com/identity/claims/objectidentifier").Value;
            if (currentCallerClientId != trustedCallerClientId || currentCallerServicePrincipalId != trustedCallerServicePrincipalId)
            {
                throw new HttpResponseException(new HttpResponseMessage { StatusCode = HttpStatusCode.Unauthorized, ReasonPhrase = "The appID or service principal ID is not the expected value." });
            }
        }
4. <span data-ttu-id="5c82a-307">Należy ponownie wdrożyć projekt ToDoListDataAPI w usłudze Azure App Service.</span><span class="sxs-lookup"><span data-stu-id="5c82a-307">Redeploy the ToDoListDataAPI project to Azure App Service.</span></span>
5. <span data-ttu-id="5c82a-308">W przeglądarce, kliknij polecenie Przejdź do adresu URL HTTPS aplikacji sieci web frontonu AngularJS, a na stronie głównej **listy zadań do wykonania** kartę.</span><span class="sxs-lookup"><span data-stu-id="5c82a-308">In your browser, go to the AngularJS front end web app's HTTPS URL, and in the home page click the **To Do List** tab.</span></span>
   
    <span data-ttu-id="5c82a-309">Aplikacja nie działa, ponieważ wywołania wewnętrznej kończą się niepowodzeniem.</span><span class="sxs-lookup"><span data-stu-id="5c82a-309">The application doesn't work because calls to the back end are failing.</span></span> <span data-ttu-id="5c82a-310">Nowy kod sprawdza rzeczywisty identyfikator appid i elemencie objectidentifier, ale nie ma jeszcze prawidłowych wartości w celu sprawdzania ich względem.</span><span class="sxs-lookup"><span data-stu-id="5c82a-310">The new code is checking actual appid and objectidentifier but it doesn't yet have the correct values to check them against.</span></span> <span data-ttu-id="5c82a-311">Przeglądarka konsoli narzędzi dla deweloperów zgłasza, że serwer zwrócił błąd HTTP 401.</span><span class="sxs-lookup"><span data-stu-id="5c82a-311">The browser Developer Tools Console reports that the server is returning an HTTP 401 error.</span></span>
   
    ![Błąd w Developer Tools konsoli](./media/app-service-api-dotnet-service-principal-auth/webapperror.png)
   
    <span data-ttu-id="5c82a-313">W poniższych krokach można skonfigurować oczekiwanych wartości.</span><span class="sxs-lookup"><span data-stu-id="5c82a-313">In the following steps you configure the expected values.</span></span>
6. <span data-ttu-id="5c82a-314">Przy użyciu programu PowerShell usługi Azure AD, pobrać wartości nazwy głównej usługi dla aplikacji usługi Azure AD, który został utworzony dla projektu TodoListWebApp.</span><span class="sxs-lookup"><span data-stu-id="5c82a-314">Using Azure AD PowerShell, get the value of the service principal for the Azure AD application that you created for the TodoListWebApp project.</span></span>
   
    <span data-ttu-id="5c82a-315">a.</span><span class="sxs-lookup"><span data-stu-id="5c82a-315">a.</span></span> <span data-ttu-id="5c82a-316">Aby uzyskać instrukcje dotyczące sposobu instalowania programu Azure PowerShell i nawiązać połączenia z subskrypcją, zobacz [przy użyciu programu Azure PowerShell z usługą Azure Resource Manager](../powershell-azure-resource-manager.md).</span><span class="sxs-lookup"><span data-stu-id="5c82a-316">For instructions on how to install Azure PowerShell and connect to your subscription, see [Using Azure PowerShell with Azure Resource Manager](../powershell-azure-resource-manager.md).</span></span>
   
    <span data-ttu-id="5c82a-317">b.</span><span class="sxs-lookup"><span data-stu-id="5c82a-317">b.</span></span> <span data-ttu-id="5c82a-318">Aby uzyskać listę podmiotów zabezpieczeń, usługi, należy wykonać `Login-AzureRmAccount` polecenia, a następnie `Get-AzureRmADServicePrincipal` polecenia.</span><span class="sxs-lookup"><span data-stu-id="5c82a-318">To get a list of service principals, execute the `Login-AzureRmAccount` command and then the `Get-AzureRmADServicePrincipal` command.</span></span>
   
    <span data-ttu-id="5c82a-319">c.</span><span class="sxs-lookup"><span data-stu-id="5c82a-319">c.</span></span> <span data-ttu-id="5c82a-320">Znajdź identyfikator obiektu dla nazwy głównej usługi aplikacji TodoListAPI i zapisać go w lokalizacji można skopiować z później.</span><span class="sxs-lookup"><span data-stu-id="5c82a-320">Find the objectid for the service principal of the TodoListAPI application, and save it in a location you can copy from later.</span></span>
7. <span data-ttu-id="5c82a-321">W portalu Azure przejdź do bloku aplikacji interfejsu API dla aplikacji interfejsu API, który wdrożony projekt ToDoListDataAPI w celu.</span><span class="sxs-lookup"><span data-stu-id="5c82a-321">In the Azure portal, navigate to the API app blade for the API app that you deployed the ToDoListDataAPI project to.</span></span>
8. <span data-ttu-id="5c82a-322">Kliknij przycisk **Ustawienia > Ustawienia aplikacji**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-322">Click **Settings > Application settings**.</span></span>
9. <span data-ttu-id="5c82a-323">W **ustawień aplikacji** Dodaj następujące klucze i wartości:</span><span class="sxs-lookup"><span data-stu-id="5c82a-323">In the **App settings** section, add the following keys and values:</span></span>
   
   | <span data-ttu-id="5c82a-324">**Klucz**</span><span class="sxs-lookup"><span data-stu-id="5c82a-324">**Key**</span></span> | <span data-ttu-id="5c82a-325">TODO:TrustedCallerServicePrincipalId</span><span class="sxs-lookup"><span data-stu-id="5c82a-325">todo:TrustedCallerServicePrincipalId</span></span> |
   | --- | --- |
   | <span data-ttu-id="5c82a-326">**Wartość**</span><span class="sxs-lookup"><span data-stu-id="5c82a-326">**Value**</span></span> |<span data-ttu-id="5c82a-327">Identyfikator podmiotu zabezpieczeń usługi wywołania aplikacji</span><span class="sxs-lookup"><span data-stu-id="5c82a-327">Service principal id of calling application</span></span> |
   | <span data-ttu-id="5c82a-328">**Przykład**</span><span class="sxs-lookup"><span data-stu-id="5c82a-328">**Example**</span></span> |<span data-ttu-id="5c82a-329">4f4a94a4-6f0d-4072-4f4a94a4-6f0d-4072</span><span class="sxs-lookup"><span data-stu-id="5c82a-329">4f4a94a4-6f0d-4072-4f4a94a4-6f0d-4072</span></span> |
   
   | <span data-ttu-id="5c82a-330">**Klucz**</span><span class="sxs-lookup"><span data-stu-id="5c82a-330">**Key**</span></span> | <span data-ttu-id="5c82a-331">TODO:TrustedCallerClientId</span><span class="sxs-lookup"><span data-stu-id="5c82a-331">todo:TrustedCallerClientId</span></span> |
   | --- | --- |
   | <span data-ttu-id="5c82a-332">**Wartość**</span><span class="sxs-lookup"><span data-stu-id="5c82a-332">**Value**</span></span> |<span data-ttu-id="5c82a-333">Identyfikator klienta aplikacji - skopiowane z aplikacji TodoListAPI usługi Azure AD podczas wywoływania</span><span class="sxs-lookup"><span data-stu-id="5c82a-333">Client ID of calling application - copied from the TodoListAPI Azure AD application</span></span> |
   | <span data-ttu-id="5c82a-334">**Przykład**</span><span class="sxs-lookup"><span data-stu-id="5c82a-334">**Example**</span></span> |<span data-ttu-id="5c82a-335">960adec2-b74a-484a-960adec2-b74a-484a</span><span class="sxs-lookup"><span data-stu-id="5c82a-335">960adec2-b74a-484a-960adec2-b74a-484a</span></span> |
10. <span data-ttu-id="5c82a-336">Kliknij pozycję **Zapisz**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-336">Click **Save**.</span></span>
    
     ![Klikanie pozycji Zapisz.](./media/app-service-api-dotnet-service-principal-auth/trustedcaller.png)
11. <span data-ttu-id="5c82a-338">W przeglądarce, wróć do adresu URL aplikacji sieci web, a na stronie głównej kliknij **listy zadań do wykonania** kartę.</span><span class="sxs-lookup"><span data-stu-id="5c82a-338">In your browser, return to the web app's URL, and in the home page click the **To Do List** tab.</span></span>
    
     <span data-ttu-id="5c82a-339">Teraz aplikacja działa zgodnie z oczekiwaniami, ponieważ aplikacja zaufany obiekt wywołujący identyfikator i identyfikator podmiotu zabezpieczeń usługi są oczekiwanych wartości.</span><span class="sxs-lookup"><span data-stu-id="5c82a-339">This time the application works as expected because the trusted caller app ID and service principal ID are the expected values.</span></span>
    
     ![Lista zadań do wykonania strony](./media/app-service-api-dotnet-service-principal-auth/mvchome.png)

## <a name="building-the-projects-from-scratch"></a><span data-ttu-id="5c82a-341">Kompilowanie projektów od podstaw</span><span class="sxs-lookup"><span data-stu-id="5c82a-341">Building the projects from scratch</span></span>
<span data-ttu-id="5c82a-342">Dwa projekty interfejsu API sieci Web zostały utworzone przy użyciu **aplikacji interfejsu API Azure** projektu szablonu i zastępowanie domyślnego kontrolera wartości z kontrolerem listy zadań.</span><span class="sxs-lookup"><span data-stu-id="5c82a-342">The two Web API projects were created by using the **Azure API App** project template and replacing the default Values controller with a ToDoList controller.</span></span> <span data-ttu-id="5c82a-343">Uzyskania tokeny podmiotu zabezpieczeń usługi Azure AD w projekcie ToDoListAPI [Active Directory Authentication Library (ADAL) dla platformy .NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory/) zainstalowano pakiet NuGet.</span><span class="sxs-lookup"><span data-stu-id="5c82a-343">For acquiring Azure AD service principal tokens in the ToDoListAPI project, the [Active Directory Authentication Library (ADAL) for .NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory/) NuGet package was installed.</span></span>

<span data-ttu-id="5c82a-344">Aby uzyskać informacje o sposobie tworzenia aplikacji jednostronicowej AngularJS z interfejsu API sieci Web wewnętrznej jak ToDoListAngular, zobacz [ręce w laboratorium: tworzenie jednej strony aplikacji JEDNOSTRONICOWEJ z interfejsu API sieci Web platformy ASP.NET i Angular.js](http://www.asp.net/web-api/overview/getting-started-with-aspnet-web-api/build-a-single-page-application-spa-with-aspnet-web-api-and-angularjs).</span><span class="sxs-lookup"><span data-stu-id="5c82a-344">For information about how to  create an AngularJS single-page application with a Web API back end like ToDoListAngular, see  [Hands On Lab: Build a Single Page Application (SPA) with ASP.NET Web API and Angular.js](http://www.asp.net/web-api/overview/getting-started-with-aspnet-web-api/build-a-single-page-application-spa-with-aspnet-web-api-and-angularjs).</span></span> <span data-ttu-id="5c82a-345">Aby uzyskać informacje o sposobie dodawania kod uwierzytelniania usługi Azure AD, zobacz [zabezpieczanie AngularJS jednej strony aplikacji za pomocą usługi Azure AD](../active-directory/active-directory-devquickstarts-angular.md).</span><span class="sxs-lookup"><span data-stu-id="5c82a-345">For information about how to add Azure AD authentication code, see [Securing AngularJS Single Page Apps with Azure AD](../active-directory/active-directory-devquickstarts-angular.md).</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="5c82a-346">Rozwiązywanie problemów</span><span class="sxs-lookup"><span data-stu-id="5c82a-346">Troubleshooting</span></span>
[!INCLUDE [troubleshooting](../../includes/app-service-api-auth-troubleshooting.md)]

* <span data-ttu-id="5c82a-347">Upewnij się, że użytkownik nie należy mylić (warstwy środkowej) ToDoListAPI i ToDoListDataAPI (warstwy danych).</span><span class="sxs-lookup"><span data-stu-id="5c82a-347">Make sure that you don't confuse ToDoListAPI (middle tier) and ToDoListDataAPI (data tier).</span></span> <span data-ttu-id="5c82a-348">Na przykład, w tym samouczku można dodać uwierzytelniania w aplikacji interfejsu API warstwy danych **, ale klucz aplikacji muszą pochodzić z aplikacji usługi Azure AD, który został utworzony dla aplikacji interfejsu API warstwy środkowej**.</span><span class="sxs-lookup"><span data-stu-id="5c82a-348">For example, in this tutorial you add authentication to the data tier API app, **but the app key must come from the Azure AD application that you created for the middle tier API app**.</span></span>

## <a name="next-steps"></a><span data-ttu-id="5c82a-349">Następne kroki</span><span class="sxs-lookup"><span data-stu-id="5c82a-349">Next steps</span></span>
<span data-ttu-id="5c82a-350">To jest ostatni samouczek w serii aplikacje interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="5c82a-350">This is the last tutorial in the API Apps series.</span></span> 

<span data-ttu-id="5c82a-351">Aby uzyskać więcej informacji na temat usługi Azure Active Directory zobacz następujące zasoby.</span><span class="sxs-lookup"><span data-stu-id="5c82a-351">For more information about Azure Active Directory, see the following resources.</span></span>

* [<span data-ttu-id="5c82a-352">Przewodnik Azure deweloperzy AD</span><span class="sxs-lookup"><span data-stu-id="5c82a-352">Azure AD developers' guide</span></span>](http://aka.ms/aaddev)
* [<span data-ttu-id="5c82a-353">Scenariusze usługi Azure AD</span><span class="sxs-lookup"><span data-stu-id="5c82a-353">Azure AD scenarios</span></span>](http://aka.ms/aadscenarios)
* [<span data-ttu-id="5c82a-354">Przykłady Azure AD</span><span class="sxs-lookup"><span data-stu-id="5c82a-354">Azure AD samples</span></span>](http://aka.ms/aadsamples)
  
    <span data-ttu-id="5c82a-355">[Aplikacji sieci Web-WebAPI-OAuth2-AppIdentity-DotNet](http://github.com/AzureADSamples/WebApp-WebAPI-OAuth2-AppIdentity-DotNet) próbki jest podobny do przedstawiono, w tym samouczku, ale bez korzystania z usługi aplikacji uwierzytelniania.</span><span class="sxs-lookup"><span data-stu-id="5c82a-355">The [WebApp-WebAPI-OAuth2-AppIdentity-DotNet](http://github.com/AzureADSamples/WebApp-WebAPI-OAuth2-AppIdentity-DotNet) sample is similar to what is shown in this tutorial, but without using App Service authentication.</span></span>

<span data-ttu-id="5c82a-356">Informacje o inne sposoby wdrażania projektów programu Visual Studio do aplikacji interfejsu API za pomocą programu Visual Studio lub [automatyzacji wdrażania](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) z [systemu kontroli źródła](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control), zobacz [sposobu wdrażania platformy Azure Aplikacji usługi app Service](../app-service-web/web-sites-deploy.md).</span><span class="sxs-lookup"><span data-stu-id="5c82a-356">For information about other ways to deploy Visual Studio projects to API apps, by using Visual Studio or by [automating deployment](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) from a [source control system](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control), see [How to deploy an Azure App Service app](../app-service-web/web-sites-deploy.md).</span></span>

