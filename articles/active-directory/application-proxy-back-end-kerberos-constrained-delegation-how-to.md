---
title: "Jak skonfigurować serwer Proxy aplikacji aplikacji na używanie ograniczone delegowanie protokołu Kerberos | Dokumentacja firmy Microsoft"
description: "Jak skonfigurować delegowanie ograniczone protokołu Kerberos dla aplikacji serwera Proxy aplikacji usługi Azure AD."
services: active-directory
documentationcenter: 
author: ajamess
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/11/2017
ms.author: asteen
ms.openlocfilehash: 3a768c30cb874d42d7b4fbd2eeaa6c0e23904e10
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 08/03/2017
---
# <a name="how-to-configure-an-application-proxy-application-to-use-kerberos-constrained-delegation"></a><span data-ttu-id="ba109-103">Jak skonfigurować serwer Proxy aplikacji aplikacji na używanie ograniczone delegowanie protokołu Kerberos</span><span class="sxs-lookup"><span data-stu-id="ba109-103">How to configure an Application Proxy application to use Kerberos Constrained Delegation</span></span>

<span data-ttu-id="ba109-104">Dostępne metody do osiągnięcia logowania jednokrotnego do aplikacji opublikowanych nieco może różnić się od aplikacji i jedną z opcji, że serwer Proxy aplikacji Azure oferuje zaraz po jego zainstalowaniu, jest delegowanie ograniczone protokołu Kerberos (KCD).</span><span class="sxs-lookup"><span data-stu-id="ba109-104">The methods available for achieving SSO to published applications can somewhat vary from application to application and one of the options that Azure Application Proxy offers right out of the box, is Kerberos Constrained Delegation (KCD).</span></span> <span data-ttu-id="ba109-105">Jest to, których hostem łącznika jest skonfigurowany do uwierzytelniania kerberos ograniczonego do wewnętrznej bazy danych aplikacji, w imieniu użytkowników.</span><span class="sxs-lookup"><span data-stu-id="ba109-105">This is where a connector host is configured to perform constrained kerberos authentication to backend applications, on behalf of users.</span></span>

<span data-ttu-id="ba109-106">Procedura włączania KCD jest stosunkowo prosta i zwykle wymaga nie więcej niż ogólną wiedzą z różnymi składnikami i przebieg uwierzytelniania, która ułatwia obsługę logowania jednokrotnego.</span><span class="sxs-lookup"><span data-stu-id="ba109-106">The actual procedure for enabling KCD is relatively straightforward and typically requires no more than a general understanding of the various components and authentication flow that facilitates SSO.</span></span> <span data-ttu-id="ba109-107">Znalezienie dobre źródła informacje ułatwiające rozwiązywanie problemów z scenariuszy, gdzie KCD logowania jednokrotnego nie działać zgodnie z oczekiwaniami, może być rozrzedzony.</span><span class="sxs-lookup"><span data-stu-id="ba109-107">Finding good sources of information to help troubleshoot scenarios where KCD SSO doesn’t function as expected, can be sparse.</span></span>

<span data-ttu-id="ba109-108">Tak próbuje zapewnia jeden punkt odniesienia, które powinny pomóc w Rozwiązywanie problemów i własnym rozwiązania niektórych typowych problemów, które przedstawiono w tym artykule.</span><span class="sxs-lookup"><span data-stu-id="ba109-108">As such, this article attempts to provide a single point of reference that should help troubleshoot and self-remediate some of the most common issues that we see.</span></span> <span data-ttu-id="ba109-109">W tym samym czasie oferują dodatkowe wskazówki dotyczące diagnozowania bardziej złożoną i plików implementacji.</span><span class="sxs-lookup"><span data-stu-id="ba109-109">At the same time offer additional guidance for diagnosing the more complex and troubled of implementation.</span></span>

<span data-ttu-id="ba109-110">należy pamiętać, że w tym artykule sprawia, że następujące założenia:</span><span class="sxs-lookup"><span data-stu-id="ba109-110">note that this article makes the following assumptions:</span></span>

-   <span data-ttu-id="ba109-111">Serwera Proxy aplikacji Azure została wdrożona jako na naszych [dokumentacji](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) i dostępu do aplikacji z systemem innym niż KCD działa zgodnie z oczekiwaniami.</span><span class="sxs-lookup"><span data-stu-id="ba109-111">Azure Application Proxy has been deployed as per our [documentation](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) and general access to non KCD applications is working as expected.</span></span>

-   <span data-ttu-id="ba109-112">Aplikacja docelowa opublikowanych zależy od usług IIS i przez firmę Microsoft implementacja protokołu kerberos.</span><span class="sxs-lookup"><span data-stu-id="ba109-112">The published target application is based on IIS and Microsoft’s implementation of kerberos.</span></span>

-   <span data-ttu-id="ba109-113">Host serwera i aplikacji znajdują się w jednej domenie usługi Active Directory.</span><span class="sxs-lookup"><span data-stu-id="ba109-113">The server and application hosts reside in a single Active Directory domain.</span></span> <span data-ttu-id="ba109-114">Szczegółowe informacje dotyczące wielu domen i lasów scenariusze można znaleźć w naszych [oficjalny dokument KCD](http://aka.ms/KCDPaper).</span><span class="sxs-lookup"><span data-stu-id="ba109-114">Detailed information on cross domain and forest scenarios can be found in our [KCD whitepaper](http://aka.ms/KCDPaper).</span></span>

-   <span data-ttu-id="ba109-115">Aplikacja podmiotu jest publikowana na platformie Azure dzierżawcy z wstępne uwierzytelnianie jest włączone, a użytkownicy mogą uwierzytelniać na platformie Azure za pośrednictwem uwierzytelnianie oparte na formularzach.</span><span class="sxs-lookup"><span data-stu-id="ba109-115">The subject application is published in an Azure tenant with pre-authentication enabled, and users are expected to authenticate to Azure via forms based authentication.</span></span> <span data-ttu-id="ba109-116">Scenariusze uwierzytelniania klienta sformatowanego nie są objęte w tym artykule, ale można dodać w pewnym momencie w przyszłości.</span><span class="sxs-lookup"><span data-stu-id="ba109-116">Rich client authentication scenarios are not covered by this article, but be added at some point in the future.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="ba109-117">Wymagania wstępne</span><span class="sxs-lookup"><span data-stu-id="ba109-117">Prerequisites</span></span>

<span data-ttu-id="ba109-118">Serwer Proxy aplikacji Azure można wdrożyć do niemal dowolnego typu infrastruktury lub środowiska i architektur bez wątpienia różnią się od organizacji.</span><span class="sxs-lookup"><span data-stu-id="ba109-118">Azure Application Proxy can be deployed into pretty much any type of infrastructure or environment and the architectures no doubt vary from organization to organization.</span></span> <span data-ttu-id="ba109-119">Jedną z najbardziej typowych przyczyn KCD powiązanych problemy nie jest środowisk, ale zamiast prostego niewłaściwa konfiguracji lub ogólne nadzoru.</span><span class="sxs-lookup"><span data-stu-id="ba109-119">One of the most common causes of KCD related issues are not the environments themselves, but rather simple mis-configurations, or general oversight.</span></span>

<span data-ttu-id="ba109-120">Z tego powodu informacjami jest zawsze najpierw upewnić się, czy zostały spełnione wszystkie wymagania wstępne określone w naszym głównym [przy użyciu logowania jednokrotnego KCD z artykułem serwera Proxy aplikacji](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) przed rozpoczęciem rozwiązywania problemów.</span><span class="sxs-lookup"><span data-stu-id="ba109-120">For this reason, our advice is always to start by making sure you have met all the pre-requisites laid out in our main [Using KCD SSO with the Application Proxy article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) before starting troubleshooting.</span></span>

<span data-ttu-id="ba109-121">Szczególnie sekcję na temat konfigurowania KCD na 2012 R2, jak to wykorzystuje podejście różni się w przypadku konfigurowania KCD w poprzednich wersjach systemu Windows, ale także będąc w trosce o kilka innych kwestii:</span><span class="sxs-lookup"><span data-stu-id="ba109-121">Particularly the section on configuring KCD on 2012R2, as this employs a fundamentally different approach to configuring KCD on previous versions of Windows, but also while being mindful of several other considerations:</span></span>

-   <span data-ttu-id="ba109-122">Nie jest często serwerem członkowskim domeny otworzyć okno dialogowe bezpiecznego kanału z określonego kontrolera domeny.</span><span class="sxs-lookup"><span data-stu-id="ba109-122">It is not uncommon for a domain member server to open a secure channel dialog with a specific domain controller.</span></span> <span data-ttu-id="ba109-123">Następnie przenieś innego okna dialogowego w dowolnym momencie, aby hosty łącznika zazwyczaj nie powinny być ograniczone do możliwość komunikacji z tylko określonej lokalnej lokacji kontrolerów domeny.</span><span class="sxs-lookup"><span data-stu-id="ba109-123">Then move to another dialog at any given time, so connector hosts should generally not be restricted to being able to communicate with only specific local site DCs.</span></span>

-   <span data-ttu-id="ba109-124">Podobnie jak powyżej punktu, obejmujące różne domeny, które scenariuszy zależą od odwołań, które bezpośrednie hostem łącznika do kontrolerów domeny, które mogą znajdować się poza lokalnej sieci obwodowej.</span><span class="sxs-lookup"><span data-stu-id="ba109-124">Similar to the above point, cross domain scenarios rely on referrals that direct a connector host to DCs that may reside outside of the local network perimeter.</span></span> <span data-ttu-id="ba109-125">W tym scenariuszu, który jest równie ważne upewnić się również umożliwi ruchu lub nowszej do kontrolerów domeny, które reprezentują innych domen lub innego delegowania zakończyć się niepowodzeniem.</span><span class="sxs-lookup"><span data-stu-id="ba109-125">In this scenario it is equally important to make sure you are also allowing traffic onwards to DCs that represent other respective domains, or else delegation fail.</span></span>

-   <span data-ttu-id="ba109-126">Jeśli to możliwe, należy unikać wprowadzania żadnych aktywnych urządzeń adresy IP/Identyfikatory między hostami łącznika i kontrolery domeny, jak te są czasami za pośrednictwem niepożądanych i zakłócić ruch RPC core</span><span class="sxs-lookup"><span data-stu-id="ba109-126">Where possible, you should avoid placing any active IPS/IDS devices between connector hosts and DCs, as these are sometimes over intrusive and interfere with core RPC traffic</span></span>

<span data-ttu-id="ba109-127">Tyle chcielibyśmy szybkie rozwiązywanie problemów i ostatecznie może trwać, dlatego w miarę możliwości należy spróbuj i przetestować delegowania w najprostszym scenariuszy.</span><span class="sxs-lookup"><span data-stu-id="ba109-127">As much as we’d like to resolve issues quickly and effectively, it can take time, so where possible you should try and test delegation in the simplest of scenarios.</span></span> <span data-ttu-id="ba109-128">Wprowadzenie więcej zmiennych, im bardziej może być konieczne będą konkurować o.</span><span class="sxs-lookup"><span data-stu-id="ba109-128">The more variables you introduce, the more you may have to contend with.</span></span> <span data-ttu-id="ba109-129">Na przykład ograniczając testowanie do pojedynczego łącznika można zapisać cenny czas i dodatkowe łączników można dodać po rozwiązaniu problemów.</span><span class="sxs-lookup"><span data-stu-id="ba109-129">For example, limiting your testing to a single connector can save valuable time, and additional connectors can be added after the issues has been resolved.</span></span>

<span data-ttu-id="ba109-130">Pewne czynniki środowiska może również być przyczyną problemu, więc ponownie Jeśli to możliwe spróbuj i zminimalizować architektury do minimum systemu od zera do testowania.</span><span class="sxs-lookup"><span data-stu-id="ba109-130">Some environmental factors may also be contributing to an issue, so again if possible try and minimize the architecture to a bare minimum for testing.</span></span> <span data-ttu-id="ba109-131">Na przykład nie są rzadko nieprawidłowej konfiguracji zapory wewnętrznej listy kontroli dostępu, więc jeśli to możliwe mieć cały ruch z łącznika może bezpośrednio za pomocą kontrolerów domeny i wewnętrznej bazy danych aplikacji.</span><span class="sxs-lookup"><span data-stu-id="ba109-131">For example, misconfigured internal firewall ACLs are not uncommon, so if possible have all traffic from a connector allowed straight through to the DCs and backend application.</span></span> 

<span data-ttu-id="ba109-132">Faktycznie bezwzględną najlepszym miejscem, aby umieścić łączniki zbliża się zgodnie z ich celów jako może być.</span><span class="sxs-lookup"><span data-stu-id="ba109-132">Actually the absolute best place to position connectors is as close to their targets as can be.</span></span> <span data-ttu-id="ba109-133">Wbudowany zapory nas o podczas testowania, po prostu dodaje niepotrzebne złożoność i właśnie przedłużyć czas badania sieci.</span><span class="sxs-lookup"><span data-stu-id="ba109-133">Having a firewall sat inline whilst testing simply adds unnecessary complexity, and could just prolong your investigations.</span></span>

<span data-ttu-id="ba109-134">Tak co stanowi KCD problem mimo to?</span><span class="sxs-lookup"><span data-stu-id="ba109-134">So, what constitutes a KCD problem anyway?</span></span> <span data-ttu-id="ba109-135">Dobrze istnieje kilka oznaczeń klasycznego KCD niepowodzeniem sesji rejestracji jednokrotnej i pierwszy objawy problemu zwykle pojawiają się w przeglądarce.</span><span class="sxs-lookup"><span data-stu-id="ba109-135">Well, there several classic indications of KCD SSO failing and the first signs of an issue usually manifest themselves in the browser.</span></span>

   ![Błąd konfiguracji KCD niepoprawne](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![Autoryzacja nie powiodła się z powodu brakujących uprawnień](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

<span data-ttu-id="ba109-138">wszystkie które posiadają tej samej objaw nie może wykonać logowanie Jednokrotne i w związku z tym odmowie dostępu użytkownika do aplikacji.</span><span class="sxs-lookup"><span data-stu-id="ba109-138">all which bear the same symptom of failing to perform SSO, and consequently denying the user access to the application.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="ba109-139">Rozwiązywanie problemów</span><span class="sxs-lookup"><span data-stu-id="ba109-139">Troubleshooting</span></span>

<span data-ttu-id="ba109-140">W jaki sposób można następnie Rozwiąż ten problem są zależne od problemu i obserwowanych objawów.</span><span class="sxs-lookup"><span data-stu-id="ba109-140">How you then troubleshoot depend on the issue and observed symptoms.</span></span> <span data-ttu-id="ba109-141">Przed każdym przechodzi dalsze czy Sugerujemy następujące łącza, ponieważ zawierają one przydatne informacje, które można mogą nie mieć wszedł między:</span><span class="sxs-lookup"><span data-stu-id="ba109-141">Before going any further we would suggest the following links, as they contain useful information you may not yet have come across:</span></span>

-   [<span data-ttu-id="ba109-142">Rozwiązywanie problemów z serwera Proxy aplikacji i komunikaty o błędach</span><span class="sxs-lookup"><span data-stu-id="ba109-142">Troubleshoot Application Proxy problems and error messages</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot)

-   [<span data-ttu-id="ba109-143">Błędy protokołu Kerberos i objawy</span><span class="sxs-lookup"><span data-stu-id="ba109-143">Kerberos errors and symptoms</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot#kerberos-errors)

-   [<span data-ttu-id="ba109-144">Praca z logowania jednokrotnego podczas lokalnej i w chmurze tożsamości nie są identyczne</span><span class="sxs-lookup"><span data-stu-id="ba109-144">Working with SSO when on-premises and cloud identities are not identical</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd#working-with-sso-when-on-premises-and-cloud-identities-are-not-identical)

<span data-ttu-id="ba109-145">Jeśli masz daleko, wówczas główny problem ostatecznie istnieje.</span><span class="sxs-lookup"><span data-stu-id="ba109-145">If you’ve got this far, then the main issue definitely exists.</span></span> <span data-ttu-id="ba109-146">Musisz szczegółowej analizy, więc uruchomienie oddzielając przepływu w trzech etapach distinct, które można rozwiązywać problemy.</span><span class="sxs-lookup"><span data-stu-id="ba109-146">You need to dig deeper, so start by separating the flow into three distinct stages that you can troubleshoot.</span></span>

<span data-ttu-id="ba109-147">**Wstępne uwierzytelnienie klienta** — użytkownika zewnętrznego, uwierzytelnianie na platformie Azure za pośrednictwem przeglądarki.</span><span class="sxs-lookup"><span data-stu-id="ba109-147">**Client pre-authentication** - The external user authenticating to Azure via a browser.</span></span>

<span data-ttu-id="ba109-148">Możliwość wstępnego uwierzytelniania na platformie Azure jest potrzeby logowania jednokrotnego KCD funkcji.</span><span class="sxs-lookup"><span data-stu-id="ba109-148">Being able to pre-authenticate to Azure is imperative for KCD SSO to function.</span></span> <span data-ttu-id="ba109-149">Powinno to przetestowane i skierowana najpierw, jeśli występują problemy.</span><span class="sxs-lookup"><span data-stu-id="ba109-149">This should be tested and addressed first, if there are any issues.</span></span> <span data-ttu-id="ba109-150">Należy pamiętać, etap uwierzytelniania wstępnego nie ma związku KCD lub opublikowanej aplikacji.</span><span class="sxs-lookup"><span data-stu-id="ba109-150">Note that the pre-authentication stage has no relation to KCD or the published application.</span></span> <span data-ttu-id="ba109-151">Powinny być dość łatwe naprawić niezgodności przez związane z poprawnością Sprawdzanie konta podmiot istnieje na platformie Azure i że nie jest ono wyłączone/blokowane.</span><span class="sxs-lookup"><span data-stu-id="ba109-151">It should be fairly easy to correct any discrepancies by sanity checking the subject account exists in Azure, and that it is not disabled/blocked.</span></span> <span data-ttu-id="ba109-152">Odpowiedzi na błąd w przeglądarce jest dość opisowa, że aby poznać przyczynę.</span><span class="sxs-lookup"><span data-stu-id="ba109-152">The error response in the browser is usually descriptive enough to understand the cause.</span></span> <span data-ttu-id="ba109-153">Nasze dokumenty rozwiązywanie można zweryfikować, jeśli nie masz pewności, możesz również sprawdzić.</span><span class="sxs-lookup"><span data-stu-id="ba109-153">You can also check our other Troubleshoot docs to verify if you aren’t sure.</span></span>

<span data-ttu-id="ba109-154">**Delegowanie usługi** — łącznika serwera Proxy Azure uzyskania biletu usługi z Centrum dystrybucji KLUCZY (Centrum dystrybucji protokołu Kerberos), protokołu kerberos w imieniu użytkowników.</span><span class="sxs-lookup"><span data-stu-id="ba109-154">**Delegation service** - The Azure Proxy connector obtaining a kerberos service ticket from a KDC (Kerberos Distribution Center), on behalf of users.</span></span>

<span data-ttu-id="ba109-155">Zewnętrzne komunikacji między klientem a Azure frontonu powinny nie ma wpływu na KCD, inne niż zapewnienia jego działanie.</span><span class="sxs-lookup"><span data-stu-id="ba109-155">The external communications between the client and the Azure front end should have no bearing on KCD whatsoever, other than ensuring that it works.</span></span> <span data-ttu-id="ba109-156">Jest to tak usługę serwera Proxy Azure można podać prawidłowy identyfikator które używane do uzyskania biletu kerberos.</span><span class="sxs-lookup"><span data-stu-id="ba109-156">This is so the Azure Proxy service can be provided with a valid user ID that be used to obtain a kerberos ticket.</span></span> <span data-ttu-id="ba109-157">Bez tego KCD nie jest możliwe, a nie powiedzie się.</span><span class="sxs-lookup"><span data-stu-id="ba109-157">Without this KCD is not possible and would fail.</span></span>

<span data-ttu-id="ba109-158">Jak wspomniano wcześniej, komunikaty o błędach przeglądarki zwykle zawierają niektóre dobrej wskazówek Dlaczego rzeczy kończą się niepowodzeniem.</span><span class="sxs-lookup"><span data-stu-id="ba109-158">As mentioned previously, the browser error messages usually provide some good clues on why things are failing.</span></span> <span data-ttu-id="ba109-159">Upewnij się, że należy zanotować identyfikator działania i sygnaturę czasową w odpowiedzi jako pozwalają służące do skorelowania zachowania rzeczywiste zdarzenia w dzienniku zdarzeń serwera Proxy usługi Azure.</span><span class="sxs-lookup"><span data-stu-id="ba109-159">Make sure to note down the activity ID and timestamp in the response as this allow you to correlate the behavior to actual events in the Azure Proxy event log.</span></span>

   ![Błąd konfiguracji KCD niepoprawne](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

<span data-ttu-id="ba109-161">I odpowiednie pozycje widoczne czy dziennik zdarzeń może być traktowany jako zdarzenia 13019 lub 12027.</span><span class="sxs-lookup"><span data-stu-id="ba109-161">And the corresponding entries seen the event log would be seen as events 13019 or 12027.</span></span> <span data-ttu-id="ba109-162">Można znaleźć w dziennikach zdarzeń łącznika **Dzienniki aplikacji i usług** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Łącznik**&gt;**Admin**.</span><span class="sxs-lookup"><span data-stu-id="ba109-162">You can find the connector event logs in **Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector**&gt;**Admin**.</span></span>

   ![Zdarzenie 13019 z dziennika zdarzeń serwera Proxy aplikacji](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![Zdarzenie 12027 z dziennika zdarzeń serwera Proxy aplikacji](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

-   <span data-ttu-id="ba109-165">Na użytek rekord A w systemie DNS wewnętrzny adres aplikacji, a nie rekordu CName</span><span class="sxs-lookup"><span data-stu-id="ba109-165">Use an A record in your internal DNS for the application’s address, and not a CName</span></span>

-   <span data-ttu-id="ba109-166">Ponownie upewnij się, że host łącznika przyznano uprawnienia do delegowania wyznaczone konto docelowe głównej nazwy usługi, a **Użyj dowolnego protokołu uwierzytelniania** jest zaznaczone.</span><span class="sxs-lookup"><span data-stu-id="ba109-166">Re-confirm that the connector host has been granted the rights to delegate to the designated target account’s SPN, and that **Use any authentication protocol** is selected.</span></span> <span data-ttu-id="ba109-167">Ten temat znajdują się w naszym głównym [artykułu konfiguracji logowania jednokrotnego](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span><span class="sxs-lookup"><span data-stu-id="ba109-167">This is covered in our main [SSO configuration article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span></span>

-   <span data-ttu-id="ba109-168">Sprawdź, czy jest tylko jedno wystąpienie SPN istniejących w AD przez wystawienie **setspn - x** z wiersza polecenia na żadnym hoście członek domeny</span><span class="sxs-lookup"><span data-stu-id="ba109-168">Verify that there is only a single instance of the SPN in existence in AD by issuing a **setspn -x** from a cmd prompt on any domain member host</span></span>

-   <span data-ttu-id="ba109-169">Sprawdź, czy zasady domeny jest wymuszany w celu ograniczenia [maksymalny rozmiar kerberos wystawionych tokenów](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), jak to uniemożliwienia łącznik uzyskania tokenu Jeśli okaże się zbyt</span><span class="sxs-lookup"><span data-stu-id="ba109-169">Check to see if a domain policy is being enforced to limit the [max size of issued kerberos tokens](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), as this prevent the connector from obtaining a token if found to be excessive</span></span>

<span data-ttu-id="ba109-170">Wymiany między hostem łącznika i domeny Centrum dystrybucji KLUCZY przechwytywania śledzenia sieci będzie wówczas następnego kroku najlepsze uzyskania bardziej niski poziom szczegółów dotyczących kwestii.</span><span class="sxs-lookup"><span data-stu-id="ba109-170">A network trace capturing the exchanges between the connector host and a domain KDC would then be the next best step in obtaining more low level detail on the issues.</span></span> <span data-ttu-id="ba109-171">Można je znaleźć w [nowości papieru rozwiązywanie](https://aka.ms/proxytshootpaper).</span><span class="sxs-lookup"><span data-stu-id="ba109-171">You can find this in [deep dive Troubleshoot paper](https://aka.ms/proxytshootpaper).</span></span>

<span data-ttu-id="ba109-172">Jeśli biletów wygląda dobrze, powinny pojawić się zdarzenia w dzienniku informujący o tym uwierzytelnianie nie powiodło się z powodu aplikacji zwracanie 401.</span><span class="sxs-lookup"><span data-stu-id="ba109-172">If ticketing looks good, you should see an event in the logs stating that authentication failed due to the application returning a 401.</span></span> <span data-ttu-id="ba109-173">Zwykle wskazuje, że aplikacja docelowa odrzucenia biletu, więc kontynuować następujące kolejnego etapu.</span><span class="sxs-lookup"><span data-stu-id="ba109-173">This typically indicates that the target application rejecting your ticket, so proceed with the following next stage.</span></span>

<span data-ttu-id="ba109-174">**Aplikacji docelowej** -konsumenta biletu kerberos udostępniane przez łącznik programu</span><span class="sxs-lookup"><span data-stu-id="ba109-174">**Target application** - The consumer of the kerberos ticket provided by the connector</span></span>

<span data-ttu-id="ba109-175">Na tym etapie łącznik powinien wysłali kerberos biletu usługi z zapleczem jako nagłówek w pierwszym żądaniu aplikacji.</span><span class="sxs-lookup"><span data-stu-id="ba109-175">At this stage the connector is expected to have sent a kerberos service ticket to the backend, as a header within the first application request.</span></span>

-   <span data-ttu-id="ba109-176">Przy użyciu wewnętrzny adres URL aplikacji zdefiniowano w portalu, zweryfikuj, że aplikacja jest dostępny bezpośrednio z przeglądarki na hoście łącznika.</span><span class="sxs-lookup"><span data-stu-id="ba109-176">Using the application’s internal URL defined in the portal, validate that the application is accessible directly from the browser on the connector host.</span></span> <span data-ttu-id="ba109-177">Następnie możesz zalogować się pomyślnie.</span><span class="sxs-lookup"><span data-stu-id="ba109-177">Then you can login successfully.</span></span> <span data-ttu-id="ba109-178">Szczegółowe informacje o tej czynności można znaleźć na stronie Rozwiązywanie problemów dotyczących łącznika.</span><span class="sxs-lookup"><span data-stu-id="ba109-178">Details on doing this can be found on the connector Troubleshoot page.</span></span>

-   <span data-ttu-id="ba109-179">Pracując nadal na hoście łącznika upewnij się, że uwierzytelniania między przeglądarką a aplikacja używa protokołu kerberos, wykonując jedną z następujących czynności:</span><span class="sxs-lookup"><span data-stu-id="ba109-179">Still on the connector host, confirm that the authentication between the browser and the application is using kerberos, by doing one of the following:</span></span>

1.  <span data-ttu-id="ba109-180">Uruchamianie narzędzi dla deweloperów (**F12**) w programie Internet Explorer lub użyj [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) z hosta łącznika.</span><span class="sxs-lookup"><span data-stu-id="ba109-180">Run Dev tools(**F12**) in Internet Explorer, or use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) from the connector host.</span></span> <span data-ttu-id="ba109-181">Przejdź do aplikacji przy użyciu wewnętrznego adresu URL i sprawdzić oferowany nagłówki autoryzacji WWW zwrócił w odpowiedzi z aplikacji, aby upewnić się, że negocjowania lub występuje protokołu kerberos.</span><span class="sxs-lookup"><span data-stu-id="ba109-181">Go to the application using the internal URL, and inspect the offered WWW authorization headers returned in the response from the application, to ensure that either negotiate or kerberos is present.</span></span> <span data-ttu-id="ba109-182">Obiektu blob kolejnych kerberos zwracany w odpowiedzi z przeglądarki do aplikacji zaczynają się zwykle **YII**, więc jest to dobry wskazanie protokołu kerberos w play.</span><span class="sxs-lookup"><span data-stu-id="ba109-182">A subsequent kerberos blob returned in the response from the browser to the application typically start with **YII**, so this is a good indication of kerberos being in play.</span></span> <span data-ttu-id="ba109-183">NTLM z drugiej strony zawsze rozpoczynają się **TlRMTVNTUAAB**, która odczytuje NTLMSSP podczas zdekodować z formatu Base64.</span><span class="sxs-lookup"><span data-stu-id="ba109-183">NTLM on the other hand always start with **TlRMTVNTUAAB**, which reads NTLMSSP when decoded from Base64.</span></span> <span data-ttu-id="ba109-184">Jeśli widzisz **TlRMTVNTUAAB** na początku obiektu blob, oznacza to, że protokół Kerberos jest **nie** dostępne.</span><span class="sxs-lookup"><span data-stu-id="ba109-184">If you see **TlRMTVNTUAAB** at the start of the blob, this means that Kerberos is **not** available.</span></span> <span data-ttu-id="ba109-185">Jeśli widzisz, prawdopodobnie Kerberos dostępne.</span><span class="sxs-lookup"><span data-stu-id="ba109-185">If you don’t see this, Kerberos is likely available.</span></span>

  * <span data-ttu-id="ba109-186">Uwaga: Jeśli przy użyciu programu Fiddler, ta metoda wymaga czasowo wyłączyć ochrona rozszerzona na konfiguracji aplikacji w usługach IIS.</span><span class="sxs-lookup"><span data-stu-id="ba109-186">Note, if using Fiddler, this method would require temporarily disabling extended protection on the application’s config in IIS.</span></span>

     ![Przeglądarce inspekcji sieci](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)

    <span data-ttu-id="ba109-188">*Rysunek:* ponieważ to nie rozpoczyna się od TIRMTVNTUAAB, jest to przykład, że protokół Kerberos jest dostępne.</span><span class="sxs-lookup"><span data-stu-id="ba109-188">*Figure:* Since this does not start with TIRMTVNTUAAB, this is an example that Kerberos is available.</span></span> <span data-ttu-id="ba109-189">To jest przykład obiektu Blob protokołu Kerberos, który nie zaczyna się od YII.</span><span class="sxs-lookup"><span data-stu-id="ba109-189">This is an example of a Kerberos Blob that doesn’t start with YII.</span></span>

2.  <span data-ttu-id="ba109-190">Z listy dostawców w lokacji i dostępu do aplikacji IIS bezpośrednio z programu Internet Explorer na hoście łącznika tymczasowe usunięcie NTLM.</span><span class="sxs-lookup"><span data-stu-id="ba109-190">Temporarily remove NTLM from the providers list on IIS site and access app directly from IE on connector host.</span></span> <span data-ttu-id="ba109-191">Z uwierzytelniania NTLM nie jest już na liście dostawców można uzyskać dostęp do aplikacji tylko przy użyciu protokołu Kerberos.</span><span class="sxs-lookup"><span data-stu-id="ba109-191">With NTLM no longer in the providers list, you should be able to access the application using Kerberos only.</span></span> <span data-ttu-id="ba109-192">Jeśli to się nie powiedzie, następnie które sugeruje, że występuje problem z konfiguracją aplikacji i uwierzytelnianie Kerberos nie działa.</span><span class="sxs-lookup"><span data-stu-id="ba109-192">If this fails, then that suggests that there is a problem with the application’s configuration and Kerberos authentication is not functioning.</span></span>

<span data-ttu-id="ba109-193">Czy protokołu Kerberos nie jest dostępna, negocjowania ustawienia uwierzytelniania aplikacji w usługach IIS, aby upewnić się, czy są dostępne najwyżej z NTLM tuż poniżej.</span><span class="sxs-lookup"><span data-stu-id="ba109-193">If Kerberos is not available, then check the application’s authentication settings in IIS to make sure negotiate is listed topmost, with NTLM just beneath it.</span></span> <span data-ttu-id="ba109-194">(Nie Negotiate: kerberos lub Negotiate: protokołu PKU2U).</span><span class="sxs-lookup"><span data-stu-id="ba109-194">(Not Negotiate:kerberos or Negotiate:PKU2U).</span></span> <span data-ttu-id="ba109-195">Nadal tylko, jeśli protokół Kerberos jest funkcjonalności.</span><span class="sxs-lookup"><span data-stu-id="ba109-195">Only continue if Kerberos is functional.</span></span>

   ![Dostawców uwierzytelniania systemu Windows](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
-   <span data-ttu-id="ba109-197">Z protokołu Kerberos i NTLM w miejscu umożliwia teraz tymczasowo wyłączyć wstępnego uwierzytelniania dla aplikacji w portalu.</span><span class="sxs-lookup"><span data-stu-id="ba109-197">With Kerberos and NTLM in place, lets now temporarily disable pre-authentication for the application in the portal.</span></span> <span data-ttu-id="ba109-198">Zobacz, czy można do niego dostęp z Internetu przy użyciu zewnętrznego adresu URL.</span><span class="sxs-lookup"><span data-stu-id="ba109-198">See if you can access it from the internet using the external URL.</span></span> <span data-ttu-id="ba109-199">Powinien być monitowani o uwierzytelnienie i powinno być możliwe w tym celu z kontem używanym w poprzednim kroku.</span><span class="sxs-lookup"><span data-stu-id="ba109-199">You should be prompted to authenticate and should be able to do so with the same account used in the previous step.</span></span> <span data-ttu-id="ba109-200">Jeśli nie, oznacza to problem z aplikacjami wewnętrznej bazy danych i nie KCD w ogóle.</span><span class="sxs-lookup"><span data-stu-id="ba109-200">If not, this indicates a problem with the backend application and not KCD at all.</span></span>

-   <span data-ttu-id="ba109-201">Teraz ponownie włączyć wstępnego uwierzytelniania w portalu i uwierzytelniania za pośrednictwem platformy Azure przez próby połączenia aplikacji za pomocą jego zewnętrznego adresu URL.</span><span class="sxs-lookup"><span data-stu-id="ba109-201">Now re-enable pre-authentication in the portal and authenticate through Azure by attempting to connect to the application via it’s external URL.</span></span> <span data-ttu-id="ba109-202">Logowanie Jednokrotne nie powiodło się, należy Zobacz niedozwolonych komunikat w przeglądarce, a także zdarzenie 13022 w dzienniku:</span><span class="sxs-lookup"><span data-stu-id="ba109-202">If SSO has failed, then you should see a forbidden error message in the browser, plus event 13022 in the log:</span></span>

    <span data-ttu-id="ba109-203">*Łącznik serwera Proxy aplikacji usługi Microsoft AAD nie może uwierzytelnić użytkownika, ponieważ serwer wewnętrznej bazy danych odpowiada prób uwierzytelnienia Kerberos z powodu błędu HTTP 401.*</span><span class="sxs-lookup"><span data-stu-id="ba109-203">*Microsoft AAD Application Proxy Connector cannot authenticate the user because the backend server responds to Kerberos authentication attempts with an HTTP 401 error.*</span></span>

    ![Dostęp zabroniony błąd 401 HTTTP](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)

-   <span data-ttu-id="ba109-205">Sprawdź, czy aplikacji usług IIS, aby upewnić się, pula aplikacji skonfigurowana jest skonfigurowany do używania tego samego konta, skonfigurowaną główną nazwę usługi przed w usłudze AD, przechodząc w usługach IIS, jak przedstawiono poniżej</span><span class="sxs-lookup"><span data-stu-id="ba109-205">Check the IIS application to ensure the configured application pool is configured to use the same account that the SPN has been configured against in AD, by navigating in IIS as illustrated below</span></span>

    ![Okno konfiguracji aplikacji usług IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)

    <span data-ttu-id="ba109-207">Jeśli znasz już tożsamości, należy wydać następujące polecenie w wierszu polecenia, aby upewnić się, że to konto jest ostatecznie skonfigurowany z tej nazwy SPN.</span><span class="sxs-lookup"><span data-stu-id="ba109-207">Once you know the identity, issue the following from a cmd prompt to make sure this account is definitely configured with the SPN in question.</span></span> <span data-ttu-id="ba109-208">Na przykład **setspn – q http/spn.wacketywack.com**</span><span class="sxs-lookup"><span data-stu-id="ba109-208">For example,  **setspn – q http/spn.wacketywack.com**</span></span>

    ![Okno polecenia SetSPN](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)

-   <span data-ttu-id="ba109-210">Sprawdź, czy nazwa SPN zdefiniowane w odniesieniu do ustawień aplikacji w portalu jest tej samej nazwy SPN skonfigurowanego przed docelowe AD konto używane przez puli aplikacji</span><span class="sxs-lookup"><span data-stu-id="ba109-210">Check that the SPN defined against the application’s settings in the portal is the same SPN that is configured against the target AD account in use by the application’s app pool</span></span>

   ![Konfiguracja SPN w portalu Azure](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
-   <span data-ttu-id="ba109-212">Przejdź do usług IIS i wybierz **edytora konfiguracji** opcję dla aplikacji, a następnie przejdź do **system.webServer/security/authentication/windowsAuthentication** do upewnij się, że  **UseAppPoolCredentials** jest ustawiona na wartość true</span><span class="sxs-lookup"><span data-stu-id="ba109-212">Go into IIS and select the **Configuration Editor** option for the application, and navigate to **system.webServer/security/authentication/windowsAuthentication** to make sure that **UseAppPoolCredentials** is set to true</span></span>

   ![Opcja credential pul aplikacji konfiguracji usług IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

<span data-ttu-id="ba109-214">Gdy są przydatne w zwiększanie wydajności operacji protokołu Kerberos, pozostawiając również włączono obsługę trybu jądra powoduje, że bilet żądanej usługi można odszyfrować za pomocą konta komputera.</span><span class="sxs-lookup"><span data-stu-id="ba109-214">While being useful in improving the performance of Kerberos operations, leaving Kernel mode enabled also causes the ticket for the requested service to be decrypted using machine account.</span></span> <span data-ttu-id="ba109-215">Jest to również system lokalny, więc po to ustawioną wartość true, podziału KCD w przypadku aplikacji znajduje się na wielu serwerach w farmie.</span><span class="sxs-lookup"><span data-stu-id="ba109-215">This is also called the Local system, so having this set to true break KCD when the application is hosted across multiple servers in a farm.</span></span>

-   <span data-ttu-id="ba109-216">Jako dodatkowe sprawdzanie może również chcesz wyłączyć **rozszerzone** ochrony zbyt.</span><span class="sxs-lookup"><span data-stu-id="ba109-216">As an additional check, you may also want to disable the **Extended** protection too.</span></span> <span data-ttu-id="ba109-217">Zostały napotkano scenariuszy, w którym to okazał się break KCD po włączeniu w bardzo określonej konfiguracji, gdy aplikacja jest publikowany jako podfolderem folderu domyślnej witryny sieci Web.</span><span class="sxs-lookup"><span data-stu-id="ba109-217">There have been encountered scenarios where this has proved to break KCD when enabled in very specific configurations, where an application is published as a sub folder of the Default Web site.</span></span> <span data-ttu-id="ba109-218">Ten sam jest skonfigurowany do uwierzytelniania anonimowego, pozostawiając całego okna dialogowe nieaktywna co sugeruje, że obiekty podrzędne nie będzie dziedziczy wszystkie aktywne ustawienia.</span><span class="sxs-lookup"><span data-stu-id="ba109-218">This itself is configured for Anonymous authentication only, leaving the entire dialogs greyed out suggesting child objects would not be inheriting any active settings.</span></span> <span data-ttu-id="ba109-219">Jednak gdy możliwości zawsze zalecamy posiadanie to włączone, więc wszelkimi środkami testu, ale nie zapomnij Przywróć tutaj, aby włączyć.</span><span class="sxs-lookup"><span data-stu-id="ba109-219">But where possible we would always recommend having this enabled, so by all means test, but don’t forget to restore this to enabled.</span></span>

<span data-ttu-id="ba109-220">Te dodatkowe kontrole powinny umieszczono należy na ścieżkę, aby rozpocząć korzystanie z opublikowanych aplikacji.</span><span class="sxs-lookup"><span data-stu-id="ba109-220">These additional checks should have put you on track to start using your published application.</span></span> <span data-ttu-id="ba109-221">Można teraz i aż dodatkowe łączniki, które także są skonfigurowane do delegowania, ale jeśli nie musisz kwestie następnie będzie Sugerujemy odczytu naszych bardziej szczegółowym opisem technicznym [kompletny przewodnik po dla serwera Proxy aplikacji usługi AD Rozwiązywanie problemów z platformy Azure](https://aka.ms/proxytshootpaper)</span><span class="sxs-lookup"><span data-stu-id="ba109-221">You can go ahead and spin up additional connectors that are also configured to delegate, but if things are no further then we would suggest a read of our more in-depth technical walkthrough [The complete guide for Troubleshoot Azure AD Application Proxy](https://aka.ms/proxytshootpaper)</span></span>

<span data-ttu-id="ba109-222">Jeśli nadal nie możesz się postęp problemu, pomocy technicznej będzie więcej niż przyjemnością pomóc i nadal w tym miejscu.</span><span class="sxs-lookup"><span data-stu-id="ba109-222">If you’re still unable to progress your issue, support would be more than happy to assist and continue from here.</span></span> <span data-ttu-id="ba109-223">Tworzenie biletu pomocy technicznej bezpośrednio z poziomu portalu i naszych inżynierów będzie dotrzeć do należy.</span><span class="sxs-lookup"><span data-stu-id="ba109-223">Create a support ticket directly within the portal and our engineers will reach out to you.</span></span>

## <a name="other-scenarios"></a><span data-ttu-id="ba109-224">Inne scenariusze</span><span class="sxs-lookup"><span data-stu-id="ba109-224">Other scenarios</span></span>

-   <span data-ttu-id="ba109-225">Serwer Proxy aplikacji Azure żąda biletu Kerberos przed wysłaniem żądania do aplikacji.</span><span class="sxs-lookup"><span data-stu-id="ba109-225">Azure Application Proxy requests a Kerberos ticket before sending its request to an application.</span></span> <span data-ttu-id="ba109-226">Niektóre 3 aplikacje firm, takich jak Tableau serwera nie chcesz, aby ta metoda uwierzytelniania, a raczej oczekuje więcej z konwencjonalnej negocjacji została wykonana.</span><span class="sxs-lookup"><span data-stu-id="ba109-226">Some 3rd party applications such as Tableau Server do not like this method of authenticating, and rather expects the more conventional negotiations to take place,.</span></span> <span data-ttu-id="ba109-227">Pierwsze żądanie jest anonimowe, co pozwala aplikacji na odpowiedź z typami uwierzytelniania obsługuje za pośrednictwem 401.</span><span class="sxs-lookup"><span data-stu-id="ba109-227">The first request is anonymous, allowing the application to respond with the authentication types that it supports through a 401.</span></span>

-   <span data-ttu-id="ba109-228">Podwójny przeskok uwierzytelnianie — często używane w scenariuszach, w którym warstwy aplikacji z wewnętrznej bazy danych i front end wymagające uwierzytelniania, takich jak SQL Reporting Services.</span><span class="sxs-lookup"><span data-stu-id="ba109-228">Double hop authentication - Commonly used in scenarios where an application is tiered, with a backend and front end, both requiring authentication, such as SQL Reporting Services.</span></span>

## <a name="next-steps"></a><span data-ttu-id="ba109-229">Następne kroki</span><span class="sxs-lookup"><span data-stu-id="ba109-229">Next steps</span></span>
[<span data-ttu-id="ba109-230">Skonfiguruj ograniczone delegowanie protokołu kerberos (KCD) do domeny zarządzanej</span><span class="sxs-lookup"><span data-stu-id="ba109-230">Configure kerberos constrained delegation (KCD) on a managed domain</span></span>](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-enable-kcd)
