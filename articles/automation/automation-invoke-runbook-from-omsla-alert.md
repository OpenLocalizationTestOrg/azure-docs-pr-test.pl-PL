---
title: "Wywoływanie elementu runbook usługi Azure Automation z alertu usługi Log Analytics | Microsoft Docs"
description: "Ten artykuł zawiera omówienie sposobu wywoływania elementu runbook usługi Automation z alertu usługi Microsoft OMS Log Analytics."
services: automation
documentationcenter: 
author: mgoedtel
manager: jwhit
editor: 
ms.assetid: 
ms.service: automation
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 01/31/2017
ms.author: magoedte
ms.openlocfilehash: 81cf490eae7f283c0180875cb3a2ed2ffe6333c8
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 07/11/2017
---
# <a name="calling-an-azure-automation-runbook-from-an-oms-log-analytics-alert"></a><span data-ttu-id="6a704-103">Wywoływanie elementu runbook usługi Azure Automation z alertu usługi OMS Log Analytics</span><span class="sxs-lookup"><span data-stu-id="6a704-103">Calling an Azure Automation runbook from an OMS Log Analytics alert</span></span>

<span data-ttu-id="6a704-104">W przypadku skonfigurowania w usłudze Log Analytics alertu do tworzenia rekordu alertu, gdy wyniki spełniają określone kryteria (takie jak długotrwały wzrost użycia procesora lub jeśli konkretny proces aplikacji o znaczeniu krytycznym dla funkcjonalności aplikacji biznesowej zakończy się niepowodzeniem i zapisze odpowiadające zdarzenie w dzienniku zdarzeń systemu Windows), alert ten może automatycznie uruchomić element runbook usługi Automation w celu podjęcia próby automatycznego rozwiązania problemu.</span><span class="sxs-lookup"><span data-stu-id="6a704-104">When an alert is configured in Log Analytics to create an alert record if results match a particular criteria, such as a prolonged spike in processor utilization or a particular application process critical to the functionality of a business application fails and writes a corresponding event in the Windows event log, that alert can automatically run an Automation runbook in an attempt to auto-remediate the issue.</span></span>  

<span data-ttu-id="6a704-105">Podczas konfigurowania alertu dostępne są dwie opcje wywołania elementu runbook.</span><span class="sxs-lookup"><span data-stu-id="6a704-105">There are two options to call a runbook when configuring the alert.</span></span>  <span data-ttu-id="6a704-106">Są to:</span><span class="sxs-lookup"><span data-stu-id="6a704-106">Specifically,</span></span>

1. <span data-ttu-id="6a704-107">Skorzystanie z elementu webhook.</span><span class="sxs-lookup"><span data-stu-id="6a704-107">Using a Webhook.</span></span>
   * <span data-ttu-id="6a704-108">To jedyna dostępna opcja w przypadku, gdy obszar roboczy pakietu OMS nie jest połączony z kontem usługi Automation.</span><span class="sxs-lookup"><span data-stu-id="6a704-108">This is the only option available if your OMS workspace is not linked to an Automation account.</span></span>
   * <span data-ttu-id="6a704-109">Jeśli masz już konto usługi Automation połączone z obszarem roboczym pakietu OMS, ta opcja będzie nadal dostępna.</span><span class="sxs-lookup"><span data-stu-id="6a704-109">If you already have an Automation account linked to an OMS workspace, this option is still available.</span></span>  

2. <span data-ttu-id="6a704-110">Bezpośrednie wybranie elementu runbook.</span><span class="sxs-lookup"><span data-stu-id="6a704-110">Select a runbook directly.</span></span>
   * <span data-ttu-id="6a704-111">Ta opcja jest dostępna tylko po połączeniu obszaru roboczego pakietu OMS z kontem usługi Automation.</span><span class="sxs-lookup"><span data-stu-id="6a704-111">This option is available only when the OMS workspace is linked to an Automation account.</span></span>  

## <a name="calling-a-runbook-using-a-webhook"></a><span data-ttu-id="6a704-112">Wywoływanie elementu runbook przy użyciu elementu webhook</span><span class="sxs-lookup"><span data-stu-id="6a704-112">Calling a runbook using a webhook</span></span>

<span data-ttu-id="6a704-113">Element webhook umożliwia uruchomienie określonego elementu runbook w usłudze Azure Automation za pośrednictwem pojedynczego żądania HTTP.</span><span class="sxs-lookup"><span data-stu-id="6a704-113">A webhook allows you to start a particular runbook in Azure Automation through a single HTTP request.</span></span>  <span data-ttu-id="6a704-114">Zanim skonfigurujesz [alert usługi Log Analytics](../log-analytics/log-analytics-alerts.md#alert-rules) do wywoływania elementu runbook za pomocą elementu webhook jako akcji alertu, musisz najpierw utworzyć element webhook dla elementu runbook, który będzie wywoływany przy użyciu tej metody.</span><span class="sxs-lookup"><span data-stu-id="6a704-114">Before configuring the [Log Analytics alert](../log-analytics/log-analytics-alerts.md#alert-rules) to call the runbook using a webhook as an alert action, you will need to first create a webhook for the runbook that will be called using this method.</span></span>  <span data-ttu-id="6a704-115">Przejrzyj i wykonaj kroki podane w artykule dotyczącym [tworzenia elementu webhook](automation-webhooks.md#creating-a-webhook). Pamiętaj o zapisaniu adresu URL elementu webhook, aby podać go podczas konfigurowania reguły alertu.</span><span class="sxs-lookup"><span data-stu-id="6a704-115">Review and follow the steps in the [create a webhook](automation-webhooks.md#creating-a-webhook) article and remember to record the webhook URL so that you can reference it while configuring the alert rule.</span></span>   

## <a name="calling-a-runbook-directly"></a><span data-ttu-id="6a704-116">Bezpośrednie uruchamianie elementu runbook</span><span class="sxs-lookup"><span data-stu-id="6a704-116">Calling a runbook directly</span></span>

<span data-ttu-id="6a704-117">Jeśli w obszarze roboczym pakietu OMS masz zainstalowaną i skonfigurowaną usługę Automation & Control, podczas konfigurowania opcji akcji elementu runbook dla alertu możesz wyświetlić wszystkie elementy runbook na liście rozwijanej **Wybierz element runbook** i wybrać konkretny element runbook, który ma być uruchamiany w odpowiedzi na alert.</span><span class="sxs-lookup"><span data-stu-id="6a704-117">If you have the Automation & Control offering installed and configured in your OMS workspace, when configuring the Runbook actions option for the alert, you can view all runbooks from the **Select a runbook** dropdown list and select the specific runbook you want to run in response to the alert.</span></span>  <span data-ttu-id="6a704-118">Wybrany element runbook można uruchomić w przestrzeni roboczej w chmurze platformy Azure lub w hybrydowym procesie roboczym elementu runbook.</span><span class="sxs-lookup"><span data-stu-id="6a704-118">The selected runbook can run in a workspace in the Azure cloud or on a hybrid runbook worker.</span></span>  <span data-ttu-id="6a704-119">Po utworzeniu alertu przy użyciu opcji elementu runbook dla elementu runbook zostanie utworzony element webhook.</span><span class="sxs-lookup"><span data-stu-id="6a704-119">When the alert is created using the runbook option, a webhook will be created for the runbook.</span></span>  <span data-ttu-id="6a704-120">Element webhook można wyświetlić po przejściu do konta usługi Automation i do bloku elementu webhook wybranego elementu runbook.</span><span class="sxs-lookup"><span data-stu-id="6a704-120">You can see the webhook if you go to the Automation account and navigate to the webhook blade of the selected runbook.</span></span>  <span data-ttu-id="6a704-121">W przypadku usunięcia alertu element webhook nie zostanie usunięty, jednak użytkownik może usunąć element webhook ręcznie.</span><span class="sxs-lookup"><span data-stu-id="6a704-121">If you delete the alert, the webhook is not deleted, but the user can delete the webhook manually.</span></span>  <span data-ttu-id="6a704-122">Nieusunięcie elementu webhook nie stanowi problemu — będzie on po prostu elementem oddzielonym, który ostatecznie trzeba będzie usunąć w celu utrzymania uporządkowanego konta usługi Automation.</span><span class="sxs-lookup"><span data-stu-id="6a704-122">It is not a problem if the webhook is not deleted, it is just an orphaned item that will eventually need to be deleted in order to maintain an organized Automation account.</span></span>  

## <a name="characteristics-of-a-runbook-for-both-options"></a><span data-ttu-id="6a704-123">Właściwości elementu runbook (w przypadku obu opcji)</span><span class="sxs-lookup"><span data-stu-id="6a704-123">Characteristics of a runbook (for both options)</span></span>

<span data-ttu-id="6a704-124">Obie metody wywoływania elementu runbook z poziomu alertu usługi Log Analytics cechują się innym zachowaniem, które należy zrozumieć przed skonfigurowaniem reguł alertu.</span><span class="sxs-lookup"><span data-stu-id="6a704-124">Both methods for calling the runbook from the Log Analytics alert have different behavior characteristics that need to be understood before you configure your alert rules.</span></span>  

* <span data-ttu-id="6a704-125">Musisz mieć parametr wejściowy elementu runbook o nazwie **WebhookData**, którego typ to **Obiekt**.</span><span class="sxs-lookup"><span data-stu-id="6a704-125">You must have a runbook input parameter called **WebhookData** that is **Object** type.</span></span>  <span data-ttu-id="6a704-126">Może on być wymagany lub opcjonalny.</span><span class="sxs-lookup"><span data-stu-id="6a704-126">It can be mandatory or optional.</span></span>  <span data-ttu-id="6a704-127">Przy użyciu tego parametru wejściowego alert przekazuje wyniki wyszukiwania do elementu runbook.</span><span class="sxs-lookup"><span data-stu-id="6a704-127">The alert passes the search results to the runbook using this input parameter.</span></span>

        param  
         (  
          [Parameter (Mandatory=$true)]  
          [object] $WebhookData  
         )

*  <span data-ttu-id="6a704-128">Musisz mieć kod konwertujący parametr WebhookData na obiekt programu PowerShell.</span><span class="sxs-lookup"><span data-stu-id="6a704-128">You must have code to convert the WebhookData to a PowerShell object.</span></span>

    `$SearchResults = (ConvertFrom-Json $WebhookData.RequestBody).SearchResults.value`

    <span data-ttu-id="6a704-129">Element *$SearchResults* będzie tablicą obiektów; każdy obiekt zawiera pola z wartościami z jednego wyniku wyszukiwania</span><span class="sxs-lookup"><span data-stu-id="6a704-129">*$SearchResults* will be an array of objects; each object contains the fields with values from one search result</span></span>

### <a name="webhookdata-inconsistencies-between-the-webhook-option-and-runbook-option"></a><span data-ttu-id="6a704-130">Niespójności parametru WebhookData między opcją elementu webhook a opcją elementu runbook</span><span class="sxs-lookup"><span data-stu-id="6a704-130">WebhookData inconsistencies between the webhook option and runbook option</span></span>

* <span data-ttu-id="6a704-131">Podczas konfigurowania alertu do wywoływania elementu webhook wprowadź adres URL elementu webhook utworzonego dla elementu runbook i kliknij przycisk **Przetestuj element webhook**.</span><span class="sxs-lookup"><span data-stu-id="6a704-131">When configuring an alert to call a Webhook, enter a webhook URL you created for a runbook, and click the **Test Webhook** button.</span></span>  <span data-ttu-id="6a704-132">Wynikowy parametr WebhookData przesłany do elementu runbook nie zawiera elementu *.SearchResult* ani *.SearchResults*.</span><span class="sxs-lookup"><span data-stu-id="6a704-132">The resulting WebhookData sent to the runbook does not contain either *.SearchResult* or *.SearchResults*.</span></span>

*  <span data-ttu-id="6a704-133">W przypadku zapisania tego alertu, gdy alert zostanie wyzwolony i wywoła element webhook, przesłany do elementu runbook parametr WebhookData będzie zawierać element *.SearchResult*.</span><span class="sxs-lookup"><span data-stu-id="6a704-133">If you save that alert, when the alert triggers and calls the webhook, the WebhookData sent to the runbook contains *.SearchResult*.</span></span>
* <span data-ttu-id="6a704-134">W przypadku utworzenia alertu i skonfigurowania go do wywoływania elementu runbook (który również tworzy element webhook) wyzwolony alert wysyła parametr WebhookData do elementu runbook, który zawiera element *.SearchResults*.</span><span class="sxs-lookup"><span data-stu-id="6a704-134">If you create an alert, and configure it to call a runbook (which also creates a webhook), when the alert triggers it sends WebhookData to the runbook that contains *.SearchResults*.</span></span>

<span data-ttu-id="6a704-135">W związku z tym w powyższym przykładzie kodu należy pobrać element *.SearchResult*, jeśli alert wywołuje element webhook, bądź element *.SearchResults*, jeśli alert wywołuje element runbook bezpośrednio.</span><span class="sxs-lookup"><span data-stu-id="6a704-135">Thus in the code example above, you will need to get *.SearchResult* if the alert calls a webhook, and will need to get *.SearchResults* if the alert calls a runbook directly.</span></span>

## <a name="example-walkthrough"></a><span data-ttu-id="6a704-136">Przykładowy przewodnik</span><span class="sxs-lookup"><span data-stu-id="6a704-136">Example walkthrough</span></span>

<span data-ttu-id="6a704-137">Pokażemy, jak to działa, korzystając z następującego przykładowego graficznego elementu runbook, który uruchamia usługę systemu Windows.</span><span class="sxs-lookup"><span data-stu-id="6a704-137">We will demonstrate how this works by using the following example graphical runbook, which starts a Windows service.</span></span><br><br> ![Graficzny element runbook uruchamiający usługę systemu Windows](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice.png)<br>

<span data-ttu-id="6a704-139">Ten element runbook ma jeden parametr wejściowy typu **Obiekt** o nazwie **WebhookData** i zawiera dane elementu webhook przekazane z alertu zawierającego element *.SearchResults*.</span><span class="sxs-lookup"><span data-stu-id="6a704-139">The runbook has one input parameter of type **Object** that is called **WebhookData** and includes the webhook data passed from the alert containing *.SearchResults*.</span></span><br><br> <span data-ttu-id="6a704-140">![Parametry wejściowe elementu runbook](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice-inputparameter.png)</span><span class="sxs-lookup"><span data-stu-id="6a704-140">![Runbook input parameters](media/automation-invoke-runbook-from-omsla-alert/automation-runbook-restartservice-inputparameter.png)</span></span><br>

<span data-ttu-id="6a704-141">Na potrzeby tego przykładu w usłudze Log Analytics utworzyliśmy dwa pola niestandardowe, *SvcDisplayName_CF* i *SvcState_CF*, w celu wyodrębnienia nazwy wyświetlanej usługi i stanu usługi (uruchomiona lub zatrzymana) ze zdarzenia zapisanego w dzienniku zdarzeń systemu.</span><span class="sxs-lookup"><span data-stu-id="6a704-141">For this example, in Log Analytics we created two custom fields, *SvcDisplayName_CF* and *SvcState_CF*, to extract the service display name and the state of the service (i.e. running or stopped) from the event written to the System event log.</span></span>  <span data-ttu-id="6a704-142">Następnie tworzymy regułę alertu z następującym zapytaniem wyszukiwania: `Type=Event SvcDisplayName_CF="Print Spooler" SvcState_CF="stopped"`, dzięki czemu możemy wykryć, kiedy usługa Print Spooler zostanie zatrzymana w systemie Windows.</span><span class="sxs-lookup"><span data-stu-id="6a704-142">We then create an alert rule with the following search query: `Type=Event SvcDisplayName_CF="Print Spooler" SvcState_CF="stopped"` so that we can detect when the Print Spooler service is stopped on the Windows system.</span></span>  <span data-ttu-id="6a704-143">Może być to dowolna interesująca nas usługa, ale w tym przykładzie odwołujemy się do jednej ze wstępnie istniejących usług zawartych w systemie operacyjnym Windows.</span><span class="sxs-lookup"><span data-stu-id="6a704-143">It can be any service of interest, but for this example we are referencing one of the pre-existing services that are included with the Windows OS.</span></span>  <span data-ttu-id="6a704-144">Akcja alertu jest skonfigurowana do wykonywania naszego elementu runbook użytego w tym przykładzie i do działania w hybrydowym procesie roboczym elementu runbook, który jest włączony w systemach docelowych.</span><span class="sxs-lookup"><span data-stu-id="6a704-144">The alert action is configured to execute our runbook used in this example and run on the Hybrid Runbook Worker, which are enabled on the target systems.</span></span>   

<span data-ttu-id="6a704-145">Działanie kodu elementu runbook **Get Service Name from LA** przekonwertuje ciąg w formacie JSON na typ obiektu i zastosuje filtr do elementu *SvcDisplayName_CF* w celu wyodrębnienia nazwy wyświetlanej usługi systemu Windows, a następnie przekaże ją do kolejnego działania, które przed podjęciem próby ponownego uruchomienia usługi sprawdzi, czy została zatrzymana.</span><span class="sxs-lookup"><span data-stu-id="6a704-145">The runbook code activity **Get Service Name from LA** will convert the JSON-formatted string into an object type and filter on the item *SvcDisplayName_CF* to extract the display name of the Windows service and pass this onto the next activity which will verify the service is stopped before attempting to restart it.</span></span>  <span data-ttu-id="6a704-146">*SvcDisplayName_CF* to [pole niestandardowe](../log-analytics/log-analytics-custom-fields.md) utworzone w usłudze Log Analytics na potrzeby tego przykładu.</span><span class="sxs-lookup"><span data-stu-id="6a704-146">*SvcDisplayName_CF* is a [custom field](../log-analytics/log-analytics-custom-fields.md) created in Log Analytics to demonstrate this example.</span></span>

    $SearchResults = (ConvertFrom-Json $WebhookData.RequestBody).SearchResults.value
    $SearchResults.SvcDisplayName_CF  

<span data-ttu-id="6a704-147">Po zatrzymaniu usługi reguła alertu w usłudze Log Analytics wykryje dopasowanie, po czym wyzwoli element runbook i wyśle kontekst alertu do tego elementu.</span><span class="sxs-lookup"><span data-stu-id="6a704-147">When the service stops, the alert rule in Log Analytics will detect a match and trigger the runbook and send the alert context to the runbook.</span></span> <span data-ttu-id="6a704-148">Element runbook podejmie działanie w celu sprawdzenia, czy usługa została zatrzymana. Jeśli tak, nastąpi próba ponownego uruchomienia usługi. Działanie sprawdzi, czy usługa została uruchomiona prawidłowo, i wyprowadzi wyniki.</span><span class="sxs-lookup"><span data-stu-id="6a704-148">The runbook will take action to verify the service is stopped, and if so attempt to restart the service and verify it started correctly and output the results.</span></span>     

<span data-ttu-id="6a704-149">Jeśli nie masz konta usługi Automation połączonego z przestrzenią roboczą pakietu OMS, możesz też skonfigurować regułę alertu z akcją elementu webhook wyzwalającą element runbook i skonfigurować element runbook do konwertowania ciągu w formacie JSON oraz filtrowania elementu *.SearchResult* zgodnie z podanymi wcześniej wskazówkami.</span><span class="sxs-lookup"><span data-stu-id="6a704-149">Alternatively if you don't have your Automation account linked to your OMS workspace, you would configure the alert rule with a webhook action to trigger the runbook and configure the runbook to convert the JSON-formatted string and filter on *.SearchResult* following the guidance mentioned earlier.</span></span>    

## <a name="next-steps"></a><span data-ttu-id="6a704-150">Następne kroki</span><span class="sxs-lookup"><span data-stu-id="6a704-150">Next steps</span></span>

* <span data-ttu-id="6a704-151">Aby dowiedzieć się więcej o alertach w usłudze Log Analytics i o sposobie ich tworzenia, zobacz temat [Alerts in Log Analytics](../log-analytics/log-analytics-alerts.md) (Alerty w usłudze Log Analytics).</span><span class="sxs-lookup"><span data-stu-id="6a704-151">To learn more about alerts in Log Analytics and how to create one, see [Alerts in Log Analytics](../log-analytics/log-analytics-alerts.md).</span></span>

* <span data-ttu-id="6a704-152">Aby zrozumieć, jak wyzwalać elementy runbook przy użyciu elementu webhook, zobacz artykuł [Elementy webhook w usłudze Azure Automation](automation-webhooks.md).</span><span class="sxs-lookup"><span data-stu-id="6a704-152">To understand how to trigger runbooks using a webhook, see [Azure Automation webhooks](automation-webhooks.md).</span></span>
