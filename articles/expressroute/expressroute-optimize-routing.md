---
title: "Optymalizacja routingu usługi ExpressRoute: Azure| Microsoft Docs"
description: "Ta strona zawiera szczegółowe informacje dotyczące optymalizacji routingu w przypadku, gdy występują co najmniej dwa obwody usługi ExpressRoute łączące firmę Microsoft z siecią firmową."
documentationcenter: na
services: expressroute
author: charwen
manager: carmonm
editor: 
ms.assetid: fca53249-d9c3-4cff-8916-f8749386a4dd
ms.service: expressroute
ms.devlang: na
ms.topic: get-started-article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 04/06/2017
ms.author: charwen
ms.openlocfilehash: c3a85b9445d69330c3f6c7d298169efddb6ecca0
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 07/11/2017
---
# <a name="optimize-expressroute-routing"></a><span data-ttu-id="02fc5-103">Optymalizacja routingu usługi ExpressRoute</span><span class="sxs-lookup"><span data-stu-id="02fc5-103">Optimize ExpressRoute Routing</span></span>
<span data-ttu-id="02fc5-104">Jeśli masz wiele obwodów usługi ExpressRoute, masz więcej niż jedną ścieżkę łączenia z firmą Microsoft.</span><span class="sxs-lookup"><span data-stu-id="02fc5-104">When you have multiple ExpressRoute circuits, you have more than one path to connect to Microsoft.</span></span> <span data-ttu-id="02fc5-105">W związku z tym może wystąpić routing nieoptymalny, tzn. ruch może użyć dłuższej ścieżki w celu dotarcia do firmy Microsoft lub z firmy Microsoft do sieci użytkownika.</span><span class="sxs-lookup"><span data-stu-id="02fc5-105">As a result, suboptimal routing may happen - that is, your traffic may take a longer path to reach Microsoft, and Microsoft to your network.</span></span> <span data-ttu-id="02fc5-106">Im dłuższa ścieżka sieciowa, tym większe opóźnienie.</span><span class="sxs-lookup"><span data-stu-id="02fc5-106">The longer the network path, the higher the latency.</span></span> <span data-ttu-id="02fc5-107">Opóźnienie ma bezpośredni wpływ na wydajność aplikacji i środowisko użytkownika.</span><span class="sxs-lookup"><span data-stu-id="02fc5-107">Latency has direct impact on application performance and user experience.</span></span> <span data-ttu-id="02fc5-108">W tym artykule przedstawiono ten problem i wyjaśniono, jak zoptymalizować routing przy użyciu standardowych technologii routingu.</span><span class="sxs-lookup"><span data-stu-id="02fc5-108">This article will illustrate this problem and explain how to optimize routing using the standard routing technologies.</span></span>

## <a name="suboptimal-routing-from-customer-to-microsoft"></a><span data-ttu-id="02fc5-109">Suboptymalny routing od klienta do firmy Microsoft</span><span class="sxs-lookup"><span data-stu-id="02fc5-109">Suboptimal routing from customer to Microsoft</span></span>
<span data-ttu-id="02fc5-110">Przyjrzyjmy się problemowi z routingiem, korzystając z przykładu.</span><span class="sxs-lookup"><span data-stu-id="02fc5-110">Let's take a close look at the routing problem by an example.</span></span> <span data-ttu-id="02fc5-111">Załóżmy, że masz dwa biura w USA: jedno w Los Angeles i jedno w Nowym Jorku.</span><span class="sxs-lookup"><span data-stu-id="02fc5-111">Imagine you have two offices in the US, one in Los Angeles and one in New York.</span></span> <span data-ttu-id="02fc5-112">Biura są połączone za pośrednictwem sieci WAN, która może być Twoją siecią podstawową lub siecią IP VPN dostawcy usług.</span><span class="sxs-lookup"><span data-stu-id="02fc5-112">Your offices are connected on a Wide Area Network (WAN), which can be either your own backbone network or your service provider's IP VPN.</span></span> <span data-ttu-id="02fc5-113">Dostępne są dwa obwody usługi ExpressRoute: jeden w zachodnich stanach USA i jeden we wschodnich stanach USA, które są również połączone w ramach sieci WAN.</span><span class="sxs-lookup"><span data-stu-id="02fc5-113">You have two ExpressRoute circuits, one in US West and one in US East, that are also connected on the WAN.</span></span> <span data-ttu-id="02fc5-114">Oczywiście masz dwie ścieżki połączenia z siecią firmy Microsoft.</span><span class="sxs-lookup"><span data-stu-id="02fc5-114">Obviously, you have two paths to connect to the Microsoft network.</span></span> <span data-ttu-id="02fc5-115">Teraz wyobraź sobie, że dysponujesz wdrożeniem platformy Azure (np. usługą Azure App Service) zarówno w zachodnich, jak i wschodnich stanach USA.</span><span class="sxs-lookup"><span data-stu-id="02fc5-115">Now imagine you have Azure deployment (for example, Azure App Service) in both US West and US East.</span></span> <span data-ttu-id="02fc5-116">Masz zamiar połączyć użytkowników z Los Angeles z regionem świadczenia usługi Azure Zachodnie stany USA Azure, a użytkowników w Nowym Jorku z regionem Wschodnie stany USA, ponieważ administrator usług anonsuje, że użytkownicy z poszczególnych biur uzyskują w ten sposób dostęp do pobliskich usług Azure w celu uzyskania optymalnego środowiska.</span><span class="sxs-lookup"><span data-stu-id="02fc5-116">Your intention is to connect your users in Los Angeles to Azure US West and your users in New York to Azure US East because your service admin advertises that users in each office access the nearby Azure services for optimal experiences.</span></span> <span data-ttu-id="02fc5-117">Niestety plan działa dobrze w przypadku użytkowników ze wschodniego wybrzeża, ale nie w przypadku użytkowników z zachodniego wybrzeża.</span><span class="sxs-lookup"><span data-stu-id="02fc5-117">Unfortunately, the plan works out well for the east coast users but not for the west coast users.</span></span> <span data-ttu-id="02fc5-118">Przyczyną tego problemu jest następująca.</span><span class="sxs-lookup"><span data-stu-id="02fc5-118">The cause of the problem is the following.</span></span> <span data-ttu-id="02fc5-119">W poszczególnych obwodach usługi ExpressRoute anonsujemy zarówno prefiks dla wschodnich stanów USA (23.100.0.0/16), jak i prefiks w zachodnich stanach USA (13.100.0.0/16).</span><span class="sxs-lookup"><span data-stu-id="02fc5-119">On each ExpressRoute circuit, we advertise to you both the prefix in Azure US East (23.100.0.0/16) and the prefix in Azure US West (13.100.0.0/16).</span></span> <span data-ttu-id="02fc5-120">Jeśli nie wiesz, który prefiks odpowiada któremu regionowi, nie możesz ich traktować w różny sposób.</span><span class="sxs-lookup"><span data-stu-id="02fc5-120">If you don't know which prefix is from which region, you are not able to treat it differently.</span></span> <span data-ttu-id="02fc5-121">Sieć WAN może uznać, że oba prefiksy są bliżej wschodnich niż zachodnich stanów USA, i skierować obu użytkowników biura do obwodu usługi ExpressRoute we wschodnich stanach USA.</span><span class="sxs-lookup"><span data-stu-id="02fc5-121">Your WAN network may think both of the prefixes are closer to US East than US West and therefore route both office users to the ExpressRoute circuit in US East.</span></span> <span data-ttu-id="02fc5-122">W rezultacie wielu użytkowników w biurze z Los Angeles będzie niezadowolonych.</span><span class="sxs-lookup"><span data-stu-id="02fc5-122">In the end, you will have many unhappy users in the Los Angeles office.</span></span>

![Przypadek 1 dotyczący usługi ExpressRoute — suboptymalny routing od klienta do firmy Microsoft](./media/expressroute-optimize-routing/expressroute-case1-problem.png)

### <a name="solution-use-bgp-communities"></a><span data-ttu-id="02fc5-124">Rozwiązanie: użyj społeczności BGP</span><span class="sxs-lookup"><span data-stu-id="02fc5-124">Solution: use BGP Communities</span></span>
<span data-ttu-id="02fc5-125">Aby zoptymalizować routing dla użytkowników obu biur, trzeba wiedzieć, który prefiks odpowiada zachodnim, a który wschodnim stanom USA.</span><span class="sxs-lookup"><span data-stu-id="02fc5-125">To optimize routing for both office users, you need to know which prefix is from Azure US West and which from Azure US East.</span></span> <span data-ttu-id="02fc5-126">Kodujemy te informacje przy użyciu [wartości społeczności BGP](expressroute-routing.md).</span><span class="sxs-lookup"><span data-stu-id="02fc5-126">We encode this information by using [BGP Community values](expressroute-routing.md).</span></span> <span data-ttu-id="02fc5-127">Przypisaliśmy unikatową wartość społeczności BGP do każdego regionu świadczenia usługi Azure, np. „12076:51004” dla wschodnich, a „12076:51006” dla zachodnich stanów USA.</span><span class="sxs-lookup"><span data-stu-id="02fc5-127">We've assigned a unique BGP Community value to each Azure region, e.g. "12076:51004" for US East, "12076:51006" for US West.</span></span> <span data-ttu-id="02fc5-128">Skoro już wiesz, który prefiks odpowiada któremu regionowi świadczenia usługi Azure, możesz skonfigurować preferowany obwód usługi ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="02fc5-128">Now that you know which prefix is from which Azure region, you can configure which ExpressRoute circuit should be preferred.</span></span> <span data-ttu-id="02fc5-129">Ponieważ do wymiany informacji o routingu używamy protokołu BGP, w celu wpłynięcia na routing możesz użyć preferencji lokalnej BGP.</span><span class="sxs-lookup"><span data-stu-id="02fc5-129">Because we use the BGP to exchange routing info, you can use BGP's Local Preference to influence routing.</span></span> <span data-ttu-id="02fc5-130">W naszym przykładzie można przypisać wyższą wartość preferencji lokalnej na 13.100.0.0/16 w zachodnich niż we wschodnich stanach USA i podobnie wyższą wartość preferencji lokalnej na 23.100.0.0/16 we wschodnich niż w zachodnich stanach USA.</span><span class="sxs-lookup"><span data-stu-id="02fc5-130">In our example, you can assign a higher local preference value to 13.100.0.0/16 in US West than in US East, and similarly, a higher local preference value to 23.100.0.0/16 in US East than in US West.</span></span> <span data-ttu-id="02fc5-131">Ta konfiguracja pozwoli zagwarantować, że gdy obie ścieżki do firmy Microsoft będą dostępne, użytkownicy w Los Angeles będą korzystać z obwodu usługi ExpressRoute w zachodnich stanach USA do połączenia ze stanami zachodnimi, natomiast użytkownicy z Nowego Jorku będą korzystać z usługi ExpressRoute we wschodnich stanach USA w celu połączenia ze stanami wschodnimi.</span><span class="sxs-lookup"><span data-stu-id="02fc5-131">This configuration will make sure that, when both paths to Microsoft are available, your users in Los Angeles will take the ExpressRoute circuit in US West to connect to Azure US West whereas your users in New York take the ExpressRoute in US East to Azure US East.</span></span> <span data-ttu-id="02fc5-132">Routing jest zoptymalizowany po obu stronach.</span><span class="sxs-lookup"><span data-stu-id="02fc5-132">Routing is optimized on both sides.</span></span> 

![Rozwiązanie przypadku 1 dotyczącego usługi ExpressRoute — używanie społeczności BGP](./media/expressroute-optimize-routing/expressroute-case1-solution.png)

> [!NOTE]
> <span data-ttu-id="02fc5-134">Tę samą technikę, obejmującą preferencję lokalną, można zastosować do routingu od klienta do usługi Azure Virtual Network.</span><span class="sxs-lookup"><span data-stu-id="02fc5-134">The same technique, using Local Preference, can be applied to routing from customer to Azure Virtual Network.</span></span> <span data-ttu-id="02fc5-135">Wartością społeczności BGP nie oznaczamy prefiksów anonsowanych z platformy Azure do Twojej sieci.</span><span class="sxs-lookup"><span data-stu-id="02fc5-135">We don't tag BGP Community value to the prefixes advertised from Azure to your network.</span></span> <span data-ttu-id="02fc5-136">Jednak ponieważ wiadomo, które wdrożenie usługi Virtual Network znajduje się najbliżej danego biura, można odpowiednio skonfigurować routery, ustawiając preferowanie określonego obwodu usługi ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="02fc5-136">However, since you know which of your Virtual Network deployment is close to which of your office, you can configure your routers accordingly to prefer one ExpressRoute circuit to another.</span></span>
>
>

## <a name="suboptimal-routing-from-microsoft-to-customer"></a><span data-ttu-id="02fc5-137">Suboptymalny routing od firmy Microsoft do klienta</span><span class="sxs-lookup"><span data-stu-id="02fc5-137">Suboptimal routing from Microsoft to customer</span></span>
<span data-ttu-id="02fc5-138">Oto inny przykład, w którym połączenia z firmy Microsoft używają dłuższej ścieżki, by dotrzeć do sieci.</span><span class="sxs-lookup"><span data-stu-id="02fc5-138">Here is another example where connections from Microsoft take a longer path to reach your network.</span></span> <span data-ttu-id="02fc5-139">W tym przypadku używasz lokalnych serwerów programu Exchange i usługi Exchange Online w [środowisku hybrydowym](https://technet.microsoft.com/library/jj200581%28v=exchg.150%29.aspx).</span><span class="sxs-lookup"><span data-stu-id="02fc5-139">In this case, you use on-premises Exchange servers and Exchange Online in a [hybrid environment](https://technet.microsoft.com/library/jj200581%28v=exchg.150%29.aspx).</span></span> <span data-ttu-id="02fc5-140">Biura są połączone z siecią WAN.</span><span class="sxs-lookup"><span data-stu-id="02fc5-140">Your offices are connected to a WAN.</span></span> <span data-ttu-id="02fc5-141">Prefiksy serwerów lokalnych w obu biurach są anonsowane do firmy Microsoft za pośrednictwem dwóch obwodów usługi ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="02fc5-141">You advertise the prefixes of your on-premises servers in both of your offices to Microsoft through the two ExpressRoute circuits.</span></span> <span data-ttu-id="02fc5-142">Usługa Exchange Online inicjuje połączenia z serwerami lokalnymi w takich sytuacjach jak migracja skrzynek pocztowych.</span><span class="sxs-lookup"><span data-stu-id="02fc5-142">Exchange Online will initiate connections to the on-premises servers in cases such as mailbox migration.</span></span> <span data-ttu-id="02fc5-143">Niestety połączenie z biurem w Los Angeles zostaje skierowane do obwodu usługi ExpressRoute we wschodnich stanach USA, po czym przechodzi cały kontynent z powrotem na zachodnie wybrzeże.</span><span class="sxs-lookup"><span data-stu-id="02fc5-143">Unfortunately, the connection to your Los Angeles office is routed to the ExpressRoute circuit in US East before traversing the entire continent back to the west coast.</span></span> <span data-ttu-id="02fc5-144">Przyczyna tego problemu jest podobna do pierwszej.</span><span class="sxs-lookup"><span data-stu-id="02fc5-144">The cause of the problem is similar to the first one.</span></span> <span data-ttu-id="02fc5-145">Bez żadnej wskazówki sieć firmy Microsoft nie może rozróżnić, który prefiks klienta jest blisko wschodnich, a który blisko zachodnich stanów USA.</span><span class="sxs-lookup"><span data-stu-id="02fc5-145">Without any hint, the Microsoft network can't tell which customer prefix is close to US East and which one is close to US West.</span></span> <span data-ttu-id="02fc5-146">Czasami wybiera nieprawidłową ścieżkę do biura w Los Angeles.</span><span class="sxs-lookup"><span data-stu-id="02fc5-146">It happens to pick the wrong path to your office in Los Angeles.</span></span>

![Przypadek 2 dotyczący usługi ExpressRoute — suboptymalny routing od firmy Microsoft do klienta](./media/expressroute-optimize-routing/expressroute-case2-problem.png)

### <a name="solution-use-as-path-prepending"></a><span data-ttu-id="02fc5-148">Rozwiązanie: użyj dołączania ścieżki AS</span><span class="sxs-lookup"><span data-stu-id="02fc5-148">Solution: use AS PATH prepending</span></span>
<span data-ttu-id="02fc5-149">Istnieją dwa rozwiązania tego problemu.</span><span class="sxs-lookup"><span data-stu-id="02fc5-149">There are two solutions to the problem.</span></span> <span data-ttu-id="02fc5-150">Pierwsze z nich polega na tym, by po prostu anonsować prefiks lokalny biura w Los Angeles, 177.2.0.0/31, w obwodzie usługi ExpressRoute w stanach zachodnich, a prefiks lokalny biura w Nowym Jorku, 177.2.0.2/31, w obwodzie w stanach wschodnich.</span><span class="sxs-lookup"><span data-stu-id="02fc5-150">The first one is that you simply advertise your on-premises prefix for your Los Angeles office, 177.2.0.0/31, on the ExpressRoute circuit in US West and your on-premises prefix for your New York office, 177.2.0.2/31, on the ExpressRoute circuit in US East.</span></span> <span data-ttu-id="02fc5-151">W wyniku tego istnieje tylko jedna ścieżka dla firmy Microsoft do połączenia się z każdym z biur.</span><span class="sxs-lookup"><span data-stu-id="02fc5-151">As a result, there is only one path for Microsoft to connect to each of your offices.</span></span> <span data-ttu-id="02fc5-152">Nie ma żadnych niejednoznaczności i routing zostaje zoptymalizowany.</span><span class="sxs-lookup"><span data-stu-id="02fc5-152">There is no ambiguity and routing is optimized.</span></span> <span data-ttu-id="02fc5-153">Dla tego projektu należy przemyśleć strategię pracy awaryjnej.</span><span class="sxs-lookup"><span data-stu-id="02fc5-153">With this design, you need to think about your failover strategy.</span></span> <span data-ttu-id="02fc5-154">W przypadku, gdy ścieżka do firmy Microsoft za pośrednictwem usługi ExpressRoute zostanie uszkodzona, musisz zadbać o to, by usługa Exchange Online mogła nadal łączyć się z serwerami lokalnymi.</span><span class="sxs-lookup"><span data-stu-id="02fc5-154">In the event that the path to Microsoft via ExpressRoute is broken, you need to make sure that Exchange Online can still connect to your on-premises servers.</span></span> 

<span data-ttu-id="02fc5-155">Drugim rozwiązaniem jest dalsze anonsowanie obu prefiksów w obu obwodach usługi ExpressRoute i dodatkowo podawanie wskazówki z informacją, który prefiks jest blisko którego biura.</span><span class="sxs-lookup"><span data-stu-id="02fc5-155">The second solution is that you continue to advertise both of the prefixes on both ExpressRoute circuits, and in addition you give us a hint of which prefix is close to which one of your offices.</span></span> <span data-ttu-id="02fc5-156">Ponieważ firma Microsoft obsługuje ścieżkę AS BGP do wywołania, można skonfigurować ścieżkę AS dla prefiksu, aby wpłynąć na routing.</span><span class="sxs-lookup"><span data-stu-id="02fc5-156">Because we support BGP AS Path prepending, you can configure the AS Path for your prefix to influence routing.</span></span> <span data-ttu-id="02fc5-157">W tym przykładzie można wydłużyć ścieżkę AS dla 172.2.0.0/31 we wschodnich stanach USA, aby firma Microsoft preferowała obwód usługi ExpressRoute w stanach zachodnich dla ruchu przeznaczonego dla tego prefiksu (dla naszej sieci ścieżka do tego prefiksu jest krótsza na zachodzie).</span><span class="sxs-lookup"><span data-stu-id="02fc5-157">In this example, you can lengthen the AS PATH for 172.2.0.0/31 in US East so that we will prefer the ExpressRoute circuit in US West for traffic destined for this prefix (as our network will think the path to this prefix is shorter in the west).</span></span> <span data-ttu-id="02fc5-158">Podobnie można wydłużyć ścieżkę AS dla 172.2.0.2/31 w zachodnich stanach USA, by firma Microsoft preferowała obwód usługi ExpressRoute w stanach wschodnich.</span><span class="sxs-lookup"><span data-stu-id="02fc5-158">Similarly you can lengthen the AS PATH for 172.2.0.2/31 in US West so that we'll prefer the ExpressRoute circuit in US East.</span></span> <span data-ttu-id="02fc5-159">Routing zostaje zoptymalizowany dla obu biur.</span><span class="sxs-lookup"><span data-stu-id="02fc5-159">Routing is optimized for both offices.</span></span> <span data-ttu-id="02fc5-160">W tym projekcie jeśli jeden obwód usługi ExpressRoute zostanie uszkodzony, usługa Exchange Online może nadal uzyskać dostęp do użytkownika za pośrednictwem innego obwodu usługi ExpressRoute i sieci WAN.</span><span class="sxs-lookup"><span data-stu-id="02fc5-160">With this design, if one ExpressRoute circuit is broken, Exchange Online can still reach you via another ExpressRoute circuit and your WAN.</span></span> 

> [!IMPORTANT]
> <span data-ttu-id="02fc5-161">Firma Microsoft usuwa prywatne numery AS w ścieżce AS dla prefiksów odebranych w ramach komunikacji równorzędnej Microsoft.</span><span class="sxs-lookup"><span data-stu-id="02fc5-161">We remove private AS numbers in the AS PATH for the prefixes received on Microsoft Peering.</span></span> <span data-ttu-id="02fc5-162">Aby wpłynąć na routing komunikacji równorzędnej firmy Microsoft, należy dołączyć publiczne numery AS do ścieżki AS.</span><span class="sxs-lookup"><span data-stu-id="02fc5-162">You need to append public AS numbers in the AS PATH to influence routing for Microsoft Peering.</span></span>
> 
> 

![Rozwiązanie przypadku 2 dotyczącego usługi ExpressRoute — używanie dołączania ścieżki AS](./media/expressroute-optimize-routing/expressroute-case2-solution.png)

> [!NOTE]
> <span data-ttu-id="02fc5-164">Choć przedstawione przykłady odnoszą się do komunikacji równorzędnej firmy Microsoft i publicznej komunikacji równorzędnej, to firma Microsoft nie obsługuje takich samych możliwości dla prywatnej komunikacji równorzędnej.</span><span class="sxs-lookup"><span data-stu-id="02fc5-164">While the examples given here are for Microsoft and Public peerings, we do support the same capabilities for the Private peering.</span></span> <span data-ttu-id="02fc5-165">Ponadto dołączanie ścieżki AS działa w obrębie pojedynczego obwodu usługi ExpressRoute i wpływa na wybór ścieżek podstawowej i pomocniczej.</span><span class="sxs-lookup"><span data-stu-id="02fc5-165">Also, the AS Path prepending works within one single ExpressRoute circuit, to influence the selection of the primary and secondary paths.</span></span>
> 
> 

## <a name="suboptimal-routing-between-virtual-networks"></a><span data-ttu-id="02fc5-166">Suboptymalny routing między sieciami wirtualnymi</span><span class="sxs-lookup"><span data-stu-id="02fc5-166">Suboptimal routing between virtual networks</span></span>
<span data-ttu-id="02fc5-167">Usługa ExpressRoute umożliwia skonfigurowanie usługi Virtual Network pod kątem komunikacji za pośrednictwem sieci wirtualnych przez połączenie ich z obwodem usługi ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="02fc5-167">With ExpressRoute, you can enable Virtual Network to Virtual Network (which is also known as "VNet") communication by linking them to an ExpressRoute circuit.</span></span> <span data-ttu-id="02fc5-168">W przypadku połączenia sieci wirtualnych z wieloma obwodami usługi ExpressRoute między sieciami wirtualnymi może wystąpić suboptymalny routing.</span><span class="sxs-lookup"><span data-stu-id="02fc5-168">When you link them to multiple ExpressRoute circuits, suboptimal routing can happen between the VNets.</span></span> <span data-ttu-id="02fc5-169">Rozważmy przykład.</span><span class="sxs-lookup"><span data-stu-id="02fc5-169">Let's consider an example.</span></span> <span data-ttu-id="02fc5-170">Dostępne są dwa obwody usługi ExpressRoute: jeden w zachodnich stanach USA i jeden we wschodnich stanach USA.</span><span class="sxs-lookup"><span data-stu-id="02fc5-170">You have two ExpressRoute circuits, one in US West and one in US East.</span></span> <span data-ttu-id="02fc5-171">W każdym regionie znajdują się dwie sieci wirtualne.</span><span class="sxs-lookup"><span data-stu-id="02fc5-171">In each region, you have two VNets.</span></span> <span data-ttu-id="02fc5-172">W jednej sieci wirtualnej są wdrożone serwery sieci Web, a w drugiej — serwery aplikacji.</span><span class="sxs-lookup"><span data-stu-id="02fc5-172">Your web servers are deployed in one VNet and application servers in the other.</span></span> <span data-ttu-id="02fc5-173">W celu zapewnienia nadmiarowości dwie sieci wirtualne w każdym regionie są połączone z lokalnym obwodem usługi ExpressRoute i zdalnym obwodem usługi ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="02fc5-173">For redundancy, you link the two VNets in each region to both the local ExpressRoute circuit and the remote ExpressRoute circuit.</span></span> <span data-ttu-id="02fc5-174">Jak widać na poniższej ilustracji, każdą sieć wirtualną łączą dwie ścieżki prowadzące do drugiej sieci wirtualnej.</span><span class="sxs-lookup"><span data-stu-id="02fc5-174">As can be seen below, from each VNet there are two paths to the other VNet.</span></span> <span data-ttu-id="02fc5-175">W ramach połączenia sieci wirtualnych nie wiadomo, który obwód usługi ExpressRoute jest lokalny, a który zdalny.</span><span class="sxs-lookup"><span data-stu-id="02fc5-175">The VNets don't know which ExpressRoute circuit is local and which one is remote.</span></span> <span data-ttu-id="02fc5-176">Ponieważ do równoważenia obciążenia ruchu między sieciami wirtualnymi jest używany routing wielościeżkowy z równym kosztem (ECMP, Equal-Cost-Multi-Path), część ruchu przepływa dłuższą ścieżką i jest kierowana do zdalnego obwodu usługi ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="02fc5-176">Consequently as they do Equal-Cost-Multi-Path (ECMP) routing to load-balance inter-VNet traffic, some traffic flows will take the longer path and get routed at the remote ExpressRoute circuit.</span></span>

![Przypadek 3 dotyczący usługi ExpressRoute — suboptymalny routing między sieciami wirtualnymi](./media/expressroute-optimize-routing/expressroute-case3-problem.png)

### <a name="solution-assign-a-high-weight-to-local-connection"></a><span data-ttu-id="02fc5-178">Rozwiązanie: przypisanie wysokiej wagi połączeniu lokalnemu</span><span class="sxs-lookup"><span data-stu-id="02fc5-178">Solution: assign a high weight to local connection</span></span>
<span data-ttu-id="02fc5-179">Rozwiązanie jest proste.</span><span class="sxs-lookup"><span data-stu-id="02fc5-179">The solution is simple.</span></span> <span data-ttu-id="02fc5-180">Ponieważ wiadomo, gdzie znajdują się sieci wirtualne i obwody, można określić preferowaną ścieżkę dla poszczególnych sieci wirtualnych.</span><span class="sxs-lookup"><span data-stu-id="02fc5-180">Since you know where the VNets and the circuits are, you can tell us which path each VNet should prefer.</span></span> <span data-ttu-id="02fc5-181">Na potrzeby tego przykładu połączeniu lokalnemu jest przypisywana wyższa waga niż połączeniu zdalnemu (zobacz przykład konfiguracji [tutaj](expressroute-howto-linkvnet-arm.md#modify-a-virtual-network-connection)).</span><span class="sxs-lookup"><span data-stu-id="02fc5-181">Specifically for this example, you assign a higher weight to the local connection than to the remote connection (see the configuration example [here](expressroute-howto-linkvnet-arm.md#modify-a-virtual-network-connection)).</span></span> <span data-ttu-id="02fc5-182">Gdy sieć wirtualna z wieloma połączeniami odbierze prefiks drugiej sieci wirtualnej, w celu wysłania danych przeznaczonych dla tego prefiksu zostanie wybrane połączenie z najwyższą wagą.</span><span class="sxs-lookup"><span data-stu-id="02fc5-182">When a VNet receives the prefix of the other VNet on multiple connections it will prefer the connection with the highest weight to send traffic destined for that prefix.</span></span>

![Rozwiązanie przypadku 3 dotyczącego usługi ExpressRoute — przypisanie wysokiej wagi połączeniu lokalnemu](./media/expressroute-optimize-routing/expressroute-case3-solution.png)

> [!NOTE]
> <span data-ttu-id="02fc5-184">Jeśli korzystasz z kilku obwodów usługi ExpressRoute, możesz również zmieniać routing z sieci wirtualnej do sieci lokalnej, konfigurując wagę połączenia, zamiast stosowania dołączania ścieżki AS, które zostało opisane w drugim scenariuszu.</span><span class="sxs-lookup"><span data-stu-id="02fc5-184">You can also influence routing from VNet to your on-premises network, if you have multiple ExpressRoute circuits, by configuring the weight of a connection instead of applying AS PATH prepending, a technique described in the second scenario above.</span></span> <span data-ttu-id="02fc5-185">Podczas określania trasy danych w przypadku wszystkich prefiksów waga połączenia ma zawsze pierwszeństwo przed długością ścieżki AS.</span><span class="sxs-lookup"><span data-stu-id="02fc5-185">For each prefix, we will always look at the connection weight before the AS Path length when deciding how to send traffic.</span></span>
>
>
