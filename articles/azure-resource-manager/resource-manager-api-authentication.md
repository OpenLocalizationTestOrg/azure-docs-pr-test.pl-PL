---
title: "Azure uwierzytelniania usługi Active Directory i usługi Resource Manager | Dokumentacja firmy Microsoft"
description: "Przewodnik dewelopera do uwierzytelniania przy użyciu interfejsu API usługi Azure Resource Manager i usługi Azure Active Directory dla integracji aplikacji z innych subskrypcji platformy Azure."
services: azure-resource-manager,active-directory
documentationcenter: na
author: dushyantgill
manager: timlt
editor: tysonn
ms.assetid: 17b2b40d-bf42-4c7d-9a88-9938409c5088
ms.service: azure-resource-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 12/27/2016
ms.author: dugill;tomfitz
ms.openlocfilehash: 7830dc4774652f4d108e98660dce3bcea7b32d05
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 07/11/2017
---
# <a name="use-resource-manager-authentication-api-to-access-subscriptions"></a><span data-ttu-id="6ab84-103">Użyj Menedżera zasobów uwierzytelniania interfejsu API do dostępu do subskrypcji</span><span class="sxs-lookup"><span data-stu-id="6ab84-103">Use Resource Manager authentication API to access subscriptions</span></span>
## <a name="introduction"></a><span data-ttu-id="6ab84-104">Wprowadzenie</span><span class="sxs-lookup"><span data-stu-id="6ab84-104">Introduction</span></span>
<span data-ttu-id="6ab84-105">Jeśli jesteś deweloper oprogramowania, który musi utworzyć aplikację, która zarządza zasobami Azure klienta, w tym temacie przedstawiono sposób uwierzytelniania za pomocą interfejsów API usługi Azure Resource Manager i uzyskanie dostępu do zasobów w innych subskrypcji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-105">If you are a software developer who needs to create an app that manages customer's Azure resources, this topic shows you how to authenticate with the Azure Resource Manager APIs and gain access to resources in other subscriptions.</span></span>

<span data-ttu-id="6ab84-106">Aplikację można uzyskać dostęp do interfejsów API Menedżera zasobów kilka sposobów:</span><span class="sxs-lookup"><span data-stu-id="6ab84-106">Your app can access the Resource Manager APIs in couple of ways:</span></span>

1. <span data-ttu-id="6ab84-107">**Użytkownik i uzyskania dostępu do aplikacji**: dla aplikacji, które uzyskują dostęp do zasobów w imieniu zalogowanego użytkownika.</span><span class="sxs-lookup"><span data-stu-id="6ab84-107">**User + app access**: for apps that access resources on behalf of a signed-in user.</span></span> <span data-ttu-id="6ab84-108">Ta metoda działa w przypadku aplikacji, takich jak aplikacje sieci web i narzędzia wiersza polecenia, które zajmują się tylko "interakcyjne Zarządzanie" zasobów platformy Azure.</span><span class="sxs-lookup"><span data-stu-id="6ab84-108">This approach works for apps, such as web apps and command-line tools, that deal with only "interactive management" of Azure resources.</span></span>
2. <span data-ttu-id="6ab84-109">**Dostęp tylko do aplikacji**: dla aplikacji uruchamianych demon usługi i zaplanowanych zadań.</span><span class="sxs-lookup"><span data-stu-id="6ab84-109">**App-only access**: for apps that run daemon services and scheduled jobs.</span></span> <span data-ttu-id="6ab84-110">Tożsamości aplikacji otrzymuje bezpośredni dostęp do zasobów.</span><span class="sxs-lookup"><span data-stu-id="6ab84-110">The app's identity is granted direct access to the resources.</span></span> <span data-ttu-id="6ab84-111">Ta metoda działa w przypadku aplikacji wymagających długoterminowej bezobsługowe dostępu (Instalacja nienadzorowana) na platformie Azure.</span><span class="sxs-lookup"><span data-stu-id="6ab84-111">This approach works for apps that need long-term headless (unattended) access to Azure.</span></span>

<span data-ttu-id="6ab84-112">Ten temat zawiera instrukcje krok po kroku, aby utworzyć aplikację, która jest stosowana w obu tych metod autoryzacji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-112">This topic provides step-by-step instructions to create an app that employs both these authorization methods.</span></span> <span data-ttu-id="6ab84-113">Widoczny jest sposób wykonania poszczególnych kroków z interfejsu API REST lub C#.</span><span class="sxs-lookup"><span data-stu-id="6ab84-113">It shows how to perform each step with REST API or C#.</span></span> <span data-ttu-id="6ab84-114">Kompletna aplikacja platformy ASP.NET MVC jest dostępna na [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span><span class="sxs-lookup"><span data-stu-id="6ab84-114">The complete ASP.NET MVC application is available at [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span></span>

## <a name="what-the-web-app-does"></a><span data-ttu-id="6ab84-115">Co to jest aplikacja sieci web</span><span class="sxs-lookup"><span data-stu-id="6ab84-115">What the web app does</span></span>
<span data-ttu-id="6ab84-116">Aplikacja sieci web:</span><span class="sxs-lookup"><span data-stu-id="6ab84-116">The web app:</span></span>

1. <span data-ttu-id="6ab84-117">Logowania użytkownika w usłudze Azure.</span><span class="sxs-lookup"><span data-stu-id="6ab84-117">Signs-in an Azure user.</span></span>
2. <span data-ttu-id="6ab84-118">Pyta użytkownika w celu przyznania dostępu do aplikacji sieci web do Menedżera zasobów.</span><span class="sxs-lookup"><span data-stu-id="6ab84-118">Asks user to grant the web app access to Resource Manager.</span></span>
3. <span data-ttu-id="6ab84-119">Pobiera użytkownika + tokenu dostępu aplikacji do uzyskiwania dostępu do Menedżera zasobów.</span><span class="sxs-lookup"><span data-stu-id="6ab84-119">Gets user + app access token for accessing Resource Manager.</span></span>
4. <span data-ttu-id="6ab84-120">Używa tokenu (z kroku 3), aby wywołać Resource Manager i przypisać nazwy głównej usługi aplikacji do roli w subskrypcji, która zapewnia dostęp długoterminowej aplikacji do subskrypcji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-120">Uses token (from step 3) to call Resource Manager and assign the app's service principal to a role in the subscription, which gives the app long-term access to the subscription.</span></span>
5. <span data-ttu-id="6ab84-121">Pobiera token dostępu tylko do aplikacji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-121">Gets app-only access token.</span></span>
6. <span data-ttu-id="6ab84-122">Używa tokenu (z kroku 5) do zarządzania zasobami w subskrypcji za pomocą Menedżera zasobów.</span><span class="sxs-lookup"><span data-stu-id="6ab84-122">Uses token (from step 5) to manage resources in the subscription through Resource Manager.</span></span>

<span data-ttu-id="6ab84-123">Poniżej przedstawiono przepływ end-to-end aplikacji sieci web.</span><span class="sxs-lookup"><span data-stu-id="6ab84-123">Here's the end-to-end flow of the web application.</span></span>

![Przepływ uwierzytelniania usługi Resource Manager](./media/resource-manager-api-authentication/Auth-Swim-Lane.png)

<span data-ttu-id="6ab84-125">Jako użytkownik identyfikator subskrypcji podanie subskrypcję, której chcesz użyć:</span><span class="sxs-lookup"><span data-stu-id="6ab84-125">As a user, you provide the subscription id for the subscription you want to use:</span></span>

![Podaj identyfikator subskrypcji](./media/resource-manager-api-authentication/sample-ux-1.png)

<span data-ttu-id="6ab84-127">Wybierz konto, które ma być używane do logowania.</span><span class="sxs-lookup"><span data-stu-id="6ab84-127">Select the account to use for logging in.</span></span>

![Wybierz konto](./media/resource-manager-api-authentication/sample-ux-2.png)

<span data-ttu-id="6ab84-129">Wprowadź swoje poświadczenia.</span><span class="sxs-lookup"><span data-stu-id="6ab84-129">Provide your credentials.</span></span>

![Podaj poświadczenia](./media/resource-manager-api-authentication/sample-ux-3.png)

<span data-ttu-id="6ab84-131">Udziel aplikacji uprawnień dostępu do Twojej subskrypcji platformy Azure:</span><span class="sxs-lookup"><span data-stu-id="6ab84-131">Grant the app access to your Azure subscriptions:</span></span>

![Udzielanie dostępu](./media/resource-manager-api-authentication/sample-ux-4.png)

<span data-ttu-id="6ab84-133">Zarządzanie subskrypcjami połączone:</span><span class="sxs-lookup"><span data-stu-id="6ab84-133">Manage your connected subscriptions:</span></span>

![Łączenie subskrypcji](./media/resource-manager-api-authentication/sample-ux-7.png)

## <a name="register-application"></a><span data-ttu-id="6ab84-135">Zarejestrować aplikację</span><span class="sxs-lookup"><span data-stu-id="6ab84-135">Register application</span></span>
<span data-ttu-id="6ab84-136">Przed rozpoczęciem kodowania, należy zarejestrować aplikacji sieci web z usługi Azure Active Directory (AD).</span><span class="sxs-lookup"><span data-stu-id="6ab84-136">Before you start coding, register your web app with Azure Active Directory (AD).</span></span> <span data-ttu-id="6ab84-137">Rejestracja aplikacji tworzy centralnej tożsamości aplikacji w usłudze Azure AD.</span><span class="sxs-lookup"><span data-stu-id="6ab84-137">The app registration creates a central identity for your app in Azure AD.</span></span> <span data-ttu-id="6ab84-138">Przechowuje podstawowe informacje o aplikacji, takich jak identyfikator klienta OAuth, adresy URL odpowiedzi i poświadczenia, których aplikacja korzysta z uwierzytelniania i dostępu do interfejsów API usługi Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="6ab84-138">It holds basic information about your application like OAuth Client ID, Reply URLs, and credentials that your application uses to authenticate and access Azure Resource Manager APIs.</span></span> <span data-ttu-id="6ab84-139">Rejestracja aplikacji rejestruje także różne delegowane uprawnienia, których aplikacja wymaga podczas uzyskiwania dostępu do APIs firmy Microsoft w imieniu użytkownika.</span><span class="sxs-lookup"><span data-stu-id="6ab84-139">The app registration also records the various delegated permissions that your application needs when accessing Microsoft APIs on behalf of the user.</span></span>

<span data-ttu-id="6ab84-140">Ponieważ aplikacja uzyskuje dostęp do innych subskrypcji, należy go skonfigurować jako aplikacji wielodostępnej.</span><span class="sxs-lookup"><span data-stu-id="6ab84-140">Because your app accesses other subscription, you must configure it as a multi-tenant application.</span></span> <span data-ttu-id="6ab84-141">Aby przekazać sprawdzania poprawności, podaj domeny skojarzonych z usługą Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="6ab84-141">To pass validation, provide a domain associated with your Azure Active Directory.</span></span> <span data-ttu-id="6ab84-142">Aby wyświetlić domeny skojarzone z usługą Azure Active Directory, zaloguj się do [klasyczny portal](https://manage.windowsazure.com).</span><span class="sxs-lookup"><span data-stu-id="6ab84-142">To see the domains associated with your Azure Active Directory, log in to the [classic portal](https://manage.windowsazure.com).</span></span> <span data-ttu-id="6ab84-143">Wybierz w usłudze Azure Active Directory, a następnie wybierz **domen**.</span><span class="sxs-lookup"><span data-stu-id="6ab84-143">Select your Azure Active Directory and then select **Domains**.</span></span>

<span data-ttu-id="6ab84-144">Poniższy przykład pokazuje, jak zarejestrować aplikacji przy użyciu programu Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="6ab84-144">The following example shows how to register the app by using Azure PowerShell.</span></span> <span data-ttu-id="6ab84-145">Musi mieć najnowszą wersję programu Azure PowerShell, aby to polecenie mogło działać (sierpnia 2016).</span><span class="sxs-lookup"><span data-stu-id="6ab84-145">You must have the latest version (August 2016) of Azure PowerShell for this command to work.</span></span>

    $app = New-AzureRmADApplication -DisplayName "{app name}" -HomePage "https://{your domain}/{app name}" -IdentifierUris "https://{your domain}/{app name}" -Password "{your password}" -AvailableToOtherTenants $true

<span data-ttu-id="6ab84-146">Aby zalogować się jako aplikacji usługi AD, należy identyfikator aplikacji i hasło.</span><span class="sxs-lookup"><span data-stu-id="6ab84-146">To log in as the AD application, you need the application id and password.</span></span> <span data-ttu-id="6ab84-147">Aby wyświetlić identyfikator aplikacji jest zwracana z poprzedniego polecenia, należy użyć:</span><span class="sxs-lookup"><span data-stu-id="6ab84-147">To see the application id that is returned from the previous command, use:</span></span>

    $app.ApplicationId

<span data-ttu-id="6ab84-148">Poniższy przykład pokazuje, jak zarejestrować aplikacji przy użyciu wiersza polecenia platformy Azure.</span><span class="sxs-lookup"><span data-stu-id="6ab84-148">The following example shows how to register the app by using Azure CLI.</span></span>

    azure ad app create --name {app name} --home-page https://{your domain}/{app name} --identifier-uris https://{your domain}/{app name} --password {your password} --available true

<span data-ttu-id="6ab84-149">Wyniki zawierają identyfikator aplikacji, należy podczas uwierzytelniania, co aplikacja.</span><span class="sxs-lookup"><span data-stu-id="6ab84-149">The results include the AppId, which you need when authenticating as the application.</span></span>

### <a name="optional-configuration---certificate-credential"></a><span data-ttu-id="6ab84-150">Konfiguracja opcjonalna — certyfikat poświadczeń</span><span class="sxs-lookup"><span data-stu-id="6ab84-150">Optional configuration - certificate credential</span></span>
<span data-ttu-id="6ab84-151">Usługi Azure AD obsługuje również certyfikat poświadczeń dla aplikacji: utwórz samopodpisany certyfikat, przechowywać klucz prywatny i Dodaj klucz publiczny do rejestracji aplikacji usługi Azure AD.</span><span class="sxs-lookup"><span data-stu-id="6ab84-151">Azure AD also supports certificate credentials for applications: you create a self-signed cert, keep the private key, and add the public key to your Azure AD application registration.</span></span> <span data-ttu-id="6ab84-152">W przypadku uwierzytelniania aplikacji wysyła małych ładunku do usługi Azure AD podpisany przy użyciu klucza prywatnego, i usługi Azure AD sprawdza podpis przy użyciu klucza publicznego, który został zarejestrowany.</span><span class="sxs-lookup"><span data-stu-id="6ab84-152">For authentication, your application sends a small payload to Azure AD signed using your private key, and Azure AD validates the signature using the public key that you registered.</span></span>

<span data-ttu-id="6ab84-153">Dla informacji o tworzeniu aplikacji AD przy użyciu certyfikatu znajduje się w temacie [użycia programu Azure PowerShell do tworzenia nazwy głównej usługi dostępu do zasobów](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) lub [Użyj wiersza polecenia platformy Azure można utworzyć nazwy głównej usługi dostępu do zasobów](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate).</span><span class="sxs-lookup"><span data-stu-id="6ab84-153">For information about creating an AD app with a certificate, see [Use Azure PowerShell to create a service principal to access resources](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) or [Use Azure CLI to create a service principal to access resources](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate).</span></span>

## <a name="get-tenant-id-from-subscription-id"></a><span data-ttu-id="6ab84-154">Uzyskanie identyfikatora dzierżawy z identyfikatorem subskrypcji</span><span class="sxs-lookup"><span data-stu-id="6ab84-154">Get tenant id from subscription id</span></span>
<span data-ttu-id="6ab84-155">Do żądania tokenu, który może służyć do wywołania usługi Resource Manager, aplikacja musi znać identyfikator dzierżawy dzierżawy usługi Azure AD, obsługującym subskrypcji platformy Azure.</span><span class="sxs-lookup"><span data-stu-id="6ab84-155">To request a token that can be used to call Resource Manager, your application needs to know the tenant ID of the Azure AD tenant that hosts the Azure subscription.</span></span> <span data-ttu-id="6ab84-156">Prawdopodobnie użytkownicy wiedzą, ich identyfikatorów subskrypcji, ale nie będzie wiadomo, ich dzierżawy identyfikatorów dla usługi Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="6ab84-156">Most likely, your users know their subscription ids, but they might not know their tenant ids for Azure Active Directory.</span></span> <span data-ttu-id="6ab84-157">Uzyskanie identyfikatora dzierżawy przez użytkownika, należy poprosić użytkownika dla identyfikatora subskrypcji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-157">To get the user's tenant id, ask the user for the subscription id.</span></span> <span data-ttu-id="6ab84-158">Podaj ten identyfikator subskrypcji, wysyłając żądanie dotyczące subskrypcji:</span><span class="sxs-lookup"><span data-stu-id="6ab84-158">Provide that subscription id when sending a request about the subscription:</span></span>

    https://management.azure.com/subscriptions/{subscription-id}?api-version=2015-01-01

<span data-ttu-id="6ab84-159">Żądanie kończy się niepowodzeniem, ponieważ użytkownik nie zarejestrował jeszcze, ale można pobrać identyfikatora dzierżawy z odpowiedzi.</span><span class="sxs-lookup"><span data-stu-id="6ab84-159">The request fails because the user has not logged in yet, but you can retrieve the tenant id from the response.</span></span> <span data-ttu-id="6ab84-160">W tym wyjątku pobrać identyfikator dzierżawcy z wartości nagłówka odpowiedzi dla **WWW-Authenticate**.</span><span class="sxs-lookup"><span data-stu-id="6ab84-160">In that exception, retrieve the tenant id from the response header value for **WWW-Authenticate**.</span></span> <span data-ttu-id="6ab84-161">Zobacz to implementacja [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) metody.</span><span class="sxs-lookup"><span data-stu-id="6ab84-161">You see this implementation in the [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) method.</span></span>

## <a name="get-user--app-access-token"></a><span data-ttu-id="6ab84-162">Pobierz użytkownika + tokenu dostępu do aplikacji</span><span class="sxs-lookup"><span data-stu-id="6ab84-162">Get user + app access token</span></span>
<span data-ttu-id="6ab84-163">Aplikacja przekierowuje użytkownika do usługi Azure AD z OAuth 2.0 autoryzować żądania — uwierzytelnianie poświadczeń użytkownika i wrócić kod autoryzacji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-163">Your application redirects the user to Azure AD with an OAuth 2.0 Authorize Request - to authenticate the user's credentials and get back an authorization code.</span></span> <span data-ttu-id="6ab84-164">Aplikacja korzysta z kodu autoryzacji, Uzyskaj token dostępu dla Menedżera zasobów.</span><span class="sxs-lookup"><span data-stu-id="6ab84-164">Your application uses the authorization code to get an access token for Resource Manager.</span></span> <span data-ttu-id="6ab84-165">[ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) metoda tworzy żądania autoryzacji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-165">The [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) method creates the authorization request.</span></span>

<span data-ttu-id="6ab84-166">W tym temacie przedstawiono żądania interfejsu API REST do uwierzytelnienia użytkownika.</span><span class="sxs-lookup"><span data-stu-id="6ab84-166">This topic shows the REST API requests to authenticate the user.</span></span> <span data-ttu-id="6ab84-167">Umożliwia także biblioteki pomocnika do uwierzytelniania w kodzie.</span><span class="sxs-lookup"><span data-stu-id="6ab84-167">You can also use helper libraries to perform authentication in your code.</span></span> <span data-ttu-id="6ab84-168">Aby uzyskać więcej informacji o tych bibliotek, zobacz [bibliotek uwierzytelniania usługi Azure Active Directory](../active-directory/active-directory-authentication-libraries.md).</span><span class="sxs-lookup"><span data-stu-id="6ab84-168">For more information about these libraries, see [Azure Active Directory Authentication Libraries](../active-directory/active-directory-authentication-libraries.md).</span></span> <span data-ttu-id="6ab84-169">Aby uzyskać instrukcje dotyczące integrowania zarządzania tożsamością w aplikacji, zobacz [przewodnik dewelopera usługi Azure Active Directory](../active-directory/active-directory-developers-guide.md).</span><span class="sxs-lookup"><span data-stu-id="6ab84-169">For guidance on integrating identity management in an application, see [Azure Active Directory developer's guide](../active-directory/active-directory-developers-guide.md).</span></span>

### <a name="auth-request-oauth-20"></a><span data-ttu-id="6ab84-170">Żądanie uwierzytelniania (OAuth 2.0)</span><span class="sxs-lookup"><span data-stu-id="6ab84-170">Auth request (OAuth 2.0)</span></span>
<span data-ttu-id="6ab84-171">Wystawiać Open ID Connect/OAuth2.0 autoryzacji żądania do punktu końcowego autoryzacji usługi Azure AD:</span><span class="sxs-lookup"><span data-stu-id="6ab84-171">Issue an Open ID Connect/OAuth2.0 Authorize Request to the Azure AD Authorize endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize

<span data-ttu-id="6ab84-172">Parametry ciągu zapytania, które są dostępne dla tego żądania są opisane w [kod autoryzacji żądania](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) tematu.</span><span class="sxs-lookup"><span data-stu-id="6ab84-172">The query string parameters that are available for this request are described in the [request an authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) topic.</span></span>

<span data-ttu-id="6ab84-173">Poniższy przykład przedstawia sposób żądania autoryzacji OAuth2.0:</span><span class="sxs-lookup"><span data-stu-id="6ab84-173">The following example shows how to request OAuth2.0 authorization:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=query&response_type=code&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&domain_hint=live.com

<span data-ttu-id="6ab84-174">Usługi Azure AD uwierzytelnia użytkownika, a w razie potrzeby pyta użytkownika można udzielić uprawnienia do aplikacji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-174">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span></span> <span data-ttu-id="6ab84-175">Zwraca kod autoryzacji do adresu URL odpowiedzi aplikacji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-175">It returns the authorization code to the Reply URL of your application.</span></span> <span data-ttu-id="6ab84-176">W zależności od żądanego response_mode, usługi Azure AD albo odsyła dane w ciągu zapytania lub jako dane post.</span><span class="sxs-lookup"><span data-stu-id="6ab84-176">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span></span>

    code=AAABAAAAiL****FDMZBUwZ8eCAA&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="auth-request-open-id-connect"></a><span data-ttu-id="6ab84-177">Żądanie uwierzytelniania (Open ID Connect)</span><span class="sxs-lookup"><span data-stu-id="6ab84-177">Auth request (Open ID Connect)</span></span>
<span data-ttu-id="6ab84-178">Jeśli chcesz nie tylko dostęp do usługi Azure Resource Manager w imieniu użytkownika, ale również umożliwiać użytkownikowi zalogować się do aplikacji przy użyciu konta usługi Azure AD, należy wydać Open ID autoryzować żądania połączenia.</span><span class="sxs-lookup"><span data-stu-id="6ab84-178">If you not only wish to access Azure Resource Manager on behalf of the user, but also allow the user to sign in to your application using their Azure AD account, issue an Open ID Connect Authorize Request.</span></span> <span data-ttu-id="6ab84-179">Z Open ID Connect aplikacja odbiera żądaniu z usługi Azure AD, która aplikacji można używać do logowania użytkownika.</span><span class="sxs-lookup"><span data-stu-id="6ab84-179">With Open ID Connect, your application also receives an id_token from Azure AD that your app can use to sign in the user.</span></span>

<span data-ttu-id="6ab84-180">Parametry ciągu zapytania, które są dostępne dla tego żądania są opisane w [wysłanie żądania rejestrowania](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) tematu.</span><span class="sxs-lookup"><span data-stu-id="6ab84-180">The query string parameters that are available for this request are described in the [Send the sign-in request](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) topic.</span></span>

<span data-ttu-id="6ab84-181">Oto przykład Open ID Connect żądania jest:</span><span class="sxs-lookup"><span data-stu-id="6ab84-181">An example Open ID Connect request is:</span></span>

     https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=form_post&response_type=code+id_token&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&scope=openid+profile&nonce=63567Dc4MDAw&domain_hint=live.com&state=M_12tMyKaM8

<span data-ttu-id="6ab84-182">Usługi Azure AD uwierzytelnia użytkownika, a w razie potrzeby pyta użytkownika można udzielić uprawnienia do aplikacji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-182">Azure AD authenticates the user, and, if necessary, asks the user to grant permission to the app.</span></span> <span data-ttu-id="6ab84-183">Zwraca kod autoryzacji do adresu URL odpowiedzi aplikacji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-183">It returns the authorization code to the Reply URL of your application.</span></span> <span data-ttu-id="6ab84-184">W zależności od żądanego response_mode, usługi Azure AD albo odsyła dane w ciągu zapytania lub jako dane post.</span><span class="sxs-lookup"><span data-stu-id="6ab84-184">Depending on the requested response_mode, Azure AD either sends back the data in query string or as post data.</span></span>

<span data-ttu-id="6ab84-185">Przykład Open ID Connect odpowiedzi to:</span><span class="sxs-lookup"><span data-stu-id="6ab84-185">An example Open ID Connect response is:</span></span>

    code=AAABAAAAiL*****I4rDWd7zXsH6WUjlkIEQxIAA&id_token=eyJ0eXAiOiJKV1Q*****T3GrzzSFxg&state=M_12tMyKaM8&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="token-request-oauth20-code-grant-flow"></a><span data-ttu-id="6ab84-186">Żądania tokenu (OAuth2.0 Code Grant Flow)</span><span class="sxs-lookup"><span data-stu-id="6ab84-186">Token request (OAuth2.0 Code Grant Flow)</span></span>
<span data-ttu-id="6ab84-187">Teraz, gdy aplikacja otrzymał kod autoryzacji z usługi Azure AD, nadszedł czas na Uzyskaj token dostępu usługi Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="6ab84-187">Now that your application has received the authorization code from Azure AD, it is time to get the access token for Azure Resource Manager.</span></span>  <span data-ttu-id="6ab84-188">Opublikuj OAuth2.0 Code Grant Token żądania do punktu końcowego usługi Azure AD tokenu:</span><span class="sxs-lookup"><span data-stu-id="6ab84-188">Post an OAuth2.0 Code Grant Token Request to the Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="6ab84-189">Parametry ciągu zapytania, które są dostępne dla tego żądania są opisane w [kodu autoryzacji](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) tematu.</span><span class="sxs-lookup"><span data-stu-id="6ab84-189">The query string parameters that are available for this request are described in the [use the authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) topic.</span></span>

<span data-ttu-id="6ab84-190">W poniższym przykładzie przedstawiono żądania tokenu grant kodu z poświadczeniami hasło:</span><span class="sxs-lookup"><span data-stu-id="6ab84-190">The following example shows a request for code grant token with password credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="6ab84-191">Podczas pracy z poświadczeń certyfikatu, Utwórz tokenu Web JSON (JWT) i znak (RSA SHA256) przy użyciu klucza prywatnego poświadczeń certyfikatu aplikacji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-191">When working with certificate credentials, create a JSON Web Token (JWT) and sign (RSA SHA256) using the private key of your application's certificate credential.</span></span> <span data-ttu-id="6ab84-192">Typy oświadczeń dla tokenu są wyświetlane w [oświadczeń tokenu JWT](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span><span class="sxs-lookup"><span data-stu-id="6ab84-192">The claim types for the token are shown in [JWT token claims](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span></span> <span data-ttu-id="6ab84-193">Aby informacje, zobacz [kod biblioteki uwierzytelniania Active Directory (.NET)](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) do podpisywania tokenów JWT potwierdzenia klienta.</span><span class="sxs-lookup"><span data-stu-id="6ab84-193">For reference, see the [Active Directory Auth Library (.NET) code](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) to sign Client Assertion JWT tokens.</span></span>

<span data-ttu-id="6ab84-194">Zobacz [specyfikację Open ID Connect](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) szczegółowe informacje dotyczące uwierzytelniania klientów.</span><span class="sxs-lookup"><span data-stu-id="6ab84-194">See the [Open ID Connect spec](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) for details on client authentication.</span></span>

<span data-ttu-id="6ab84-195">W poniższym przykładzie przedstawiono żądania tokenu grant kodu z poświadczeniami certyfikatu:</span><span class="sxs-lookup"><span data-stu-id="6ab84-195">The following example shows a request for code grant token with certificate credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer&client_assertion=eyJhbG*****Y9cYo8nEjMyA

<span data-ttu-id="6ab84-196">Oto przykład odpowiedzi dla kodu umożliwić token:</span><span class="sxs-lookup"><span data-stu-id="6ab84-196">An example response for code grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039858","not_before":"1432035958","resource":"https://management.core.windows.net/","access_token":"eyJ0eXAiOiJKV1Q****M7Cw6JWtfY2lGc5A","refresh_token":"AAABAAAAiL9Kn2Z****55j-sjnyYgAA","scope":"user_impersonation","id_token":"eyJ0eXAiOiJKV*****-drP1J3P-HnHi9Rr46kGZnukEBH4dsg"}

#### <a name="handle-code-grant-token-response"></a><span data-ttu-id="6ab84-197">Obsługa odpowiedzi tokenu grant kodu</span><span class="sxs-lookup"><span data-stu-id="6ab84-197">Handle code grant token response</span></span>
<span data-ttu-id="6ab84-198">Odpowiedź oznaczająca Powodzenie tokenu zawiera (użytkownik + aplikacji) tokenu dostępu dla usługi Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="6ab84-198">A successful token response contains the (user + app) access token for Azure Resource Manager.</span></span> <span data-ttu-id="6ab84-199">Aplikacja używa ten token dostępu, aby otworzyć Menedżera zasobów w imieniu użytkownika.</span><span class="sxs-lookup"><span data-stu-id="6ab84-199">Your application uses this access token to access Resource Manager on behalf of the user.</span></span> <span data-ttu-id="6ab84-200">Okres istnienia tokenów dostępu wystawiony przez usługę Azure AD to jedna godzina.</span><span class="sxs-lookup"><span data-stu-id="6ab84-200">The lifetime of access tokens issued by Azure AD is one hour.</span></span> <span data-ttu-id="6ab84-201">Jest mało prawdopodobne, że aplikację sieci web musi odnawiać (użytkownik + aplikacji) tokenu dostępu.</span><span class="sxs-lookup"><span data-stu-id="6ab84-201">It is unlikely that your web application needs to renew the (user + app) access token.</span></span> <span data-ttu-id="6ab84-202">Jeśli konieczne do odnawiania tokenu dostępu, należy użyć token odświeżania, która aplikacja otrzymuje w odpowiedzi tokenu.</span><span class="sxs-lookup"><span data-stu-id="6ab84-202">If it needs to renew the access token, use the refresh token that your application receives in the token response.</span></span> <span data-ttu-id="6ab84-203">Opublikuj OAuth2.0 Token żądania do punktu końcowego usługi Azure AD tokenu:</span><span class="sxs-lookup"><span data-stu-id="6ab84-203">Post an OAuth2.0 Token Request to the Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="6ab84-204">Parametry używane z żądaniem odświeżania są opisane w [odświeżanie tokenu dostępu](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span><span class="sxs-lookup"><span data-stu-id="6ab84-204">The parameters to use with the refresh request are described in [refreshing the access token](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span></span>

<span data-ttu-id="6ab84-205">Poniższy przykład przedstawia użycie odświeżanie tokenu:</span><span class="sxs-lookup"><span data-stu-id="6ab84-205">The following example shows how to use the refresh token:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=refresh_token&refresh_token=AAABAAAAiL9Kn2Z****55j-sjnyYgAA&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="6ab84-206">Tokeny odświeżania może służyć do uzyskania nowego tokenów dostępu dla usługi Azure Resource Manager, nie są one odpowiednie dla dostęp w trybie offline przez aplikację.</span><span class="sxs-lookup"><span data-stu-id="6ab84-206">Although refresh tokens can be used to get new access tokens for Azure Resource Manager, they are not suitable for offline access by your application.</span></span> <span data-ttu-id="6ab84-207">Okres istnienia tokenów odświeżania jest ograniczona, a tokeny odświeżania są powiązane z użytkownikiem.</span><span class="sxs-lookup"><span data-stu-id="6ab84-207">The refresh tokens lifetime is limited, and refresh tokens are bound to the user.</span></span> <span data-ttu-id="6ab84-208">Jeśli użytkownik opuszcza organizację, aplikacji, używając tokenu odświeżania utracenia dostępu.</span><span class="sxs-lookup"><span data-stu-id="6ab84-208">If the user leaves the organization, the application using the refresh token loses access.</span></span> <span data-ttu-id="6ab84-209">Ta metoda nie jest odpowiedni dla aplikacji, które są używane przez zespoły do zarządzania zasobami platformy Azure.</span><span class="sxs-lookup"><span data-stu-id="6ab84-209">This approach isn't suitable for applications that are used by teams to manage their Azure resources.</span></span>

## <a name="check-if-user-can-assign-access-to-subscription"></a><span data-ttu-id="6ab84-210">Sprawdź, czy użytkownik może przypisać dostęp do subskrypcji</span><span class="sxs-lookup"><span data-stu-id="6ab84-210">Check if user can assign access to subscription</span></span>
<span data-ttu-id="6ab84-211">Teraz aplikacja ma token, aby uzyskać dostępu do usługi Azure Resource Manager w imieniu użytkownika.</span><span class="sxs-lookup"><span data-stu-id="6ab84-211">Your application now has a token to access Azure Resource Manager on behalf of the user.</span></span> <span data-ttu-id="6ab84-212">Następnym krokiem jest także łączenie aplikacji do subskrypcji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-212">The next step is to connect your app to the subscription.</span></span> <span data-ttu-id="6ab84-213">Po nawiązaniu połączenia aplikacji można zarządzać te subskrypcje, nawet wtedy, gdy użytkownik nie jest obecny (długoterminowej dostęp w trybie offline).</span><span class="sxs-lookup"><span data-stu-id="6ab84-213">After connecting, your app can manage those subscriptions even when the user isn't present (long-term offline access).</span></span>

<span data-ttu-id="6ab84-214">Dla każdej subskrypcji nawiązać wywołać [uprawnienia listy Resource Manager](https://docs.microsoft.com/rest/api/authorization/permissions) interfejsu API w celu określenia, czy użytkownik ma uprawnienia zarządzania dla subskrypcji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-214">For each subscription to connect, call the [Resource Manager list permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API to determine whether the user has access management rights for the subscription.</span></span>

<span data-ttu-id="6ab84-215">[UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) metoda przykładowej aplikacji ASP.NET MVC implementuje tego wywołania.</span><span class="sxs-lookup"><span data-stu-id="6ab84-215">The [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) method of the ASP.NET MVC sample app implements this call.</span></span>

<span data-ttu-id="6ab84-216">Poniższy przykład pokazuje, jak zażądać uprawnień użytkownika w subskrypcji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-216">The following example shows how to request a user's permissions on a subscription.</span></span> <span data-ttu-id="6ab84-217">83cfe939-2402-4581-b761-4f59b0a041e4 jest identyfikator subskrypcji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-217">83cfe939-2402-4581-b761-4f59b0a041e4 is the id of the subscription.</span></span>

    GET https://management.azure.com/subscriptions/83cfe939-2402-4581-b761-4f59b0a041e4/providers/microsoft.authorization/permissions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiLC***lwO1mM7Cw6JWtfY2lGc5A

<span data-ttu-id="6ab84-218">Przykładem odpowiedzi, aby uzyskać uprawnienia użytkownika w subskrypcji jest:</span><span class="sxs-lookup"><span data-stu-id="6ab84-218">An example of the response to get user's permissions on subscription is:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"actions":["*"],"notActions":["Microsoft.Authorization/*/Write","Microsoft.Authorization/*/Delete"]},{"actions":["*/read"],"notActions":[]}]}

<span data-ttu-id="6ab84-219">Uprawnienia interfejsu API zwraca wiele uprawnień.</span><span class="sxs-lookup"><span data-stu-id="6ab84-219">The permissions API returns multiple permissions.</span></span> <span data-ttu-id="6ab84-220">Wszystkie uprawnienia składa się z dozwolonych akcji (Akcje) i niedopuszczalne akcje (notactions).</span><span class="sxs-lookup"><span data-stu-id="6ab84-220">Each permission consists of allowed actions (actions) and disallowed actions (notactions).</span></span> <span data-ttu-id="6ab84-221">Jeśli jest obecna na liście dozwolonych akcji żadnych uprawnień i nie znajduje się na liście notactions te uprawnienia, użytkownik może wykonać tej operacji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-221">If an action is present in the allowed actions list of any permission and not present in the notactions list of that permission, the user is allowed to perform that action.</span></span> <span data-ttu-id="6ab84-222">**Microsoft.Authorization/RoleAssignments/Write** jest akcja management rights która udziela dostępu.</span><span class="sxs-lookup"><span data-stu-id="6ab84-222">**microsoft.authorization/roleassignments/write** is the action that that grants access management rights.</span></span> <span data-ttu-id="6ab84-223">Aplikacja musi przeanalizować wyniku uprawnienia do wyszukania dopasowanie wyrażenia regularnego w ciągu tej akcji w działaniach i notactions każdego uprawnienia.</span><span class="sxs-lookup"><span data-stu-id="6ab84-223">Your application must parse the permissions result to look for a regex match on this action string in the actions and notactions of each permission.</span></span>

## <a name="get-app-only-access-token"></a><span data-ttu-id="6ab84-224">Uzyskaj token dostępu tylko do aplikacji</span><span class="sxs-lookup"><span data-stu-id="6ab84-224">Get app-only access token</span></span>
<span data-ttu-id="6ab84-225">Teraz wiesz, czy użytkownik może przypisać dostęp do subskrypcji platformy Azure.</span><span class="sxs-lookup"><span data-stu-id="6ab84-225">Now, you know if the user can assign access to the Azure subscription.</span></span> <span data-ttu-id="6ab84-226">Następne kroki są:</span><span class="sxs-lookup"><span data-stu-id="6ab84-226">The next steps are:</span></span>

1. <span data-ttu-id="6ab84-227">Przypisz odpowiednie role RBAC do tożsamości aplikacji w ramach subskrypcji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-227">Assign the appropriate RBAC role to your application's identity on the subscription.</span></span>
2. <span data-ttu-id="6ab84-228">Sprawdzanie poprawności przypisania dostępu przez wykonanie zapytania dotyczącego aplikacji uprawnienia subskrypcji lub uzyskiwania dostępu do usługi Resource Manager przy użyciu tokenu tylko do aplikacji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-228">Validate the access assignment by querying for the Application's permission on the subscription or by accessing Resource Manager using app-only token.</span></span>
3. <span data-ttu-id="6ab84-229">Zapisz połączenie w strukturze danych aplikacji "połączonych subskrypcji" - utrwalanie identyfikator subskrypcji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-229">Record the connection in your applications "connected subscriptions" data structure - persisting the id of the subscription.</span></span>

<span data-ttu-id="6ab84-230">Oto bliżej w pierwszym kroku.</span><span class="sxs-lookup"><span data-stu-id="6ab84-230">Let's look closer at the first step.</span></span> <span data-ttu-id="6ab84-231">Aby przypisać odpowiednie role RBAC tożsamości aplikacji, należy określić:</span><span class="sxs-lookup"><span data-stu-id="6ab84-231">To assign the appropriate RBAC role to the application's identity, you must determine:</span></span>

* <span data-ttu-id="6ab84-232">Identyfikator obiektu tożsamości aplikacji w usłudze Active Directory Azure użytkownika</span><span class="sxs-lookup"><span data-stu-id="6ab84-232">The object id of your application's identity in the user's Azure Active Directory</span></span>
* <span data-ttu-id="6ab84-233">Identyfikator roli RBAC, wymaganych przez aplikację dla tej subskrypcji</span><span class="sxs-lookup"><span data-stu-id="6ab84-233">The identifier of the RBAC role that your application requires on the subscription</span></span>

<span data-ttu-id="6ab84-234">Podczas uwierzytelniania użytkownika z usługi Azure AD aplikacja tworzy obiekt główną usługi dla aplikacji w tej usłudze Azure AD.</span><span class="sxs-lookup"><span data-stu-id="6ab84-234">When your application authenticates a user from an Azure AD, it creates a service principal object for your application in that Azure AD.</span></span> <span data-ttu-id="6ab84-235">Azure umożliwia role RBAC ma być przypisany do nazwy główne usług uzyskać bezpośredni dostęp do odpowiednie aplikacje na zasobów platformy Azure.</span><span class="sxs-lookup"><span data-stu-id="6ab84-235">Azure allows RBAC roles to be assigned to service principals to grant direct access to corresponding applications on Azure resources.</span></span> <span data-ttu-id="6ab84-236">Ta akcja jest dokładnie Życzymy zrobić.</span><span class="sxs-lookup"><span data-stu-id="6ab84-236">This action is exactly what we wish to do.</span></span> <span data-ttu-id="6ab84-237">Zapytania interfejsu API programu Graph usługi AD platformy Azure w celu ustalenia identyfikatora nazwy głównej usługi aplikacji w zalogowanego użytkownika przez usługi Azure AD.</span><span class="sxs-lookup"><span data-stu-id="6ab84-237">Query the Azure AD Graph API to determine the identifier of the service principal of your application in the signed-in user's Azure AD.</span></span>

<span data-ttu-id="6ab84-238">Masz tylko token dostępu usługi Azure Resource Manager — należy uzyskać nowy token dostępu do wywołania interfejsu API programu Azure AD Graph.</span><span class="sxs-lookup"><span data-stu-id="6ab84-238">You only have an access token for Azure Resource Manager - you need a new access token to call the Azure AD Graph API.</span></span> <span data-ttu-id="6ab84-239">Każda aplikacja sieci Web w usłudze Azure AD ma uprawnienia do tworzenia zapytań własną obiekt główny usługi, więc token dostępu tylko do aplikacji jest wystarczająca.</span><span class="sxs-lookup"><span data-stu-id="6ab84-239">Every application in Azure AD has permission to query its own service principal object, so an app-only access token is sufficient.</span></span>

<a id="app-azure-ad-graph" />

### <a name="get-app-only-access-token-for-azure-ad-graph-api"></a><span data-ttu-id="6ab84-240">Uzyskaj token dostępu tylko do aplikacji interfejsu API Azure AD Graph</span><span class="sxs-lookup"><span data-stu-id="6ab84-240">Get app-only access token for Azure AD Graph API</span></span>
<span data-ttu-id="6ab84-241">Aby uwierzytelniać swoją aplikację i uzyskać token do interfejsu API Azure AD Graph, wysłać żądania tokenu przepływu OAuth2.0 przyznania poświadczeń klienta do punktu końcowego tokenu usługi Azure AD (**https://login.microsoftonline.com/ {directory_domain_name} / OAuth2/Token**).</span><span class="sxs-lookup"><span data-stu-id="6ab84-241">To authenticate your app and get a token to Azure AD Graph API, issue a Client Credential Grant OAuth2.0 flow token request to Azure AD token endpoint (**https://login.microsoftonline.com/{directory_domain_name}/OAuth2/Token**).</span></span>

<span data-ttu-id="6ab84-242">[GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) metody przykładowej aplikacji ASP.net MVC pobiera dostęp tylko do aplikacji token dla interfejsu API programu Graph dla platformy .NET przy użyciu biblioteki uwierzytelniania usługi Active Directory.</span><span class="sxs-lookup"><span data-stu-id="6ab84-242">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) method of the ASP.net MVC sample application gets an app-only access token for Graph API using the Active Directory Authentication Library for .NET.</span></span>

<span data-ttu-id="6ab84-243">Parametry ciągu zapytania, które są dostępne dla tego żądania są opisane w [żądania tokenu dostępu](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) tematu.</span><span class="sxs-lookup"><span data-stu-id="6ab84-243">The query string parameters that are available for this request are described in the [Request an Access Token](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) topic.</span></span>

<span data-ttu-id="6ab84-244">Oto przykład żądania tokenu przyznania poświadczeń klienta:</span><span class="sxs-lookup"><span data-stu-id="6ab84-244">An example request for client credential grant token:</span></span>

    POST https://login.microsoftonline.com/62e173e9-301e-423e-bcd4-29121ec1aa24/oauth2/token HTTP/1.1
    Content-Type: application/x-www-form-urlencoded
    Content-Length: 187</pre>
    <pre>grant_type=client_credentials&client_id=a0448380-c346-4f9f-b897-c18733de9394&resource=https%3A%2F%2Fgraph.windows.net%2F &client_secret=olna8C*****Og%3D

<span data-ttu-id="6ab84-245">Oto przykład odpowiedzi dla poświadczeń klienta umożliwić token:</span><span class="sxs-lookup"><span data-stu-id="6ab84-245">An example response for client credential grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039862","not_before":"1432035962","resource":"https://graph.windows.net/","access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSIsImtpZCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLndpbmRv****G5gUTV-kKorR-pg"}

### <a name="get-objectid-of-application-service-principal-in-user-azure-ad"></a><span data-ttu-id="6ab84-246">Pobrania ObjectId nazwy głównej usługi aplikacji w użytkownika usługi Azure AD</span><span class="sxs-lookup"><span data-stu-id="6ab84-246">Get ObjectId of application service principal in user Azure AD</span></span>
<span data-ttu-id="6ab84-247">Teraz, użyj tokenu na dostęp tylko do aplikacji zapytania [podmiotów zabezpieczeń usługi Azure AD Graph](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) API w celu określenia identyfikatora obiektu w katalogu, nazwy głównej usługi aplikacji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-247">Now, use the app-only access token to query the [Azure AD Graph Service Principals](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) API to determine the Object Id of the application's service principal in the directory.</span></span>

<span data-ttu-id="6ab84-248">[GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) metoda przykładowej aplikacji ASP.net MVC implementuje tego wywołania.</span><span class="sxs-lookup"><span data-stu-id="6ab84-248">The [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) method of the ASP.net MVC sample application implements this call.</span></span>

<span data-ttu-id="6ab84-249">Poniższy przykład pokazuje, jak żądanie nazwy głównej usługi aplikacji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-249">The following example shows how to request an application's service principal.</span></span> <span data-ttu-id="6ab84-250">a0448380-c346-4f9f-b897-c18733de9394 jest identyfikator klienta aplikacji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-250">a0448380-c346-4f9f-b897-c18733de9394 is the client id of the application.</span></span>

    GET https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/servicePrincipals?api-version=1.5&$filter=appId%20eq%20'a0448380-c346-4f9f-b897-c18733de9394' HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJK*****-kKorR-pg

<span data-ttu-id="6ab84-251">W poniższym przykładzie przedstawiono odpowiedzi na żądanie usługi aplikacji głównej</span><span class="sxs-lookup"><span data-stu-id="6ab84-251">The following example shows a response to the request for an application's service principal</span></span>

    HTTP/1.1 200 OK

    {"odata.metadata":"https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/$metadata#directoryObjects/Microsoft.DirectoryServices.ServicePrincipal","value":[{"odata.type":"Microsoft.DirectoryServices.ServicePrincipal","objectType":"ServicePrincipal","objectId":"9b5018d4-6951-42ed-8a92-f11ec283ccec","deletionTimestamp":null,"accountEnabled":true,"appDisplayName":"CloudSense","appId":"a0448380-c346-4f9f-b897-c18733de9394","appOwnerTenantId":"62e173e9-301e-423e-bcd4-29121ec1aa24","appRoleAssignmentRequired":false,"appRoles":[],"displayName":"CloudSense","errorUrl":null,"homepage":"http://www.vipswapper.com/cloudsense","keyCredentials":[],"logoutUrl":null,"oauth2Permissions":[{"adminConsentDescription":"Allow the application to access CloudSense on behalf of the signed-in user.","adminConsentDisplayName":"Access CloudSense","id":"b7b7338e-683a-4796-b95e-60c10380de1c","isEnabled":true,"type":"User","userConsentDescription":"Allow the application to access CloudSense on your behalf.","userConsentDisplayName":"Access CloudSense","value":"user_impersonation"}],"passwordCredentials":[],"preferredTokenSigningKeyThumbprint":null,"publisherName":"vipswapper"quot;,"replyUrls":["http://www.vipswapper.com/cloudsense","http://www.vipswapper.com","http://vipswapper.com","http://vipswapper.azurewebsites.net","http://localhost:62080"],"samlMetadataUrl":null,"servicePrincipalNames":["http://www.vipswapper.com/cloudsense","a0448380-c346-4f9f-b897-c18733de9394"],"tags":["WindowsAzureActiveDirectoryIntegratedApp"]}]}

### <a name="get-azure-rbac-role-identifier"></a><span data-ttu-id="6ab84-252">Pobierz identyfikator roli Azure RBAC</span><span class="sxs-lookup"><span data-stu-id="6ab84-252">Get Azure RBAC role identifier</span></span>
<span data-ttu-id="6ab84-253">Aby przypisać odpowiednie role RBAC do nazwy głównej usługi, należy określić identyfikator roli Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="6ab84-253">To assign the appropriate RBAC role to your service principal, you must determine the identifier of the Azure RBAC role.</span></span>

<span data-ttu-id="6ab84-254">Odpowiednią rolę RBAC dla aplikacji:</span><span class="sxs-lookup"><span data-stu-id="6ab84-254">The right RBAC role for your application:</span></span>

* <span data-ttu-id="6ab84-255">Jeśli aplikacja monitoruje tylko subskrypcja, bez wprowadzania żadnych zmian, wymaga tylko czytnika uprawnienia dla tej subskrypcji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-255">If your application only monitors the subscription, without making any changes, it requires only reader permissions on the subscription.</span></span> <span data-ttu-id="6ab84-256">Przypisz **czytnika** roli.</span><span class="sxs-lookup"><span data-stu-id="6ab84-256">Assign the **Reader** role.</span></span>
* <span data-ttu-id="6ab84-257">Jeśli aplikacja Azure subskrypcji, Tworzenie/modyfikowanie/usuwanie jednostek wymaga jednego uprawnienia współautora.</span><span class="sxs-lookup"><span data-stu-id="6ab84-257">If your application manages Azure the subscription, creating/modifying/deleting entities, it requires one of the contributor permissions.</span></span>
  * <span data-ttu-id="6ab84-258">Aby zarządzać określonego typu zasobu, Przypisz role współautora określonych zasobów (Współautor·maszyny·wirtualnej, współautora sieci wirtualnych, współautora konta magazynu itp.)</span><span class="sxs-lookup"><span data-stu-id="6ab84-258">To manage a particular type of resource, assign the resource-specific contributor roles (Virtual Machine Contributor, Virtual Network Contributor, Storage Account Contributor, etc.)</span></span>
  * <span data-ttu-id="6ab84-259">Aby zarządzać dowolnego typu zasobu, należy przypisać **współautora** roli.</span><span class="sxs-lookup"><span data-stu-id="6ab84-259">To manage any resource type, assign the **Contributor** role.</span></span>

<span data-ttu-id="6ab84-260">Przypisania roli dla aplikacji są widoczne dla użytkowników, dlatego wybierz wymagane najmniejszych uprawnień.</span><span class="sxs-lookup"><span data-stu-id="6ab84-260">The role assignment for your application is visible to users, so select the least-required privilege.</span></span>

<span data-ttu-id="6ab84-261">Wywołanie [definicji roli Menedżera zasobów interfejsu API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) Aby wyświetlić listę wszystkich ról Azure RBAC i wyszukiwania, a następnie iteracja wyników można znaleźć definicji odpowiednią rolę według nazwy.</span><span class="sxs-lookup"><span data-stu-id="6ab84-261">Call the [Resource Manager role definition API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) to list all Azure RBAC roles and search then iterate over the result to find the desired role definition by name.</span></span>

<span data-ttu-id="6ab84-262">[GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) metoda przykładowej aplikacji ASP.net MVC implementuje tego wywołania.</span><span class="sxs-lookup"><span data-stu-id="6ab84-262">The [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) method of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="6ab84-263">W poniższym przykładzie żądania pokazuje, jak można pobrać identyfikatora roli Azure RBAC.</span><span class="sxs-lookup"><span data-stu-id="6ab84-263">The following request example shows how to get Azure RBAC role identifier.</span></span> <span data-ttu-id="6ab84-264">09cbd307-aa71-4aca-b346-5f253e6e3ebb jest identyfikator subskrypcji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-264">09cbd307-aa71-4aca-b346-5f253e6e3ebb is the id of the subscription.</span></span>

    GET https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV*****fY2lGc5

<span data-ttu-id="6ab84-265">Odpowiedź znajduje się w następującym formacie:</span><span class="sxs-lookup"><span data-stu-id="6ab84-265">The response is in the following format:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"properties":{"roleName":"API Management Service Contributor","type":"BuiltInRole","description":"Lets you manage API Management services, but not access to them.","scope":"/","permissions":[{"actions":["Microsoft.ApiManagement/Services/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/312a565d-c81f-4fd8-895a-4e21e48d571c","type":"Microsoft.Authorization/roleDefinitions","name":"312a565d-c81f-4fd8-895a-4e21e48d571c"},{"properties":{"roleName":"Application Insights Component Contributor","type":"BuiltInRole","description":"Lets you manage Application Insights components, but not access to them.","scope":"/","permissions":[{"actions":["Microsoft.Insights/components/*","Microsoft.Insights/webtests/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/ae349356-3a1b-4a5e-921d-050484c6347e","type":"Microsoft.Authorization/roleDefinitions","name":"ae349356-3a1b-4a5e-921d-050484c6347e"}]}

<span data-ttu-id="6ab84-266">Nie trzeba wywołać tego interfejsu API w sposób ciągły.</span><span class="sxs-lookup"><span data-stu-id="6ab84-266">You do not need to call this API on an ongoing basis.</span></span> <span data-ttu-id="6ab84-267">Po określeniu dobrze znany identyfikator GUID definicji roli, można utworzyć identyfikator definicji roli jako:</span><span class="sxs-lookup"><span data-stu-id="6ab84-267">Once you've determined the well-known GUID of the role definition, you can construct the role definition id as:</span></span>

    /subscriptions/{subscription_id}/providers/Microsoft.Authorization/roleDefinitions/{well-known-role-guid}

<span data-ttu-id="6ab84-268">Poniżej przedstawiono znane identyfikatory GUID często używane wbudowane role:</span><span class="sxs-lookup"><span data-stu-id="6ab84-268">Here are the well-known guids of commonly used built-in roles:</span></span>

| <span data-ttu-id="6ab84-269">Rola</span><span class="sxs-lookup"><span data-stu-id="6ab84-269">Role</span></span> | <span data-ttu-id="6ab84-270">Identyfikator GUID</span><span class="sxs-lookup"><span data-stu-id="6ab84-270">Guid</span></span> |
| --- | --- |
| <span data-ttu-id="6ab84-271">Czytelnik</span><span class="sxs-lookup"><span data-stu-id="6ab84-271">Reader</span></span> |<span data-ttu-id="6ab84-272">acdd72a7-3385-48ef-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="6ab84-272">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |
| <span data-ttu-id="6ab84-273">Współautor</span><span class="sxs-lookup"><span data-stu-id="6ab84-273">Contributor</span></span> |<span data-ttu-id="6ab84-274">b24988ac-6180-42a0-ab88-20f7382dd24c</span><span class="sxs-lookup"><span data-stu-id="6ab84-274">b24988ac-6180-42a0-ab88-20f7382dd24c</span></span> |
| <span data-ttu-id="6ab84-275">Współautor maszyny wirtualnej</span><span class="sxs-lookup"><span data-stu-id="6ab84-275">Virtual Machine Contributor</span></span> |<span data-ttu-id="6ab84-276">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span><span class="sxs-lookup"><span data-stu-id="6ab84-276">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span></span> |
| <span data-ttu-id="6ab84-277">Współautor sieci wirtualnej</span><span class="sxs-lookup"><span data-stu-id="6ab84-277">Virtual Network Contributor</span></span> |<span data-ttu-id="6ab84-278">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span><span class="sxs-lookup"><span data-stu-id="6ab84-278">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span></span> |
| <span data-ttu-id="6ab84-279">Współautor konta magazynu</span><span class="sxs-lookup"><span data-stu-id="6ab84-279">Storage Account Contributor</span></span> |<span data-ttu-id="6ab84-280">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span><span class="sxs-lookup"><span data-stu-id="6ab84-280">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span></span> |
| <span data-ttu-id="6ab84-281">Współautor witryny sieci Web</span><span class="sxs-lookup"><span data-stu-id="6ab84-281">Website Contributor</span></span> |<span data-ttu-id="6ab84-282">de139f84-1756-47ae-9be6-808fbbe84772</span><span class="sxs-lookup"><span data-stu-id="6ab84-282">de139f84-1756-47ae-9be6-808fbbe84772</span></span> |
| <span data-ttu-id="6ab84-283">Współautor Plan sieci Web</span><span class="sxs-lookup"><span data-stu-id="6ab84-283">Web Plan Contributor</span></span> |<span data-ttu-id="6ab84-284">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span><span class="sxs-lookup"><span data-stu-id="6ab84-284">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span></span> |
| <span data-ttu-id="6ab84-285">SQL Server współautora</span><span class="sxs-lookup"><span data-stu-id="6ab84-285">SQL Server Contributor</span></span> |<span data-ttu-id="6ab84-286">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span><span class="sxs-lookup"><span data-stu-id="6ab84-286">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span></span> |
| <span data-ttu-id="6ab84-287">Współautor bazy danych SQL</span><span class="sxs-lookup"><span data-stu-id="6ab84-287">SQL DB Contributor</span></span> |<span data-ttu-id="6ab84-288">9b7fa17d-e63e-47B0-bb0a-15c516ac86ec</span><span class="sxs-lookup"><span data-stu-id="6ab84-288">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span></span> |

### <a name="assign-rbac-role-to-application"></a><span data-ttu-id="6ab84-289">Przypisz rolę RBAC do aplikacji</span><span class="sxs-lookup"><span data-stu-id="6ab84-289">Assign RBAC role to application</span></span>
<span data-ttu-id="6ab84-290">Masz wszystkie elementy potrzebne do przypisać odpowiednie role RBAC do Twojej nazwy głównej usługi za pomocą [Resource Manager utworzyć przypisanie roli](https://docs.microsoft.com/rest/api/authorization/roleassignments) interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="6ab84-290">You have everything you need to assign the appropriate RBAC role to your service principal by using the [Resource Manager create role assignment](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span></span>

<span data-ttu-id="6ab84-291">[GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) metoda przykładowej aplikacji ASP.net MVC implementuje tego wywołania.</span><span class="sxs-lookup"><span data-stu-id="6ab84-291">The [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) method of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="6ab84-292">Oto przykład żądania do przypisania roli RBAC do aplikacji:</span><span class="sxs-lookup"><span data-stu-id="6ab84-292">An example request to assign RBAC role to application:</span></span>

    PUT https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/microsoft.authorization/roleassignments/4f87261d-2816-465d-8311-70a27558df4c?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiL*****FlwO1mM7Cw6JWtfY2lGc5
    Content-Type: application/json
    Content-Length: 230

    {"properties": {"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2"}}

<span data-ttu-id="6ab84-293">W żądaniu używane są następujące wartości:</span><span class="sxs-lookup"><span data-stu-id="6ab84-293">In the request, the following values are used:</span></span>

| <span data-ttu-id="6ab84-294">Identyfikator GUID</span><span class="sxs-lookup"><span data-stu-id="6ab84-294">Guid</span></span> | <span data-ttu-id="6ab84-295">Opis</span><span class="sxs-lookup"><span data-stu-id="6ab84-295">Description</span></span> |
| --- | --- |
| <span data-ttu-id="6ab84-296">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span><span class="sxs-lookup"><span data-stu-id="6ab84-296">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span></span> |<span data-ttu-id="6ab84-297">Identyfikator subskrypcji</span><span class="sxs-lookup"><span data-stu-id="6ab84-297">the id of the subscription</span></span> |
| <span data-ttu-id="6ab84-298">c3097b31-7309-4c59-b4e3-770f8406bad2</span><span class="sxs-lookup"><span data-stu-id="6ab84-298">c3097b31-7309-4c59-b4e3-770f8406bad2</span></span> |<span data-ttu-id="6ab84-299">Identyfikator nazwy głównej usługi aplikacji</span><span class="sxs-lookup"><span data-stu-id="6ab84-299">the object id of the service principal of the application</span></span> |
| <span data-ttu-id="6ab84-300">acdd72a7-3385-48ef-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="6ab84-300">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |<span data-ttu-id="6ab84-301">Identyfikator roli czytnika</span><span class="sxs-lookup"><span data-stu-id="6ab84-301">the id of the reader role</span></span> |
| <span data-ttu-id="6ab84-302">4f87261d-2816-465d-8311-70a27558df4c</span><span class="sxs-lookup"><span data-stu-id="6ab84-302">4f87261d-2816-465d-8311-70a27558df4c</span></span> |<span data-ttu-id="6ab84-303">Nowy identyfikator guid utworzone dla nowe przypisanie roli</span><span class="sxs-lookup"><span data-stu-id="6ab84-303">a new guid created for the new role assignment</span></span> |

<span data-ttu-id="6ab84-304">Odpowiedź znajduje się w następującym formacie:</span><span class="sxs-lookup"><span data-stu-id="6ab84-304">The response is in the following format:</span></span>

    HTTP/1.1 201 Created

    {"properties":{"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2","scope":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb"},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleAssignments/4f87261d-2816-465d-8311-70a27558df4c","type":"Microsoft.Authorization/roleAssignments","name":"4f87261d-2816-465d-8311-70a27558df4c"}

### <a name="get-app-only-access-token-for-azure-resource-manager"></a><span data-ttu-id="6ab84-305">Uzyskaj dostęp tylko do aplikacji token dla usługi Azure Resource Manager</span><span class="sxs-lookup"><span data-stu-id="6ab84-305">Get app-only access token for Azure Resource Manager</span></span>
<span data-ttu-id="6ab84-306">Aby sprawdzić poprawność tej aplikacji ma żądany dostęp do subskrypcji, wykonaj zadania testowego dla subskrypcji przy użyciu tokenu tylko do aplikacji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-306">To validate that app has the desired access on the subscription, perform a test task on the subscription using an app-only token.</span></span>

<span data-ttu-id="6ab84-307">Aby uzyskać token dostępu tylko do aplikacji, wykonaj instrukcje z sekcji [Uzyskaj token dostępu tylko do aplikacji interfejsu API Azure AD Graph](#app-azure-ad-graph), podając inną wartość dla parametru zasobów:</span><span class="sxs-lookup"><span data-stu-id="6ab84-307">To get an app-only access token, follow instructions from section [Get app-only access token for Azure AD Graph API](#app-azure-ad-graph), with a different value for the resource parameter:</span></span>

    https://management.core.windows.net/

<span data-ttu-id="6ab84-308">[ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) metody przykładowej aplikacji ASP.NET MVC pobiera dostęp tylko do aplikacji token dla Menedżera zasobów Azure dla platformy .net przy użyciu biblioteki uwierzytelniania usługi Active Directory.</span><span class="sxs-lookup"><span data-stu-id="6ab84-308">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample application gets an app-only access token for Azure Resource Manager using the Active Directory Authentication Library for .net.</span></span>

#### <a name="get-applications-permissions-on-subscription"></a><span data-ttu-id="6ab84-309">Uzyskać uprawnienia aplikacji w subskrypcji</span><span class="sxs-lookup"><span data-stu-id="6ab84-309">Get Application's Permissions on Subscription</span></span>
<span data-ttu-id="6ab84-310">Aby sprawdzić, czy aplikacja ma odpowiednie prawa dostępu na subskrypcji platformy Azure, może także wywołać [uprawnienia menedżera zasobów](https://docs.microsoft.com/rest/api/authorization/permissions) interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="6ab84-310">To check that your application has the desired access on an Azure subscription, you may also call the [Resource Manager Permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span></span> <span data-ttu-id="6ab84-311">Ta metoda jest podobna do sposób można stwierdzić, czy użytkownik ma uprawnienia dostępu do zarządzania dla subskrypcji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-311">This approach is similar to how you determined whether the user has Access Management rights for the subscription.</span></span> <span data-ttu-id="6ab84-312">Teraz, wymaga jednak uprawnień interfejsu API przy użyciu tokenu dostępu tylko do aplikacji, odebrany w poprzednim kroku.</span><span class="sxs-lookup"><span data-stu-id="6ab84-312">However, this time, call the permissions API with the app-only access token that you received in the previous step.</span></span>

<span data-ttu-id="6ab84-313">[ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) metoda przykładowej aplikacji ASP.NET MVC implementuje tego wywołania.</span><span class="sxs-lookup"><span data-stu-id="6ab84-313">The [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of the ASP.NET MVC sample app implements this call.</span></span>

## <a name="manage-connected-subscriptions"></a><span data-ttu-id="6ab84-314">Zarządzanie subskrypcjami połączonych</span><span class="sxs-lookup"><span data-stu-id="6ab84-314">Manage connected subscriptions</span></span>
<span data-ttu-id="6ab84-315">Gdy odpowiednie role RBAC jest przypisany do głównej na subskrypcję usługi aplikacji, aplikacja może zachować monitorowania/zarządzanie przy użyciu tokenów dostępu tylko do aplikacji dla usługi Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="6ab84-315">When the appropriate RBAC role is assigned to your application's service principal on the subscription, your application can keep monitoring/managing it using app-only access tokens for Azure Resource Manager.</span></span>

<span data-ttu-id="6ab84-316">Jeśli właściciel subskrypcji usuwa przypisanie roli aplikacji przy użyciu klasycznego portalu lub narzędzia wiersza polecenia, aplikacji nie będzie już mógł uzyskać dostępu do tej subskrypcji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-316">If a subscription owner removes your application's role assignment using the classic portal or command-line tools, your application is no longer able to access that subscription.</span></span> <span data-ttu-id="6ab84-317">W takim przypadku należy powiadomienia użytkownika Przerwano połączenie z subskrypcją z poza aplikacją i nadaj im opcję "Napraw" połączenie.</span><span class="sxs-lookup"><span data-stu-id="6ab84-317">In that case, you should notify the user that the connection with the subscription was severed from outside the application and give them an option to "repair" the connection.</span></span> <span data-ttu-id="6ab84-318">"Napraw" po prostu ponownie utworzyć przypisania roli, który został usunięty w trybie offline.</span><span class="sxs-lookup"><span data-stu-id="6ab84-318">"Repair" would simply re-create the role assignment that was deleted offline.</span></span>

<span data-ttu-id="6ab84-319">Tak samo, jak włączono użytkownik mógł się połączyć subskrypcje aplikacji musi zezwolić użytkownikowi na odłączyć za subskrypcje.</span><span class="sxs-lookup"><span data-stu-id="6ab84-319">Just as you enabled the user to connect subscriptions to your application, you must allow the user to disconnect subscriptions too.</span></span> <span data-ttu-id="6ab84-320">Z dostępu administracyjnego punktu widzenia Odłącz oznacza usunięcie przypisania roli mającą nazwę główną usługi aplikacji dla tej subskrypcji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-320">From an access management point of view, disconnect means removing the role assignment that the application's service principal has on the subscription.</span></span> <span data-ttu-id="6ab84-321">Opcjonalnie każdy stan aplikacji dla subskrypcji mogą zostać usunięte za.</span><span class="sxs-lookup"><span data-stu-id="6ab84-321">Optionally, any state in the application for the subscription might be removed too.</span></span>
<span data-ttu-id="6ab84-322">Tylko użytkownicy mający uprawnienie zarządzania dla tej subskrypcji są w stanie rozłączenia subskrypcji.</span><span class="sxs-lookup"><span data-stu-id="6ab84-322">Only users with access management permission on the subscription are able to disconnect the subscription.</span></span>

<span data-ttu-id="6ab84-323">[Metody RevokeRoleFromServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) platformy ASP.net MVC przykładowej aplikacji implementuje tego wywołania.</span><span class="sxs-lookup"><span data-stu-id="6ab84-323">The [RevokeRoleFromServicePrincipalOnSubscription method](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) of the ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="6ab84-324">To wszystko — użytkownicy mogą teraz łatwo połączyć i zarządzać ich subskrypcjami platformy Azure z aplikacją.</span><span class="sxs-lookup"><span data-stu-id="6ab84-324">That's it - users can now easily connect and manage their Azure subscriptions with your application.</span></span>
