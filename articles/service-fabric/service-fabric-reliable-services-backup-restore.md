---
title: aaaService sieci szkieletowej kopii zapasowej i przywracania | Dokumentacja firmy Microsoft
description: "Dokumentacja koncepcyjna sieci szkieletowej usługi tworzenia kopii zapasowych i przywracania"
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: subramar,jessebenson
ms.assetid: 91ea6ca4-cc2a-4155-9823-dcbd0b996349
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2017
ms.author: mcoskun
ms.openlocfilehash: e502b59c84999c3fe825167383f00a5ebd70c9b5
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 10/06/2017
---
# <a name="back-up-and-restore-reliable-services-and-reliable-actors"></a><span data-ttu-id="1e0ce-103">Kopie zapasowe i przywracanie Reliable Services i Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="1e0ce-103">Back up and restore Reliable Services and Reliable Actors</span></span>
<span data-ttu-id="1e0ce-104">Sieć szkieletowa usług Azure to platforma wysokiej dostępności, która replikuje stanu hello w wielu węzłach toomaintain tego wysokiej dostępności.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-104">Azure Service Fabric is a high-availability platform that replicates hello state across multiple nodes toomaintain this high availability.</span></span>  <span data-ttu-id="1e0ce-105">W związku z tym nawet w przypadku awarii jednego węzła w klastrze hello, usługi hello nadal toobe dostępne.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-105">Thus, even if one node in hello cluster fails, hello services continue toobe available.</span></span> <span data-ttu-id="1e0ce-106">Dublowanie w wbudowane dostarczane przez platformę hello może być wystarczające dla niektórych, w niektórych przypadkach pożądane jest, aby tooback usługi hello zapasowych (tooan zewnętrznym sklepie).</span><span class="sxs-lookup"><span data-stu-id="1e0ce-106">While this in-built redundancy provided by hello platform may be sufficient for some, in certain cases it is desirable for hello service tooback up data (tooan external store).</span></span>

> [!NOTE]
> <span data-ttu-id="1e0ce-107">Jest krytyczne toobackup i przywracanie danych (i test, który działa zgodnie z oczekiwaniami), można odzyskać z scenariuszy utraty danych.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-107">It is critical toobackup and restore your data (and test that it works as expected) so you can recover from data loss scenarios.</span></span>
> 
> 

<span data-ttu-id="1e0ce-108">Na przykład usługa może być tooback zapasowych danych w kolejności tooprotect z hello następujące scenariusze:</span><span class="sxs-lookup"><span data-stu-id="1e0ce-108">For example, a service may want tooback up data in order tooprotect from hello following scenarios:</span></span>

- <span data-ttu-id="1e0ce-109">W przypadku hello hello trwałą utratę całego klastra sieci szkieletowej usług.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-109">In hello event of hello permanent loss of an entire Service Fabric cluster.</span></span>
- <span data-ttu-id="1e0ce-110">Trwałą utratę większości hello replik partycji usługi</span><span class="sxs-lookup"><span data-stu-id="1e0ce-110">Permanent loss of a majority of hello replicas of a service partition</span></span>
- <span data-ttu-id="1e0ce-111">Błędy administracyjne zgodnie z którymi stanu hello przypadkowo pobiera usunięte lub uszkodzony.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-111">Administrative errors whereby hello state accidentally gets deleted or corrupted.</span></span> <span data-ttu-id="1e0ce-112">Na przykład tak zdarzyć, jeśli administrator z uprawnieniami wystarczające błędnego usuwa hello usługę.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-112">For example, this may happen if an administrator with sufficient privilege erroneously deletes hello service.</span></span>
- <span data-ttu-id="1e0ce-113">Usterki w usłudze hello, które spowodować uszkodzenie danych.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-113">Bugs in hello service that cause data corruption.</span></span> <span data-ttu-id="1e0ce-114">Na przykład może to być spowodowane uaktualnienie kodu usługi uruchamia zapisywania tooa danych błędny niezawodnej kolekcji.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-114">For example, this may happen when a service code upgrade starts writing faulty data tooa Reliable Collection.</span></span> <span data-ttu-id="1e0ce-115">W takim przypadku zarówno hello kod i dane hello może mieć toobe przywrócono tooan wcześniej stanu.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-115">In such a case, both hello code and hello data may have toobe reverted tooan earlier state.</span></span>
- <span data-ttu-id="1e0ce-116">Przetwarzanie danych w trybie offline.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-116">Offline data processing.</span></span> <span data-ttu-id="1e0ce-117">Może być w trybie offline przetwarzania danych do analizy biznesowej, wykonywanej oddzielnie z hello usługi, które generuje dane hello toohave wygodne.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-117">It might be convenient toohave offline processing of data for business intelligence that happens separately from hello service that generates hello data.</span></span>

<span data-ttu-id="1e0ce-118">Funkcja Kopia zapasowa i przywracanie Hello umożliwia usług oparty na powitania niezawodnej usługi interfejsu API toocreate i przywracania kopii zapasowych.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-118">hello Backup/Restore feature allows services built on hello Reliable Services API toocreate and restore backups.</span></span> <span data-ttu-id="1e0ce-119">Witaj kopii zapasowej interfejsów API dostarczonych przez platformę hello Zezwalaj na kopie zapasowe stanu partycji usługi, bez blokowania odczytu lub zapisu.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-119">hello backup APIs provided by hello platform allow backup(s) of a service partition's state, without blocking read or write operations.</span></span> <span data-ttu-id="1e0ce-120">przywracania Hello interfejsów API umożliwiają przywrócone z kopii zapasowej wybrany toobe stanu partycji usługi.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-120">hello restore APIs allow a service partition's state toobe restored from a chosen backup.</span></span>

## <a name="types-of-backup"></a><span data-ttu-id="1e0ce-121">Typy kopii zapasowych</span><span class="sxs-lookup"><span data-stu-id="1e0ce-121">Types of Backup</span></span>
<span data-ttu-id="1e0ce-122">Dostępne są dwie opcje tworzenia kopii zapasowej: pełne i przyrostowe.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-122">There are two backup options: Full and Incremental.</span></span>
<span data-ttu-id="1e0ce-123">Pełna kopia zapasowa jest kopii zapasowej, który zawiera wszystkie hello wymagane toorecreate hello stan danych repliki hello: punkty kontrolne i wszystkie rekordy dziennika.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-123">A full backup is a backup that contains all hello data required toorecreate hello state of hello replica: checkpoints and all log records.</span></span>
<span data-ttu-id="1e0ce-124">Ponieważ ma ona punkty kontrolne hello i dziennika hello, pełnej kopii zapasowej można przywracać samodzielnie.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-124">Since it has hello checkpoints and hello log, a full backup can be restored by itself.</span></span>

<span data-ttu-id="1e0ce-125">Witaj problem z pełnych kopii zapasowych niemożliwości hello punkty kontrolne są duże.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-125">hello problem with full backups arises when hello checkpoints are large.</span></span>
<span data-ttu-id="1e0ce-126">Na przykład repliki, który ma 16 GB pamięci stanu ma punkty kontrolne, składające się z około too16 GB.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-126">For example, a replica that has 16 GB of state will have checkpoints that add up approximately too16 GB.</span></span>
<span data-ttu-id="1e0ce-127">Mamy cel punktu odzyskiwania pięciu minut hello replica wymaga toobe kopii zapasowej co pięć minut.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-127">If we have a Recovery Point Objective of five minutes, hello replica needs toobe backed up every five minutes.</span></span>
<span data-ttu-id="1e0ce-128">Zawsze zapasową musi toocopy 16 GB pamięci punkty kontrolne dodatkowo too50 MB (można skonfigurować przy użyciu `CheckpointThresholdInMB`), przez jaką dzienniki.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-128">Each time it backs up it needs toocopy 16 GB of checkpoints in addition too50 MB (configurable using `CheckpointThresholdInMB`) worth of logs.</span></span>

![Przykład pełnej kopii zapasowej.](media/service-fabric-reliable-services-backup-restore/FullBackupExample.PNG)

<span data-ttu-id="1e0ce-130">problem toothis rozwiązania Hello jest przyrostowych kopii zapasowych, gdzie kopii zapasowej zawiera tylko rekordów dziennika hello zmienione od czasu ostatniej kopii zapasowej hello.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-130">hello solution toothis problem is incremental backups, where backup only contains hello changed log records since hello last backup.</span></span>

![Przyrostowej kopii zapasowej przykład.](media/service-fabric-reliable-services-backup-restore/IncrementalBackupExample.PNG)

<span data-ttu-id="1e0ce-132">Ponieważ przyrostowe kopie zapasowe są tylko zmiany od ostatniej kopii zapasowej hello (nie zawiera punktów kontrolnych hello), toobe mają zwykle szybsze, ale nie można przywrócić na ich własnych.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-132">Since incremental backups are only changes since hello last backup (does not include hello checkpoints), they tend toobe faster but they cannot be restored on their own.</span></span>
<span data-ttu-id="1e0ce-133">toorestore przyrostowej kopii zapasowej całego łańcucha kopii zapasowej hello jest wymagana.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-133">toorestore an incremental backup, hello entire backup chain is required.</span></span>
<span data-ttu-id="1e0ce-134">Łańcuch kopii zapasowych łańcuch kopii zapasowych w programie pełnej kopii zapasowej i następuje numer ciągłe przyrostowych kopii zapasowych.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-134">A backup chain is a chain of backups starting with a full backup and followed by a number of contiguous incremental backups.</span></span>

## <a name="backup-reliable-services"></a><span data-ttu-id="1e0ce-135">Niezawodne usługi tworzenia kopii zapasowej</span><span class="sxs-lookup"><span data-stu-id="1e0ce-135">Backup Reliable Services</span></span>
<span data-ttu-id="1e0ce-136">Witaj autor usługi ma pełną kontrolę nad tym, kiedy toomake kopii zapasowych i przechowywania kopii zapasowych.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-136">hello service author has full control of when toomake backups and where backups will be stored.</span></span>

<span data-ttu-id="1e0ce-137">toostart kopii zapasowej, usługa hello musi funkcji członkowskiej hello dziedziczone tooinvoke `BackupAsync`.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-137">toostart a backup, hello service needs tooinvoke hello inherited member function `BackupAsync`.</span></span>  
<span data-ttu-id="1e0ce-138">Tworzenie kopii zapasowych może być utworzona tylko z repliki podstawowej i wymagają podania zapisu stanu toobe przyznane.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-138">Backups can be made only from primary replicas, and they require write status toobe granted.</span></span>

<span data-ttu-id="1e0ce-139">Jak pokazano poniżej, `BackupAsync` przyjmuje `BackupDescription` obiektu, w którym można określić pełny lub przyrostowej kopii zapasowej, a także funkcję wywołania zwrotnego, `Func<< BackupInfo, CancellationToken, Task<bool>>>` który wywoływane, gdy hello folderu kopii zapasowej został utworzony lokalnie i jest gotowy toobe przenieść się toosome magazynu zewnętrznego.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-139">As shown below, `BackupAsync` takes in a `BackupDescription` object, where one can specify a full or incremental backup, as well as a callback function, `Func<< BackupInfo, CancellationToken, Task<bool>>>` that is invoked when hello backup folder has been created locally and is ready toobe moved out toosome external storage.</span></span>

```csharp

BackupDescription myBackupDescription = new BackupDescription(backupOption.Incremental,this.BackupCallbackAsync);

await this.BackupAsync(myBackupDescription);

```

<span data-ttu-id="1e0ce-140">Żądanie tootake przyrostowej kopii zapasowej może zakończyć się niepowodzeniem z `FabricMissingFullBackupException`.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-140">Request tootake an incremental backup can fail with `FabricMissingFullBackupException`.</span></span> <span data-ttu-id="1e0ce-141">Ten wyjątek wskazuje jeden hello następujące czynności wykonywane:</span><span class="sxs-lookup"><span data-stu-id="1e0ce-141">This exception indicates that one of hello following things is happening:</span></span>

- <span data-ttu-id="1e0ce-142">repliki Hello nigdy nie miało pełnej kopii zapasowej, ponieważ jest on podstawowym,</span><span class="sxs-lookup"><span data-stu-id="1e0ce-142">hello replica has never taken a full backup since it has become primary,</span></span>
- <span data-ttu-id="1e0ce-143">Niektóre hello rekordów dziennika, ponieważ hello ostatniej kopii zapasowej został obcięty lub</span><span class="sxs-lookup"><span data-stu-id="1e0ce-143">some of hello log records since hello last backup has been truncated or</span></span>
- <span data-ttu-id="1e0ce-144">repliki przekazany hello `MaxAccumulatedBackupLogSizeInMB` limit.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-144">replica passed hello `MaxAccumulatedBackupLogSizeInMB` limit.</span></span>

<span data-ttu-id="1e0ce-145">Użytkownicy mogą zwiększyć prawdopodobieństwo hello jest możliwe toodo przyrostowych kopii zapasowych przez skonfigurowanie `MinLogSizeInMB` lub `TruncationThresholdFactor`.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-145">Users can increase hello likelihood of being able toodo incremental backups by configuring `MinLogSizeInMB` or `TruncationThresholdFactor`.</span></span>
<span data-ttu-id="1e0ce-146">Należy pamiętać, że te wartości po zwiększeniu hello na użycie dysku repliki.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-146">Note that increasing these values increases hello per replica disk usage.</span></span>
<span data-ttu-id="1e0ce-147">Aby uzyskać więcej informacji, zobacz [niezawodnej usługi konfiguracji](service-fabric-reliable-services-configuration.md)</span><span class="sxs-lookup"><span data-stu-id="1e0ce-147">For more information, see [Reliable Services Configuration](service-fabric-reliable-services-configuration.md)</span></span>

<span data-ttu-id="1e0ce-148">`BackupInfo`zawiera informacje dotyczące tworzenia kopii zapasowej hello hello lokalizacja folderu hello, gdzie środowiska uruchomieniowego hello zapisywane hello kopii zapasowej (`BackupInfo.Directory`).</span><span class="sxs-lookup"><span data-stu-id="1e0ce-148">`BackupInfo` provides information regarding hello backup, including hello location of hello folder where hello runtime saved hello backup (`BackupInfo.Directory`).</span></span> <span data-ttu-id="1e0ce-149">Funkcja wywołania zwrotnego Hello można przenieść hello `BackupInfo.Directory` tooan zewnętrznym sklepie lub w innej lokalizacji.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-149">hello callback function can move hello `BackupInfo.Directory` tooan external store or another location.</span></span>  <span data-ttu-id="1e0ce-150">Ta funkcja zwraca również wartość logiczną wskazującą, czy był lokalizacji docelowej tooits toosuccessfully stanie przenoszenia hello folderu kopii zapasowej.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-150">This function also returns a bool that indicates whether it was able toosuccessfully move hello backup folder tooits target location.</span></span>

<span data-ttu-id="1e0ce-151">Witaj poniższy kod przedstawia sposób hello `BackupCallbackAsync` metoda może być używana tooupload hello kopii zapasowej tooAzure magazynu:</span><span class="sxs-lookup"><span data-stu-id="1e0ce-151">hello following code demonstrates how hello `BackupCallbackAsync` method can be used tooupload hello backup tooAzure Storage:</span></span>

```csharp
private async Task<bool> BackupCallbackAsync(BackupInfo backupInfo, CancellationToken cancellationToken)
{
    var backupId = Guid.NewGuid();

    await externalBackupStore.UploadBackupFolderAsync(backupInfo.Directory, backupId, cancellationToken);

    return true;
}
```

<span data-ttu-id="1e0ce-152">Przykład Witaj poprzedzających `ExternalBackupStore` jest hello przykładowe klasy, która jest używana toointerface z magazynu obiektów Blob platformy Azure i `UploadBackupFolderAsync` to metoda hello kompresuje hello folderu i umieszcza je w magazynie obiektów Blob platformy Azure hello.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-152">In hello preceeding example, `ExternalBackupStore` is hello sample class that is used toointerface with Azure Blob storage, and `UploadBackupFolderAsync` is hello method that compresses hello folder and places it in hello Azure Blob store.</span></span>

<span data-ttu-id="1e0ce-153">Należy pamiętać, że:</span><span class="sxs-lookup"><span data-stu-id="1e0ce-153">Note that:</span></span>

  - <span data-ttu-id="1e0ce-154">Może istnieć tylko jedna operacja tworzenia kopii zapasowej aktywny na replice w danym momencie.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-154">There can be only one backup operation in-flight per replica at any given time.</span></span> <span data-ttu-id="1e0ce-155">Więcej niż jeden `BackupAsync` zgłosi wywołanie naraz `FabricBackupInProgressException` tooone kopii zapasowych porządkowych toolimit.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-155">More than one `BackupAsync` call at a time will throw `FabricBackupInProgressException` toolimit inflight backups tooone.</span></span>
  - <span data-ttu-id="1e0ce-156">Jeśli replika nie powiedzie się za pośrednictwem w trakcie kopii zapasowej, hello kopia zapasowa może nie zostały zakończone.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-156">If a replica fails over while a backup is in progress, hello backup may not have been completed.</span></span> <span data-ttu-id="1e0ce-157">W związku z tym po zakończeniu trybu failover hello jest usługi hello odpowiedzialność toorestart hello w kopii zapasowej za pomocą `BackupAsync` odpowiednio do potrzeb.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-157">Thus, once hello failover finishes, it is hello service's responsibility toorestart hello backup by invoking `BackupAsync` as necessary.</span></span>

## <a name="restore-reliable-services"></a><span data-ttu-id="1e0ce-158">Przywróć niezawodne usługi</span><span class="sxs-lookup"><span data-stu-id="1e0ce-158">Restore Reliable Services</span></span>
<span data-ttu-id="1e0ce-159">Ogólnie rzecz biorąc hello przypadku tooperform operacji przywracania może być konieczne należą do jednej z tych kategorii:</span><span class="sxs-lookup"><span data-stu-id="1e0ce-159">In general, hello cases when you might need tooperform a restore operation fall into one of these categories:</span></span>

  - <span data-ttu-id="1e0ce-160">Usługa Hello partycji utraty danych.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-160">hello service partition lost data.</span></span> <span data-ttu-id="1e0ce-161">Na przykład dysku Witaj dwie z trzech replik dla partycji (łącznie z repliki podstawowej hello) pobiera uszkodzony lub wyczyszczone.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-161">For example, hello disk for two out of three replicas for a partition (including hello primary replica) gets corrupted or wiped.</span></span> <span data-ttu-id="1e0ce-162">Witaj nową podstawową może być konieczne toorestore dane z kopii zapasowej.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-162">hello new primary may need toorestore data from a backup.</span></span>
  - <span data-ttu-id="1e0ce-163">Witaj całej usługi zostaną utracone.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-163">hello entire service is lost.</span></span> <span data-ttu-id="1e0ce-164">Na przykład administrator usuwa hello całej usługi, i w związku z tym usługa hello i danych hello wymagają toobe przywrócona.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-164">For example, an administrator removes hello entire service and thus hello service and hello data need toobe restored.</span></span>
  - <span data-ttu-id="1e0ce-165">Usługa Hello zreplikowanych danych błędy aplikacji (np. z powodu błędów aplikacji).</span><span class="sxs-lookup"><span data-stu-id="1e0ce-165">hello service replicated corrupt application data (e.g., because of an application bug).</span></span> <span data-ttu-id="1e0ce-166">W takim przypadku usługa hello ma toobe uaktualniony lub Przyczyna hello przywróconego tooremove hello uszkodzenia i-uszkodzenie danych ma toobe przywrócona.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-166">In this case, hello service has toobe upgraded or reverted tooremove hello cause of hello corruption, and non-corrupt data has toobe restored.</span></span>

<span data-ttu-id="1e0ce-167">Mimo że wiele metod jest możliwe, firma Microsoft oferuje kilka przykładów przy użyciu `RestoreAsync` toorecover z hello powyżej scenariuszy.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-167">While many approaches are possible, we offer some examples on using `RestoreAsync` toorecover from hello above scenarios.</span></span>

## <a name="partition-data-loss-in-reliable-services"></a><span data-ttu-id="1e0ce-168">Utrata danych partycji w niezawodne usługi</span><span class="sxs-lookup"><span data-stu-id="1e0ce-168">Partition data loss in Reliable Services</span></span>
<span data-ttu-id="1e0ce-169">W takim przypadku hello środowiska uruchomieniowego może automatycznie wykryć hello utraty danych i wywołać hello `OnDataLossAsync` interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-169">In this case, hello runtime would automatically detect hello data loss and invoke hello `OnDataLossAsync` API.</span></span>

<span data-ttu-id="1e0ce-170">Autor usługi Hello musi hello tooperform po toorecover:</span><span class="sxs-lookup"><span data-stu-id="1e0ce-170">hello service author needs tooperform hello following toorecover:</span></span>

  - <span data-ttu-id="1e0ce-171">Metoda wirtualna klasa podstawowa hello musi zostać zastąpiona `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-171">Override hello virtual base class method `OnDataLossAsync`.</span></span>
  - <span data-ttu-id="1e0ce-172">Znajdź hello najnowszej kopii zapasowej w lokalizacji zewnętrznych hello, która zawiera hello usługi tworzenia kopii zapasowych.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-172">Find hello latest backup in hello external location that contains hello service's backups.</span></span>
  - <span data-ttu-id="1e0ce-173">Pobieranie najnowszej kopii zapasowej hello (i zdekompresować hello kopii zapasowej do folderu kopii zapasowej hello, jeśli został poddany kompresji).</span><span class="sxs-lookup"><span data-stu-id="1e0ce-173">Download hello latest backup (and uncompress hello backup into hello backup folder if it was compressed).</span></span>
  - <span data-ttu-id="1e0ce-174">Witaj `OnDataLossAsync` metoda zapewnia `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-174">hello `OnDataLossAsync` method provides a `RestoreContext`.</span></span> <span data-ttu-id="1e0ce-175">Wywołaj hello `RestoreAsync` interfejsu API na powitania podane `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-175">Call hello `RestoreAsync` API on hello provided `RestoreContext`.</span></span>
  - <span data-ttu-id="1e0ce-176">Zwraca wartość true, jeśli przywrócenie hello został pomyślnie.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-176">Return true if hello restoration was a success.</span></span>

<span data-ttu-id="1e0ce-177">Poniżej przedstawiono przykład stosowania hello `OnDataLossAsync` metody:</span><span class="sxs-lookup"><span data-stu-id="1e0ce-177">Following is an example implementation of hello `OnDataLossAsync` method:</span></span>

```csharp
protected override async Task<bool> OnDataLossAsync(RestoreContext restoreCtx, CancellationToken cancellationToken)
{
    var backupFolder = await this.externalBackupStore.DownloadLastBackupAsync(cancellationToken);

    var restoreDescription = new RestoreDescription(backupFolder);

    await restoreCtx.RestoreAsync(restoreDescription);

    return true;
}
```

<span data-ttu-id="1e0ce-178">`RestoreDescription`Przekazano toohello `RestoreContext.RestoreAsync` wywołanie zawiera element członkowski o nazwie `BackupFolderPath`.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-178">`RestoreDescription` passed in toohello `RestoreContext.RestoreAsync` call contains a member called `BackupFolderPath`.</span></span>
<span data-ttu-id="1e0ce-179">Podczas przywracania pojedynczego pełnej kopii zapasowej, to `BackupFolderPath` powinna być ustawiona ścieżka lokalna toohello hello folderu, który zawiera z pełnej kopii zapasowej.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-179">When restoring a single full backup, this `BackupFolderPath` should be set toohello local path of hello folder that contains your full backup.</span></span>
<span data-ttu-id="1e0ce-180">Podczas przywracania pełnej kopii zapasowej i liczba przyrostowe kopie zapasowe, `BackupFolderPath` powinien być ustawiony toohello ścieżki lokalnej folderu hello, która zawiera nie tylko pełna kopia zapasowa hello, ale również wszystkie hello przyrostowe kopie zapasowe.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-180">When restoring a full backup and a number of incremental backups, `BackupFolderPath` should be set toohello local path of hello folder that not only contains hello full backup, but also all hello incremental backups.</span></span>
<span data-ttu-id="1e0ce-181">`RestoreAsync`Wywołanie może zgłosić `FabricMissingFullBackupException` Jeśli hello `BackupFolderPath` podane nie zawiera pełnej kopii zapasowej.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-181">`RestoreAsync` call can throw `FabricMissingFullBackupException` if hello `BackupFolderPath` provided does not contain a full backup.</span></span>
<span data-ttu-id="1e0ce-182">Można również zgłosić `ArgumentException` Jeśli `BackupFolderPath` został przerwany łańcuch przyrostowych kopii zapasowych.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-182">It can also throw `ArgumentException` if `BackupFolderPath` has a broken chain of incremental backups.</span></span>
<span data-ttu-id="1e0ce-183">Na przykład jeśli zawiera on hello pełnej kopii zapasowej, najpierw hello przyrostowych i hello trzeci przyrostowej kopii zapasowej, ale nie hello drugi przyrostowej kopii zapasowej.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-183">For example, if it contains hello full backup, hello first incremental and hello third incremental backup but no hello second incremental backup.</span></span>

> [!NOTE]
> <span data-ttu-id="1e0ce-184">Witaj RestorePolicy jest domyślnie tooSafe.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-184">hello RestorePolicy is set tooSafe by default.</span></span>  <span data-ttu-id="1e0ce-185">Oznacza to, że hello `RestoreAsync` interfejsu API zakończy się niepowodzeniem z ArgumentException rozpoznaje tego folderu kopii zapasowej hello zawiera informacje o stanie, które jest zawarte w tej replice stanu toohello starsze niż lub równe.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-185">This means that hello `RestoreAsync` API will fail with ArgumentException if it detects that hello backup folder contains a state that is older than or equal toohello state contained in this replica.</span></span>  <span data-ttu-id="1e0ce-186">`RestorePolicy.Force`może być używane tooskip ta kontrola bezpieczeństwa.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-186">`RestorePolicy.Force` can be used tooskip this safety check.</span></span> <span data-ttu-id="1e0ce-187">To jest określony jako część `RestoreDescription`.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-187">This is specified as part of `RestoreDescription`.</span></span>
> 

## <a name="deleted-or-lost-service"></a><span data-ttu-id="1e0ce-188">Usunięte i utracone usługi</span><span class="sxs-lookup"><span data-stu-id="1e0ce-188">Deleted or lost service</span></span>
<span data-ttu-id="1e0ce-189">Jeśli usługa zostanie usunięty, należy najpierw ponownie utworzyć hello usługi przed przywróceniem hello danych.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-189">If a service is removed, you must first re-create hello service before hello data can be restored.</span></span>  <span data-ttu-id="1e0ce-190">Jest ważne toocreate hello usługi o tej samej konfiguracji, np. schemat, partycjonowania, który hello dane można przywrócić bezproblemowo powitalne.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-190">It is important toocreate hello service with hello same configuration, e.g., partitioning scheme, so that hello data can be restored seamlessly.</span></span>  <span data-ttu-id="1e0ce-191">Po skonfigurowaniu usługi hello hello danych toorestore interfejsu API (`OnDataLossAsync` powyżej) ma toobe wywoływane na każdej partycji tej usługi.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-191">Once hello service is up, hello API toorestore data (`OnDataLossAsync` above) has toobe invoked on every partition of this service.</span></span> <span data-ttu-id="1e0ce-192">Jednym ze sposobów osiągnięcia jest przy użyciu `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` na każdej partycji.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-192">One way of achieving this is by using `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` on every partition.</span></span>  

<span data-ttu-id="1e0ce-193">Z tego punktu implementacji jest hello taki sam jak hello powyżej scenariusza.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-193">From this point, implementation is hello same as hello above scenario.</span></span> <span data-ttu-id="1e0ce-194">Każda partycja musi toorestore hello najnowszych odpowiednich kopii zapasowej z magazynu zewnętrznego hello.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-194">Each partition needs toorestore hello latest relevant backup from hello external store.</span></span> <span data-ttu-id="1e0ce-195">Jedno zastrzeżenie: jest tej partycji hello, którego identyfikator może teraz zmieniono, ponieważ środowisko uruchomieniowe hello dynamicznie tworzy identyfikatorów partycji.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-195">One caveat is that hello partition ID may have now changed, since hello runtime creates partition IDs dynamically.</span></span> <span data-ttu-id="1e0ce-196">W związku z tym usługa hello musi toostore hello partycji odpowiednie informacje i usługi nazwa tooidentify hello poprawne najnowszej kopii zapasowej toorestore z dla każdej partycji.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-196">Thus, hello service needs toostore hello appropriate partition information and service name tooidentify hello correct latest backup toorestore from for each partition.</span></span>

> [!NOTE]
> <span data-ttu-id="1e0ce-197">Nie zaleca się toouse `FabricClient.ServiceManager.InvokeDataLossAsync` na każdej partycji toorestore hello całej usługi, ponieważ, który może doprowadzić do uszkodzenia sieci klastra.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-197">It is not recommended toouse `FabricClient.ServiceManager.InvokeDataLossAsync` on each partition toorestore hello entire service, since that may corrupt your cluster state.</span></span>
> 

## <a name="replication-of-corrupt-application-data"></a><span data-ttu-id="1e0ce-198">Replikacja danych aplikacji uszkodzony</span><span class="sxs-lookup"><span data-stu-id="1e0ce-198">Replication of corrupt application data</span></span>
<span data-ttu-id="1e0ce-199">Uaktualniania aplikacji hello nowo wdrożone zawiera usterkę, która może spowodować uszkodzenie danych.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-199">If hello newly deployed application upgrade has a bug, that may cause corruption of data.</span></span> <span data-ttu-id="1e0ce-200">Na przykład uaktualnienie aplikacji może uruchomić tooupdate każdego rekordu numeru telefonu w niezawodnej słownik zawiera nieprawidłowy kod obszaru.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-200">For example, an application upgrade may start tooupdate every phone number record in a Reliable Dictionary with an invalid area code.</span></span>  <span data-ttu-id="1e0ce-201">W takim przypadku hello nieprawidłowych numerach telefonów będą replikowane od sieci szkieletowej usług nie został powiadomiony o rodzaju hello hello danych, które są przechowywane.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-201">In this case, hello invalid phone numbers will be replicated since Service Fabric is not aware of hello nature of hello data that is being stored.</span></span>

<span data-ttu-id="1e0ce-202">Witaj po pierwsze toodo po wykrywania takich rażące usterkę, która spowoduje uszkodzenie danych toofreeze hello usługa na poziomie aplikacji hello i, jeśli to możliwe, uaktualnienie wersji toohello hello kodu aplikacji, który nie ma błędów hello.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-202">hello first thing toodo after you detect such an egregious bug that causes data corruption is toofreeze hello service at hello application level and, if possible, upgrade toohello version of hello application code that does not have hello bug.</span></span>  <span data-ttu-id="1e0ce-203">Jednak nawet po hello kodu usługi został rozwiązany, hello danych nadal może być uszkodzony i dlatego może być konieczne toobe przywrócić dane.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-203">However, even after hello service code is fixed, hello data may still be corrupt and thus data may need toobe restored.</span></span>  <span data-ttu-id="1e0ce-204">W takim przypadku nie można wystarczające toorestore hello najnowszej kopii zapasowej, ponieważ hello najnowszej kopii zapasowych również może być uszkodzony.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-204">In such cases, it may not be sufficient toorestore hello latest backup, since hello latest backups may also be corrupt.</span></span>  <span data-ttu-id="1e0ce-205">W związku z tym należy toofind hello ostatniej kopii zapasowej utworzonej przed hello danych został uszkodzony.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-205">Thus, you have toofind hello last backup that was made before hello data got corrupted.</span></span>

<span data-ttu-id="1e0ce-206">Jeśli nie masz pewności, których kopie zapasowe są uszkodzone, można wdrożyć nowy klaster sieci szkieletowej usług i przywracać kopie zapasowe powitalnych wykorzystywanych partycji, podobnie jak hello powyżej "Usunięte lub usługa utracone" scenariusza.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-206">If you are not sure which backups are corrupt, you could deploy a new Service Fabric cluster and restore hello backups of affected partitions just like hello above "Deleted or lost service" scenario.</span></span>  <span data-ttu-id="1e0ce-207">Dla każdej partycji uruchomić przywracanie kopii zapasowych hello z najnowszych toohello hello najmniej.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-207">For each partition, start restoring hello backups from hello most recent toohello least.</span></span> <span data-ttu-id="1e0ce-208">Po znalezieniu kopii zapasowej, która nie ma uszkodzenie hello Przenieś/Usuń wszystkie kopie zapasowe tej partycji, które były nowsza (od tej kopii zapasowej).</span><span class="sxs-lookup"><span data-stu-id="1e0ce-208">Once you find a backup that does not have hello corruption, move/delete all backups of this partition that were more recent (than that backup).</span></span> <span data-ttu-id="1e0ce-209">Powtórz ten proces dla każdej partycji.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-209">Repeat this process for each partition.</span></span> <span data-ttu-id="1e0ce-210">Teraz, gdy `OnDataLossAsync` jest wywoływana na powitania partycji w klastra produkcyjnego hello, hello ostatniej kopii zapasowej znaleziono w hello zewnętrznych magazynu będzie hello jedną pobrane hello powyżej procesu.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-210">Now, when `OnDataLossAsync` is called on hello partition in hello production cluster, hello last backup found in hello external store will be hello one picked by hello above process.</span></span>

<span data-ttu-id="1e0ce-211">Teraz, hello etapami Witaj, "Usunięte lub usługa utracone" sekcji może być używana toorestore stanie hello hello usługi toohello stanu, zanim kod buggy hello uszkodzony hello stanu.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-211">Now, hello steps in hello "Deleted or lost service" section can be used toorestore hello state of hello service toohello state before hello buggy code corrupted hello state.</span></span>

<span data-ttu-id="1e0ce-212">Należy pamiętać, że:</span><span class="sxs-lookup"><span data-stu-id="1e0ce-212">Note that:</span></span>

  - <span data-ttu-id="1e0ce-213">Podczas przywracania, jest stosowany hello kopii zapasowej przywrócić jest starsza niż stan hello hello partycji przed hello dane zostały utracone.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-213">When you restore, there is a chance that hello backup being restored is older than hello state of hello partition before hello data was lost.</span></span> <span data-ttu-id="1e0ce-214">W związku z tym należy przywrócić tylko jako ostatni toorecover możliwości jak najwięcej danych jak to możliwe.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-214">Because of this, you should restore only as a last resort toorecover as much data as possible.</span></span>
  - <span data-ttu-id="1e0ce-215">Witaj ciąg, który reprezentuje ścieżkę folderu kopii zapasowej hello i hello ścieżki plików w folderze kopii zapasowej hello może być większa niż 255 znaków, w zależności od ścieżki zmiennej FabricDataRoot hello i długość nazwy typu aplikacji.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-215">hello string that represents hello backup folder path and hello paths of files inside hello backup folder can be greater than 255 characters, depending on hello FabricDataRoot path and Application Type name's length.</span></span> <span data-ttu-id="1e0ce-216">Może to spowodować niektóre metody .NET, takie jak `Directory.Move`, toothrow hello `PathTooLongException` wyjątku.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-216">This can cause some .NET methods, like `Directory.Move`, toothrow hello `PathTooLongException` exception.</span></span> <span data-ttu-id="1e0ce-217">Jednym z rozwiązań jest toodirectly wywołania interfejsów API kernel32, takich jak `CopyFile`.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-217">One workaround is toodirectly call kernel32 APIs, like `CopyFile`.</span></span>

## <a name="backup-and-restore-reliable-actors"></a><span data-ttu-id="1e0ce-218">Kopia zapasowa i przywracanie Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="1e0ce-218">Backup and restore Reliable Actors</span></span>


<span data-ttu-id="1e0ce-219">Niezawodne Framework złośliwych użytkowników jest oparty na niezawodne usługi.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-219">Reliable Actors Framework is built on top of Reliable Services.</span></span> <span data-ttu-id="1e0ce-220">Witaj ActorService obsługującego hello actor(s) jest stanowe niezawodnej usługi.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-220">hello ActorService which hosts hello actor(s) is a stateful reliable service.</span></span> <span data-ttu-id="1e0ce-221">W związku z tym wszystkie hello kopii zapasowej i przywracania funkcji dostępnych w usługach niezawodnej jest również dostępna tooReliable podmiotów (z wyjątkiem zachowania, które są właściwe dla dostawcy stanu).</span><span class="sxs-lookup"><span data-stu-id="1e0ce-221">Hence, all hello backup and restore functionality available in Reliable Services is also available tooReliable Actors (except behaviors that are state provider specific).</span></span> <span data-ttu-id="1e0ce-222">Ponieważ kopie zapasowe zostaną wykonane na podstawie na partycji, Stany wszystkich podmiotów partycji zostaną umieszczone w kopii (i przywracania jest podobny i nastąpi na podstawie na partycji).</span><span class="sxs-lookup"><span data-stu-id="1e0ce-222">Since backups will be taken on a per-partition basis, states for all actors in that partition will be backed up (and restoration is similar and will happen on a per-partition basis).</span></span> <span data-ttu-id="1e0ce-223">tooperform wykonywania kopii zapasowej/przywracania, hello Właściciel usługi należy utworzyć niestandardowe aktora klasy usługi, która pochodzi z klasy ActorService i następnie wykonywania kopii zapasowej/przywracania tooReliable podobnych usług zgodnie z powyższym opisem w poprzedniej sekcji.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-223">tooperform backup/restore, hello service owner should create a custom actor service class that derives from ActorService class and then do backup/restore similar tooReliable Services as described above in previous sections.</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo)
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="1e0ce-224">Podczas tworzenia klasy usługi aktora niestandardowe, należy to również tooregister, podczas rejestrowania hello aktora.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-224">When you create a custom actor service class, you need tooregister that as well when registering hello actor.</span></span>

```csharp
ActorRuntime.RegisterActorAsync<MyActor>(
   (context, typeInfo) => new MyCustomActorService(context, typeInfo)).GetAwaiter().GetResult();
```

<span data-ttu-id="1e0ce-225">Witaj domyślnego stanu dostawcy dla elementów Reliable Actors jest `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-225">hello default state provider for Reliable Actors is `KvsActorStateProvider`.</span></span> <span data-ttu-id="1e0ce-226">Przyrostowa kopia zapasowa nie jest włączona domyślnie dla `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-226">Incremental backup is not enabled by default for `KvsActorStateProvider`.</span></span> <span data-ttu-id="1e0ce-227">Można włączyć przyrostowej kopii zapasowej, tworząc `KvsActorStateProvider` z hello odpowiednie ustawienie w swoich konstruktorach i następnie przekazanie jej przez konstruktora tooActorService, jak pokazano w poniższym fragmencie kodu:</span><span class="sxs-lookup"><span data-stu-id="1e0ce-227">You can enable incremental backup by creating `KvsActorStateProvider` with hello appropriate setting in its constructor and then passing it tooActorService constructor as shown in following code snippet:</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo, null, null, new KvsActorStateProvider(true)) // Enable incremental backup
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="1e0ce-228">Po włączeniu przyrostowej kopii zapasowej, biorąc przyrostowej kopii zapasowej może zakończyć się niepowodzeniem z FabricMissingFullBackupException dla jednego z następujących powodów i trzeba będzie tootake pełnej kopii zapasowej przed zmianą przyrostowe kopie zapasowe:</span><span class="sxs-lookup"><span data-stu-id="1e0ce-228">After incremental backup has been enabled, taking an incremental backup can fail with FabricMissingFullBackupException for one of following reasons and you will need tootake a full backup before taking incremental backup(s):</span></span>

  - <span data-ttu-id="1e0ce-229">repliki Hello nigdy nie został wykonany pełnej kopii zapasowej, ponieważ stał się podstawowym.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-229">hello replica has never taken a full backup since it became primary.</span></span>
  - <span data-ttu-id="1e0ce-230">Niektóre rekordy dziennika hello została obcięta, ponieważ ostatnia kopia zapasowa została wykonana.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-230">Some of hello log records were truncated since last backup was taken.</span></span>

<span data-ttu-id="1e0ce-231">Po włączeniu przyrostowej kopii zapasowej `KvsActorStateProvider` nie używa toomanage cyklicznego buforu dziennika rejestruje i okresowo obcina go.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-231">When incremental backup is enabled, `KvsActorStateProvider` does not use circular buffer toomanage its log records and periodically truncates it.</span></span> <span data-ttu-id="1e0ce-232">Jeśli żadna kopia zapasowa nie zostanie podjęta przez użytkownika w danym okresie 45 minut, hello system automatycznie obcina hello rekordów dziennika.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-232">If no backup is taken by user for a period of 45 minutes, hello system automatically truncates hello log records.</span></span> <span data-ttu-id="1e0ce-233">Ten interwał można skonfigurować, określając `logTrunctationIntervalInMinutes` w `KvsActorStateProvider` — Konstruktor (toowhen podobne włączenie przyrostowej kopii zapasowej).</span><span class="sxs-lookup"><span data-stu-id="1e0ce-233">This interval can be configured by specifying `logTrunctationIntervalInMinutes` in `KvsActorStateProvider` constructor (similar toowhen enabling incremental backup).</span></span> <span data-ttu-id="1e0ce-234">rekordów dziennika Hello również może pobrać obcięty, jeśli replika podstawowa potrzebujesz toobuild innej repliki, wysyłając jego dane.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-234">hello log records may also get truncated if primary replica need toobuild another replica by sending all its data.</span></span>

<span data-ttu-id="1e0ce-235">Podczas operacji przywracania z kopii zapasowej łańcucha, podobne usługi tooReliable, hello BackupFolderPath powinien zawierać podkatalogów z podkatalogu co zawierające pełnej kopii zapasowej oraz inne podkatalogi zawierające przyrostowe kopie zapasowe.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-235">When doing restore from a backup chain, similar tooReliable Services, hello BackupFolderPath should contain subdirectories with one subdirectory containing full backup and others subdirectories containing incremental backup(s).</span></span> <span data-ttu-id="1e0ce-236">Interfejs API przywracania Hello zgłosi FabricException z odpowiedni komunikat o błędzie w przypadku niepowodzenia weryfikacji łańcucha kopii zapasowej hello.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-236">hello restore API will throw FabricException with appropriate error message if hello backup chain validation fails.</span></span> 

> [!NOTE]
> <span data-ttu-id="1e0ce-237">`KvsActorStateProvider`obecnie ignoruje opcję hello RestorePolicy.Safe.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-237">`KvsActorStateProvider` currently ignores hello option RestorePolicy.Safe.</span></span> <span data-ttu-id="1e0ce-238">Obsługa tej funkcji jest planowana w nową wersją.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-238">Support for this feature is planned in an upcoming release.</span></span>
> 

## <a name="testing-backup-and-restore"></a><span data-ttu-id="1e0ce-239">Testowanie kopii zapasowych i przywracania</span><span class="sxs-lookup"><span data-stu-id="1e0ce-239">Testing Backup and Restore</span></span>
<span data-ttu-id="1e0ce-240">Jest ważne tooensure, kluczowych danych jest tworzona kopia zapasowa, którą można przywrócić.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-240">It is important tooensure that critical data is being backed up, and can be restored from.</span></span> <span data-ttu-id="1e0ce-241">Można to zrobić za pomocą hello `Start-ServiceFabricPartitionDataLoss` polecenia cmdlet programu PowerShell, który można wywołać utrata danych w tootest określonej partycji, czy hello danych kopii zapasowej i przywrócenia jej funkcjonalności dla usługi działa zgodnie z oczekiwaniami.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-241">This can be done by invoking hello `Start-ServiceFabricPartitionDataLoss` cmdlet in PowerShell that can induce data loss in a particular partition tootest whether hello data backup and restore functionality for your service is working as expected.</span></span>  <span data-ttu-id="1e0ce-242">Możliwe jest również możliwe tooprogrammatically wywoływać utraty danych i Przywróć z zdarzenia oraz.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-242">It is also possible tooprogrammatically invoke data loss and restore from that event as well.</span></span>

> [!NOTE]
> <span data-ttu-id="1e0ce-243">Można znaleźć przykładowe zastosowanie kopii zapasowej i przywrócenia jej funkcjonalności w hello aplikacji odwołania sieci Web w witrynie GitHub.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-243">You can find a sample implementation of backup and restore functionality in hello Web Reference App on GitHub.</span></span> <span data-ttu-id="1e0ce-244">Zapoznaj się hello `Inventory.Service` usługi, aby uzyskać więcej informacji.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-244">Please look at hello `Inventory.Service` service for more details.</span></span>
> 
> 

## <a name="under-hello-hood-more-details-on-backup-and-restore"></a><span data-ttu-id="1e0ce-245">Pod maską hello: więcej informacji na temat tworzenia kopii zapasowych i przywracania</span><span class="sxs-lookup"><span data-stu-id="1e0ce-245">Under hello hood: more details on backup and restore</span></span>
<span data-ttu-id="1e0ce-246">Oto niektóre więcej informacji dotyczących tworzenia kopii zapasowej i przywracania.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-246">Here's some more details on backup and restore.</span></span>

### <a name="backup"></a><span data-ttu-id="1e0ce-247">Tworzenie kopii zapasowych</span><span class="sxs-lookup"><span data-stu-id="1e0ce-247">Backup</span></span>
<span data-ttu-id="1e0ce-248">Witaj niezawodnej Menedżer stanu zawiera hello możliwości toocreate spójne kopie zapasowe bez blokowania dowolne operacje odczytu lub zapisu.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-248">hello Reliable State Manager provides hello ability toocreate consistent backups without blocking any read or write operations.</span></span> <span data-ttu-id="1e0ce-249">toodo tak, jego korzysta z mechanizmu stanu trwałego punktu kontrolnego i dziennika.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-249">toodo so, it utilizes a checkpoint and log persistence mechanism.</span></span>  <span data-ttu-id="1e0ce-250">Hello niezawodnej Menedżer stanu przyjmuje rozmytego (lekkie) punkty kontrolne w niektórych punktów wykorzystania toorelieve z dziennika transakcyjne hello i skrócić czas odzyskiwania.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-250">hello Reliable State Manager takes fuzzy (lightweight) checkpoints at certain points toorelieve pressure from hello transactional log and improve recovery times.</span></span>  <span data-ttu-id="1e0ce-251">Gdy `BackupAsync` jest nazywany hello niezawodnej Menedżer stanu powoduje, że wszystkie obiekty niezawodnej toocopy ich najnowszego punktu kontrolnego pliki tooa lokalnego folderu kopii zapasowej.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-251">When `BackupAsync` is called, hello Reliable State Manager instructs all Reliable objects toocopy their latest checkpoint files tooa local backup folder.</span></span>  <span data-ttu-id="1e0ce-252">Następnie hello niezawodnej Menedżer stanu kopiuje wszystkie rekordy dziennika, zaczynając od hello "wskaźnik start" toohello najnowsze rekordu dziennika do folderu kopii zapasowej hello.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-252">Then, hello Reliable State Manager copies all log records, starting from hello "start pointer" toohello latest log record into hello backup folder.</span></span>  <span data-ttu-id="1e0ce-253">Ponieważ wszystkie rekordy dziennika hello się toohello najnowszego rekordu dziennika są uwzględnione w kopii zapasowej hello i hello niezawodnej Menedżer stanu zachowuje rejestrowania zapisu z wyprzedzeniem, hello niezawodnej Menedżer stanu gwarantuje, że wszystkie transakcje który są zatwierdzone (`CommitAsync` zwrócił pomyślnie) są uwzględniane w kopii zapasowej hello.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-253">Since all hello log records up toohello latest log record are included in hello backup and hello Reliable State Manager preserves write-ahead logging, hello Reliable State Manager guarantees that all transactions that are committed (`CommitAsync` has returned successfully) are included in hello backup.</span></span>

<span data-ttu-id="1e0ce-254">Każdej transakcji, które zatwierdza po `BackupAsync` została wywołana może lub nie może być hello kopii zapasowej.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-254">Any transaction that commits after `BackupAsync` has been called may or may not be in hello backup.</span></span>  <span data-ttu-id="1e0ce-255">Po hello lokalnego folderu kopii zapasowej zostały wprowadzone przez platformę hello (tj. lokalna kopia zapasowa zostanie zakończony przez środowisko uruchomieniowe hello), hello usługi tworzenia kopii zapasowej wywołania zwrotnego jest wywoływany.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-255">Once hello local backup folder has been populated by hello platform (i.e., local backup is completed by hello runtime), hello service's backup callback is invoked.</span></span>  <span data-ttu-id="1e0ce-256">To wywołanie zwrotne jest odpowiedzialny za przeniesienie zewnętrznej lokalizacji tooan folderu kopii zapasowej hello takie jak magazyn Azure.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-256">This callback is responsible for moving hello backup folder tooan external location such as Azure Storage.</span></span>

### <a name="restore"></a><span data-ttu-id="1e0ce-257">Przywracanie</span><span class="sxs-lookup"><span data-stu-id="1e0ce-257">Restore</span></span>
<span data-ttu-id="1e0ce-258">Witaj niezawodnej Menedżer stanu zawiera hello możliwości toorestore z kopii zapasowej przy użyciu hello `RestoreAsync` interfejsu API.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-258">hello Reliable State Manager provides hello ability toorestore from a backup by using hello `RestoreAsync` API.</span></span>  
<span data-ttu-id="1e0ce-259">Witaj `RestoreAsync` metody na `RestoreContext` można wywołać tylko wewnątrz hello `OnDataLossAsync` metody.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-259">hello `RestoreAsync` method on `RestoreContext` can be called only inside hello `OnDataLossAsync` method.</span></span>
<span data-ttu-id="1e0ce-260">Witaj bool zwrócony przez `OnDataLossAsync` wskazuje, czy usługa hello została przywrócona stanu ze źródła zewnętrznego.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-260">hello bool returned by `OnDataLossAsync` indicates whether hello service restored its state from an external source.</span></span>
<span data-ttu-id="1e0ce-261">Jeśli hello `OnDataLossAsync` zwraca wartość true, Service Fabric ponownie utworzy wszystkie inne replik z tego serwera podstawowego.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-261">If hello `OnDataLossAsync` returns true, Service Fabric will rebuild all other replicas from this primary.</span></span> <span data-ttu-id="1e0ce-262">Sieć szkieletowa usług gwarantuje, że replik, które otrzymają `OnDataLossAsync` połączeń telefonicznych z pierwszego przejścia toohello podstawową rolą, ale nie są przyznawane odczytać stanu lub zapisać stanu.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-262">Service Fabric ensures that replicas that will receive `OnDataLossAsync` call first transition toohello primary role but are not granted read status or write status.</span></span>
<span data-ttu-id="1e0ce-263">To oznacza, że implementacje klasy StatefulService `RunAsync` nie zostanie wywołany, dopóki `OnDataLossAsync` zakończy się pomyślnie.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-263">This implies that for StatefulService implementers, `RunAsync` will not be called until `OnDataLossAsync` finishes successfully.</span></span>
<span data-ttu-id="1e0ce-264">Następnie `OnDataLossAsync` zostanie wywołana na powitania nową podstawową.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-264">Then, `OnDataLossAsync` will be invoked on hello new primary.</span></span>
<span data-ttu-id="1e0ce-265">Dopóki usługi zakończeniu działania tego interfejsu API pomyślnie (przez zwrócenie wartości true lub false) i zakończeniu hello istotne zmiany konfiguracji, hello interfejsu API będzie przechowywać wywoływana pojedynczo.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-265">Until a service completes this API successfully (by returning true or false) and finishes hello relevant reconfiguration, hello API will keep being called one at a time.</span></span>

<span data-ttu-id="1e0ce-266">`RestoreAsync`najpierw porzuca wszystkie istniejące stanu w hello replika podstawowa została wywołana w.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-266">`RestoreAsync` first drops all existing state in hello primary replica that it was called on.</span></span>  
<span data-ttu-id="1e0ce-267">Wszystkie obiekty niezawodnej hello, znajdujące się w folderze kopii zapasowej hello tworzy następnie hello niezawodnej Menedżer stanu.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-267">Then hello Reliable State Manager creates all hello Reliable objects that exist in hello backup folder.</span></span>  
<span data-ttu-id="1e0ce-268">Następnie obiekty niezawodnej hello są instrukcją toorestore z ich punkty kontrolne w hello folderu kopii zapasowej.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-268">Next, hello Reliable objects are instructed toorestore from their checkpoints in hello backup folder.</span></span>  
<span data-ttu-id="1e0ce-269">Na koniec hello niezawodnej Menedżer stanu odzyskuje własny stan z rekordów dziennika hello hello folderu kopii zapasowej i wykonuje odzyskiwanie.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-269">Finally, hello Reliable State Manager recovers its own state from hello log records in hello backup folder and performs recovery.</span></span>  
<span data-ttu-id="1e0ce-270">W ramach procesu odzyskiwania hello operacji począwszy od hello "punkt początkowy", których zatwierdzania rekordy dziennika w folderze kopii zapasowej hello są obiektami niezawodnej toohello powtórzony.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-270">As part of hello recovery process, operations starting from hello "starting point" that have commit log records in hello backup folder are replayed toohello Reliable objects.</span></span>  
<span data-ttu-id="1e0ce-271">Ten krok zapewnia, że hello odzyskane stanu jest spójna.</span><span class="sxs-lookup"><span data-stu-id="1e0ce-271">This step ensures that hello recovered state is consistent.</span></span>

## <a name="next-steps"></a><span data-ttu-id="1e0ce-272">Następne kroki</span><span class="sxs-lookup"><span data-stu-id="1e0ce-272">Next steps</span></span>
  - [<span data-ttu-id="1e0ce-273">Elementy Reliable Collections</span><span class="sxs-lookup"><span data-stu-id="1e0ce-273">Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
  - [<span data-ttu-id="1e0ce-274">Niezawodne usługi szybki start</span><span class="sxs-lookup"><span data-stu-id="1e0ce-274">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
  - [<span data-ttu-id="1e0ce-275">Niezawodne usługi powiadomień</span><span class="sxs-lookup"><span data-stu-id="1e0ce-275">Reliable Services notifications</span></span>](service-fabric-reliable-services-notifications.md)
  - [<span data-ttu-id="1e0ce-276">Niezawodne usługi konfiguracji</span><span class="sxs-lookup"><span data-stu-id="1e0ce-276">Reliable Services configuration</span></span>](service-fabric-reliable-services-configuration.md)
  - [<span data-ttu-id="1e0ce-277">Dokumentacja dla deweloperów niezawodnej kolekcji</span><span class="sxs-lookup"><span data-stu-id="1e0ce-277">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)

