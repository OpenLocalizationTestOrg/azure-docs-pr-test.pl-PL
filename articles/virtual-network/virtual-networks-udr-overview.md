---
title: "Trasy zdefiniowane przez użytkownika i przekazywanie adresów IP na platformie Azure | Microsoft Docs"
description: "Dowiedz się, w jaki sposób skonfigurować trasy zdefiniowane przez użytkownika i przekazywanie adresów IP w celu przekazywania ruchu do wirtualnych urządzeń sieciowych na platformie Azure."
services: virtual-network
documentationcenter: na
author: jimdial
manager: timlt
editor: tysonn
ms.assetid: c39076c4-11b7-4b46-a904-817503c4b486
ms.service: virtual-network
ms.devlang: na
ms.topic: get-started-article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 03/15/2016
ms.author: jdial
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 6274e0101f6fb0864c8d1efaef7fcde78b8760c3
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 07/11/2017
---
# <a name="user-defined-routes-and-ip-forwarding"></a><span data-ttu-id="13ae3-103">Trasy zdefiniowane przez użytkownika i przekazywanie adresów IP</span><span class="sxs-lookup"><span data-stu-id="13ae3-103">User-defined routes and IP forwarding</span></span>

<span data-ttu-id="13ae3-104">Po dodaniu maszyny wirtualnej do sieci wirtualnej na platformie Azure można zauważyć, że maszyny wirtualne mogą automatycznie komunikować się ze sobą za pośrednictwem sieci.</span><span class="sxs-lookup"><span data-stu-id="13ae3-104">When you add virtual machines (VMs) to a virtual network (VNet) in Azure, you will notice that the VMs are able to communicate with each other over the network, automatically.</span></span> <span data-ttu-id="13ae3-105">Nie ma potrzeby określania bramy, nawet gdy maszyny wirtualne znajdują się w różnych podsieciach.</span><span class="sxs-lookup"><span data-stu-id="13ae3-105">You do not need to specify a gateway, even though the VMs are in different subnets.</span></span> <span data-ttu-id="13ae3-106">Dotyczy to także komunikacji z maszyn wirtualnych do publicznej sieci Internet, a nawet do sieci lokalnej, gdy obecne jest połączenie hybrydowe z platformy Azure do własnego centrum danych.</span><span class="sxs-lookup"><span data-stu-id="13ae3-106">The same is true for communication from the VMs to the public Internet, and even to your on-premises network when a hybrid connection from Azure to your own datacenter is present.</span></span>

<span data-ttu-id="13ae3-107">Taki przepływ komunikacji jest możliwy, ponieważ platforma Azure korzysta z szeregu tras systemowych do definiowania przepływu ruchu w sieci IP.</span><span class="sxs-lookup"><span data-stu-id="13ae3-107">This flow of communication is possible because Azure uses a series of system routes to define how IP traffic flows.</span></span> <span data-ttu-id="13ae3-108">Trasy systemowe sterują przepływem komunikacji według następujących scenariuszy:</span><span class="sxs-lookup"><span data-stu-id="13ae3-108">System routes control the flow of communication in the following scenarios:</span></span>

* <span data-ttu-id="13ae3-109">Z tej samej podsieci.</span><span class="sxs-lookup"><span data-stu-id="13ae3-109">From within the same subnet.</span></span>
* <span data-ttu-id="13ae3-110">Z jednej podsieci do drugiej w ramach sieci wirtualnej.</span><span class="sxs-lookup"><span data-stu-id="13ae3-110">From a subnet to another within a VNet.</span></span>
* <span data-ttu-id="13ae3-111">Z maszyny wirtualnej do sieci Internet.</span><span class="sxs-lookup"><span data-stu-id="13ae3-111">From VMs to the Internet.</span></span>
* <span data-ttu-id="13ae3-112">Z sieci wirtualnej do innej sieci wirtualnej za pośrednictwem bramy sieci VPN.</span><span class="sxs-lookup"><span data-stu-id="13ae3-112">From a VNet to another VNet through a VPN gateway.</span></span>
* <span data-ttu-id="13ae3-113">Z sieci wirtualnej do innej sieci wirtualnej za pośrednictwem komunikacji równorzędnej sieci wirtualnych (tworzenia łańcucha usług).</span><span class="sxs-lookup"><span data-stu-id="13ae3-113">From a VNet to another VNet through VNet Peering (Service Chaining).</span></span>
* <span data-ttu-id="13ae3-114">Z sieci wirtualnej do sieci lokalnej za pośrednictwem bramy sieci VPN.</span><span class="sxs-lookup"><span data-stu-id="13ae3-114">From a VNet to your on-premises network through a VPN gateway.</span></span>

<span data-ttu-id="13ae3-115">Na poniższym rysunku przedstawiono prostą konfigurację obejmującą sieć wirtualną, dwie podsieci i kilka maszyn wirtualnych wraz trasami systemowymi, które umożliwiają ruch pakietów IP.</span><span class="sxs-lookup"><span data-stu-id="13ae3-115">The figure below shows a simple setup with a VNet, two subnets, and a few VMs, along with the system routes that allow IP traffic to flow.</span></span>

![Trasy systemowe platformy Azure](./media/virtual-networks-udr-overview/Figure1.png)

<span data-ttu-id="13ae3-117">Chociaż korzystanie z tras systemowych automatycznie umożliwia ruch sieciowy we wdrożeniu, istnieją przypadki, w których użytkownik chce sterować przekazywaniem pakietów przez urządzenia wirtualne.</span><span class="sxs-lookup"><span data-stu-id="13ae3-117">Although the use of system routes facilitates traffic automatically for your deployment, there are cases in which you want to control the routing of packets through a virtual appliance.</span></span> <span data-ttu-id="13ae3-118">Można to zrobić, tworząc trasy definiowane przez użytkownika, które wskazują kolejny krok na drodze pakietu do określonej podsieci, aby zamiast tego przeszły do urządzeń wirtualnych, i włączając funkcję przesyłania dalej IP dla maszyny wirtualnej uruchomionej jako urządzenie wirtualne.</span><span class="sxs-lookup"><span data-stu-id="13ae3-118">You can do so by creating user defined routes that specify the next hop for packets flowing to a specific subnet to go to your virtual appliance instead, and enabling IP forwarding for the VM running as the virtual appliance.</span></span>

<span data-ttu-id="13ae3-119">Na poniższym rysunku przedstawiono przykład tras zdefiniowanych przez użytkownika i przesyłania dalej IP, wymuszający przechodzenie pakietów wysłanych z jednej podsieci do drugiej przez urządzenie wirtualne w trzeciej podsieci.</span><span class="sxs-lookup"><span data-stu-id="13ae3-119">The figure below shows an example of user defined routes and IP forwarding to force packets sent to one subnet from another to go through a virtual appliance on a third subnet.</span></span>

![Trasy systemowe platformy Azure](./media/virtual-networks-udr-overview/Figure2.png)

> [!IMPORTANT]
> <span data-ttu-id="13ae3-121">Trasy zdefiniowane przez użytkownika dotyczą ruchu wychodzącego z dowolnego zasobu w podsieci (na przykład interfejsów sieciowych dołączonych do maszyn wirtualnych).</span><span class="sxs-lookup"><span data-stu-id="13ae3-121">User-defined routes are applied to traffic leaving a subnet from any resource (such as network interfaces attached to VMs) in the subnet.</span></span> <span data-ttu-id="13ae3-122">Na przykład nie można tworzyć tras określających, w jaki sposób ruch z Internetu trafia do podsieci.</span><span class="sxs-lookup"><span data-stu-id="13ae3-122">You cannot create routes to specify how traffic enters a subnet from the Internet, for instance.</span></span> <span data-ttu-id="13ae3-123">Urządzenie, do którego jest kierowany ruch, nie może znajdować się w tej samej podsieci, z której pochodzą dane.</span><span class="sxs-lookup"><span data-stu-id="13ae3-123">The appliance you are forwarding traffic to cannot be in the same subnet where the traffic originates.</span></span> <span data-ttu-id="13ae3-124">Dla urządzeń zawsze należy utworzyć oddzielne podsieci.</span><span class="sxs-lookup"><span data-stu-id="13ae3-124">Always create a separate subnet for your appliances.</span></span> 
> 
> 

## <a name="route-resource"></a><span data-ttu-id="13ae3-125">Zasób trasy</span><span class="sxs-lookup"><span data-stu-id="13ae3-125">Route resource</span></span>
<span data-ttu-id="13ae3-126">Pakiety są przesyłane za pośrednictwem sieci TCP/IP w oparciu o tabelę tras zdefiniowaną w każdym węźle w sieci fizycznej.</span><span class="sxs-lookup"><span data-stu-id="13ae3-126">Packets are routed over a TCP/IP network based on a route table defined at each node on the physical network.</span></span> <span data-ttu-id="13ae3-127">Tabela tras jest kolekcją indywidualnych tras, która w oparciu o docelowy adres IP umożliwia podjęcie decyzji, dokąd należy przekazywać pakiety.</span><span class="sxs-lookup"><span data-stu-id="13ae3-127">A route table is a collection of individual routes used to decide where to forward packets based on the destination IP address.</span></span> <span data-ttu-id="13ae3-128">Trasa składa się z następujących elementów:</span><span class="sxs-lookup"><span data-stu-id="13ae3-128">A route consists of the following:</span></span>

| <span data-ttu-id="13ae3-129">Właściwość</span><span class="sxs-lookup"><span data-stu-id="13ae3-129">Property</span></span> | <span data-ttu-id="13ae3-130">Opis</span><span class="sxs-lookup"><span data-stu-id="13ae3-130">Description</span></span> | <span data-ttu-id="13ae3-131">Ograniczenia</span><span class="sxs-lookup"><span data-stu-id="13ae3-131">Constraints</span></span> | <span data-ttu-id="13ae3-132">Zagadnienia do rozważenia</span><span class="sxs-lookup"><span data-stu-id="13ae3-132">Considerations</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="13ae3-133">Przedrostek adresu</span><span class="sxs-lookup"><span data-stu-id="13ae3-133">Address Prefix</span></span> |<span data-ttu-id="13ae3-134">Docelowy adres CIDR, do którego zostanie zastosowana trasa, na przykład 10.1.0.0/16.</span><span class="sxs-lookup"><span data-stu-id="13ae3-134">The destination CIDR to which the route applies, such as 10.1.0.0/16.</span></span> |<span data-ttu-id="13ae3-135">Musi to być prawidłowy zakres adresów CIDR reprezentujący adresy w publicznej sieci Internet, sieci wirtualnej platformy Azure lub lokalnym centrum danych.</span><span class="sxs-lookup"><span data-stu-id="13ae3-135">Must be a valid CIDR range representing addresses on the public Internet, Azure virtual network, or on-premises datacenter.</span></span> |<span data-ttu-id="13ae3-136">Upewnij się, że **przedrostek adresu** nie zawiera **adresu następnego skoku**, ponieważ w przeciwnym razie pakiety wpadną w pętlę, przechodząc od źródła do adresu następnego skoku i nigdy nie docierając do miejsca docelowego.</span><span class="sxs-lookup"><span data-stu-id="13ae3-136">Make sure the **Address prefix** does not contain the address for the **Next hop address**, otherwise your packets will enter in a loop going from the source to the next hop without ever reaching the destination.</span></span> |
| <span data-ttu-id="13ae3-137">Typ następnego skoku</span><span class="sxs-lookup"><span data-stu-id="13ae3-137">Next hop type</span></span> |<span data-ttu-id="13ae3-138">Typ skoku platformy Azure, dokąd pakiet powinien zostać przesłany.</span><span class="sxs-lookup"><span data-stu-id="13ae3-138">The type of Azure hop the packet should be sent to.</span></span> |<span data-ttu-id="13ae3-139">Musi mieć jedną z następujących wartości:</span><span class="sxs-lookup"><span data-stu-id="13ae3-139">Must be one of the following values:</span></span> <br/> <span data-ttu-id="13ae3-140">**Sieć wirtualna**</span><span class="sxs-lookup"><span data-stu-id="13ae3-140">**Virtual Network**.</span></span> <span data-ttu-id="13ae3-141">Reprezentuje lokalną sieć wirtualną.</span><span class="sxs-lookup"><span data-stu-id="13ae3-141">Represents the local virtual network.</span></span> <span data-ttu-id="13ae3-142">Na przykład jeśli dwie podsieci 10.1.0.0/16 i 10.2.0.0/16 znajdują się w tej samej sieci wirtualnej, trasa dla każdej podsieci w tabeli tras będzie miała wartość następnego skoku *Sieć wirtualna*.</span><span class="sxs-lookup"><span data-stu-id="13ae3-142">For instance, if you have two subnets, 10.1.0.0/16 and 10.2.0.0/16 in the same virtual network, the route for each subnet in the route table will have a next hop value of *Virtual Network*.</span></span> <br/> <span data-ttu-id="13ae3-143">**Brama sieci wirtualnej**</span><span class="sxs-lookup"><span data-stu-id="13ae3-143">**Virtual Network Gateway**.</span></span> <span data-ttu-id="13ae3-144">Reprezentuje usługę Azure S2S VPN Gateway.</span><span class="sxs-lookup"><span data-stu-id="13ae3-144">Represents an Azure S2S VPN Gateway.</span></span> <br/> <span data-ttu-id="13ae3-145">**Internet**.</span><span class="sxs-lookup"><span data-stu-id="13ae3-145">**Internet**.</span></span> <span data-ttu-id="13ae3-146">Reprezentuje domyślną bramę sieci Internet dostarczoną przez infrastrukturę platformy Azure.</span><span class="sxs-lookup"><span data-stu-id="13ae3-146">Represents the default Internet gateway provided by the Azure Infrastructure.</span></span> <br/> <span data-ttu-id="13ae3-147">**Urządzenie wirtualne**.</span><span class="sxs-lookup"><span data-stu-id="13ae3-147">**Virtual Appliance**.</span></span> <span data-ttu-id="13ae3-148">Reprezentuje urządzenie wirtualne dodane do Twojej sieci wirtualnej platformy Azure.</span><span class="sxs-lookup"><span data-stu-id="13ae3-148">Represents a virtual appliance you added to your Azure virtual network.</span></span> <br/> <span data-ttu-id="13ae3-149">**Brak**.</span><span class="sxs-lookup"><span data-stu-id="13ae3-149">**None**.</span></span> <span data-ttu-id="13ae3-150">Reprezentuje czarną dziurę.</span><span class="sxs-lookup"><span data-stu-id="13ae3-150">Represents a black hole.</span></span> <span data-ttu-id="13ae3-151">Pakiety przekazywane do czarnej dziury nie zostaną w ogóle przekazane.</span><span class="sxs-lookup"><span data-stu-id="13ae3-151">Packets forwarded to a black hole will not be forwarded at all.</span></span> |<span data-ttu-id="13ae3-152">Rozważ użycie **urządzenia wirtualnego** umożliwiającego skierowanie ruchu do maszyny wirtualnej lub wewnętrznego adresu IP usługi Azure Load Balancer.</span><span class="sxs-lookup"><span data-stu-id="13ae3-152">Consider using **Virtual Appliance** to direct traffic to a VM or Azure Load Balancer internal IP address.</span></span>  <span data-ttu-id="13ae3-153">Typ ten umożliwia określenie adresu IP zgodnie z poniższym opisem.</span><span class="sxs-lookup"><span data-stu-id="13ae3-153">This type allows the specification of an IP address as described below.</span></span> <span data-ttu-id="13ae3-154">Należy rozważyć użycie typu **Brak**, aby zatrzymać pakiety w drodze do zadanego miejsca docelowego.</span><span class="sxs-lookup"><span data-stu-id="13ae3-154">Consider using a **None** type to stop packets from flowing to a given destination.</span></span> |
| <span data-ttu-id="13ae3-155">Adres następnego skoku</span><span class="sxs-lookup"><span data-stu-id="13ae3-155">Next hop address</span></span> |<span data-ttu-id="13ae3-156">Adres następnego skoku zawiera adres IP, do którego powinien zostać przekazany pakiet.</span><span class="sxs-lookup"><span data-stu-id="13ae3-156">The next hop address contains the IP address packets should be forwarded to.</span></span> <span data-ttu-id="13ae3-157">Wartości następnego skoku są dozwolone tylko w przypadku tras, dla których typem następnego skoku jest *Urządzenie wirtualne*.</span><span class="sxs-lookup"><span data-stu-id="13ae3-157">Next hop values are only allowed in routes where the next hop type is *Virtual Appliance*.</span></span> |<span data-ttu-id="13ae3-158">Musi to być adres IP osiągalny w sieci wirtualnej, w której stosowana jest trasa zdefiniowana przez użytkownika nieprzechodząca przez **bramę sieci wirtualnej**.</span><span class="sxs-lookup"><span data-stu-id="13ae3-158">Must be an IP address that is reachable within the Virtual Network where the User Defined Route is applied, without going through a **Virtual Network Gateway**.</span></span> <span data-ttu-id="13ae3-159">Adres IP musi znajdować się w tej samej sieci wirtualnej, w której jest stosowany, lub w równorzędnej sieci wirtualnej.</span><span class="sxs-lookup"><span data-stu-id="13ae3-159">The IP address has to be on the same Virtual Network where it is applied, or on a peered Virtual Network.</span></span> |<span data-ttu-id="13ae3-160">Jeśli adres IP reprezentuje maszynę wirtualną, upewnij się, że funkcja [Przesyłanie dalej IP](#IP-forwarding) platformy Azure dla maszyny wirtualnej jest włączona.</span><span class="sxs-lookup"><span data-stu-id="13ae3-160">If the IP address represents a VM, make sure you enable [IP forwarding](#IP-forwarding) in Azure for the VM.</span></span> <span data-ttu-id="13ae3-161">Jeśli adres IP reprezentuje wewnętrzny adres IP usługi Azure Load Balancer, upewnij się, że dla każdego portu, którego obciążenie chcesz zrównoważyć, skonfigurowano zgodną regułę równoważenia obciążenia.</span><span class="sxs-lookup"><span data-stu-id="13ae3-161">If the IP address represents the internal IP address of Azure Load Balancer, make sure you have a matching load balancing rule for each port you wish to load balance.</span></span>|

<span data-ttu-id="13ae3-162">W programie Azure PowerShell niektóre wartości „NextHopType” mają inne nazwy:</span><span class="sxs-lookup"><span data-stu-id="13ae3-162">In Azure PowerShell some of the "NextHopType" values have different names:</span></span>

* <span data-ttu-id="13ae3-163">Sieć wirtualna to VnetLocal,</span><span class="sxs-lookup"><span data-stu-id="13ae3-163">Virtual Network is VnetLocal</span></span>
* <span data-ttu-id="13ae3-164">Brama sieci wirtualnej to VirtualNetworkGateway,</span><span class="sxs-lookup"><span data-stu-id="13ae3-164">Virtual Network Gateway is VirtualNetworkGateway</span></span>
* <span data-ttu-id="13ae3-165">Urządzenie wirtualne to VirtualAppliance,</span><span class="sxs-lookup"><span data-stu-id="13ae3-165">Virtual Appliance is VirtualAppliance</span></span>
* <span data-ttu-id="13ae3-166">Internet to Internet</span><span class="sxs-lookup"><span data-stu-id="13ae3-166">Internet is Internet</span></span>
* <span data-ttu-id="13ae3-167">Brak to None.</span><span class="sxs-lookup"><span data-stu-id="13ae3-167">None is None</span></span>

### <a name="system-routes"></a><span data-ttu-id="13ae3-168">Trasy systemowe</span><span class="sxs-lookup"><span data-stu-id="13ae3-168">System routes</span></span>
<span data-ttu-id="13ae3-169">Każda podsieć utworzona w sieci wirtualnej jest automatycznie skojarzona z tabelą tras, która zawiera następujące reguły dotyczące tras systemowych:</span><span class="sxs-lookup"><span data-stu-id="13ae3-169">Every subnet created in a virtual network is automatically associated with a route table that contains the following system route rules:</span></span>

* <span data-ttu-id="13ae3-170">**Reguła lokalnej sieci wirtualnej**: ta reguła jest tworzona automatycznie dla każdej podsieci w sieci wirtualnej.</span><span class="sxs-lookup"><span data-stu-id="13ae3-170">**Local Vnet Rule**: This rule is automatically created for every subnet in a virtual network.</span></span> <span data-ttu-id="13ae3-171">Określa, że istnieje bezpośrednie połączenie między maszynami wirtualnymi w sieci wirtualnej i nie ma żadnego pośredniego następnego skoku.</span><span class="sxs-lookup"><span data-stu-id="13ae3-171">It specifies that there is a direct link between the VMs in the VNet and there is no intermediate next hop.</span></span>
* <span data-ttu-id="13ae3-172">**Reguła lokalna**: ta reguła dotyczy całego ruchu kierowanego do zakresu adresów lokalnych i jako miejsca docelowego następnego skoku używa bramy sieci VPN.</span><span class="sxs-lookup"><span data-stu-id="13ae3-172">**On-premises Rule**: This rule applies to all traffic destined to the on-premises address range and uses VPN gateway as the next hop destination.</span></span>
* <span data-ttu-id="13ae3-173">**Reguła sieci Internet**: ta reguła obsługuje cały ruch kierowany do publicznej sieci Internet (prefiks adresu 0.0.0.0/0) i jako miejsca docelowego następnego skoku dla wszystkich pakietów kierowanych do sieci Internet używa dostarczonej przez infrastrukturę bramy sieci Internet.</span><span class="sxs-lookup"><span data-stu-id="13ae3-173">**Internet Rule**: This rule handles all traffic destined to the public Internet (address prefix 0.0.0.0/0) and uses the infrastructure internet gateway as the next hop for all traffic destined to the Internet.</span></span>

### <a name="user-defined-routes"></a><span data-ttu-id="13ae3-174">Trasy definiowane przez użytkownika</span><span class="sxs-lookup"><span data-stu-id="13ae3-174">User-defined routes</span></span>
<span data-ttu-id="13ae3-175">Dla większości środowisk wystarczające są trasy systemowe zdefiniowane już przez platformę Azure.</span><span class="sxs-lookup"><span data-stu-id="13ae3-175">For most environments you will only need the system routes already defined by Azure.</span></span> <span data-ttu-id="13ae3-176">Może jednak zajść konieczność utworzenia tabeli tras i dodania co najmniej jednej trasy w szczególnych przypadkach, takich jak:</span><span class="sxs-lookup"><span data-stu-id="13ae3-176">However, you may need to create a route table and add one or more routes in specific cases, such as:</span></span>

* <span data-ttu-id="13ae3-177">Wymuszanie tunelowania do sieci Internet za pośrednictwem sieci lokalnej.</span><span class="sxs-lookup"><span data-stu-id="13ae3-177">Force tunneling to the Internet via your on-premises network.</span></span>
* <span data-ttu-id="13ae3-178">Korzystanie z urządzeń lokalnych w środowisku platformy Azure.</span><span class="sxs-lookup"><span data-stu-id="13ae3-178">Use of virtual appliances in your Azure environment.</span></span>

<span data-ttu-id="13ae3-179">W przypadku powyższych scenariuszy należy utworzyć tabelę tras i dodać do niej trasy zdefiniowane przez użytkownika.</span><span class="sxs-lookup"><span data-stu-id="13ae3-179">In the scenarios above, you will have to create a route table and add user defined routes to it.</span></span> <span data-ttu-id="13ae3-180">Jednocześnie może występować wiele tabel tras, a ta sama tabela może być skojarzona z większą liczbą podsieci.</span><span class="sxs-lookup"><span data-stu-id="13ae3-180">You can have multiple route tables, and the same route table can be associated to one or more subnets.</span></span> <span data-ttu-id="13ae3-181">Każda podsieć może być skojarzona tylko z jedną tabelą tras.</span><span class="sxs-lookup"><span data-stu-id="13ae3-181">And each subnet can only be associated to a single route table.</span></span> <span data-ttu-id="13ae3-182">Wszystkie maszyny wirtualne i usługi chmury w podsieci używają tabeli tras związanej z tą podsiecią.</span><span class="sxs-lookup"><span data-stu-id="13ae3-182">All VMs and cloud services in a subnet use the route table associated to that subnet.</span></span>

<span data-ttu-id="13ae3-183">Jeśli z podsiecią nie jest skojarzona tabela tras, korzysta ona z tras systemowych.</span><span class="sxs-lookup"><span data-stu-id="13ae3-183">Subnets rely on system routes until a route table is associated to the subnet.</span></span> <span data-ttu-id="13ae3-184">Jeśli skojarzenie istnieje, routing odbywa się w oparciu o najdłuższe dopasowanie prefiksu (Longest Prefix Match, LPM) wybierane spośród tras definiowanych przez użytkownika i tras systemowych.</span><span class="sxs-lookup"><span data-stu-id="13ae3-184">Once an association exists, routing is done based on Longest Prefix Match (LPM) among both user defined routes and system routes.</span></span> <span data-ttu-id="13ae3-185">Jeśli istnieje więcej niż jedna trasa z tym samym dopasowaniem LPM, wybór trasy odbywa się według następującej kolejności:</span><span class="sxs-lookup"><span data-stu-id="13ae3-185">If there is more than one route with the same LPM match then a route is selected based on its origin in the following order:</span></span>

1. <span data-ttu-id="13ae3-186">Trasa zdefiniowana przez użytkownika</span><span class="sxs-lookup"><span data-stu-id="13ae3-186">User defined route</span></span>
2. <span data-ttu-id="13ae3-187">Trasa protokołu BGP (jeśli używane są połączenia ExpressRoute)</span><span class="sxs-lookup"><span data-stu-id="13ae3-187">BGP route (when ExpressRoute is used)</span></span>
3. <span data-ttu-id="13ae3-188">Trasa systemowa</span><span class="sxs-lookup"><span data-stu-id="13ae3-188">System route</span></span>

<span data-ttu-id="13ae3-189">Informacje na temat tworzenia tras definiowanych przez użytkownika można znaleźć w artykule [Sposób tworzenia tras i włączanie funkcji przesyłania dalej IP na platformie Azure](virtual-network-create-udr-arm-template.md).</span><span class="sxs-lookup"><span data-stu-id="13ae3-189">To learn how to create user defined routes, see [How to Create Routes and Enable IP Forwarding in Azure](virtual-network-create-udr-arm-template.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="13ae3-190">Trasy zdefiniowane przez użytkownika są stosowane tylko w odniesieniu do maszyn wirtualnych i usług w chmurze.</span><span class="sxs-lookup"><span data-stu-id="13ae3-190">User defined routes are only applied to Azure VMs and cloud services.</span></span> <span data-ttu-id="13ae3-191">Na przykład jeśli pomiędzy siecią lokalną a platformą Azure ma zostać wstawione urządzenie wirtualne zapory, konieczne jest utworzenie trasy zdefiniowanej przez użytkownika dla tabel tras platformy Azure, która spowoduje przekazanie całego ruchu kierowanego do lokalnej przestrzeni adresowej do urządzenia wirtualnego.</span><span class="sxs-lookup"><span data-stu-id="13ae3-191">For instance, if you want to add a firewall virtual appliance between your on-premises network and Azure, you will have to create a user defined route for your Azure route tables that forwards all traffic going to the on-premises address space to the virtual appliance.</span></span> <span data-ttu-id="13ae3-192">Można również dodać trasę zdefiniowaną przez użytkownika do podsieci GatewaySubnet, aby przekazywać cały ruch z sieci lokalnej do platformy Azure za pośrednictwem urządzenia wirtualnego.</span><span class="sxs-lookup"><span data-stu-id="13ae3-192">You can also add a user defined route (UDR) to the GatewaySubnet to forward all traffic from on-premises to Azure through the virtual appliance.</span></span> <span data-ttu-id="13ae3-193">Ta możliwość została ostatnio dodana.</span><span class="sxs-lookup"><span data-stu-id="13ae3-193">This is a recent addition.</span></span>
> 
> 

### <a name="bgp-routes"></a><span data-ttu-id="13ae3-194">Trasy protokołu BGP</span><span class="sxs-lookup"><span data-stu-id="13ae3-194">BGP routes</span></span>
<span data-ttu-id="13ae3-195">Jeśli między siecią lokalną a platformą Azure istniej połączenie ExpressRoute, można włączyć protokół BGP w celu propagowania tras z sieci lokalnej do platformy Azure.</span><span class="sxs-lookup"><span data-stu-id="13ae3-195">If you have an ExpressRoute connection between your on-premises network and Azure, you can enable BGP to propagate routes from your on-premises network to Azure.</span></span> <span data-ttu-id="13ae3-196">Te trasy protokołu BGP są używane w taki sam sposób, jak trasy systemowe i trasy definiowane przez użytkownika w każdej podsieci platformy Azure.</span><span class="sxs-lookup"><span data-stu-id="13ae3-196">These BGP routes are used in the same way as system routes and user defined routes in each Azure subnet.</span></span> <span data-ttu-id="13ae3-197">Więcej informacji można znaleźć w artykule [ExpressRoute — wprowadzenie](../expressroute/expressroute-introduction.md).</span><span class="sxs-lookup"><span data-stu-id="13ae3-197">For more information see [ExpressRoute Introduction](../expressroute/expressroute-introduction.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="13ae3-198">W środowisku Azure można skonfigurować wymuszanie tunelowania przez sieć lokalną, tworząc trasę definiowaną przez użytkownika dla podsieci 0.0.0.0/0, korzystającą z bramy sieci VPN w następnym skoku.</span><span class="sxs-lookup"><span data-stu-id="13ae3-198">You can configure your Azure environment to use force tunneling through your on-premises network by creating a user defined route for subnet 0.0.0.0/0 that uses the VPN gateway as the next hop.</span></span> <span data-ttu-id="13ae3-199">Metoda ta działa jednak tylko w przypadku korzystania z bramy sieci VPN, a nie połączeń ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="13ae3-199">However, this only works if you are using a VPN gateway, not ExpressRoute.</span></span> <span data-ttu-id="13ae3-200">W przypadku połączeń ExpressRoute wymuszanie tunelowania jest konfigurowane za pomocą protokołu BGP.</span><span class="sxs-lookup"><span data-stu-id="13ae3-200">For ExpressRoute, forced tunneling is configured through BGP.</span></span>
> 
> 

## <a name="ip-forwarding"></a><span data-ttu-id="13ae3-201">Przekazywanie IP</span><span class="sxs-lookup"><span data-stu-id="13ae3-201">IP forwarding</span></span>
<span data-ttu-id="13ae3-202">Jak opisano powyżej, jednym z głównych powodów tworzenia tras definiowanych przez użytkownika jest przesyłanie ruchu sieciowego do urządzenia wirtualnego.</span><span class="sxs-lookup"><span data-stu-id="13ae3-202">As described above, one of the main reasons to create a user defined route is to forward traffic to a virtual appliance.</span></span> <span data-ttu-id="13ae3-203">Urządzenie wirtualne to po prostu maszyna wirtualna, na której działa aplikacja służąca do obsługi ruchu sieciowego w określony sposób, na przykład zapora lub urządzenie NAT.</span><span class="sxs-lookup"><span data-stu-id="13ae3-203">A virtual appliance is nothing more than a VM that runs an application used to handle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="13ae3-204">Ta maszyna wirtualna musi mieć zdolność odbierania ruchu przychodzącego, który nie jest skierowany do niej samej.</span><span class="sxs-lookup"><span data-stu-id="13ae3-204">This virtual appliance VM must be able to receive incoming traffic that is not addressed to itself.</span></span> <span data-ttu-id="13ae3-205">Aby umożliwić maszynie wirtualnej odbieranie ruchu kierowanego do innych miejsc docelowych, konieczne jest włączenie dla tej maszyny wirtualnej funkcji przesyłania dalej IP.</span><span class="sxs-lookup"><span data-stu-id="13ae3-205">To allow a VM to receive traffic addressed to other destinations, you must enable IP Forwarding for the VM.</span></span> <span data-ttu-id="13ae3-206">Jest to ustawienie platformy Azure, a nie systemu operacyjnego gościa.</span><span class="sxs-lookup"><span data-stu-id="13ae3-206">This is an Azure setting, not a setting in the guest operating system.</span></span>

## <a name="next-steps"></a><span data-ttu-id="13ae3-207">Następne kroki</span><span class="sxs-lookup"><span data-stu-id="13ae3-207">Next steps</span></span>
* <span data-ttu-id="13ae3-208">Dowiedz się, w jaki sposób można [tworzyć trasy w modelu wdrożenia usługi Resource Manager](virtual-network-create-udr-arm-template.md) i kojarzyć je z podsieciami.</span><span class="sxs-lookup"><span data-stu-id="13ae3-208">Learn how to [create routes in the Resource Manager deployment model](virtual-network-create-udr-arm-template.md) and associate them to subnets.</span></span> 
* <span data-ttu-id="13ae3-209">Dowiedz się, w jaki sposób można [tworzyć trasy w klasycznym modelu wdrożenia](virtual-network-create-udr-classic-ps.md) i kojarzyć je z podsieciami.</span><span class="sxs-lookup"><span data-stu-id="13ae3-209">Learn how to [create routes in the classic deployment model](virtual-network-create-udr-classic-ps.md) and associate them to subnets.</span></span>

